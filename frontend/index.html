<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TAAXDOG - Dashboard</title>
    <!-- Add these lines to ensure Bootstrap JS is properly loaded -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://kit.fontawesome.com/your-fontawesome-kit.js" crossorigin="anonymous"></script>
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Custom CSS -->
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f8f9fa;
        }

        .sidebar {
            position: fixed;
            top: 56px;
            /* Match navbar height to prevent overlap */
            bottom: 0;
            left: 0;
            z-index: 100;
            padding: 0;
            /* Remove top padding since we're using top: 56px */
            box-shadow: inset -1px 0 0 rgba(0, 0, 0, .1);
            background-color: white;
            color: #333;
            width: 240px;
            /* Set explicit width to match main-content margin */
        }

        .sidebar-sticky {
            position: relative;
            height: 100%;
            /* Take full height of sidebar */
            padding-top: 0.5rem;
            overflow-x: hidden;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .sidebar .nav-link {
            font-weight: 500;
            color: #333;
            padding: 0.75rem 1rem;
            margin-bottom: 0.25rem;
        }

        .sidebar .nav-link:hover {
            background-color: rgba(0, 0, 0, 0.05);
        }

        .sidebar .nav-link.active {
            background-color: rgba(0, 0, 0, 0.1);
        }

        .sidebar .nav-link i {
            margin-right: 10px;
        }

        .navbar-brand {
            padding-top: 0.75rem;
            padding-bottom: 0.75rem;
            font-size: 1.5rem;
            font-weight: bold;
            color: #333;
            display: flex;
            align-items: center;
        }

        .navbar-brand i {
            color: #4361ee;
            margin-right: 10px;
        }

        .navbar {
            background-color: white;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            position: fixed;
            /* Fix navbar to top */
            width: 100%;
            top: 0;
            z-index: 101;
            height: 56px;
            /* Set explicit height */
        }

        .navbar .navbar-toggler {
            border-color: rgba(0, 0, 0, 0.5);
        }

        .main-content {
            margin-left: 240px;
            /* Match sidebar width */
            padding: 2rem 1.5rem;
        }

        .card {
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            border: none;
        }

        .card-header {
            background-color: transparent;
            border-bottom: 1px solid rgba(0, 0, 0, 0.125);
            font-weight: 600;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .stats-card {
            text-align: left;
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        .stats-card .card-body {
            padding: 1.5rem;
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .stats-card .stat-value {
            font-size: 1.8rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
        }

        .stats-card .stat-change {
            font-size: 0.8rem;
            padding: 3px 8px;
            border-radius: 20px;
            display: inline-block;
        }

        .stats-card .positive-change {
            background-color: rgba(0, 200, 0, 0.1);
            color: #00b300;
        }

        .stats-card .negative-change {
            background-color: rgba(255, 0, 0, 0.1);
            color: #e60000;
        }

        .stats-card .neutral-change {
            background-color: rgba(128, 128, 128, 0.1);
            color: #808080;
        }

        .stats-card i {
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
        }

        .income-icon {
            color: #4CAF50;
        }

        .expense-icon {
            color: #F44336;
        }

        .balance-icon {
            color: #3F51B5;
        }

        .subscription-icon {
            color: #9C27B0;
        }

        .progress {
            height: 10px;
            margin-top: 5px;
            margin-bottom: 15px;
        }

        .goal-item {
            margin-bottom: 15px;
        }

        .goal-details {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }

        .notification-item {
            padding: 10px 0;
            border-bottom: 1px solid #eee;
        }

        .notification-item:last-child {
            border-bottom: none;
        }

        .notification-date {
            font-size: 0.8rem;
            color: #777;
        }

        .clock-display {
            position: absolute;
            bottom: 15px;
            right: 15px;
            background: #555;
            color: white;
            padding: 5px 15px;
            border-radius: 5px;
            font-size: 1.5rem;
            font-weight: bold;
        }

        .connect-bank-btn {
            background-color: #4361ee;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
        }

        .connect-bank-btn:hover {
            background-color: #3250b2;
        }

        .modal-body iframe {
            width: 100%;
            min-height: 500px;
            border: none;
        }

        .bank-connection-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 15px;
            border-bottom: 1px solid #eee;
            margin-bottom: 10px;
        }

        .bank-logo {
            max-width: 40px;
            margin-right: 15px;
        }

        .bank-info {
            flex-grow: 1;
        }

        .bank-name {
            font-weight: 600;
            margin-bottom: 2px;
        }

        .bank-status {
            font-size: 0.8rem;
            color: #6c757d;
        }

        .bank-status.success {
            color: #28a745;
        }

        .bank-status.error {
            color: #dc3545;
        }

        .bank-status.pending {
            color: #ffc107;
        }

        .bank-actions {
            display: flex;
            gap: 8px;
        }

        .bank-actions button {
            border: none;
            background: none;
            color: #4361ee;
            cursor: pointer;
            padding: 5px;
        }

        .bank-actions button:hover {
            color: #3250b2;
        }

        /* Mobile responsive adjustments */
        @media (max-width: 767.98px) {
            .sidebar {
                position: static;
                height: auto;
                padding: 0;
                width: 100%;
                margin-top: 56px;
            }

            .main-content {
                margin-left: 0;
                margin-top: 56px;
                /* Add margin for fixed navbar */
                padding: 1rem;
            }

            .navbar {
                position: fixed;
            }

            .navbar-brand {
                font-size: 1.2rem;
            }
        }

        /* Additional styles for tiles */
        .tile-card {
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        .tile-card:hover {
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
            transform: translateY(-5px);
        }

        .tile-card .card-body {
            display: flex;
            flex-direction: column;
            flex: 1;
            overflow: hidden;
            /* Prevent content from overflowing */
            position: relative;
            /* For positioning the clock */
        }

        .scrollable-content {
            scrollbar-width: thin;
            overflow-y: auto;
            flex: 1;
        }

        .scrollable-content::-webkit-scrollbar {
            width: 6px;
        }

        .scrollable-content::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        .scrollable-content::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 3px;
        }

        .scrollable-content::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        /* For modal content scrollability */
        #tile-modal-content {
            max-height: 70vh;
            overflow-y: auto;
            padding: 10px;
        }

        /* Mobile specific styles */
        @media (max-width: 767.98px) {
            .card-body {
                padding: 0.75rem;
            }
        }

        /* Logout button styling */
        .logout-button {
            margin-top: auto;
            padding: 10px 15px;
            background-color: #f8f9fa;
            border-top: 1px solid #eee;
        }

        .logout-button .nav-link {
            color: #dc3545 !important;
            font-weight: bold;
        }

        .logout-button .nav-link:hover {
            background-color: #f1f1f1;
        }

        .stats-card {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .stats-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        }

        .tile {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            min-height: 200px;
            cursor: pointer;
        }

        .tile:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        }

        .chart-container {
            height: 300px;
        }

        /* Dashboard-specific styles */
        #data-dashboard-section .card {
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            border: none;
            border-radius: 8px;
            overflow: hidden;
            margin-bottom: 20px;
        }

        #data-dashboard-section .card-header {
            padding: 12px 16px;
            font-weight: 500;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        }

        #data-dashboard-section .card-body {
            padding: 20px;
        }

        /* Make the canvas container fill its parent */
        #data-dashboard-section canvas {
            width: 100% !important;
            height: 100% !important;
            max-height: 100%;
            max-width: 100%;
            display: block;
        }

        /* Center the chart in its container */
        #categoryChart {
            margin: 0 auto;
        }

        #data-dashboard-section .table-card-body {
            height: auto;
            max-height: 350px;
            padding: 0;
        }

        #transactionsTable {
            font-size: 0.9rem;
            margin-bottom: 0;
        }

        #transactionsTable th {
            font-weight: 600;
            background-color: #f8f9fa;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        #transactionsTable td {
            vertical-align: middle;
            padding: 0.5rem;
        }

        /* Responsive layout for dashboard */
        @media (max-width: 991.98px) {
            #data-dashboard-section .row {
                margin-bottom: 1rem !important;
            }

            #data-dashboard-section .col-lg-6 {
                margin-bottom: 1rem;
            }

            #data-dashboard-section .card .card-body {
                height: 350px;
            }
        }

        .bank-connection-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 15px;
            border-bottom: 1px solid #eee;
            margin-bottom: 10px;
        }

        .bank-logo {
            max-width: 40px;
            margin-right: 15px;
        }
    </style>

    <!-- Chart.js for Data Visualization -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
</head>

<body>
    <!-- Top Navbar -->
    <nav class="navbar navbar-expand-lg navbar-light sticky-top">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">
                <i class="fas fa-wallet"></i> TaaxDog
            </a>
            <div class="d-flex">
                <button class="connect-bank-btn" id="connect-bank-button">
                    Connect Bank
                </button>
            </div>
        </div>
    </nav>

    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <nav id="sidebar" class="col-md-3 col-lg-2 d-md-block sidebar collapse">
                <div class="sidebar-sticky">
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link active" href="#">
                                <i class="fas fa-tachometer-alt"></i> Dashboard
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" id="data-dashboard-nav-link">
                                <i class="fas fa-chart-bar text-primary"></i> Data Dashboard
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" id="net-income-nav-link">
                                <i class="fas fa-money-bill-wave text-success"></i> Net Income
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" id="total-expenses-nav-link">
                                <i class="fas fa-arrow-circle-down text-danger"></i> Total Expenses
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" id="net-balance-nav-link">
                                <i class="fas fa-balance-scale text-primary"></i> Net Balance
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" id="subscriptions-nav-link">
                                <i class="fas fa-repeat text-primary"></i> Subscriptions
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" id="bank-accounts-nav-link">
                                <i class="fas fa-university text-success"></i> Bank Accounts
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" id="goals-nav-link">
                                <i class="fas fa-bullseye me-2"></i> Goals
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" id="tax-profile-nav-link">
                                <i class="fas fa-file-invoice-dollar me-2"></i> Your Tax Profile
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#">
                                <i class="fas fa-shield-alt me-2"></i> Security
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" id="receipts-nav-link">
                                <i class="fas fa-receipt text-success"></i> Receipts
                            </a>
                        </li>
                        <!-- Add the financial insights tab to the sidebar navigation -->
                        <a class="nav-link" id="financial-insights-tab" data-bs-toggle="pill" href="#financial-insights"
                            role="tab">
                            <i class="fas fa-robot"></i>
                            AI Insights
                        </a>
                    </ul>

                    <!-- Logout button at bottom of sidebar -->
                    <div class="logout-button mt-auto">
                        <ul class="nav flex-column">
                            <li class="nav-item">
                                <a class="nav-link d-flex align-items-center" href="#" id="logout-button">
                                    <i class="fas fa-sign-out-alt text-danger me-2"></i>
                                    <span>Log Out</span>
                                </a>
                            </li>
                        </ul>
                    </div>
                </div>
            </nav>

            <!-- Main Content -->
            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4 main-content">
                <div class="row mt-5">
                    <!-- First Row - Stats Cards -->
                    <div class="col-md-3 mb-4">
                        <div class="card stats-card" id="net-income-card" data-card="net-income"
                            style="cursor: pointer;">
                            <div class="card-header">
                                Net Income
                                <i class="fas fa-arrow-circle-up income-icon"></i>
                            </div>
                            <div class="card-body">
                                <div class="stat-value" id="net-income-value">$0.00</div>
                                <div class="stat-change positive-change">
                                    <i class="fas fa-arrow-up"></i> +12.3% from last month
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-4">
                        <div class="card stats-card" id="total-expenses-card" data-card="total-expenses"
                            style="cursor: pointer;">
                            <div class="card-header">
                                Total Expenses
                                <i class="fas fa-arrow-circle-down expense-icon"></i>
                            </div>
                            <div class="card-body">
                                <div class="stat-value" id="total-expenses-value">$0.00</div>
                                <div class="stat-change negative-change">
                                    <i class="fas fa-arrow-down"></i> -8.1% from last month
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-4">
                        <div class="card stats-card" id="net-balance-card" data-card="net-balance"
                            style="cursor: pointer;">
                            <div class="card-header">
                                Net Balance
                                <i class="fas fa-balance-scale balance-icon"></i>
                            </div>
                            <div class="card-body">
                                <div class="stat-value" id="net-balance-value">$0.00</div>
                                <div class="stat-change positive-change">
                                    <i class="fas fa-arrow-up"></i> +15.2% from last month
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-4">
                        <div class="card stats-card" id="subscriptions-card" data-card="subscriptions"
                            style="cursor: pointer;">
                            <div class="card-header">
                                Subscriptions
                                <i class="fas fa-repeat subscription-icon"></i>
                            </div>
                            <div class="card-body">
                                <div class="stat-value">$<span id="total-subscriptions-value">0.00</span></div>
                                <div class="stat-change neutral-change">
                                    <span id="subscription-count">0</span> active subscriptions
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Second Row - Goals, Notifications, and Bank Accounts -->
                <div class="row mt-3">
                    <!-- Left Side - Goals -->
                    <div class="col-md-6">
                        <!-- Goals Card -->
                        <div class="card tile-card h-100" data-tile-type="goals" id="goals-card"
                            style="cursor: pointer;">
                            <div class="card-header">
                                Goals Progress
                                <i class="fas fa-bullseye text-warning"></i>
                            </div>
                            <div class="card-body">
                                <div class="scrollable-content">
                                    <h3>3 Active Goals</h3>
                                    <div class="stat-change positive-change mb-4">
                                        <i class="fas fa-check-circle"></i> 60% Complete from last month
                                    </div>

                                    <!-- Emergency Fund Goal -->
                                    <div class="goal-item">
                                        <div class="goal-details">
                                            <span>Emergency Fund</span>
                                            <span class="text-success">$5000.00</span>
                                        </div>
                                        <div class="progress">
                                            <div class="progress-bar bg-success" role="progressbar" style="width: 50%"
                                                aria-valuenow="50" aria-valuemin="0" aria-valuemax="100"></div>
                                        </div>
                                        <div class="d-flex justify-content-between">
                                            <small>$5000.00 of $10000.00</small>
                                            <small>Due: 30/06/2024</small>
                                        </div>
                                    </div>

                                    <!-- New Car Goal -->
                                    <div class="goal-item">
                                        <div class="goal-details">
                                            <span>New Car</span>
                                            <span class="text-success">$2500.00</span>
                                        </div>
                                        <div class="progress">
                                            <div class="progress-bar bg-success" role="progressbar" style="width: 16.7%"
                                                aria-valuenow="16.7" aria-valuemin="0" aria-valuemax="100"></div>
                                        </div>
                                        <div class="d-flex justify-content-between">
                                            <small>$2500.00 of $15000.00</small>
                                            <small>Due: 31/12/2024</small>
                                        </div>
                                    </div>

                                    <!-- Holiday Goal -->
                                    <div class="goal-item">
                                        <div class="goal-details">
                                            <span>Holiday</span>
                                            <span class="text-success">$1200.00</span>
                                        </div>
                                        <div class="progress">
                                            <div class="progress-bar bg-success" role="progressbar" style="width: 40%"
                                                aria-valuenow="40" aria-valuemin="0" aria-valuemax="100"></div>
                                        </div>
                                        <div class="d-flex justify-content-between">
                                            <small>$1200.00 of $3000.00</small>
                                            <small>Due: 15/09/2024</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Right Side - Bank Accounts and Notifications -->
                    <div class="col-md-6">
                        <!-- Bank Accounts Card -->
                        <div class="card tile-card mb-3" data-tile-type="bank-accounts"
                            style="height: calc(50% - 10px);">
                            <div class="card-header">
                                Bank Accounts
                                <i class="fas fa-university text-primary"></i>
                            </div>
                            <div class="card-body">
                                <div class="scrollable-content">
                                    <div id="bank-connections-container">
                                        <!-- Bank connections will be loaded here -->
                                        <div class="text-center py-4" id="no-connections-message">
                                            <i class="fas fa-university fa-3x mb-3 text-muted"></i>
                                            <p>No bank accounts connected yet. Click the "Connect Bank" button in the
                                                top-right corner to get started.</p>
                                        </div>
                                        <div id="dashboard-connections-list" style="display: none;">
                                            <!-- Bank connections will be loaded here -->
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Notifications Card -->
                        <div class="card tile-card" data-tile-type="notifications" style="height: calc(50% - 10px);">
                            <div class="card-header">
                                Notifications
                                <i class="fas fa-bell text-warning"></i>
                            </div>
                            <div class="card-body">
                                <div class="scrollable-content">
                                    <h3>2 New Updates</h3>

                                    <!-- Notifications List -->
                                    <div class="notification-item">
                                        <h5>Tax Return Due</h5>
                                        <p>Your tax return is due in 2 weeks</p>
                                        <p class="notification-date">15/03/2024</p>
                                    </div>

                                    <div class="notification-item">
                                        <h5>Goal Milestone</h5>
                                        <p>Emergency Fund reached 75% of target</p>
                                        <p class="notification-date">10/03/2024</p>
                                    </div>
                                </div>

                                <!-- Clock Display -->
                                <div class="clock-display">
                                    <span id="hours">14</span>:<span id="minutes">31</span>
                                    <div class="d-flex justify-content-between">
                                        <small>min</small>
                                        <small>hour</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Third Row - Tax Profile Card -->
                <div class="row mt-3">
                    <div class="col-12">
                        <div class="card tile-card" data-tile-type="tax-profile" id="tax-profile-card"
                            style="cursor: pointer;">
                            <div class="card-header">
                                Your Tax Profile
                                <i class="fas fa-file-invoice-dollar text-primary"></i>
                            </div>
                            <div class="card-body">
                                <div class="scrollable-content">
                                    <div id="tax-profile-summary">
                                        <!-- Tax profile summary will be loaded here -->
                                        <div class="text-center py-4" id="no-tax-profile-message">
                                            <i class="fas fa-file-invoice-dollar fa-3x mb-3 text-muted"></i>
                                            <p>You haven't set up your tax profile yet. Click here to get started.</p>
                                        </div>
                                        <div id="tax-profile-summary-content" style="display: none;">
                                            <!-- Tax profile details will be loaded here -->
                                            <div class="row">
                                                <div class="col-md-6">
                                                    <h6 class="text-muted mb-3">Personal Information</h6>
                                                    <p><strong>Name:</strong> <span id="summary-full-name">-</span></p>
                                                    <p><strong>TFN:</strong> <span id="summary-tfn">-</span></p>
                                                    <p><strong>Filing Status:</strong> <span
                                                            id="summary-filing-status">-</span></p>
                                                    <p><strong>Dependents:</strong> <span
                                                            id="summary-dependents">-</span></p>
                                                </div>
                                                <div class="col-md-6">
                                                    <h6 class="text-muted mb-3">Financial Summary</h6>
                                                    <p><strong>Income Sources:</strong> <span
                                                            id="summary-income-sources">-</span></p>
                                                    <p><strong>Deductions Claimed:</strong> <span
                                                            id="summary-deductions">-</span></p>
                                                    <p><strong>HECS/HELP Debt:</strong> <span id="summary-hecs">-</span>
                                                    </p>
                                                </div>
                                            </div>
                                            <div class="text-center mt-3">
                                                <button class="btn btn-sm btn-outline-primary"
                                                    id="edit-tax-profile-btn">
                                                    <i class="fas fa-edit me-1"></i> View/Edit Tax Profile
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Fourth Row - Receipts Section (initially hidden) -->
                <div class="row mt-3" id="receipts-section" style="display: none;">
                    <div class="col-12">
                        <div class="card shadow-sm mb-4">
                            <div class="card-header bg-white d-flex justify-content-between align-items-center py-3">
                                <h5 class="mb-0"><i class="fas fa-receipt text-primary me-2"></i>Receipts</h5>
                                <button class="btn btn-primary" id="receipt-upload-section-btn">
                                    <i class="fas fa-plus me-1"></i> Upload New Receipt
                                </button>
                            </div>
                            <div class="card-body">
                                <!-- Search and Filter Bar -->
                                <div class="row mb-4">
                                    <div class="col-md-4 mb-2 mb-md-0">
                                        <div class="input-group">
                                            <input type="text" class="form-control border-end-0" id="receipt-search"
                                                placeholder="Search merchant, items...">
                                            <button class="btn btn-outline-secondary border-start-0 bg-white"
                                                type="button" id="receipt-search-btn">
                                                <i class="fas fa-search text-muted"></i>
                                            </button>
                                        </div>
                                    </div>
                                    <div class="col-md-3 mb-2 mb-md-0">
                                        <select class="form-select" id="receipt-category-filter">
                                            <option value="">All Categories</option>
                                            <option value="groceries">Groceries</option>
                                            <option value="dining">Dining & Restaurants</option>
                                            <option value="entertainment">Entertainment</option>
                                            <option value="transportation">Transportation</option>
                                            <option value="utilities">Utilities</option>
                                            <option value="housing">Housing & Rent</option>
                                            <option value="healthcare">Healthcare</option>
                                            <option value="education">Education</option>
                                            <option value="shopping">Shopping</option>
                                            <option value="travel">Travel</option>
                                            <option value="business">Business Expenses</option>
                                            <option value="other">Other</option>
                                        </select>
                                    </div>
                                    <div class="col-md-3 mb-2 mb-md-0">
                                        <select class="form-select" id="receipt-date-filter">
                                            <option value="all">All Time</option>
                                            <option value="today">Today</option>
                                            <option value="week">This Week</option>
                                            <option value="month">This Month</option>
                                            <option value="quarter">This Quarter</option>
                                            <option value="year">This Year</option>
                                        </select>
                                    </div>
                                    <div class="col-md-2">
                                        <button class="btn btn-outline-secondary w-100" id="reset-filters-btn">
                                            <i class="fas fa-undo me-1"></i> Reset
                                        </button>
                                    </div>
                                </div>

                                <div id="no-receipts-message" style="display: none;" class="text-center p-5">
                                    <div class="mb-4">
                                        <i class="fas fa-receipt fa-4x text-secondary opacity-50"></i>
                                    </div>
                                    <h5 class="text-muted mb-3">No receipts found</h5>
                                    <p class="text-muted mb-4">Upload your first receipt to start tracking your expenses
                                    </p>
                                    <button class="btn btn-primary btn-lg" id="upload-first-receipt-btn">
                                        <i class="fas fa-plus me-2"></i> Upload Your First Receipt
                                    </button>
                                </div>

                                <div id="receipts-list" style="display: none;">
                                    <div class="table-responsive rounded">
                                        <table class="table table-hover align-middle">
                                            <thead class="table-light">
                                                <tr>
                                                    <th class="ps-3">Date</th>
                                                    <th>Merchant</th>
                                                    <th>Category</th>
                                                    <th>Amount</th>
                                                    <th>Status</th>
                                                    <th class="text-end pe-3">Actions</th>
                                                </tr>
                                            </thead>
                                            <tbody id="receipts-table-body">
                                                <!-- Receipts will be loaded here -->
                                            </tbody>
                                        </table>
                                    </div>
                                    <div class="d-flex justify-content-between align-items-center mt-3">
                                        <div>
                                            <span class="text-muted">Showing <span id="receipts-count">0</span>
                                                receipts</span>
                                        </div>
                                        <nav aria-label="Receipt pagination">
                                            <ul class="pagination pagination-sm" id="receipts-pagination">
                                                <!-- Pagination will be added here -->
                                            </ul>
                                        </nav>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Receipt Statistics Card -->
                        <div class="card shadow-sm mb-4">
                            <div class="card-header bg-white py-3">
                                <h5 class="mb-0"><i class="fas fa-chart-pie text-primary me-2"></i>Receipt Summary</h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-3 mb-3 mb-md-0">
                                        <div class="card border-0 bg-light h-100">
                                            <div class="card-body text-center">
                                                <h6 class="text-muted mb-2">Total Receipts</h6>
                                                <h3 id="total-receipts-count">0</h3>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-3 mb-3 mb-md-0">
                                        <div class="card border-0 bg-light h-100">
                                            <div class="card-body text-center">
                                                <h6 class="text-muted mb-2">Total Spent</h6>
                                                <h3 id="total-receipts-amount">$0.00</h3>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-3 mb-3 mb-md-0">
                                        <div class="card border-0 bg-light h-100">
                                            <div class="card-body text-center">
                                                <h6 class="text-muted mb-2">Matched Receipts</h6>
                                                <h3 id="matched-receipts-count">0</h3>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="card border-0 bg-light h-100">
                                            <div class="card-body text-center">
                                                <h6 class="text-muted mb-2">Average Amount</h6>
                                                <h3 id="average-receipt-amount">$0.00</h3>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <input type="file" id="receipt-file-input" accept="image/*,.pdf" style="display: none;" />
                <div id="receipt-review-form" style="display:none; margin-top: 20px;">
                    <h5>Review Receipt Details</h5>
                    <form id="receiptForm">
                        <div class="mb-3">
                            <label for="vendor_name" class="form-label">Vendor Name</label>
                            <input type="text" class="form-control" id="vendor_name" name="vendor_name">
                        </div>
                        <div class="mb-3">
                            <label for="total_amount" class="form-label">Total Amount</label>
                            <input type="number" step="0.01" class="form-control" id="total_amount" name="total_amount">
                        </div>
                        <div class="mb-3">
                            <label for="date" class="form-label">Date</label>
                            <input type="date" class="form-control" id="date" name="date">
                        </div>
                        <div class="d-flex justify-content-between">
                            <button type="submit" class="btn btn-primary">Confirm and Save</button>
                            <button type="button" class="btn btn-secondary" id="cancel-review-btn">Cancel</button>
                        </div>
                    </form>
                </div>
                <div id="toast-container" class="position-fixed bottom-0 end-0 p-3" style="z-index: 1100;">
                    <div id="main-toast" class="toast align-items-center text-white bg-primary border-0" role="alert"
                        aria-live="assertive" aria-atomic="true">
                        <div class="d-flex">
                            <div class="toast-body" id="toast-body">
                                Message here...
                            </div>
                            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"
                                aria-label="Close"></button>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Modals -->
    <!-- Net Income Modal -->
    <div class="modal fade" id="net-income-modal" tabindex="-1" aria-labelledby="net-income-modal-label"
        aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="net-income-modal-label">
                        <i class="fas fa-money-bill-wave text-success me-2"></i>Net Income Details
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row mb-4">
                        <div class="col-12">
                            <div class="card bg-light">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <h4 class="mb-0">Total Income</h4>
                                        <h3 class="text-success mb-0" id="modal-net-income-value">$0.00</h3>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <h5 class="mb-3">Income Sources</h5>
                    <div id="no-income-sources-message" class="alert alert-info" style="display: none;">
                        <i class="fas fa-info-circle me-2"></i>No income sources found. Connect your bank account to see
                        your income details.
                    </div>
                    <div id="income-sources-container">
                        <!-- Income sources will be loaded here dynamically -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Expense Categories Modal -->
    <div class="modal fade" id="expense-categories-modal" tabindex="-1" aria-labelledby="expense-categories-modal-label"
        aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="expense-categories-modal-label">
                        <i class="fas fa-chart-pie text-danger me-2"></i>Expense Categories
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="text-center p-5">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-3">Loading expense data...</p>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" id="view-all-expenses-btn">
                        <i class="fas fa-list-ul me-2"></i>View All Expenses
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Detailed Expenses Modal -->
    <div class="modal fade" id="detailed-expenses-modal" tabindex="-1" aria-labelledby="detailed-expenses-modal-label"
        aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="detailed-expenses-modal-label">
                        <i class="fas fa-receipt text-danger me-2"></i>Detailed Expenses
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <div class="card bg-light">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <h4 class="mb-0">Total Expenses</h4>
                                        <h3 class="text-danger mb-0" id="modal-detailed-expenses-value">$0.00</h3>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="input-group">
                                <input type="text" class="form-control" id="expense-search"
                                    placeholder="Search expenses...">
                                <button class="btn btn-primary" type="button" id="expense-search-btn">
                                    <i class="fas fa-search"></i>
                                </button>
                            </div>
                        </div>
                    </div>

                    <div id="no-expenses-message" class="alert alert-info d-none">
                        <i class="fas fa-info-circle me-2"></i>No expenses found. Connect your bank account to see your
                        expenses.
                    </div>

                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Description</th>
                                    <th>Merchant</th>
                                    <th>Category</th>
                                    <th>Account</th>
                                    <th class="text-end">Amount</th>
                                </tr>
                            </thead>
                            <tbody id="expenses-table-body">
                                <!-- Expense rows will be loaded here dynamically -->
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" id="view-expense-categories-btn">
                        <i class="fas fa-chart-pie me-2"></i>View Expense Categories
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Net Balance Modal -->
    <div class="modal fade" id="net-balance-modal" tabindex="-1" aria-labelledby="net-balance-modal-label"
        aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="net-balance-modal-label">
                        <i class="fas fa-balance-scale text-primary me-2"></i>Net Balance Details
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row mb-4">
                        <div class="col-12">
                            <div class="card bg-primary text-white">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <h4 class="mb-0">Net Balance</h4>
                                        <h3 class="mb-0" id="modal-net-balance-value">$0.00</h3>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <div class="card h-100">
                                <div class="card-header bg-success bg-opacity-10 text-success">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <h5 class="mb-0">Total Income</h5>
                                        <i class="fas fa-arrow-circle-up"></i>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <h3 class="text-success" id="modal-balance-income-value">$0.00</h3>
                                    <div class="mt-3">
                                        <h6>Top Income Sources:</h6>
                                        <div id="balance-income-sources">
                                            <!-- Income sources will be loaded here -->
                                        </div>
                                        <div class="mt-3">
                                            <button class="btn btn-outline-success btn-sm"
                                                id="view-all-income-from-balance-btn">
                                                <i class="fas fa-list me-1"></i> View All Income
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <div class="card h-100">
                                <div class="card-header bg-danger bg-opacity-10 text-danger">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <h5 class="mb-0">Total Expenses</h5>
                                        <i class="fas fa-arrow-circle-down"></i>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <h3 class="text-danger" id="modal-balance-expenses-value">$0.00</h3>
                                    <div class="mt-3">
                                        <h6>Top Expense Categories:</h6>
                                        <div id="balance-expense-categories">
                                            <!-- Expense categories will be loaded here -->
                                        </div>
                                        <div class="mt-3">
                                            <button class="btn btn-outline-danger btn-sm"
                                                id="view-all-expenses-from-balance-btn">
                                                <i class="fas fa-list me-1"></i> View All Expenses
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Monthly Trends Section -->
                    <div class="row mt-2">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header bg-light">
                                    <h5 class="mb-0">
                                        <i class="fas fa-chart-line me-2"></i>Monthly Balance Trend
                                    </h5>
                                </div>
                                <div class="card-body">
                                    <div class="text-center py-3">
                                        <i class="fas fa-chart-line fa-3x text-primary mb-3"></i>
                                        <p>Balance trend visualization would appear here</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" id="analyze-balance-btn">
                        <i class="fas fa-search me-1"></i>Analyze Balance
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add after the Net Balance Modal -->
    <!-- Subscriptions Modal -->
    <div class="modal fade" id="subscriptions-modal" tabindex="-1" aria-labelledby="subscriptions-modal-label"
        aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="subscriptions-modal-label">
                        <i class="fas fa-repeat text-primary me-2"></i>Manage Subscriptions
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row mb-4">
                        <div class="col-12">
                            <div class="card bg-light">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <h4 class="mb-0">Total Monthly Cost</h4>
                                        <h3 class="text-primary mb-0" id="modal-total-subscriptions-value">$0.00</h3>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="mb-0">Active Subscriptions</h5>
                        <button class="btn btn-primary btn-sm" id="add-subscription-btn">
                            <i class="fas fa-plus me-1"></i> Add Subscription
                        </button>
                    </div>

                    <div id="no-subscriptions-message" class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>No subscriptions found. Add your first subscription or
                        connect your bank to automatically detect them.
                    </div>

                    <div id="subscriptions-container">
                        <!-- Subscriptions will be loaded here -->
                    </div>

                    <!-- Add Subscription Form (initially hidden) -->
                    <div id="add-subscription-form" class="card mt-4" style="display: none;">
                        <div class="card-header bg-light">
                            <div class="d-flex justify-content-between align-items-center">
                                <h5 class="mb-0">Add New Subscription</h5>
                                <button type="button" class="btn-close" id="close-subscription-form"></button>
                            </div>
                        </div>
                        <div class="card-body">
                            <form id="subscription-form">
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <label for="subscription-name" class="form-label">Service Name</label>
                                        <input type="text" class="form-control" id="subscription-name" required>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="subscription-amount" class="form-label">Monthly Amount</label>
                                        <div class="input-group">
                                            <span class="input-group-text">$</span>
                                            <input type="number" class="form-control" id="subscription-amount"
                                                min="0.01" step="0.01" required>
                                        </div>
                                    </div>
                                </div>
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <label for="subscription-category" class="form-label">Category</label>
                                        <select class="form-select" id="subscription-category" required>
                                            <option value="">Select a category</option>
                                            <option value="Entertainment">Entertainment</option>
                                            <option value="Software">Software</option>
                                            <option value="Streaming">Streaming</option>
                                            <option value="Utilities">Utilities</option>
                                            <option value="Shopping">Shopping</option>
                                            <option value="Other">Other</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="subscription-frequency" class="form-label">Billing Frequency</label>
                                        <select class="form-select" id="subscription-frequency" required>
                                            <option value="monthly">Monthly</option>
                                            <option value="yearly">Yearly</option>
                                            <option value="quarterly">Quarterly</option>
                                            <option value="weekly">Weekly</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <label for="subscription-start-date" class="form-label">Start Date</label>
                                        <input type="date" class="form-control" id="subscription-start-date" required>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="subscription-next-payment" class="form-label">Next Payment
                                            Date</label>
                                        <input type="date" class="form-control" id="subscription-next-payment" required>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label for="subscription-notes" class="form-label">Notes (Optional)</label>
                                    <textarea class="form-control" id="subscription-notes" rows="2"></textarea>
                                </div>
                                <div class="text-end">
                                    <button type="button" class="btn btn-secondary me-2"
                                        id="cancel-subscription-btn">Cancel</button>
                                    <button type="submit" class="btn btn-primary">Save Subscription</button>
                                </div>
                            </form>
                        </div>
                    </div>

                    <!-- Auto-Detection Settings -->
                    <div class="card mt-4">
                        <div class="card-header bg-light">
                            <h5 class="mb-0">Auto-Detection Settings</h5>
                        </div>
                        <div class="card-body">
                            <div class="form-check form-switch mb-3">
                                <input class="form-check-input" type="checkbox" id="auto-detect-subscriptions" checked>
                                <label class="form-check-label" for="auto-detect-subscriptions">
                                    Automatically detect subscriptions from transactions
                                </label>
                            </div>
                            <p class="text-muted small">
                                The app will analyze your transactions and automatically detect recurring payments that
                                might be subscriptions.
                                You can review and confirm these detections.
                            </p>
                            <div class="alert alert-light border">
                                <div class="d-flex">
                                    <div class="me-3">
                                        <i class="fas fa-lightbulb text-warning fa-2x"></i>
                                    </div>
                                    <div>
                                        <h6>How it works</h6>
                                        <p class="small mb-0">
                                            The app looks for recurring transactions with similar amounts from the same
                                            merchant.
                                            When a pattern is detected, it suggests adding them as subscriptions.
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" id="scan-for-subscriptions-btn">
                        <i class="fas fa-search me-1"></i>Scan for Subscriptions
                    </button>
                </div>
            </div>
        </div>
    </div>
    <!--- file upload start -->
    <div class="modal fade" id="receipt-upload-section" tabindex="-1" aria-labelledby="receipt-upload-section-label"
        aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="card mt-3">
                        <div class="card-header bg-light">
                            <h5 class="mb-0"><i class="fas fa-file-upload text-primary me-2"></i>Upload Receipt</h5>
                        </div>
                        <div class="card-body">
                            <!-- Tab Navigation -->
                            <ul class="nav nav-tabs" id="uploadTab" role="tablist">
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link active" id="local-tab" data-bs-toggle="tab"
                                        data-bs-target="#local" type="button" role="tab">From Device</button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="url-tab" data-bs-toggle="tab" data-bs-target="#url"
                                        type="button" role="tab">From URL</button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="camera-tab" data-bs-toggle="tab"
                                        data-bs-target="#camera" type="button" role="tab">Take Photo</button>
                                </li>
                            </ul>

                            <!-- Tab Content -->
                            <div class="tab-content mt-3" id="uploadTabContent">
                                <!-- Local Upload -->
                                <div class="tab-pane fade show active" id="local" role="tabpanel">
                                    <div class="mb-3">
                                        <label for="receipt-file" class="form-label">Upload from your device</label>
                                        <input class="form-control" type="file" id="receipt-file"
                                            accept="image/*,application/pdf">
                                    </div>
                                </div>

                                <!-- URL Upload -->
                                <div class="tab-pane fade" id="url" role="tabpanel">
                                    <div class="mb-3">
                                        <label for="receipt-url" class="form-label">Paste a receipt URL</label>
                                        <input class="form-control" type="url" id="receipt-url"
                                            placeholder="https://example.com/receipt.jpg">
                                    </div>
                                </div>

                                <!-- Camera Upload -->
                                <div class="tab-pane fade" id="camera" role="tabpanel">
                                    <div class="mb-3">
                                        <label class="form-label">Take a photo of your receipt</label>
                                        <div class="d-flex flex-column">
                                            <video id="camera-stream" width="100%" height="240" autoplay playsinline
                                                class="mb-2" style="border: 1px solid #ccc;"></video>
                                            <button type="button" class="btn btn-outline-primary btn-sm mb-2"
                                                id="capture-photo-btn">Capture Photo</button>
                                            <canvas id="photo-canvas" width="640" height="480"
                                                style="display: none;"></canvas>
                                            <img id="photo-preview" class="img-thumbnail mt-2" style="display: none;" />
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="text-end">
                                <button type="submit" class="btn btn-success">Submit Receipt</button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>
    <!--- file upload end -->

    <!-- Data Dashboard Section -->
    <div id="data-dashboard-section" style="display: none; margin-left: 240px; padding: 72px 20px 20px 20px;">
        <div class="container-fluid">
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">Financial Overview</h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <h6 class="mb-3">Expenses by Category</h6>
                                    <div style="height: 300px;">
                                        <canvas id="categoryChart"></canvas>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <h6 class="mb-3">Income vs Expenses Over Time</h6>
                                    <div style="height: 300px;">
                                        <canvas id="timeChart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">Transaction History</h5>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>Date</th>
                                            <th>Merchant</th>
                                            <th>Category</th>
                                            <th>Amount</th>
                                            <th>Type</th>
                                        </tr>
                                    </thead>
                                    <tbody id="transactionsTableBody">
                                        <!-- Transactions will be loaded here dynamically -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript libraries and scripts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    <script>
        // Global configuration
        const APP_CONFIG = {
            version: '1.0.0',
            debugMode: true,
            retryAttempts: 3
        };

        // Debug logger function
        function log(message, type = 'info') {
            if (APP_CONFIG.debugMode) {
                const timestamp = new Date().toISOString().split('T')[1].split('.')[0];
                const prefix = `[TAAXDOG ${timestamp}]`;

                switch (type) {
                    case 'error':
                        console.error(prefix, message);
                        break;
                    case 'warn':
                        console.warn(prefix, message);
                        break;
                    default:
                        console.log(prefix, message);
                }
            }
        }

        // Safely execute functions with error handling
        function safeExecute(fn, fallback = null) {
            try {
                return fn();
            } catch (error) {
                log(`Error executing function: ${error.message}`, 'error');
                if (fallback) return fallback();
                return null;
            }
        }

        // ========================
        // BOOTSTRAP INITIALIZATION
        // ========================

        // Initialize Bootstrap with retries
        function initializeBootstrap(retryCount = 0) {
            log('Initializing Bootstrap...');

            if (typeof bootstrap === 'undefined') {
                log('Bootstrap not found. Loading dynamically...', 'warn');

                if (retryCount >= APP_CONFIG.retryAttempts) {
                    log('Failed to load Bootstrap after multiple attempts', 'error');
                    showErrorAlert('Application error: Failed to load required components. Please refresh the page.');
                    return false;
                }

                const script = document.createElement('script');
                script.src = 'https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js';
                script.onload = function () {
                    log('Bootstrap loaded successfully');
                    initializeBootstrap(0);
                };
                script.onerror = function () {
                    log('Failed to load Bootstrap', 'error');
                    setTimeout(() => initializeBootstrap(retryCount + 1), 1000);
                };
                document.head.appendChild(script);
                return false;
            }

            log('Bootstrap available, initializing components');
            return true;
        }

        // ==================
        // DATA INITIALIZATION
        // ==================

        // Initialize or reset mock data
        function initializeMockData() {
            log('Checking if mock data initialization is needed');

            let dataCreated = false;

            try {
                // Check if transactions exist
                let transactions = JSON.parse(localStorage.getItem('bankTransactions') || '[]');
                let accountsExist = JSON.parse(localStorage.getItem('bankAccounts') || '[]').length > 0;

                // Initialize default transactions if none exist
                if (transactions.length === 0) {
                    log('No transactions found, creating mock transactions');

                    // Create sample transactions for the past 30 days
                    transactions = generateMockTransactions(30);

                    // Save to local storage
                    localStorage.setItem('bankTransactions', JSON.stringify(transactions));

                    log('Mock transactions created successfully');
                    dataCreated = true;
                }

                // Check if goals exist
                let goals = JSON.parse(localStorage.getItem('financialGoals') || '[]');

                // Initialize default goals if none exist
                if (goals.length === 0) {
                    log('No goals found, creating mock goals');

                    // Create sample goals
                    const today = new Date();
                    const sixMonthsLater = new Date(today);
                    sixMonthsLater.setMonth(today.getMonth() + 6);

                    const oneYearLater = new Date(today);
                    oneYearLater.setMonth(today.getMonth() + 12);

                    goals = [
                        {
                            id: Date.now(),
                            name: "Emergency Fund",
                            description: "Build a 6-month emergency fund for unexpected expenses",
                            currentAmount: 5000,
                            targetAmount: 10000,
                            dueDate: sixMonthsLater.toISOString().split('T')[0],
                            category: "Emergency Fund",
                            createdAt: today.toISOString(),
                            updatedAt: today.toISOString()
                        },
                        {
                            id: Date.now() + 1,
                            name: "New Car",
                            description: "Save for a down payment on a new vehicle",
                            currentAmount: 2500,
                            targetAmount: 15000,
                            dueDate: oneYearLater.toISOString().split('T')[0],
                            category: "Car",
                            createdAt: today.toISOString(),
                            updatedAt: today.toISOString()
                        },
                        {
                            id: Date.now() + 2,
                            name: "Holiday",
                            description: "Save for a summer vacation",
                            currentAmount: 1200,
                            targetAmount: 3000,
                            dueDate: new Date(today.getFullYear(), 8, 15).toISOString().split('T')[0], // September 15
                            category: "Travel",
                            createdAt: today.toISOString(),
                            updatedAt: today.toISOString()
                        }
                    ];

                    // Save to local storage
                    localStorage.setItem('financialGoals', JSON.stringify(goals));

                    log('Mock goals created successfully');
                    dataCreated = true;
                }

                return dataCreated;
            } catch (error) {
                log(`Error initializing mock data: ${error.message}`, 'error');
                return false;
            }
        }

        // ===================
        // APPLICATION DISPLAY
        // ===================

        // Display transaction summary
        function displayTransactionSummary() {
            log('Updating financial dashboard');

            try {
                // Get transactions from localStorage
                const transactions = JSON.parse(localStorage.getItem('bankTransactions') || '[]');

                if (transactions.length === 0) {
                    log('No transactions found for display', 'warn');
                    return;
                }

                // Calculate income (positive transactions)
                const income = transactions.reduce((sum, tx) => {
                    const amount = parseFloat(tx.amount || '0');
                    return sum + (amount > 0 ? amount : 0);
                }, 0);

                // Calculate expenses (negative transactions)
                const expenses = transactions.reduce((sum, tx) => {
                    const amount = parseFloat(tx.amount || '0');
                    return sum + (amount < 0 ? Math.abs(amount) : 0);
                }, 0);

                // Calculate net balance
                const netBalance = income - expenses;

                // Update UI elements
                updateElementText('net-income-value', formatCurrency(income));
                updateElementText('total-expenses-value', formatCurrency(expenses));
                updateElementText('net-balance-value', formatCurrency(netBalance));

                // Calculate and update subscriptions (simplified estimate)
                const subscriptions = expenses * 0.15; // 15% of expenses as estimation
                updateElementText('subscriptions-value', formatCurrency(subscriptions));

                log('Financial summary updated successfully');
            } catch (error) {
                log(`Error updating financial summary: ${error.message}`, 'error');
            }
        }

        // Update bank connections display
        function updateBankConnectionsDisplay() {
            log('Updating bank connections display');

            try {
                const noConnectionsMsg = document.getElementById('no-connections-message');
                const connectionsList = document.getElementById('dashboard-connections-list');

                if (!noConnectionsMsg || !connectionsList) {
                    log('Bank connection display elements not found', 'warn');
                    return;
                }

                // Get all bank accounts
                const accounts = JSON.parse(localStorage.getItem('bankAccounts') || '[]');

                // Check if we have transactions, even without explicit accounts
                const hasTransactions = JSON.parse(localStorage.getItem('bankTransactions') || '[]').length > 0;

                if (accounts.length === 0 && !hasTransactions) {
                    // No accounts or transactions, show no connections message
                    noConnectionsMsg.style.display = 'block';
                    connectionsList.style.display = 'none';
                    connectionsList.innerHTML = '';
                    return;
                }

                // Show connections list, hide no connections message
                noConnectionsMsg.style.display = 'none';
                connectionsList.style.display = 'block';

                let connectionsHTML = '';

                // Add default mock connection if we have transactions but no accounts
                if (hasTransactions && accounts.length === 0) {
                    connectionsHTML += `
                        <div class="bank-connection-item">
                            <div class="d-flex align-items-center">
                                <img src="https://cdn.jsdelivr.net/gh/transferwise/currency-flags/master/src/flags/au.png" class="bank-logo" alt="Bank Logo">
                                <div class="bank-info">
                                    <div class="bank-name">Commonwealth Bank</div>
                                    <div class="bank-status success">Connected</div>
                                </div>
                            </div>
                            <div class="bank-actions">
                                <button type="button" title="Refresh" onclick="alert('Refreshing data is disabled in this demo')">
                                    <i class="fas fa-sync-alt"></i>
                                </button>
                                <button type="button" title="Disconnect" onclick="alert('Disconnecting is disabled in this demo')">
                                    <i class="fas fa-unlink"></i>
                                </button>
                            </div>
                        </div>
                    `;
                }

                // Add custom accounts
                accounts.forEach(account => {
                    // Determine flag icon based on bank name (simplified demo approach)
                    let flagCode = 'us'; // Default flag
                    if (account.bankName.toLowerCase().includes('commonwealth')) flagCode = 'au';
                    else if (account.bankName.toLowerCase().includes('royal')) flagCode = 'ca';
                    else if (account.bankName.toLowerCase().includes('barclays')) flagCode = 'gb';

                    // Get account type display name
                    const accountTypeName = getAccountTypeName(account.accountType);

                    // Get last 4 digits
                    const lastFourDigits = account.accountNumber.slice(-4);

                    connectionsHTML += `
                        <div class="bank-connection-item" data-account-id="${account.id}">
                            <div class="d-flex align-items-center">
                                <img src="https://cdn.jsdelivr.net/gh/transferwise/currency-flags/master/src/flags/${flagCode}.png" class="bank-logo" alt="Bank Logo">
                                <div class="bank-info">
                                    <div class="bank-name">${account.bankName}</div>
                                    <div class="account-details text-muted small">${accountTypeName} ending in ${lastFourDigits}</div>
                                    <div class="bank-status success">Connected</div>
                                </div>
                            </div>
                            <div class="d-flex align-items-center">
                                <div class="account-balance me-3">
                                    <div class="text-muted small">Balance</div>
                                    <div class="fw-bold">${formatCurrency(account.balance)}</div>
                                </div>
                                <div class="bank-actions">
                                    <button type="button" title="Refresh" onclick="alert('Refreshing data is disabled in this demo')">
                                        <i class="fas fa-sync-alt"></i>
                                    </button>
                                    <button type="button" title="Disconnect" onclick="alert('Disconnecting is disabled in this demo')">
                                        <i class="fas fa-unlink"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                });

                // Update the list
                connectionsList.innerHTML = connectionsHTML;

                log('Bank connections display updated successfully');
            } catch (error) {
                log(`Error updating bank connections: ${error.message}`, 'error');
            }
        }

        // ==================
        // EVENT HANDLING
        // ==================

        // Setup bank connection event handlers
        function setupBankConnectionHandlers() {
            log('Setting up bank connection handlers');

            try {
                // Find Connect Bank button
                const connectBankBtn = document.getElementById('connect-bank-button');
                if (!connectBankBtn) {
                    log('Connect Bank button not found', 'warn');
                    return;
                }

                // Clear any existing onclick attributes to avoid conflicts
                connectBankBtn.removeAttribute('onclick');

                // Add click event listener - add a strong direct connection
                connectBankBtn.onclick = function () {
                    log('Connect Bank button clicked');
                    openBankConnectionModal();
                };

                // Mark as having event listener
                connectBankBtn._hasClickHandler = true;

                log('Bank connection handlers set up successfully');
            } catch (error) {
                log(`Error setting up bank connection handlers: ${error.message}`, 'error');
            }
        }

        // Setup expense feature event handlers
        function setupExpenseHandlers() {
            log('Setting up expense handlers');

            try {
                // For Total Expenses card - using direct ID
                const expensesCard = document.getElementById('total-expenses-card');
                if (expensesCard && !expensesCard._hasClickHandler) {
                    expensesCard.addEventListener('click', function () {
                        log('Total Expenses card clicked');
                        openExpenseCategoriesModal();
                    });
                    expensesCard._hasClickHandler = true;
                    log('Added click handler to Total Expenses card');
                } else {
                    log('Total Expenses card not found or already has handler', 'warn');
                }

                // For Expenses nav link in sidebar - using direct ID
                const expensesNavLink = document.getElementById('total-expenses-nav-link');
                if (expensesNavLink && !expensesNavLink._hasClickHandler) {
                    expensesNavLink.addEventListener('click', function (e) {
                        e.preventDefault();
                        log('Expenses nav link clicked');
                        openDetailedExpensesModal();
                    });
                    expensesNavLink._hasClickHandler = true;
                    log('Added click handler to Expenses nav link');
                } else {
                    log('Expenses nav link not found or already has handler', 'warn');
                }

                log('Expense handlers set up successfully');
            } catch (error) {
                log(`Error setting up expense handlers: ${error.message}`, 'error');
            }
        }

        // Handle mock bank connection
        function handleMockConnection() {
            log('Handling mock bank connection');

            try {
                // Reset mock data
                initializeMockData(true);

                // Close the modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('bank-connection-modal'));
                if (modal) modal.hide();

                // Show success message
                showAlert('Bank connected successfully! Transaction data has been imported.', 'success');

                // Update the UI
                displayTransactionSummary();
                updateBankConnectionsDisplay();
            } catch (error) {
                log(`Error handling mock connection: ${error.message}`, 'error');
                showAlert('An error occurred while connecting to your bank. Please try again.', 'danger');
            }
        }

        // ====================
        // MODAL FUNCTIONALITY
        // ====================

        // Open bank connection modal
        function openBankConnectionModal() {
            log('Opening bank connection modal');

            try {
                // Check if Bootstrap is available
                if (typeof bootstrap === 'undefined') {
                    log('Bootstrap not available for modal operation', 'error');
                    showAlert('Application error: Required components not loaded. Please refresh the page.', 'danger');
                    return;
                }

                // Check if modal exists
                let modalElement = document.getElementById('bank-connection-modal');

                // If modal doesn't exist, create it
                if (!modalElement) {
                    log('Bank connection modal not found, creating it');
                    modalElement = createBankConnectionModal();
                }

                // Show the modal
                const modal = new bootstrap.Modal(modalElement);
                modal.show();

                log('Bank connection modal opened successfully');
            } catch (error) {
                log(`Error opening bank connection modal: ${error.message}`, 'error');
                showAlert('An error occurred while opening the bank connection dialog. Please refresh the page.', 'danger');
            }
        }

        // Create bank connection modal
        function createBankConnectionModal() {
            log('Creating bank connection modal');

            try {
                // Create modal HTML
                const modalHTML = `
                    <div class="modal fade" id="bank-connection-modal" tabindex="-1" aria-labelledby="bank-connection-modal-label" aria-hidden="true">
                        <div class="modal-dialog">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title" id="bank-connection-modal-label">Connect Your Bank</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                </div>
                                <div class="modal-body">
                                    <div class="alert alert-info">
                                        <i class="fas fa-info-circle me-2"></i>
                                        You're in development mode. You can create mock data or add a custom bank account.
                                    </div>
                                    
                                    <ul class="nav nav-tabs mb-3" id="bankConnectionTabs" role="tablist">
                                        <li class="nav-item" role="presentation">
                                            <button class="nav-link active" id="mock-tab" data-bs-toggle="tab" data-bs-target="#mock-content" type="button" role="tab" aria-controls="mock-content" aria-selected="true">Mock Connection</button>
                                        </li>
                                        <li class="nav-item" role="presentation">
                                            <button class="nav-link" id="custom-tab" data-bs-toggle="tab" data-bs-target="#custom-content" type="button" role="tab" aria-controls="custom-content" aria-selected="false">Add Custom Account</button>
                                        </li>
                                    </ul>
                                    
                                    <div class="tab-content" id="bankConnectionTabsContent">
                                        <div class="tab-pane fade show active" id="mock-content" role="tabpanel" aria-labelledby="mock-tab">
                                            <p>Would you like to connect to your bank account and import mock transactions?</p>
                                            <button type="button" class="btn btn-primary w-100" id="complete-mock-connection">
                                                <i class="fas fa-check me-2"></i>Complete Mock Connection
                                            </button>
                                        </div>
                                        <div class="tab-pane fade" id="custom-content" role="tabpanel" aria-labelledby="custom-tab">
                                            <form id="custom-bank-form">
                                                <div class="mb-3">
                                                    <label for="bank-name" class="form-label">Bank Name</label>
                                                    <input type="text" class="form-control" id="bank-name" required>
                                                </div>
                                                <div class="mb-3">
                                                    <label for="account-type" class="form-label">Account Type</label>
                                                    <select class="form-select" id="account-type" required>
                                                        <option value="">Select account type</option>
                                                        <option value="checking">Checking Account</option>
                                                        <option value="savings">Savings Account</option>
                                                        <option value="credit">Credit Card</option>
                                                        <option value="investment">Investment Account</option>
                                                    </select>
                                                </div>
                                                <div class="mb-3">
                                                    <label for="account-number" class="form-label">Account Number (last 4 digits)</label>
                                                    <input type="text" class="form-control" id="account-number" maxlength="4" pattern="[0-9]{4}" required>
                                                    <div class="form-text">For demo purposes only, enter any 4 digits</div>
                                                </div>
                                                <div class="mb-3">
                                                    <label for="initial-balance" class="form-label">Initial Balance</label>
                                                    <div class="input-group">
                                                        <span class="input-group-text">$</span>
                                                        <input type="number" class="form-control" id="initial-balance" min="0" step="0.01" required>
                                                    </div>
                                                </div>
                                                <button type="submit" class="btn btn-primary w-100" id="add-custom-account-btn">
                                                    <i class="fas fa-plus me-2"></i>Add Custom Account
                                                </button>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;

                // Add modal to document
                document.body.insertAdjacentHTML('beforeend', modalHTML);

                // Get reference to the newly created modal
                const modalElement = document.getElementById('bank-connection-modal');

                // Add event listener to the complete button
                const completeButton = modalElement.querySelector('#complete-mock-connection');
                if (completeButton) {
                    completeButton.addEventListener('click', handleMockConnection);
                }

                // Add event listener to the custom account form
                const customAccountForm = modalElement.querySelector('#custom-bank-form');
                if (customAccountForm) {
                    customAccountForm.addEventListener('submit', function (e) {
                        e.preventDefault();
                        handleCustomAccountAddition();
                    });
                }

                log('Bank connection modal created successfully');
                return modalElement;
            } catch (error) {
                log(`Error creating bank connection modal: ${error.message}`, 'error');
                return null;
            }
        }

        // Handle adding a custom bank account
        function handleCustomAccountAddition() {
            log('Adding custom bank account');

            try {
                // Get form values
                const bankName = document.getElementById('bank-name').value;
                const accountType = document.getElementById('account-type').value;
                const accountNumber = document.getElementById('account-number').value;
                const initialBalance = parseFloat(document.getElementById('initial-balance').value);

                // Create new bank account object
                const newAccount = {
                    id: 'acc-' + Math.random().toString(36).substring(2, 9),
                    bankName: bankName,
                    accountType: accountType,
                    accountNumber: `xxxx-xxxx-xxxx-${accountNumber}`,
                    balance: initialBalance,
                    addedOn: new Date().toISOString()
                };

                // Get existing accounts (or initialize empty array)
                const accounts = JSON.parse(localStorage.getItem('bankAccounts') || '[]');
                accounts.push(newAccount);

                // Save to localStorage
                localStorage.setItem('bankAccounts', JSON.stringify(accounts));

                // Create an initial deposit transaction
                const transactions = JSON.parse(localStorage.getItem('bankTransactions') || '[]');

                // Add initial balance as a transaction
                transactions.push({
                    id: 'tx-' + Math.random().toString(36).substring(2, 9),
                    date: new Date().toISOString(),
                    description: 'Initial Balance',
                    amount: initialBalance.toString(),
                    category: 'Deposit',
                    merchant: bankName,
                    accountName: getAccountTypeName(accountType) + ` (${accountNumber})`,
                    accountId: newAccount.id
                });

                // Save transactions
                localStorage.setItem('bankTransactions', JSON.stringify(transactions));

                // Close the modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('bank-connection-modal'));
                if (modal) modal.hide();

                // Show success message
                showAlert(`${bankName} account ending in ${accountNumber} has been added successfully!`, 'success');

                // Update the UI
                displayTransactionSummary();
                updateBankConnectionsDisplay();

                log('Custom bank account added successfully');
            } catch (error) {
                log(`Error adding custom bank account: ${error.message}`, 'error');
                showAlert('An error occurred while adding your bank account. Please try again.', 'danger');
            }
        }

        // Helper to get account type display name
        function getAccountTypeName(accountType) {
            const types = {
                checking: 'Checking Account',
                savings: 'Savings Account',
                credit: 'Credit Card',
                investment: 'Investment Account'
            };
            return types[accountType] || 'Account';
        }

        // Open expense categories modal
        function openExpenseCategoriesModal() {
            log('Opening expense categories modal');

            try {
                // Check if Bootstrap is available
                if (typeof bootstrap === 'undefined') {
                    log('Bootstrap not available for modal operation', 'error');
                    showAlert('Application error: Required components not loaded. Please refresh the page.', 'danger');
                    return;
                }

                // Get modal element
                let modalElement = document.getElementById('expense-categories-modal');

                // If modal doesn't exist, create it
                if (!modalElement) {
                    log('Expense categories modal not found, creating it');
                    modalElement = document.createElement('div');
                    modalElement.id = 'expense-categories-modal';
                    modalElement.className = 'modal fade';
                    modalElement.setAttribute('tabindex', '-1');
                    modalElement.innerHTML = `
                        <div class="modal-dialog modal-lg">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title">
                                        <i class="fas fa-chart-pie text-danger me-2"></i>Expense Categories
                                    </h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                </div>
                                <div class="modal-body">
                                    <div class="text-center p-5">
                                        <div class="spinner-border text-primary" role="status">
                                            <span class="visually-hidden">Loading...</span>
                                        </div>
                                        <p class="mt-3">Loading expense data...</p>
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                </div>
                            </div>
                        </div>
                    `;
                    document.body.appendChild(modalElement);
                }

                // Show the modal
                const modal = new bootstrap.Modal(modalElement);
                modal.show();

                // Load expense data after modal is shown
                modalElement.addEventListener('shown.bs.modal', function () {
                    loadExpenseCategoriesContent(modalElement);
                }, { once: true });

                log('Expense categories modal opened successfully');
            } catch (error) {
                log(`Error opening expense categories modal: ${error.message}`, 'error');
                showAlert('An error occurred while opening the expense categories. Please refresh the page.', 'danger');
            }
        }

        // Load expense categories content
        function loadExpenseCategoriesContent(modalElement) {
            log('Loading expense categories content');

            try {
                // Get transactions
                const transactions = JSON.parse(localStorage.getItem('bankTransactions') || '[]');
                const expenses = transactions.filter(tx => parseFloat(tx.amount) < 0);

                if (expenses.length === 0) {
                    modalElement.querySelector('.modal-body').innerHTML = `
                        <div class="text-center py-4">
                            <i class="fas fa-exclamation-circle fa-3x text-warning mb-3"></i>
                            <p>No expense transactions found. Connect your bank account or create mock data first.</p>
                        </div>
                    `;
                    return;
                }

                // Calculate total expenses
                const totalExpenses = expenses.reduce((sum, tx) => sum + Math.abs(parseFloat(tx.amount)), 0);

                // Group by category
                const categories = {};
                expenses.forEach(tx => {
                    const category = tx.category || 'Uncategorized';
                    if (!categories[category]) {
                        categories[category] = 0;
                    }
                    categories[category] += Math.abs(parseFloat(tx.amount));
                });

                // Sort categories by amount
                const sortedCategories = Object.entries(categories)
                    .sort((a, b) => b[1] - a[1]);

                // Generate HTML content
                let categoriesHTML = '';
                sortedCategories.forEach(([category, amount]) => {
                    const percentage = ((amount / totalExpenses) * 100).toFixed(1);
                    categoriesHTML += `
                        <div class="d-flex justify-content-between align-items-center mb-2 p-2 border-bottom">
                            <div>
                                <span class="badge bg-primary me-2">${category}</span>
                                <span>${percentage}%</span>
                            </div>
                            <span class="text-danger fw-bold">$${amount.toFixed(2)}</span>
                        </div>
                    `;
                });

                // Update modal content
                modalElement.querySelector('.modal-body').innerHTML = `
                    <div class="row mb-4">
                        <div class="col-12">
                            <div class="card bg-light">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <h4 class="mb-0">Total Expenses</h4>
                                        <h3 class="text-danger mb-0">$${totalExpenses.toFixed(2)}</h3>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-7">
                            <h5 class="mb-3">Expenses by Category</h5>
                            <div class="card">
                                <div class="card-body p-3">
                                    ${categoriesHTML}
                                </div>
                            </div>
                        </div>
                        <div class="col-md-5">
                            <h5 class="mb-3">Distribution</h5>
                            <div class="card">
                                <div class="card-body">
                                    <div class="text-center py-3">
                                        <i class="fas fa-chart-pie fa-3x text-primary mb-3"></i>
                                        <p>Chart visualization would appear here</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;

                log('Expense categories content loaded successfully');
            } catch (error) {
                log(`Error loading expense categories: ${error.message}`, 'error');
                if (modalElement) {
                    modalElement.querySelector('.modal-body').innerHTML = `
                        <div class="alert alert-danger">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            An error occurred while loading expense data. Please try again.
                        </div>
                    `;
                }
            }
        }

        // =====================
        // UTILITY FUNCTIONS
        // =====================

        // Format currency value
        function formatCurrency(value) {
            // Make sure we're dealing with a number and not already formatted
            if (typeof value === 'string' && value.startsWith('$')) {
                // Already formatted, just return it
                return value;
            }
            return '$' + parseFloat(value).toFixed(2);
        }

        // Update text content of an element
        function updateElementText(elementId, text) {
            const element = document.getElementById(elementId);
            if (element) {
                // Special case for total-subscriptions-value to prevent double $ signs
                if (elementId === 'total-subscriptions-value' && text.startsWith('$')) {
                    // Strip the $ for the subscription value since the HTML already has a $ prefix
                    element.textContent = text.substring(1);
                } else {
                    element.textContent = text;
                }
                return true;
            }
            return false;
        }

        // Show an alert message
        function showAlert(message, type = 'info') {
            // Create alert element
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed top-0 start-50 translate-middle-x mt-3`;
            alertDiv.style.zIndex = '9999';
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            `;

            // Add to document
            document.body.appendChild(alertDiv);

            // Auto remove after 5 seconds
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.parentNode.removeChild(alertDiv);
                }
            }, 5000);
        }

        // Show error alert
        function showErrorAlert(message) {
            showAlert(message, 'danger');
        }

        // jQuery-like function to find elements containing text
        if (!Element.prototype.contains) {
            Element.prototype.contains = function (text) {
                return this.textContent.includes(text);
            };
        }

        // =====================
        // INITIALIZATION
        // =====================

        // Main application initialization
        function initializeApp() {
            log('Initializing TAAXDOG application...');

            // Step 1: Check if Bootstrap is available
            if (!initializeBootstrap()) {
                log('Bootstrap initialization pending, deferring app initialization');
                return;
            }

            // Step 2: Initialize mock data if needed
            const dataCreated = initializeMockData();

            // Step 3: Set up event handlers
            setupBankConnectionHandlers();
            setupExpenseHandlers();
            setupFinancialFeatureHandlers(); // Add this to set up financial feature handlers including Data Dashboard
            setupMainNavLinks(); // Add this new function to handle section visibility toggling
            setupTaxProfileForm(); // Setup tax profile form event listeners

            // Step 4: Update UI with data
            displayTransactionSummary();
            updateBankConnectionsDisplay();
            updateGoalsDisplay(); // Add this to update goals display on the dashboard

            // Log completion
            log('Application initialization completed successfully');

            // If we created data, inform the user
            if (dataCreated) {
                showAlert('Demo data has been initialized. You can now explore the app features.', 'success');
            }
        }

        // Setup navigation link handlers to toggle section visibility
        function setupMainNavLinks() {
            log('Setting up main navigation links');

            try {
                // Get all main content sections
                const mainDashboard = document.querySelector('main');
                const dataDashboardSection = document.getElementById('data-dashboard-section');

                // Handle data dashboard navigation
                const dataDashboardLink = document.getElementById('data-dashboard-nav-link');
                if (dataDashboardLink && !dataDashboardLink._hasNavClickHandler) {
                    dataDashboardLink.addEventListener('click', function (e) {
                        e.preventDefault();

                        // Hide main dashboard, show data dashboard section
                        if (mainDashboard) mainDashboard.style.display = 'none';
                        if (dataDashboardSection) {
                            dataDashboardSection.style.display = 'block';
                            loadDataDashboard(); // Load dashboard data when section is shown
                        }

                        // Update active navigation state
                        document.querySelectorAll('.sidebar .nav-link').forEach(link => {
                            link.classList.remove('active');
                        });
                        dataDashboardLink.classList.add('active');
                    });
                    dataDashboardLink._hasNavClickHandler = true;
                    log('Added navigation handler to Data Dashboard link');
                }

                // Handle main dashboard navigation
                const mainDashboardLink = document.querySelector('.sidebar .nav-link.active');
                if (mainDashboardLink && !mainDashboardLink._hasNavClickHandler) {
                    mainDashboardLink.addEventListener('click', function (e) {
                        e.preventDefault();

                        // Show main dashboard, hide data dashboard section
                        if (mainDashboard) mainDashboard.style.display = 'block';
                        if (dataDashboardSection) dataDashboardSection.style.display = 'none';

                        // Update active navigation state
                        document.querySelectorAll('.sidebar .nav-link').forEach(link => {
                            link.classList.remove('active');
                        });
                        mainDashboardLink.classList.add('active');
                    });
                    mainDashboardLink._hasNavClickHandler = true;
                    log('Added navigation handler to Main Dashboard link');
                }

                log('Main navigation links set up successfully');
            } catch (error) {
                log(`Error setting up main navigation links: ${error.message}`, 'error');
            }
        }

        // Safety wrapper for initialization
        function safeInitialize() {
            try {
                initializeApp();
            } catch (error) {
                log(`Critical error during app initialization: ${error.message}`, 'error');
                showErrorAlert('Application failed to initialize properly. Please refresh the page.');
            }
        }

        // Initialize the app when DOM is loaded
        document.addEventListener('DOMContentLoaded', function () {
            log('DOM content loaded, starting initialization sequence');
            safeInitialize();
        });

        // Setup event handlers for income and expenses
        function setupFinancialFeatureHandlers() {
            log('Setting up financial feature handlers');

            try {
                // For Net Income card - using direct ID
                const incomeCard = document.getElementById('net-income-card');
                if (incomeCard && !incomeCard._hasIncomeClickHandler) {
                    incomeCard.addEventListener('click', function () {
                        log('Net Income card clicked');
                        openNetIncomeModal();
                    });
                    incomeCard._hasIncomeClickHandler = true;
                    log('Added click handler to Net Income card');
                } else {
                    log('Net Income card not found or already has handler', 'warn');
                }

                // For Net Income nav link in sidebar - using direct ID
                const incomeNavLink = document.getElementById('net-income-nav-link');
                if (incomeNavLink && !incomeNavLink._hasIncomeClickHandler) {
                    incomeNavLink.addEventListener('click', function (e) {
                        e.preventDefault();
                        log('Net Income nav link clicked');
                        openNetIncomeModal();
                    });
                    incomeNavLink._hasIncomeClickHandler = true;
                    log('Added click handler to Net Income nav link');
                } else {
                    log('Net Income nav link not found or already has handler', 'warn');
                }

                // For Goals card - using direct ID
                const goalsCard = document.getElementById('goals-card');
                if (goalsCard && !goalsCard._hasGoalsClickHandler) {
                    goalsCard.addEventListener('click', function () {
                        log('Goals card clicked');
                        openGoalsModal();
                    });
                    goalsCard._hasGoalsClickHandler = true;
                    log('Added click handler to Goals card');
                } else {
                    log('Goals card not found or already has handler', 'warn');
                }

                // Goals nav link
                const goalsNavLink = document.getElementById('goals-nav-link');
                if (goalsNavLink && !goalsNavLink._hasGoalsClickHandler) {
                    goalsNavLink.addEventListener('click', function (e) {
                        e.preventDefault();
                        log('Goals nav link clicked');
                        openGoalsModal();
                    });
                    goalsNavLink._hasGoalsClickHandler = true;
                    log('Added click handler to Goals nav link');
                } else {
                    log('Goals nav link not found or already has handler', 'warn');
                }

                // For Net Balance card - using direct ID
                const balanceCard = document.getElementById('net-balance-card');
                if (balanceCard && !balanceCard._hasBalanceClickHandler) {
                    balanceCard.addEventListener('click', function () {
                        log('Net Balance card clicked');
                        openNetBalanceModal();
                    });
                    balanceCard._hasBalanceClickHandler = true;
                    log('Added click handler to Net Balance card');
                } else {
                    log('Net Balance card not found or already has handler', 'warn');
                }

                // For Net Balance nav link in sidebar - using direct ID
                const balanceNavLink = document.getElementById('net-balance-nav-link');
                if (balanceNavLink && !balanceNavLink._hasBalanceClickHandler) {
                    balanceNavLink.addEventListener('click', function (e) {
                        e.preventDefault();
                        log('Net Balance nav link clicked');
                        openNetBalanceModal();
                    });
                    balanceNavLink._hasBalanceClickHandler = true;
                    log('Added click handler to Net Balance nav link');
                } else {
                    log('Net Balance nav link not found or already has handler', 'warn');
                }

                // For Subscriptions card - using direct ID
                const subscriptionsCard = document.getElementById('subscriptions-card');
                if (subscriptionsCard && !subscriptionsCard._hasSubscriptionsClickHandler) {
                    subscriptionsCard.addEventListener('click', function () {
                        log('Subscriptions card clicked');
                        openSubscriptionsModal();
                    });
                    subscriptionsCard._hasSubscriptionsClickHandler = true;
                    log('Added click handler to Subscriptions card');
                } else {
                    log('Subscriptions card not found or already has handler', 'warn');
                }

                // For Subscriptions nav link in sidebar - using direct ID
                const subscriptionsNavLink = document.getElementById('subscriptions-nav-link');
                if (subscriptionsNavLink && !subscriptionsNavLink._hasSubscriptionsClickHandler) {
                    subscriptionsNavLink.addEventListener('click', function (e) {
                        e.preventDefault();
                        log('Subscriptions nav link clicked');
                        openSubscriptionsModal();
                    });
                    subscriptionsNavLink._hasSubscriptionsClickHandler = true;
                    log('Added click handler to Subscriptions nav link');
                } else {
                    log('Subscriptions nav link not found or already has handler', 'warn');
                }

                // Set up modal navigation buttons
                const viewAllExpensesBtn = document.getElementById('view-all-expenses-btn');
                if (viewAllExpensesBtn) {
                    viewAllExpensesBtn.addEventListener('click', function () {
                        // Close the categories modal
                        const categoriesModal = bootstrap.Modal.getInstance(document.getElementById('expense-categories-modal'));
                        if (categoriesModal) categoriesModal.hide();

                        // Open the detailed expenses modal
                        setTimeout(() => openDetailedExpensesModal(), 400);
                    });
                }

                const viewExpenseCategoriesBtn = document.getElementById('view-expense-categories-btn');
                if (viewExpenseCategoriesBtn) {
                    viewExpenseCategoriesBtn.addEventListener('click', function () {
                        // Close the detailed modal
                        const detailedModal = bootstrap.Modal.getInstance(document.getElementById('detailed-expenses-modal'));
                        if (detailedModal) detailedModal.hide();

                        // Open the categories modal
                        setTimeout(() => openExpenseCategoriesModal(), 400);
                    });
                }

                // Set up balance modal navigation buttons
                const viewAllIncomeFromBalanceBtn = document.getElementById('view-all-income-from-balance-btn');
                if (viewAllIncomeFromBalanceBtn) {
                    viewAllIncomeFromBalanceBtn.addEventListener('click', function () {
                        // Close the balance modal
                        const balanceModal = bootstrap.Modal.getInstance(document.getElementById('net-balance-modal'));
                        if (balanceModal) balanceModal.hide();

                        // Open the income modal
                        setTimeout(() => openNetIncomeModal(), 400);
                    });
                }

                const viewAllExpensesFromBalanceBtn = document.getElementById('view-all-expenses-from-balance-btn');
                if (viewAllExpensesFromBalanceBtn) {
                    viewAllExpensesFromBalanceBtn.addEventListener('click', function () {
                        // Close the balance modal
                        const balanceModal = bootstrap.Modal.getInstance(document.getElementById('net-balance-modal'));
                        if (balanceModal) balanceModal.hide();

                        // Open the detailed expenses modal
                        setTimeout(() => openDetailedExpensesModal(), 400);
                    });
                }

                // Data dashboard link
                const dataDashboardLink = document.getElementById('data-dashboard-nav-link');
                if (dataDashboardLink && !dataDashboardLink._hasClickHandler) {
                    dataDashboardLink.addEventListener('click', function (e) {
                        e.preventDefault();
                        loadDataDashboard();
                    });
                    dataDashboardLink._hasClickHandler = true;
                }

                // Bank Accounts nav link
                const bankAccountsNavLink = document.getElementById('bank-accounts-nav-link');
                if (bankAccountsNavLink && !bankAccountsNavLink._hasBankAccountsClickHandler) {
                    bankAccountsNavLink.addEventListener('click', function (e) {
                        e.preventDefault();
                        log('Bank Accounts nav link clicked');
                        openBankAccountsModal();
                    });
                    bankAccountsNavLink._hasBankAccountsClickHandler = true;
                    log('Added click handler to Bank Accounts nav link');
                } else {
                    log('Bank Accounts nav link not found or already has handler', 'warn');
                }

                log('Financial feature handlers set up successfully');
            } catch (error) {
                log(`Error setting up financial feature handlers: ${error.message}`, 'error');
            }
        }

        // Open net income modal
        function openNetIncomeModal() {
            log('Opening net income modal');

            try {
                // Check if Bootstrap is available
                if (typeof bootstrap === 'undefined') {
                    log('Bootstrap not available for modal operation', 'error');
                    showAlert('Application error: Required components not loaded. Please refresh the page.', 'danger');
                    return;
                }

                // Get modal element
                let modalElement = document.getElementById('net-income-modal');

                // Show the modal
                const modal = new bootstrap.Modal(modalElement);
                modal.show();

                // Load income data
                loadIncomeDetails();

                log('Net income modal opened successfully');
            } catch (error) {
                log(`Error opening net income modal: ${error.message}`, 'error');
                showAlert('An error occurred while opening the net income details. Please refresh the page.', 'danger');
            }
        }

        // Load income details
        function loadIncomeDetails() {
            log('Loading income details');

            try {
                // Get transactions from localStorage
                const transactions = JSON.parse(localStorage.getItem('bankTransactions') || '[]');
                const incomeTransactions = transactions.filter(tx => parseFloat(tx.amount) > 0);

                // Update total income value in modal
                const totalIncome = incomeTransactions.reduce((sum, tx) => sum + parseFloat(tx.amount), 0);
                const incomeValueElement = document.getElementById('modal-net-income-value');
                if (incomeValueElement) {
                    incomeValueElement.textContent = formatCurrency(totalIncome);
                }

                // Group income by source/category
                const incomeBySource = {};
                incomeTransactions.forEach(tx => {
                    const source = tx.category || 'Other Income';
                    if (!incomeBySource[source]) {
                        incomeBySource[source] = 0;
                    }
                    incomeBySource[source] += parseFloat(tx.amount);
                });

                // Generate HTML for income sources
                const sourcesContainer = document.getElementById('income-sources-container');
                const noSourcesMessage = document.getElementById('no-income-sources-message');

                if (sourcesContainer) {
                    if (incomeTransactions.length === 0) {
                        if (noSourcesMessage) noSourcesMessage.style.display = 'block';
                        sourcesContainer.innerHTML = '';
                        return;
                    }

                    if (noSourcesMessage) noSourcesMessage.style.display = 'none';

                    let sourcesHTML = '';
                    Object.entries(incomeBySource).forEach(([source, amount]) => {
                        const percentage = ((amount / totalIncome) * 100).toFixed(1);

                        sourcesHTML += `
                            <div class="card mb-3">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <h5 class="mb-0">${source}</h5>
                                        <span class="badge bg-success">${percentage}%</span>
                                    </div>
                                    <div class="d-flex justify-content-between align-items-center mt-2">
                                        <div class="text-muted">Monthly income</div>
                                        <h4 class="text-success mb-0">${formatCurrency(amount)}</h4>
                                    </div>
                                    <div class="progress mt-3" style="height: 5px;">
                                        <div class="progress-bar bg-success" role="progressbar" style="width: ${percentage}%" 
                                            aria-valuenow="${percentage}" aria-valuemin="0" aria-valuemax="100"></div>
                                    </div>
                                </div>
                            </div>
                        `;
                    });

                    sourcesContainer.innerHTML = sourcesHTML;
                }

                log('Income details loaded successfully');
            } catch (error) {
                log(`Error loading income details: ${error.message}`, 'error');
            }
        }

        // Open detailed expenses modal
        function openDetailedExpensesModal() {
            log('Opening detailed expenses modal');

            try {
                // Check if Bootstrap is available
                if (typeof bootstrap === 'undefined') {
                    log('Bootstrap not available for modal operation', 'error');
                    showAlert('Application error: Required components not loaded. Please refresh the page.', 'danger');
                    return;
                }

                // Get modal element
                let modalElement = document.getElementById('detailed-expenses-modal');

                // Show the modal
                const modal = new bootstrap.Modal(modalElement);
                modal.show();

                // Load expense transactions
                loadDetailedExpenses();

                // Setup search functionality
                setupExpenseSearch();

                log('Detailed expenses modal opened successfully');
            } catch (error) {
                log(`Error opening detailed expenses modal: ${error.message}`, 'error');
                showAlert('An error occurred while opening the detailed expenses. Please refresh the page.', 'danger');
            }
        }

        // Load detailed expenses
        function loadDetailedExpenses() {
            log('Loading detailed expenses');

            try {
                // Get transactions from localStorage
                const transactions = JSON.parse(localStorage.getItem('bankTransactions') || '[]');
                const expenses = transactions.filter(tx => parseFloat(tx.amount) < 0);

                // Update total expenses value in modal
                const totalExpenses = expenses.reduce((sum, tx) => sum + Math.abs(parseFloat(tx.amount)), 0);
                const expensesValueElement = document.getElementById('modal-detailed-expenses-value');
                if (expensesValueElement) {
                    expensesValueElement.textContent = formatCurrency(totalExpenses);
                }

                // Display expenses in table
                const tableBody = document.getElementById('expenses-table-body');
                const noExpensesMessage = document.getElementById('no-expenses-message');

                if (tableBody) {
                    if (expenses.length === 0) {
                        tableBody.innerHTML = '';
                        if (noExpensesMessage) noExpensesMessage.classList.remove('d-none');
                        return;
                    }

                    if (noExpensesMessage) noExpensesMessage.classList.add('d-none');

                    // Sort expenses by date (newest first)
                    expenses.sort((a, b) => new Date(b.date) - new Date(a.date));

                    let tableRows = '';
                    expenses.forEach(expense => {
                        const amount = Math.abs(parseFloat(expense.amount)).toFixed(2);
                        const date = new Date(expense.date).toLocaleDateString();

                        tableRows += `
                            <tr>
                                <td>${date}</td>
                                <td>${expense.description || 'No description'}</td>
                                <td>${expense.merchant || 'Unknown'}</td>
                                <td><span class="badge bg-primary">${expense.category || 'Uncategorized'}</span></td>
                                <td>${expense.accountName || 'Unknown Account'}</td>
                                <td class="text-end text-danger">$${amount}</td>
                            </tr>
                        `;
                    });

                    tableBody.innerHTML = tableRows;
                }

                log('Detailed expenses loaded successfully');
            } catch (error) {
                log(`Error loading detailed expenses: ${error.message}`, 'error');
            }
        }

        // Setup expense search functionality
        function setupExpenseSearch() {
            log('Setting up expense search');

            try {
                const searchInput = document.getElementById('expense-search');
                const searchButton = document.getElementById('expense-search-btn');

                if (!searchInput || !searchButton) {
                    log('Expense search elements not found', 'warn');
                    return;
                }

                // Clear any existing event listeners
                const newSearchInput = searchInput.cloneNode(true);
                const newSearchButton = searchButton.cloneNode(true);

                searchInput.parentNode.replaceChild(newSearchInput, searchInput);
                searchButton.parentNode.replaceChild(newSearchButton, searchButton);

                // Add search functionality
                newSearchButton.addEventListener('click', performExpenseSearch);
                newSearchInput.addEventListener('keypress', function (e) {
                    if (e.key === 'Enter') {
                        performExpenseSearch();
                    }
                });

                log('Expense search setup successfully');
            } catch (error) {
                log(`Error setting up expense search: ${error.message}`, 'error');
            }
        }

        // Perform expense search
        function performExpenseSearch() {
            log('Performing expense search');

            try {
                const searchInput = document.getElementById('expense-search');
                if (!searchInput) return;

                const searchTerm = searchInput.value.toLowerCase().trim();

                // Get transactions from localStorage
                const transactions = JSON.parse(localStorage.getItem('bankTransactions') || '[]');
                const expenses = transactions.filter(tx => parseFloat(tx.amount) < 0);

                if (searchTerm === '') {
                    // Reset to show all expenses
                    loadDetailedExpenses();
                    return;
                }

                // Filter expenses based on search term
                const filteredExpenses = expenses.filter(expense => {
                    return (
                        (expense.description && expense.description.toLowerCase().includes(searchTerm)) ||
                        (expense.merchant && expense.merchant.toLowerCase().includes(searchTerm)) ||
                        (expense.category && expense.category.toLowerCase().includes(searchTerm)) ||
                        (expense.accountName && expense.accountName.toLowerCase().includes(searchTerm))
                    );
                });

                // Display filtered expenses
                const tableBody = document.getElementById('expenses-table-body');
                const noExpensesMessage = document.getElementById('no-expenses-message');

                if (tableBody) {
                    if (filteredExpenses.length === 0) {
                        tableBody.innerHTML = `
                            <tr>
                                <td colspan="6" class="text-center py-4">
                                    <p>No matching expenses found for "${searchTerm}"</p>
                                </td>
                            </tr>
                        `;
                        if (noExpensesMessage) noExpensesMessage.classList.add('d-none');
                        return;
                    }

                    if (noExpensesMessage) noExpensesMessage.classList.add('d-none');

                    // Sort expenses by date (newest first)
                    filteredExpenses.sort((a, b) => new Date(b.date) - new Date(a.date));

                    let tableRows = '';
                    filteredExpenses.forEach(expense => {
                        const amount = Math.abs(parseFloat(expense.amount)).toFixed(2);
                        const date = new Date(expense.date).toLocaleDateString();

                        tableRows += `
                            <tr>
                                <td>${date}</td>
                                <td>${expense.description || 'No description'}</td>
                                <td>${expense.merchant || 'Unknown'}</td>
                                <td><span class="badge bg-primary">${expense.category || 'Uncategorized'}</span></td>
                                <td>${expense.accountName || 'Unknown Account'}</td>
                                <td class="text-end text-danger">$${amount}</td>
                            </tr>
                        `;
                    });

                    tableBody.innerHTML = tableRows;
                }

                log(`Expense search completed with ${filteredExpenses.length} results`);
            } catch (error) {
                log(`Error performing expense search: ${error.message}`, 'error');
            }
        }

        // Load data dashboard
        function loadDataDashboard() {
            log('Loading data dashboard');

            try {
                const dashboardSection = document.getElementById('data-dashboard-section');
                if (!dashboardSection) {
                    log('Data dashboard section element not found', 'error');
                    return;
                }

                // Show dashboard section
                dashboardSection.style.display = 'block';

                // Load transactions
                const transactions = JSON.parse(localStorage.getItem('bankTransactions') || '[]');

                // Load chart data if Chart.js is available
                if (typeof Chart !== 'undefined') {
                    createExpenseCategoryChart(transactions);
                    createExpenseTimeChart(transactions);
                }

                // Load transactions table
                loadTransactionsTable(transactions);

                log('Data dashboard loaded successfully');
            } catch (error) {
                log(`Error loading data dashboard: ${error.message}`, 'error');
            }
        }

        // Create expense category chart
        function createExpenseCategoryChart(transactions) {
            log('Creating expense category chart');

            try {
                const expensesByCategory = {};
                const expenses = transactions.filter(tx => parseFloat(tx.amount) < 0);

                // Group expenses by category
                expenses.forEach(tx => {
                    const category = tx.category || 'Uncategorized';
                    if (!expensesByCategory[category]) {
                        expensesByCategory[category] = 0;
                    }
                    expensesByCategory[category] += Math.abs(parseFloat(tx.amount));
                });

                // Convert to arrays for chart
                const categories = Object.keys(expensesByCategory);
                const values = Object.values(expensesByCategory);

                // Generate colors
                const colors = categories.map((_, i) => {
                    const hue = (i * 137) % 360; // Golden angle approximation for good distribution
                    return `hsl(${hue}, 70%, 60%)`;
                });

                // Get chart canvas
                const ctx = document.getElementById('categoryChart');
                if (!ctx) {
                    log('Category chart canvas not found', 'warn');
                    return;
                }

                // Destroy existing chart if any
                if (window.categoryPieChart) {
                    window.categoryPieChart.destroy();
                }

                // Create new chart
                window.categoryPieChart = new Chart(ctx, {
                    type: 'pie',
                    data: {
                        labels: categories,
                        datasets: [{
                            data: values,
                            backgroundColor: colors,
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'right',
                                labels: {
                                    boxWidth: 15,
                                    padding: 15
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function (context) {
                                        const value = context.raw;
                                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                        const percentage = ((value / total) * 100).toFixed(1);
                                        return `$${value.toFixed(2)} (${percentage}%)`;
                                    }
                                }
                            }
                        }
                    }
                });

                log('Expense category chart created successfully');
            } catch (error) {
                log(`Error creating expense category chart: ${error.message}`, 'error');
            }
        }

        // Create expense time chart
        function createExpenseTimeChart(transactions) {
            log('Creating expense time chart');

            try {
                // Group expenses by date
                const expensesByDate = {};
                const incomeByDate = {};

                // Process transactions
                transactions.forEach(tx => {
                    const amount = parseFloat(tx.amount);
                    const date = new Date(tx.date);
                    const dateKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;

                    if (amount < 0) { // Expense
                        if (!expensesByDate[dateKey]) {
                            expensesByDate[dateKey] = 0;
                        }
                        expensesByDate[dateKey] += Math.abs(amount);
                    } else { // Income
                        if (!incomeByDate[dateKey]) {
                            incomeByDate[dateKey] = 0;
                        }
                        incomeByDate[dateKey] += amount;
                    }
                });

                // Get all unique dates and sort them
                const allDates = [...new Set([...Object.keys(expensesByDate), ...Object.keys(incomeByDate)])].sort();

                // Prepare data for chart
                const expenseData = [];
                const incomeData = [];

                allDates.forEach(date => {
                    expenseData.push({
                        x: date,
                        y: expensesByDate[date] || 0
                    });

                    incomeData.push({
                        x: date,
                        y: incomeByDate[date] || 0
                    });
                });

                // Get chart canvas
                const ctx = document.getElementById('timeChart');
                if (!ctx) {
                    log('Time chart canvas not found', 'warn');
                    return;
                }

                // Destroy existing chart if any
                if (window.timeLineChart) {
                    window.timeLineChart.destroy();
                }

                // Create new chart
                window.timeLineChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        datasets: [
                            {
                                label: 'Expenses',
                                data: expenseData,
                                borderColor: '#dc3545',
                                backgroundColor: 'rgba(220, 53, 69, 0.1)',
                                fill: true,
                                tension: 0.3
                            },
                            {
                                label: 'Income',
                                data: incomeData,
                                borderColor: '#198754',
                                backgroundColor: 'rgba(25, 135, 84, 0.1)',
                                fill: true,
                                tension: 0.3
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            x: {
                                type: 'time',
                                time: {
                                    unit: 'day',
                                    tooltipFormat: 'MMM d, yyyy'
                                },
                                title: {
                                    display: true,
                                    text: 'Date'
                                }
                            },
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Amount ($)'
                                }
                            }
                        },
                        plugins: {
                            tooltip: {
                                callbacks: {
                                    label: function (context) {
                                        return `${context.dataset.label}: $${context.raw.y.toFixed(2)}`;
                                    }
                                }
                            }
                        }
                    }
                });

                log('Expense time chart created successfully');
            } catch (error) {
                log(`Error creating expense time chart: ${error.message}`, 'error');
            }
        }

        // Load transactions table
        function loadTransactionsTable(transactions) {
            log('Loading transactions table');

            try {
                const tableBody = document.getElementById('transactionsTableBody');
                if (!tableBody) {
                    log('Transactions table body element not found', 'warn');
                    return;
                }

                if (transactions.length === 0) {
                    tableBody.innerHTML = `
                        <tr>
                            <td colspan="5" class="text-center py-4">
                                <p>No transactions found</p>
                            </td>
                        </tr>
                    `;
                    return;
                }

                // Sort transactions by date (newest first)
                transactions.sort((a, b) => new Date(b.date) - new Date(a.date));

                let tableRows = '';
                transactions.forEach(tx => {
                    const amount = parseFloat(tx.amount);
                    const date = new Date(tx.date).toLocaleDateString();
                    const type = amount >= 0 ? 'Income' : 'Expense';
                    const amountClass = amount >= 0 ? 'text-success' : 'text-danger';

                    tableRows += `
                        <tr>
                            <td>${date}</td>
                            <td>${tx.merchant || 'Unknown'}</td>
                            <td>${tx.category || 'Uncategorized'}</td>
                            <td class="${amountClass}">$${Math.abs(amount).toFixed(2)}</td>
                            <td>${type}</td>
                        </tr>
                    `;
                });

                tableBody.innerHTML = tableRows;

                log('Transactions table loaded successfully');
            } catch (error) {
                log(`Error loading transactions table: ${error.message}`, 'error');
            }
        }

        // Open net balance modal
        function openNetBalanceModal() {
            log('Opening net balance modal');

            try {
                // Check if Bootstrap is available
                if (typeof bootstrap === 'undefined') {
                    log('Bootstrap not available for modal operation', 'error');
                    showAlert('Application error: Required components not loaded. Please refresh the page.', 'danger');
                    return;
                }

                // Get modal element
                let modalElement = document.getElementById('net-balance-modal');

                // Show the modal
                const modal = new bootstrap.Modal(modalElement);
                modal.show();

                // Load balance data
                loadNetBalanceDetails();

                log('Net balance modal opened successfully');
            } catch (error) {
                log(`Error opening net balance modal: ${error.message}`, 'error');
                showAlert('An error occurred while opening the net balance details. Please refresh the page.', 'danger');
            }
        }

        // Load net balance details
        function loadNetBalanceDetails() {
            log('Loading net balance details');

            try {
                // Get transactions from localStorage
                const transactions = JSON.parse(localStorage.getItem('bankTransactions') || '[]');

                // Calculate income (positive transactions)
                const incomeTransactions = transactions.filter(tx => parseFloat(tx.amount) > 0);
                const totalIncome = incomeTransactions.reduce((sum, tx) => sum + parseFloat(tx.amount), 0);

                // Calculate expenses (negative transactions)
                const expenseTransactions = transactions.filter(tx => parseFloat(tx.amount) < 0);
                const totalExpenses = expenseTransactions.reduce((sum, tx) => sum + Math.abs(parseFloat(tx.amount)), 0);

                // Calculate net balance
                const netBalance = totalIncome - totalExpenses;

                // Update values in the modal
                updateElementText('modal-net-balance-value', formatCurrency(netBalance));
                updateElementText('modal-balance-income-value', formatCurrency(totalIncome));
                updateElementText('modal-balance-expenses-value', formatCurrency(totalExpenses));

                // Load top income sources
                const incomeBySource = {};
                incomeTransactions.forEach(tx => {
                    const source = tx.category || 'Other Income';
                    if (!incomeBySource[source]) {
                        incomeBySource[source] = 0;
                    }
                    incomeBySource[source] += parseFloat(tx.amount);
                });

                // Sort income sources by amount and take top 3
                const topIncomeSources = Object.entries(incomeBySource)
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, 3);

                // Generate HTML for top income sources
                const incomeSourcesContainer = document.getElementById('balance-income-sources');
                if (incomeSourcesContainer) {
                    if (topIncomeSources.length === 0) {
                        incomeSourcesContainer.innerHTML = '<p class="text-muted">No income sources found</p>';
                    } else {
                        let sourcesHTML = '';
                        topIncomeSources.forEach(([source, amount]) => {
                            const percentage = ((amount / totalIncome) * 100).toFixed(1);

                            sourcesHTML += `
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <span>${source}</span>
                                    <span class="text-success">${formatCurrency(amount)} <small class="text-muted">(${percentage}%)</small></span>
                                </div>
                            `;
                        });
                        incomeSourcesContainer.innerHTML = sourcesHTML;
                    }
                }

                // Load top expense categories
                const expensesByCategory = {};
                expenseTransactions.forEach(tx => {
                    const category = tx.category || 'Uncategorized';
                    if (!expensesByCategory[category]) {
                        expensesByCategory[category] = 0;
                    }
                    expensesByCategory[category] += Math.abs(parseFloat(tx.amount));
                });

                // Sort expense categories by amount and take top 3
                const topExpenseCategories = Object.entries(expensesByCategory)
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, 3);

                // Generate HTML for top expense categories
                const expenseCategoriesContainer = document.getElementById('balance-expense-categories');
                if (expenseCategoriesContainer) {
                    if (topExpenseCategories.length === 0) {
                        expenseCategoriesContainer.innerHTML = '<p class="text-muted">No expense categories found</p>';
                    } else {
                        let categoriesHTML = '';
                        topExpenseCategories.forEach(([category, amount]) => {
                            const percentage = ((amount / totalExpenses) * 100).toFixed(1);

                            categoriesHTML += `
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <span>${category}</span>
                                    <span class="text-danger">${formatCurrency(amount)} <small class="text-muted">(${percentage}%)</small></span>
                                </div>
                            `;
                        });
                        expenseCategoriesContainer.innerHTML = categoriesHTML;
                    }
                }

                log('Net balance details loaded successfully');
            } catch (error) {
                log(`Error loading net balance details: ${error.message}`, 'error');
            }
        }

        // Add these new functions after loadNetBalanceDetails()

        // Open subscriptions modal
        function openSubscriptionsModal() {
            log('Opening subscriptions modal');

            try {
                // Check if Bootstrap is available
                if (typeof bootstrap === 'undefined') {
                    log('Bootstrap not available for modal operation', 'error');
                    showAlert('Application error: Required components not loaded. Please refresh the page.', 'danger');
                    return;
                }

                // Get modal element
                let modalElement = document.getElementById('subscriptions-modal');

                // Show the modal
                const modal = new bootstrap.Modal(modalElement);
                modal.show();

                // Load subscriptions data
                loadSubscriptionsData();

                // Set up add subscription form handlers
                setupSubscriptionFormHandlers();

                log('Subscriptions modal opened successfully');
            } catch (error) {
                log(`Error opening subscriptions modal: ${error.message}`, 'error');
                showAlert('An error occurred while opening the subscriptions. Please refresh the page.', 'danger');
            }
        }

        // Load subscriptions data
        function loadSubscriptionsData() {
            log('Loading subscriptions data');

            try {
                // Get subscriptions from localStorage
                const subscriptions = JSON.parse(localStorage.getItem('subscriptions') || '[]');

                // Update dashboard display
                updateSubscriptionDisplays(subscriptions);

                // Show/hide no subscriptions message
                const noSubscriptionsMessage = document.getElementById('no-subscriptions-message');
                const subscriptionsContainer = document.getElementById('subscriptions-container');

                if (subscriptions.length === 0) {
                    noSubscriptionsMessage.style.display = 'block';
                    subscriptionsContainer.innerHTML = '';
                    return;
                }

                noSubscriptionsMessage.style.display = 'none';

                // Generate HTML for subscriptions
                let subscriptionsHTML = '';

                subscriptions.forEach((subscription, index) => {
                    // Calculate monthly cost based on frequency
                    let monthlyCost = parseFloat(subscription.amount);
                    switch (subscription.frequency) {
                        case 'yearly':
                            monthlyCost = monthlyCost / 12;
                            break;
                        case 'quarterly':
                            monthlyCost = monthlyCost / 3;
                            break;
                        case 'weekly':
                            monthlyCost = monthlyCost * 4.33; // Average weeks in a month
                            break;
                    }

                    // Format dates
                    const startDate = new Date(subscription.startDate);
                    const nextPayment = new Date(subscription.nextPaymentDate);

                    // Calculate days until next payment
                    const today = new Date();
                    const daysUntilPayment = Math.ceil((nextPayment - today) / (1000 * 60 * 60 * 24));
                    let paymentStatus = '';

                    if (daysUntilPayment < 0) {
                        paymentStatus = '<span class="badge bg-danger">Overdue</span>';
                    } else if (daysUntilPayment <= 3) {
                        paymentStatus = '<span class="badge bg-warning text-dark">Due soon</span>';
                    } else {
                        paymentStatus = `<span class="badge bg-success">In ${daysUntilPayment} days</span>`;
                    }

                    // Create subscription card
                    subscriptionsHTML += `
                        <div class="card mb-3 subscription-card" data-subscription-id="${subscription.id}">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div>
                                        <h5 class="mb-1">${subscription.name}</h5>
                                        <span class="badge bg-light text-dark">${subscription.category}</span>
                                        <span class="badge bg-light text-dark text-capitalize">${subscription.frequency}</span>
                                    </div>
                                    <h4 class="text-primary mb-0">${formatCurrency(subscription.amount)}</h4>
                                </div>
                                <div class="row mt-3">
                                    <div class="col-md-4">
                                        <div class="text-muted small">Started on</div>
                                        <div>${startDate.toLocaleDateString()}</div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="text-muted small">Next payment</div>
                                        <div>${nextPayment.toLocaleDateString()}</div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="text-muted small">Status</div>
                                        <div>${paymentStatus}</div>
                                    </div>
                                </div>
                                <div class="mt-3 d-flex justify-content-between align-items-center">
                                    <div class="text-muted small">
                                        ${subscription.notes ? `Note: ${subscription.notes}` : ''}
                                    </div>
                                    <div>
                                        <button class="btn btn-sm btn-outline-danger delete-subscription-btn" data-subscription-index="${index}">
                                            <i class="fas fa-trash-alt"></i>
                                        </button>
                                        <button class="btn btn-sm btn-outline-primary edit-subscription-btn ms-1" data-subscription-index="${index}">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                });

                // Update container
                subscriptionsContainer.innerHTML = subscriptionsHTML;

                // Add event listeners for edit and delete buttons
                document.querySelectorAll('.edit-subscription-btn').forEach(button => {
                    button.addEventListener('click', function () {
                        const index = parseInt(this.getAttribute('data-subscription-index'));
                        editSubscription(index);
                    });
                });

                document.querySelectorAll('.delete-subscription-btn').forEach(button => {
                    button.addEventListener('click', function () {
                        const index = parseInt(this.getAttribute('data-subscription-index'));
                        deleteSubscription(index);
                    });
                });

                log('Subscriptions data loaded successfully');
            } catch (error) {
                log(`Error loading subscriptions data: ${error.message}`, 'error');
            }
        }

        // Set up subscription form handlers
        function setupSubscriptionFormHandlers() {
            log('Setting up subscription form handlers');

            try {
                // Add subscription button
                const addButton = document.getElementById('add-subscription-btn');
                if (addButton) {
                    addButton.addEventListener('click', function () {
                        document.getElementById('add-subscription-form').style.display = 'block';
                        this.style.display = 'none';

                        // Set today's date in the date fields
                        const today = new Date().toISOString().split('T')[0];
                        document.getElementById('subscription-start-date').value = today;
                        document.getElementById('subscription-next-payment').value = today;
                    });
                }

                // Close form button
                const closeButton = document.getElementById('close-subscription-form');
                if (closeButton) {
                    closeButton.addEventListener('click', function () {
                        document.getElementById('add-subscription-form').style.display = 'none';
                        document.getElementById('add-subscription-btn').style.display = 'block';
                    });
                }

                // Cancel button
                const cancelButton = document.getElementById('cancel-subscription-btn');
                if (cancelButton) {
                    cancelButton.addEventListener('click', function () {
                        document.getElementById('add-subscription-form').style.display = 'none';
                        document.getElementById('add-subscription-btn').style.display = 'block';
                        document.getElementById('subscription-form').reset();
                    });
                }

                // Form submission
                const form = document.getElementById('subscription-form');
                if (form) {
                    form.addEventListener('submit', function (e) {
                        e.preventDefault();
                        saveSubscription();
                    });
                }

                // Scan for subscriptions button
                const scanButton = document.getElementById('scan-for-subscriptions-btn');
                if (scanButton) {
                    scanButton.addEventListener('click', function () {
                        // Pass true to forceScan to override auto-scan settings
                        scanForSubscriptions(true);
                    });
                }

                log('Subscription form handlers set up successfully');
            } catch (error) {
                log(`Error setting up subscription form handlers: ${error.message}`, 'error');
            }
        }

        // Save subscription data
        function saveSubscription() {
            log('Saving subscription data');

            try {
                // Get form values
                const name = document.getElementById('subscription-name').value;
                const amount = document.getElementById('subscription-amount').value;
                const category = document.getElementById('subscription-category').value;
                const frequency = document.getElementById('subscription-frequency').value;
                const startDate = document.getElementById('subscription-start-date').value;
                const nextPaymentDate = document.getElementById('subscription-next-payment').value;
                const notes = document.getElementById('subscription-notes').value;

                // Create subscription object
                const subscription = {
                    id: 'sub-' + Math.random().toString(36).substring(2, 9),
                    name,
                    amount,
                    category,
                    frequency,
                    startDate,
                    nextPaymentDate,
                    notes,
                    autoDetected: false
                };

                // Get existing subscriptions
                const subscriptions = JSON.parse(localStorage.getItem('subscriptions') || '[]');

                // Add new subscription
                subscriptions.push(subscription);

                // Save to localStorage
                localStorage.setItem('subscriptions', JSON.stringify(subscriptions));

                // Update dashboard display
                updateSubscriptionDisplays(subscriptions);

                // Reset form and hide it
                document.getElementById('subscription-form').reset();
                document.getElementById('add-subscription-form').style.display = 'none';
                document.getElementById('add-subscription-btn').style.display = 'block';

                // Reload subscriptions data
                loadSubscriptionsData();

                // Show success message
                showAlert(`Subscription to ${name} has been added successfully`, 'success');

                log('Subscription saved successfully');
            } catch (error) {
                log(`Error saving subscription: ${error.message}`, 'error');
                showAlert('An error occurred while saving the subscription', 'danger');
            }
        }

        // Delete subscription
        function deleteSubscription(index) {
            log(`Deleting subscription at index ${index}`);

            try {
                // Get existing subscriptions
                const subscriptions = JSON.parse(localStorage.getItem('subscriptions') || '[]');

                // Store the name for the success message
                const subscriptionName = subscriptions[index].name;

                // Remove subscription
                subscriptions.splice(index, 1);

                // Save to localStorage
                localStorage.setItem('subscriptions', JSON.stringify(subscriptions));

                // Update dashboard display
                updateSubscriptionDisplays(subscriptions);

                // Reload subscriptions data
                loadSubscriptionsData();

                // Show success message
                showAlert(`Subscription to ${subscriptionName} has been deleted`, 'success');

                log('Subscription deleted successfully');
            } catch (error) {
                log(`Error deleting subscription: ${error.message}`, 'error');
                showAlert('An error occurred while deleting the subscription', 'danger');
            }
        }

        // Edit subscription
        function editSubscription(index) {
            log(`Editing subscription at index ${index}`);

            try {
                // Get existing subscriptions
                const subscriptions = JSON.parse(localStorage.getItem('subscriptions') || '[]');
                const subscription = subscriptions[index];

                // Populate form with subscription data
                document.getElementById('subscription-name').value = subscription.name;
                document.getElementById('subscription-amount').value = subscription.amount;
                document.getElementById('subscription-category').value = subscription.category;
                document.getElementById('subscription-frequency').value = subscription.frequency;
                document.getElementById('subscription-start-date').value = subscription.startDate;
                document.getElementById('subscription-next-payment').value = subscription.nextPaymentDate;
                document.getElementById('subscription-notes').value = subscription.notes || '';

                // Show form
                document.getElementById('add-subscription-form').style.display = 'block';
                document.getElementById('add-subscription-btn').style.display = 'none';

                // Modify form submission to update instead of add
                const form = document.getElementById('subscription-form');
                if (form._updateListener) {
                    form.removeEventListener('submit', form._updateListener);
                }

                form._updateListener = function (e) {
                    e.preventDefault();

                    // Update subscription data
                    subscriptions[index] = {
                        ...subscription, // Keep id and autoDetected flag
                        name: document.getElementById('subscription-name').value,
                        amount: document.getElementById('subscription-amount').value,
                        category: document.getElementById('subscription-category').value,
                        frequency: document.getElementById('subscription-frequency').value,
                        startDate: document.getElementById('subscription-start-date').value,
                        nextPaymentDate: document.getElementById('subscription-next-payment').value,
                        notes: document.getElementById('subscription-notes').value
                    };

                    // Save to localStorage
                    localStorage.setItem('subscriptions', JSON.stringify(subscriptions));

                    // Update dashboard display
                    updateSubscriptionDisplays(subscriptions);

                    // Reset form and hide it
                    document.getElementById('subscription-form').reset();
                    document.getElementById('add-subscription-form').style.display = 'none';
                    document.getElementById('add-subscription-btn').style.display = 'block';

                    // Remove this one-time event listener
                    form.removeEventListener('submit', form._updateListener);

                    // Restore original submit handler
                    form.addEventListener('submit', function (e) {
                        e.preventDefault();
                        saveSubscription();
                    });

                    // Reload subscriptions data
                    loadSubscriptionsData();

                    // Show success message
                    showAlert(`Subscription to ${subscriptions[index].name} has been updated`, 'success');
                };

                form.addEventListener('submit', form._updateListener);

                log('Subscription edit form populated successfully');
            } catch (error) {
                log(`Error editing subscription: ${error.message}`, 'error');
                showAlert('An error occurred while editing the subscription', 'danger');
            }
        }

        // Update subscription displays across the app
        function updateSubscriptionDisplays(subscriptions) {
            log('Updating subscription displays with ' + subscriptions.length + ' subscriptions');

            try {
                // Calculate total monthly cost
                let totalMonthlyCost = 0;

                subscriptions.forEach(subscription => {
                    let amount = parseFloat(subscription.amount || 0);
                    if (isNaN(amount)) amount = 0;

                    // Convert to monthly equivalent
                    switch (subscription.frequency) {
                        case 'yearly':
                            amount = amount / 12;
                            break;
                        case 'quarterly':
                            amount = amount / 3;
                            break;
                        case 'weekly':
                            amount = amount * 4.33; // Average weeks in a month
                            break;
                    }

                    totalMonthlyCost += amount;
                });

                log('Total monthly cost calculated: ' + totalMonthlyCost);

                // Update dashboard card - Direct update to prevent double $ signs
                const totalSubscriptionsElement = document.getElementById('total-subscriptions-value');
                if (totalSubscriptionsElement) {
                    totalSubscriptionsElement.textContent = parseFloat(totalMonthlyCost).toFixed(2);
                    log('Updated total-subscriptions-value to: ' + parseFloat(totalMonthlyCost).toFixed(2));
                } else {
                    log('total-subscriptions-value element not found', 'error');
                }

                // Also update the subscription count
                const subscriptionCountElement = document.getElementById('subscription-count');
                if (subscriptionCountElement) {
                    subscriptionCountElement.textContent = subscriptions.length;
                    log('Updated subscription-count to: ' + subscriptions.length);
                }

                // Update modal value
                const modalTotalElement = document.getElementById('modal-total-subscriptions-value');
                if (modalTotalElement) {
                    modalTotalElement.textContent = formatCurrency(totalMonthlyCost);
                    log('Updated modal-total-subscriptions-value to: ' + formatCurrency(totalMonthlyCost));
                }

                log('Subscription displays updated successfully');
            } catch (error) {
                log(`Error updating subscription displays: ${error.message}`, 'error');
            }
        }

        // Scan for potential subscriptions in transactions
        function scanForSubscriptions(forceScan = false) {
            log('Scanning for potential subscriptions');

            try {
                // Skip automatic scanning unless explicitly forced by user action
                if (!forceScan && !shouldAutoScanSubscriptions()) {
                    log('Automatic subscription scanning is disabled. Skipping scan.');
                    return;
                }

                // Get transactions from localStorage
                const transactions = JSON.parse(localStorage.getItem('bankTransactions') || '[]');

                // Get existing subscriptions
                const subscriptions = JSON.parse(localStorage.getItem('subscriptions') || '[]');

                // Find existing subscription merchant names to avoid duplicates
                const existingMerchants = subscriptions.map(sub => {
                    // Convert to lowercase and trim for better matching
                    return sub.name.toLowerCase().trim();
                });

                // Map of merchants with negative transactions
                const merchantTransactions = {};

                // Only look at negative transactions (expenses)
                transactions
                    .filter(tx => parseFloat(tx.amount) < 0)
                    .forEach(tx => {
                        const merchant = tx.merchant || 'Unknown';
                        const amount = Math.abs(parseFloat(tx.amount)).toFixed(2);
                        const key = `${merchant.toLowerCase()}_${amount}`;

                        if (!merchantTransactions[key]) {
                            merchantTransactions[key] = [];
                        }

                        merchantTransactions[key].push({
                            date: new Date(tx.date),
                            amount,
                            category: tx.category,
                            description: tx.description
                        });
                    });

                // Find recurring transactions with the same merchant and amount
                const potentialSubscriptions = [];

                for (const [key, txs] of Object.entries(merchantTransactions)) {
                    // Check for at least 2 transactions with similar timing
                    if (txs.length >= 2) {
                        // Sort by date
                        txs.sort((a, b) => a.date - b.date);

                        // Calculate average days between transactions
                        let totalDays = 0;
                        let intervals = 0;

                        for (let i = 1; i < txs.length; i++) {
                            const daysBetween = Math.round((txs[i].date - txs[i - 1].date) / (1000 * 60 * 60 * 24));
                            if (daysBetween > 5) { // Ignore transactions too close together
                                totalDays += daysBetween;
                                intervals++;
                            }
                        }

                        if (intervals > 0) {
                            const avgDays = totalDays / intervals;

                            // Determine if it's weekly, monthly, quarterly, or yearly
                            let frequency = 'monthly';
                            if (avgDays <= 10) {
                                frequency = 'weekly';
                            } else if (avgDays >= 75 && avgDays <= 105) {
                                frequency = 'quarterly';
                            } else if (avgDays >= 350) {
                                frequency = 'yearly';
                            }

                            // Extract merchant name from key
                            const [merchantName] = key.split('_');

                            // More robust check for existing merchants to avoid duplicates
                            // Skip if we already have this merchant in our subscriptions
                            const normalizedMerchantName = merchantName.toLowerCase().trim();
                            if (existingMerchants.some(name => name === normalizedMerchantName ||
                                name.includes(normalizedMerchantName) ||
                                normalizedMerchantName.includes(name))) {
                                continue;
                            }

                            // Create potential subscription
                            potentialSubscriptions.push({
                                name: merchantName.charAt(0).toUpperCase() + merchantName.slice(1),
                                amount: txs[0].amount,
                                category: txs[0].category || 'Entertainment',
                                frequency,
                                startDate: txs[0].date.toISOString().split('T')[0],
                                nextPaymentDate: calculateNextPaymentDate(txs[txs.length - 1].date, avgDays).toISOString().split('T')[0],
                                notes: `Auto-detected from ${txs.length} transactions. Average interval: ${Math.round(avgDays)} days.`,
                                autoDetected: true
                            });
                        }
                    }
                }

                if (potentialSubscriptions.length === 0) {
                    showAlert('No new potential subscriptions found in your transactions', 'info');
                    log('No potential subscriptions found');
                    return;
                }

                // Add the detected subscriptions to the list
                let added = 0;
                potentialSubscriptions.forEach(sub => {
                    const newSubscription = {
                        ...sub,
                        id: 'sub-' + Math.random().toString(36).substring(2, 9)
                    };

                    subscriptions.push(newSubscription);
                    added++;
                });

                // Save to localStorage
                localStorage.setItem('subscriptions', JSON.stringify(subscriptions));

                // Update dashboard display
                updateSubscriptionDisplays(subscriptions);

                // Reload subscriptions data
                loadSubscriptionsData();

                // Show success message
                showAlert(`Found and added ${added} new subscription${added !== 1 ? 's' : ''} from your transactions`, 'success');

                log(`Added ${added} potential subscriptions`);
            } catch (error) {
                log(`Error scanning for subscriptions: ${error.message}`, 'error');
                showAlert('An error occurred while scanning for subscriptions', 'danger');
            }
        }

        // Helper to calculate next payment date based on average interval
        function calculateNextPaymentDate(lastDate, avgDays) {
            const nextDate = new Date(lastDate);
            nextDate.setDate(nextDate.getDate() + Math.round(avgDays));

            // If next date is in the past, add another interval
            const today = new Date();
            if (nextDate < today) {
                nextDate.setDate(nextDate.getDate() + Math.round(avgDays));
            }

            return nextDate;
        }

        // Helper to update text content safely
        function updateElementText(elementId, text) {
            const element = document.getElementById(elementId);
            if (element) {
                // Special case for total-subscriptions-value to prevent double $ signs
                if (elementId === 'total-subscriptions-value' && text.startsWith('$')) {
                    // Strip the $ for the subscription value since the HTML already has a $ prefix
                    element.textContent = text.substring(1);
                } else {
                    element.textContent = text;
                }
                return true;
            }
            return false;
        }

        // Check if automatic subscription scanning is enabled
        function shouldAutoScanSubscriptions() {
            // By default, auto-scanning is disabled to prevent unexpected subscription creation
            const autoScanEnabled = localStorage.getItem('autoScanSubscriptionsEnabled');
            return autoScanEnabled === 'true';
        }

        // Open bank accounts modal
        function openBankAccountsModal() {
            log('Opening bank accounts modal');

            try {
                // Check if Bootstrap is available
                if (typeof bootstrap === 'undefined') {
                    log('Bootstrap not available for modal operation', 'error');
                    showAlert('Application error: Required components not loaded. Please refresh the page.', 'danger');
                    return;
                }

                // Get or create modal element
                let modalElement = document.getElementById('bank-accounts-modal');

                // If modal doesn't exist, create it
                if (!modalElement) {
                    log('Bank accounts modal not found, creating it');
                    modalElement = document.createElement('div');
                    modalElement.id = 'bank-accounts-modal';
                    modalElement.className = 'modal fade';
                    modalElement.setAttribute('tabindex', '-1');
                    modalElement.innerHTML = `
                        <div class="modal-dialog modal-lg">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title">
                                        <i class="fas fa-university text-success me-2"></i>Your Bank Accounts
                                    </h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                </div>
                                <div class="modal-body">
                                    <div id="bank-accounts-container">
                                        <div class="text-center p-5" id="bank-accounts-loading">
                                            <div class="spinner-border text-primary" role="status">
                                                <span class="visually-hidden">Loading...</span>
                                            </div>
                                            <p class="mt-3">Loading bank accounts...</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                    <button type="button" class="btn btn-primary" id="add-new-bank-btn">
                                        <i class="fas fa-plus me-1"></i>Add Bank Account
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                    document.body.appendChild(modalElement);

                    // Add event listener for the add new bank button
                    const addNewBankBtn = document.getElementById('add-new-bank-btn');
                    if (addNewBankBtn) {
                        addNewBankBtn.addEventListener('click', function () {
                            // Close this modal and open the bank connection modal
                            const currentModal = bootstrap.Modal.getInstance(modalElement);
                            if (currentModal) currentModal.hide();
                            setTimeout(() => openBankConnectionModal(), 400);
                        });
                    }
                }

                // Show the modal
                const modal = new bootstrap.Modal(modalElement);
                modal.show();

                // Load bank accounts data after modal is shown
                modalElement.addEventListener('shown.bs.modal', function () {
                    loadBankAccountsContent(modalElement);
                }, { once: true });

                log('Bank accounts modal opened successfully');
            } catch (error) {
                log(`Error opening bank accounts modal: ${error.message}`, 'error');
                showAlert('An error occurred while opening the bank accounts. Please refresh the page.', 'danger');
            }
        }

        // Load bank accounts content
        function loadBankAccountsContent(modalElement) {
            log('Loading bank accounts content');

            try {
                const accountsContainer = modalElement.querySelector('#bank-accounts-container');
                const loadingIndicator = modalElement.querySelector('#bank-accounts-loading');

                if (!accountsContainer) {
                    log('Bank accounts container not found', 'error');
                    return;
                }

                // Get accounts from localStorage
                const accounts = JSON.parse(localStorage.getItem('bankAccounts') || '[]');

                // Check if we have transactions, even without explicit accounts
                const hasTransactions = JSON.parse(localStorage.getItem('bankTransactions') || '[]').length > 0;

                // Hide loading indicator
                if (loadingIndicator) loadingIndicator.style.display = 'none';

                if (accounts.length === 0 && !hasTransactions) {
                    // No accounts or transactions
                    accountsContainer.innerHTML = `
                        <div class="text-center py-4">
                            <i class="fas fa-university fa-3x text-muted mb-3"></i>
                            <p>No bank accounts connected yet. Click "Add Bank Account" to get started.</p>
                        </div>
                    `;
                    return;
                }

                let accountsHTML = `
                    <div class="mb-4">
                        <h6 class="mb-3">Connected Accounts</h6>
                    </div>
                `;

                // Add default mock connection if we have transactions but no accounts
                if (hasTransactions && accounts.length === 0) {
                    accountsHTML += `
                        <div class="card mb-3">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div class="d-flex align-items-center">
                                        <div class="me-3">
                                            <img src="https://cdn.jsdelivr.net/gh/transferwise/currency-flags/master/src/flags/au.png" width="32" alt="Bank Logo" class="rounded">
                                        </div>
                                        <div>
                                            <h6 class="mb-0">Commonwealth Bank</h6>
                                            <span class="text-muted small">Checking Account ending in 1234</span>
                                            <div><span class="badge bg-success">Connected</span></div>
                                        </div>
                                    </div>
                                    <div class="text-end">
                                        <div class="fw-bold">$2,548.32</div>
                                        <div class="small text-muted">Current Balance</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                }

                // Add custom accounts
                accounts.forEach(account => {
                    // Determine flag icon based on bank name (simplified demo approach)
                    let flagCode = 'us'; // Default flag
                    if (account.bankName.toLowerCase().includes('commonwealth')) flagCode = 'au';
                    else if (account.bankName.toLowerCase().includes('royal')) flagCode = 'ca';
                    else if (account.bankName.toLowerCase().includes('barclays')) flagCode = 'gb';

                    // Get account type display name
                    const accountTypeName = getAccountTypeName(account.accountType);

                    // Get last 4 digits
                    const lastFourDigits = account.accountNumber.slice(-4);

                    accountsHTML += `
                        <div class="card mb-3" data-account-id="${account.id}">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div class="d-flex align-items-center">
                                        <div class="me-3">
                                            <img src="https://cdn.jsdelivr.net/gh/transferwise/currency-flags/master/src/flags/${flagCode}.png" width="32" alt="Bank Logo" class="rounded">
                                        </div>
                                        <div>
                                            <h6 class="mb-0">${account.bankName}</h6>
                                            <span class="text-muted small">${accountTypeName} ending in ${lastFourDigits}</span>
                                            <div><span class="badge bg-success">Connected</span></div>
                                        </div>
                                    </div>
                                    <div class="text-end">
                                        <div class="fw-bold">${formatCurrency(account.balance)}</div>
                                        <div class="small text-muted">Current Balance</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                });

                // Add tip for more accounts
                accountsHTML += `
                    <div class="alert alert-light border mt-3">
                        <div class="d-flex">
                            <div class="me-3">
                                <i class="fas fa-lightbulb text-warning"></i>
                            </div>
                            <div>
                                <span class="small">
                                    Connect multiple accounts to get a comprehensive view of your finances.
                                    Click "Add Bank Account" to connect more accounts.
                                </span>
                            </div>
                        </div>
                    </div>
                `;

                // Update container with accounts
                accountsContainer.innerHTML = accountsHTML;

                log('Bank accounts content loaded successfully');
            } catch (error) {
                log(`Error loading bank accounts content: ${error.message}`, 'error');
                if (modalElement) {
                    modalElement.querySelector('#bank-accounts-container').innerHTML = `
                        <div class="alert alert-danger">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            An error occurred while loading bank accounts. Please try again.
                        </div>
                    `;
                }
            }
        }

        // Get account type display name
        function getAccountTypeName(accountType) {
            switch (accountType) {
                case 'checking':
                    return 'Checking Account';
                case 'savings':
                    return 'Savings Account';
                case 'credit':
                    return 'Credit Card';
                case 'investment':
                    return 'Investment Account';
                default:
                    return 'Account';
            }
        }

        // Open goals modal
        function openGoalsModal() {
            log('Opening goals modal');

            try {
                // Check if Bootstrap is available
                if (typeof bootstrap === 'undefined') {
                    log('Bootstrap not available for modal operation', 'error');
                    showAlert('Application error: Required components not loaded. Please refresh the page.', 'danger');
                    return;
                }

                // Get or create modal element
                let modalElement = document.getElementById('goals-modal');

                // If modal doesn't exist, create it
                if (!modalElement) {
                    log('Goals modal not found, creating it');
                    modalElement = document.createElement('div');
                    modalElement.id = 'goals-modal';
                    modalElement.className = 'modal fade';
                    modalElement.setAttribute('tabindex', '-1');
                    modalElement.innerHTML = `
                        <div class="modal-dialog modal-lg">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title">
                                        <i class="fas fa-bullseye text-warning me-2"></i>Financial Goals
                                    </h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                </div>
                                <div class="modal-body">
                                    <div id="goals-container">
                                        <div class="text-center p-5" id="goals-loading">
                                            <div class="spinner-border text-primary" role="status">
                                                <span class="visually-hidden">Loading...</span>
                                            </div>
                                            <p class="mt-3">Loading your financial goals...</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                    <button type="button" class="btn btn-primary" id="add-new-goal-btn">
                                        <i class="fas fa-plus me-1"></i>Add New Goal
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                    document.body.appendChild(modalElement);

                    // Add event listener for the add new goal button
                    const addNewGoalBtn = document.getElementById('add-new-goal-btn');
                    if (addNewGoalBtn) {
                        addNewGoalBtn.addEventListener('click', function () {
                            showAddGoalForm();
                        });
                    }
                }

                // Show the modal
                const modal = new bootstrap.Modal(modalElement);
                modal.show();

                // Load goals data after modal is shown
                modalElement.addEventListener('shown.bs.modal', function () {
                    loadGoalsContent(modalElement);
                }, { once: true });

                log('Goals modal opened successfully');
            } catch (error) {
                log(`Error opening goals modal: ${error.message}`, 'error');
                showAlert('An error occurred while opening the goals. Please refresh the page.', 'danger');
            }
        }

        // Load goals content
        function loadGoalsContent(modalElement) {
            log('Loading goals content');

            try {
                const goalsContainer = modalElement.querySelector('#goals-container');
                const loadingIndicator = modalElement.querySelector('#goals-loading');

                if (!goalsContainer) {
                    log('Goals container not found', 'error');
                    return;
                }

                // Get goals from localStorage
                const goals = JSON.parse(localStorage.getItem('financialGoals') || '[]');

                // Hide loading indicator
                if (loadingIndicator) loadingIndicator.style.display = 'none';

                if (goals.length === 0) {
                    // No goals yet
                    goalsContainer.innerHTML = `
                        <div class="text-center py-4">
                            <i class="fas fa-bullseye fa-3x text-muted mb-3"></i>
                            <p>No financial goals set yet. Click "Add New Goal" to get started on your financial journey!</p>
                        </div>
                    `;
                    return;
                }

                // Calculate total saved across all goals
                const totalSaved = goals.reduce((sum, goal) => sum + parseFloat(goal.currentAmount || 0), 0);
                const totalTarget = goals.reduce((sum, goal) => sum + parseFloat(goal.targetAmount || 0), 0);
                const overallProgress = totalTarget > 0 ? (totalSaved / totalTarget) * 100 : 0;

                let goalsHTML = `
                    <div class="card mb-4">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h5 class="mb-0">Overall Progress</h5>
                                <span class="badge bg-primary">${overallProgress.toFixed(1)}%</span>
                            </div>
                            <div class="progress mb-3" style="height: 15px;">
                                <div class="progress-bar bg-primary" role="progressbar" style="width: ${overallProgress}%" 
                                    aria-valuenow="${overallProgress}" aria-valuemin="0" aria-valuemax="100"></div>
                            </div>
                            <div class="d-flex justify-content-between">
                                <span class="text-muted">Total Saved: ${formatCurrency(totalSaved)}</span>
                                <span class="text-muted">Target: ${formatCurrency(totalTarget)}</span>
                            </div>
                        </div>
                    </div>
                    
                    <h5 class="mb-3">Your Active Goals (${goals.length})</h5>
                `;

                // Sort goals by priority or progress
                goals.sort((a, b) => {
                    // Sort by completion percentage (ascending)
                    const aProgress = a.targetAmount > 0 ? (a.currentAmount / a.targetAmount) * 100 : 0;
                    const bProgress = b.targetAmount > 0 ? (b.currentAmount / b.targetAmount) * 100 : 0;
                    return aProgress - bProgress;
                });

                // Add goal cards
                goals.forEach((goal, index) => {
                    const progress = goal.targetAmount > 0 ? (goal.currentAmount / goal.targetAmount) * 100 : 0;
                    const dueDate = new Date(goal.dueDate).toLocaleDateString();

                    // Determine progress bar color
                    let progressBarColor = 'bg-success';
                    if (progress < 25) progressBarColor = 'bg-danger';
                    else if (progress < 50) progressBarColor = 'bg-warning';
                    else if (progress < 75) progressBarColor = 'bg-info';

                    goalsHTML += `
                        <div class="card mb-3">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-start mb-3">
                                    <div>
                                        <h5 class="mb-1">${goal.name}</h5>
                                        <span class="text-muted small">${goal.description || 'No description'}</span>
                                    </div>
                                    <div class="text-end">
                                        <span class="badge ${progress >= 100 ? 'bg-success' : 'bg-primary'}">${progress.toFixed(1)}%</span>
                                        <div class="mt-1">
                                            <button class="btn btn-sm btn-outline-primary edit-goal-btn" data-index="${index}">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            <button class="btn btn-sm btn-outline-danger delete-goal-btn" data-index="${index}">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="progress mb-3" style="height: 10px;">
                                    <div class="progress-bar ${progressBarColor}" role="progressbar" style="width: ${progress}%" 
                                        aria-valuenow="${progress}" aria-valuemin="0" aria-valuemax="100"></div>
                                </div>
                                
                                <div class="d-flex justify-content-between mb-2">
                                    <span class="text-muted">Current: ${formatCurrency(goal.currentAmount)}</span>
                                    <span class="text-muted">Target: ${formatCurrency(goal.targetAmount)}</span>
                                </div>
                                
                                <div class="d-flex justify-content-between">
                                    <button class="btn btn-sm btn-success update-goal-btn" data-index="${index}">
                                        <i class="fas fa-plus me-1"></i>Update Progress
                                    </button>
                                    <span class="text-muted small">Due: ${dueDate}</span>
                                </div>
                            </div>
                        </div>
                    `;
                });

                // Add information about goals
                goalsHTML += `
                    <div class="alert alert-light border mt-3">
                        <div class="d-flex">
                            <div class="me-3">
                                <i class="fas fa-lightbulb text-warning"></i>
                            </div>
                            <div>
                                <span class="small">
                                    Setting SMART financial goals (Specific, Measurable, Achievable, Relevant, Time-bound) 
                                    can increase your chances of success by up to 76% according to research.
                                </span>
                            </div>
                        </div>
                    </div>
                `;

                // Update container with goals
                goalsContainer.innerHTML = goalsHTML;

                // Add event listeners for goal actions
                goalsContainer.querySelectorAll('.edit-goal-btn').forEach(btn => {
                    btn.addEventListener('click', function () {
                        const index = this.dataset.index;
                        editGoal(index);
                    });
                });

                goalsContainer.querySelectorAll('.delete-goal-btn').forEach(btn => {
                    btn.addEventListener('click', function () {
                        const index = this.dataset.index;
                        deleteGoal(index);
                    });
                });

                goalsContainer.querySelectorAll('.update-goal-btn').forEach(btn => {
                    btn.addEventListener('click', function () {
                        const index = this.dataset.index;
                        updateGoalProgress(index);
                    });
                });

                log('Goals content loaded successfully');
            } catch (error) {
                log(`Error loading goals content: ${error.message}`, 'error');
                if (modalElement) {
                    modalElement.querySelector('#goals-container').innerHTML = `
                        <div class="alert alert-danger">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            An error occurred while loading your goals. Please try again.
                        </div>
                    `;
                }
            }
        }

        // Show add goal form
        function showAddGoalForm() {
            log('Showing add goal form');

            try {
                const goalsModal = document.getElementById('goals-modal');
                if (!goalsModal) {
                    log('Goals modal not found', 'error');
                    return;
                }

                const goalsContainer = goalsModal.querySelector('#goals-container');

                // Create form HTML
                goalsContainer.innerHTML = `
                    <h5 class="mb-4">Add New Financial Goal</h5>
                    
                    <form id="add-goal-form">
                        <div class="mb-3">
                            <label for="goal-name" class="form-label">Goal Name</label>
                            <input type="text" class="form-control" id="goal-name" required>
                        </div>
                        
                        <div class="mb-3">
                            <label for="goal-description" class="form-label">Description (Optional)</label>
                            <textarea class="form-control" id="goal-description" rows="2"></textarea>
                        </div>
                        
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="goal-current-amount" class="form-label">Current Amount ($)</label>
                                <input type="number" class="form-control" id="goal-current-amount" min="0" step="0.01" value="0" required>
                            </div>
                            <div class="col-md-6">
                                <label for="goal-target-amount" class="form-label">Target Amount ($)</label>
                                <input type="number" class="form-control" id="goal-target-amount" min="0" step="0.01" required>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="goal-due-date" class="form-label">Due Date</label>
                            <input type="date" class="form-control" id="goal-due-date" required>
                        </div>
                        
                        <div class="mb-3">
                            <label for="goal-category" class="form-label">Category</label>
                            <select class="form-select" id="goal-category" required>
                                <option value="">Select category</option>
                                <option value="Emergency Fund">Emergency Fund</option>
                                <option value="Savings">Savings</option>
                                <option value="Debt Payoff">Debt Payoff</option>
                                <option value="Retirement">Retirement</option>
                                <option value="Home">Home</option>
                                <option value="Car">Car</option>
                                <option value="Education">Education</option>
                                <option value="Travel">Travel</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                        
                        <div class="d-flex justify-content-end mt-4">
                            <button type="button" class="btn btn-secondary me-2" id="cancel-goal-btn">Cancel</button>
                            <button type="submit" class="btn btn-primary">Save Goal</button>
                        </div>
                    </form>
                `;

                // Set minimum date for due date to today
                const today = new Date().toISOString().split('T')[0];
                const dueDateInput = document.getElementById('goal-due-date');
                if (dueDateInput) {
                    dueDateInput.min = today;
                }

                // Add event listener for form submission
                const addGoalForm = document.getElementById('add-goal-form');
                if (addGoalForm) {
                    addGoalForm.addEventListener('submit', function (e) {
                        e.preventDefault();
                        saveGoal();
                    });
                }

                // Add event listener for cancel button
                const cancelGoalBtn = document.getElementById('cancel-goal-btn');
                if (cancelGoalBtn) {
                    cancelGoalBtn.addEventListener('click', function () {
                        // Reload goals content
                        loadGoalsContent(goalsModal);
                    });
                }

                log('Add goal form displayed successfully');
            } catch (error) {
                log(`Error showing add goal form: ${error.message}`, 'error');
                showAlert('An error occurred while showing the add goal form. Please try again.', 'danger');
            }
        }

        // Save goal
        function saveGoal(editIndex = null) {
            log('Saving goal');

            try {
                // Get form values
                const name = document.getElementById('goal-name').value;
                const description = document.getElementById('goal-description').value;
                const currentAmount = parseFloat(document.getElementById('goal-current-amount').value) || 0;
                const targetAmount = parseFloat(document.getElementById('goal-target-amount').value) || 0;
                const dueDate = document.getElementById('goal-due-date').value;
                const category = document.getElementById('goal-category').value;

                // Validate inputs
                if (!name || !targetAmount || !dueDate || !category) {
                    log('Invalid goal form inputs', 'warn');
                    showAlert('Please fill all required fields.', 'warning');
                    return;
                }

                // Create goal object
                const goal = {
                    id: editIndex !== null ? getGoals()[editIndex].id : Date.now(),
                    name,
                    description,
                    currentAmount,
                    targetAmount,
                    dueDate,
                    category,
                    createdAt: editIndex !== null ? getGoals()[editIndex].createdAt : new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                };

                // Get existing goals
                const goals = getGoals();

                // Update or add goal
                if (editIndex !== null) {
                    goals[editIndex] = goal;
                } else {
                    goals.push(goal);
                }

                // Save to localStorage
                localStorage.setItem('financialGoals', JSON.stringify(goals));

                // Show success message
                showAlert(`Goal "${name}" ${editIndex !== null ? 'updated' : 'added'} successfully!`, 'success');

                // Reload goals content
                const goalsModal = document.getElementById('goals-modal');
                if (goalsModal) {
                    loadGoalsContent(goalsModal);
                }

                // Update dashboard if needed
                updateGoalsDisplay();

                log('Goal saved successfully');
            } catch (error) {
                log(`Error saving goal: ${error.message}`, 'error');
                showAlert('An error occurred while saving the goal. Please try again.', 'danger');
            }
        }

        // Edit goal
        function editGoal(index) {
            log('Editing goal');

            try {
                const goals = getGoals();
                const goal = goals[index];

                if (!goal) {
                    log('Goal not found for editing', 'warn');
                    return;
                }

                showAddGoalForm();

                // Populate form with goal data
                document.getElementById('goal-name').value = goal.name || '';
                document.getElementById('goal-description').value = goal.description || '';
                document.getElementById('goal-current-amount').value = goal.currentAmount || 0;
                document.getElementById('goal-target-amount').value = goal.targetAmount || 0;
                document.getElementById('goal-due-date').value = goal.dueDate || '';
                document.getElementById('goal-category').value = goal.category || '';

                // Update form title and submit button
                const formTitle = document.querySelector('#goals-modal h5');
                if (formTitle) formTitle.textContent = 'Edit Financial Goal';

                const submitButton = document.querySelector('#add-goal-form button[type="submit"]');
                if (submitButton) submitButton.textContent = 'Update Goal';

                // Update form submission to save as edit
                const addGoalForm = document.getElementById('add-goal-form');
                if (addGoalForm) {
                    // Remove existing listeners
                    const newForm = addGoalForm.cloneNode(true);
                    addGoalForm.parentNode.replaceChild(newForm, addGoalForm);

                    // Add new listener for editing
                    newForm.addEventListener('submit', function (e) {
                        e.preventDefault();
                        saveGoal(index);
                    });
                }

                // Update cancel button
                const cancelGoalBtn = document.getElementById('cancel-goal-btn');
                if (cancelGoalBtn) {
                    cancelGoalBtn.addEventListener('click', function () {
                        loadGoalsContent(document.getElementById('goals-modal'));
                    });
                }

                log('Goal edit form populated successfully');
            } catch (error) {
                log(`Error editing goal: ${error.message}`, 'error');
                showAlert('An error occurred while editing the goal. Please try again.', 'danger');
            }
        }

        // Delete goal
        function deleteGoal(index) {
            log('Deleting goal');

            try {
                const goals = getGoals();
                const goal = goals[index];

                if (!goal) {
                    log('Goal not found for deletion', 'warn');
                    return;
                }

                // Confirm deletion
                if (!confirm(`Are you sure you want to delete the goal "${goal.name}"?`)) {
                    return;
                }

                // Remove goal from array
                goals.splice(index, 1);

                // Save to localStorage
                localStorage.setItem('financialGoals', JSON.stringify(goals));

                // Show success message
                showAlert(`Goal "${goal.name}" deleted successfully!`, 'success');

                // Reload goals content
                const goalsModal = document.getElementById('goals-modal');
                if (goalsModal) {
                    loadGoalsContent(goalsModal);
                }

                // Update dashboard if needed
                updateGoalsDisplay();

                log('Goal deleted successfully');
            } catch (error) {
                log(`Error deleting goal: ${error.message}`, 'error');
                showAlert('An error occurred while deleting the goal. Please try again.', 'danger');
            }
        }

        // Update goal progress
        function updateGoalProgress(index) {
            log('Updating goal progress');

            try {
                const goals = getGoals();
                const goal = goals[index];

                if (!goal) {
                    log('Goal not found for progress update', 'warn');
                    return;
                }

                // Ask for new contribution amount
                const amount = prompt(`Enter additional amount to add to "${goal.name}" (current: ${formatCurrency(goal.currentAmount)}):`, "0");

                if (amount === null) {
                    return; // User cancelled
                }

                const additionalAmount = parseFloat(amount);

                if (isNaN(additionalAmount) || additionalAmount < 0) {
                    showAlert('Please enter a valid positive number.', 'warning');
                    return;
                }

                // Update goal
                goal.currentAmount = (parseFloat(goal.currentAmount) || 0) + additionalAmount;
                goal.updatedAt = new Date().toISOString();

                // Cap at target amount
                if (goal.currentAmount > goal.targetAmount) {
                    if (confirm(`You've exceeded your target! Would you like to cap at the target amount (${formatCurrency(goal.targetAmount)})?`)) {
                        goal.currentAmount = goal.targetAmount;
                    }
                }

                // Save to localStorage
                localStorage.setItem('financialGoals', JSON.stringify(goals));

                // Show success message
                showAlert(`Added ${formatCurrency(additionalAmount)} to "${goal.name}" successfully!`, 'success');

                // Reload goals content
                const goalsModal = document.getElementById('goals-modal');
                if (goalsModal) {
                    loadGoalsContent(goalsModal);
                }

                // Update dashboard if needed
                updateGoalsDisplay();

                log('Goal progress updated successfully');
            } catch (error) {
                log(`Error updating goal progress: ${error.message}`, 'error');
                showAlert('An error occurred while updating the goal progress. Please try again.', 'danger');
            }
        }

        // Get goals helper
        function getGoals() {
            return JSON.parse(localStorage.getItem('financialGoals') || '[]');
        }

        // Update goals display on dashboard
        function updateGoalsDisplay() {
            log('Updating goals display on dashboard');

            try {
                const goals = getGoals();

                // Get dashboard goals card content
                const goalsCard = document.querySelector('[data-tile-type="goals"] .scrollable-content');
                if (!goalsCard) {
                    log('Goals card not found for updating', 'warn');
                    return;
                }

                if (goals.length === 0) {
                    goalsCard.innerHTML = `
                        <h3>No Active Goals</h3>
                        <div class="text-center py-4">
                            <i class="fas fa-bullseye fa-3x text-muted mb-3"></i>
                            <p>You haven't set any financial goals yet.</p>
                            <button class="btn btn-sm btn-primary mt-2" id="add-first-goal-btn">
                                <i class="fas fa-plus me-1"></i>Add Your First Goal
                            </button>
                        </div>
                    `;

                    // Add event listener for add first goal button
                    const addFirstGoalBtn = document.getElementById('add-first-goal-btn');
                    if (addFirstGoalBtn) {
                        addFirstGoalBtn.addEventListener('click', function () {
                            openGoalsModal();
                        });
                    }

                    return;
                }

                // Sort goals by progress (ascending)
                goals.sort((a, b) => {
                    const aProgress = a.targetAmount > 0 ? (a.currentAmount / a.targetAmount) * 100 : 0;
                    const bProgress = b.targetAmount > 0 ? (b.currentAmount / b.targetAmount) * 100 : 0;
                    return aProgress - bProgress;
                });

                // Take the top 3 goals for display
                const topGoals = goals.slice(0, 3);

                // Calculate overall progress
                const totalSaved = goals.reduce((sum, goal) => sum + parseFloat(goal.currentAmount || 0), 0);
                const totalTarget = goals.reduce((sum, goal) => sum + parseFloat(goal.targetAmount || 0), 0);
                const overallProgress = totalTarget > 0 ? (totalSaved / totalTarget) * 100 : 0;

                // Generate HTML
                let goalsHTML = `
                    <h3>${goals.length} Active Goal${goals.length !== 1 ? 's' : ''}</h3>
                    <div class="stat-change positive-change mb-4">
                        <i class="fas fa-check-circle"></i> ${overallProgress.toFixed(1)}% Overall Progress
                    </div>
                `;

                // Add goal items
                topGoals.forEach(goal => {
                    const progress = goal.targetAmount > 0 ? (goal.currentAmount / goal.targetAmount) * 100 : 0;
                    const dueDate = new Date(goal.dueDate).toLocaleDateString();

                    goalsHTML += `
                        <div class="goal-item">
                            <div class="goal-details">
                                <span>${goal.name}</span>
                                <span class="text-success">${formatCurrency(goal.currentAmount)}</span>
                            </div>
                            <div class="progress">
                                <div class="progress-bar bg-success" role="progressbar" style="width: ${progress}%" 
                                    aria-valuenow="${progress}" aria-valuemin="0" aria-valuemax="100"></div>
                            </div>
                            <div class="d-flex justify-content-between">
                                <small>${formatCurrency(goal.currentAmount)} of ${formatCurrency(goal.targetAmount)}</small>
                                <small>Due: ${dueDate}</small>
                            </div>
                        </div>
                    `;
                });

                // Add "View All" if there are more than 3 goals
                if (goals.length > 3) {
                    goalsHTML += `
                        <div class="text-center mt-3">
                            <button class="btn btn-sm btn-outline-primary" id="view-all-goals-btn">
                                View All ${goals.length} Goals
                            </button>
                        </div>
                    `;
                }

                // Update the card
                goalsCard.innerHTML = goalsHTML;

                // Add event listener for view all button
                const viewAllGoalsBtn = document.getElementById('view-all-goals-btn');
                if (viewAllGoalsBtn) {
                    viewAllGoalsBtn.addEventListener('click', function () {
                        openGoalsModal();
                    });
                }

                log('Goals display updated successfully');
            } catch (error) {
                log(`Error updating goals display: ${error.message}`, 'error');
            }
        }

        // Generate mock transactions
        function generateMockTransactions(days = 30) {
            log(`Generating mock transactions for the past ${days} days`);

            const today = new Date();
            const transactions = [];

            // Add income transactions
            transactions.push({
                id: 'tx-' + Math.random().toString(36).substring(2, 9),
                date: new Date(today.getFullYear(), today.getMonth(), today.getDate() - 1).toISOString(),
                description: 'Monthly Salary',
                amount: '5850.00',
                category: 'Income',
                merchant: 'Employer Inc',
                accountName: 'Checking Account'
            });

            transactions.push({
                id: 'tx-' + Math.random().toString(36).substring(2, 9),
                date: new Date(today.getFullYear(), today.getMonth(), today.getDate() - 5).toISOString(),
                description: 'Dividend Payment',
                amount: '1275.50',
                category: 'Investment',
                merchant: 'Vanguard',
                accountName: 'Investment Account'
            });

            transactions.push({
                id: 'tx-' + Math.random().toString(36).substring(2, 9),
                date: new Date(today.getFullYear(), today.getMonth(), today.getDate() - 7).toISOString(),
                description: 'Rental Income',
                amount: '2450.00',
                category: 'Real Estate',
                merchant: 'Property Management',
                accountName: 'Checking Account'
            });

            // Add expense transactions
            const categories = [
                'Groceries', 'Dining', 'Entertainment', 'Utilities',
                'Shopping', 'Transportation', 'Housing', 'Healthcare'
            ];

            const merchants = {
                'Groceries': ['Whole Foods', 'Kroger', 'Safeway', 'Trader Joe\'s'],
                'Dining': ['Chipotle', 'Starbucks', 'The Cheesecake Factory', 'Local Coffee'],
                'Entertainment': ['Netflix', 'Spotify', 'AMC Theaters', 'Apple Music'],
                'Utilities': ['Electric Company', 'Water Services', 'Internet Provider', 'Phone Company'],
                'Shopping': ['Amazon', 'Target', 'Walmart', 'Best Buy'],
                'Transportation': ['Uber', 'Shell Gas', 'Chevron', 'Public Transit'],
                'Housing': ['Apartment Rental', 'Home Depot', 'IKEA', 'Property Management'],
                'Healthcare': ['Pharmacy', 'Doctor Visit', 'Dental Clinic', 'Health Insurance']
            };

            // Create expenses for the past specified days
            for (let i = 0; i < days; i++) {
                const date = new Date(today.getFullYear(), today.getMonth(), today.getDate() - i);

                // Create 1-2 transactions per day
                const txCount = Math.floor(Math.random() * 2) + 1;

                for (let j = 0; j < txCount; j++) {
                    const category = categories[Math.floor(Math.random() * categories.length)];
                    const merchantList = merchants[category];
                    const merchant = merchantList[Math.floor(Math.random() * merchantList.length)];

                    // Random amount between $5 and $100
                    const amount = -1 * (Math.floor(Math.random() * 9500) / 100 + 5).toFixed(2);

                    transactions.push({
                        id: 'tx-' + Math.random().toString(36).substring(2, 9),
                        date: date.toISOString(),
                        description: category + ' - ' + merchant,
                        amount: amount.toString(),
                        category: category,
                        merchant: merchant,
                        accountName: Math.random() > 0.3 ? 'Checking Account' : 'Credit Card'
                    });
                }
            }

            // Add subscription transactions for mock data
            const subscriptions = [
                { name: 'Netflix', amount: 15.99, category: 'Entertainment', merchant: 'Netflix' },
                { name: 'Spotify', amount: 9.99, category: 'Entertainment', merchant: 'Spotify' },
                { name: 'Gym Membership', amount: 49.99, category: 'Health & Fitness', merchant: 'Fitness Center' },
                { name: 'Cloud Storage', amount: 9.99, category: 'Software', merchant: 'Dropbox' }
            ];

            // Add 3 months of subscription history
            for (let i = 0; i < 3; i++) {
                const month = today.getMonth() - i;
                const year = today.getFullYear() + Math.floor(month / 12);
                const adjustedMonth = ((month % 12) + 12) % 12; // Handle negative months

                subscriptions.forEach(sub => {
                    // Add each subscription once per month (around the same date)
                    const day = 5 + Math.floor(Math.random() * 5); // Between 5th and 10th of month
                    const date = new Date(year, adjustedMonth, day);

                    // Only add if within our time range
                    if ((today - date) / (1000 * 60 * 60 * 24) <= days) {
                        transactions.push({
                            id: 'tx-' + Math.random().toString(36).substring(2, 9),
                            date: date.toISOString(),
                            description: sub.name + ' Subscription',
                            amount: (-sub.amount).toString(),
                            category: sub.category,
                            merchant: sub.merchant,
                            accountName: 'Credit Card'
                        });
                    }
                });
            }

            return transactions;
        }

        // Function to handle Tax Profile sidebar link click
        function setupTaxProfileHandler() {
            log('Setting up Tax Profile handler');
            const taxProfileLink = document.getElementById('tax-profile-nav-link');

            if (taxProfileLink && !taxProfileLink._hasClickHandler) {
                taxProfileLink.addEventListener('click', function (e) {
                    e.preventDefault();
                    log('Tax Profile nav link clicked');

                    const taxProfileModal = new bootstrap.Modal(document.getElementById('tax-profile-modal'));
                    taxProfileModal.show();

                    // If no tax profile data exists yet, initialize with empty data
                    if (!localStorage.getItem('taxProfileData')) {
                        initializeEmptyTaxProfile();
                    } else {
                        // Load existing tax profile data
                        loadTaxProfileData();
                    }
                });

                taxProfileLink._hasClickHandler = true;
                log('Added click handler to Tax Profile nav link');
            } else {
                log('Tax Profile nav link not found or already has handler', 'warn');
            }
        }

        // Initialize empty tax profile data
        function initializeEmptyTaxProfile() {
            log('Initializing empty tax profile data');
            const emptyProfile = {
                personalInfo: {},
                income: {},
                deductions: {},
                taxOffsets: {},
                medicare: {},
                hecs: {},
                additionalInfo: {},
                lastUpdated: new Date().toISOString()
            };

            localStorage.setItem('taxProfileData', JSON.stringify(emptyProfile));
        }

        // Load existing tax profile data into the form
        function loadTaxProfileData() {
            log('Loading existing tax profile data');
            try {
                const taxProfileData = JSON.parse(localStorage.getItem('taxProfileData'));
                if (!taxProfileData) return;

                // Populate form fields from the saved data
                // Personal Information
                if (taxProfileData.personalInfo) {
                    const personalInfo = taxProfileData.personalInfo;

                    // Basic Identification
                    if (personalInfo.title) document.getElementById('title').value = personalInfo.title;
                    if (personalInfo.familyName) document.getElementById('family-name').value = personalInfo.familyName;
                    if (personalInfo.firstName) document.getElementById('first-given-name').value = personalInfo.firstName;
                    if (personalInfo.otherNames) document.getElementById('other-given-names').value = personalInfo.otherNames;
                    if (personalInfo.previousNames) document.getElementById('previous-names').value = personalInfo.previousNames;
                    if (personalInfo.dateOfBirth) document.getElementById('date-of-birth').value = personalInfo.dateOfBirth;
                    if (personalInfo.tfn) document.getElementById('tfn').value = personalInfo.tfn;
                    if (personalInfo.abn) document.getElementById('abn').value = personalInfo.abn;

                    // Contact Details
                    if (personalInfo.residentialAddress) document.getElementById('residential-address').value = personalInfo.residentialAddress;
                    if (personalInfo.postalAddress) document.getElementById('postal-address').value = personalInfo.postalAddress;
                    if (personalInfo.email) document.getElementById('email').value = personalInfo.email;
                    if (personalInfo.mobile) document.getElementById('mobile').value = personalInfo.mobile;
                    if (personalInfo.alternativePhone) document.getElementById('alternative-phone').value = personalInfo.alternativePhone;

                    // Filing Status
                    if (personalInfo.residencyStatus) {
                        if (personalInfo.residencyStatus === 'yes') {
                            document.getElementById('resident-yes').checked = true;
                        } else {
                            document.getElementById('resident-no').checked = true;
                        }
                    }

                    if (personalInfo.taxFreeThreshold) {
                        if (personalInfo.taxFreeThreshold === 'yes') {
                            document.getElementById('threshold-yes').checked = true;
                        } else {
                            document.getElementById('threshold-no').checked = true;
                        }
                    }

                    // Spouse details
                    if (personalInfo.hasSpouse) {
                        document.getElementById('has-spouse').checked = true;
                        toggleSpouseDetails();

                        if (personalInfo.spouseName) document.getElementById('spouse-name').value = personalInfo.spouseName;
                        if (personalInfo.spouseTfn) document.getElementById('spouse-tfn').value = personalInfo.spouseTfn;
                        if (personalInfo.spouseIncome) document.getElementById('spouse-income').value = personalInfo.spouseIncome;

                        if (personalInfo.spousePeriod) {
                            if (personalInfo.spousePeriod === 'full') {
                                document.getElementById('spouse-full').checked = true;
                            } else {
                                document.getElementById('spouse-partial').checked = true;
                            }
                        }
                    }

                    // Dependent details
                    if (personalInfo.hasDependents) {
                        document.getElementById('has-dependents').checked = true;
                        toggleDependentDetails();

                        if (personalInfo.dependents && personalInfo.dependents.length > 0) {
                            personalInfo.dependents.forEach(dependent => addDependentToForm(dependent));
                        }
                    }

                    // Bank account
                    if (personalInfo.bankBsb) document.getElementById('bank-bsb').value = personalInfo.bankBsb;
                    if (personalInfo.bankAccount) document.getElementById('bank-account').value = personalInfo.bankAccount;
                    if (personalInfo.bankName) document.getElementById('bank-name').value = personalInfo.bankName;
                }

                // Income information
                if (taxProfileData.income) {
                    const income = taxProfileData.income;

                    // Employment Income
                    if (income.employers && income.employers.length > 0) {
                        income.employers.forEach(employer => addEmployerToForm(employer));
                    }

                    // Investment Income
                    if (income.interestIncome) document.getElementById('interest-income').value = income.interestIncome;
                    if (income.dividendIncome) document.getElementById('dividend-income').value = income.dividendIncome;
                    if (income.trustIncome) document.getElementById('trust-income').value = income.trustIncome;
                    if (income.rentalIncome) document.getElementById('rental-income').value = income.rentalIncome;
                    if (income.capitalGains) document.getElementById('capital-gains').value = income.capitalGains;

                    // Government Payments
                    if (income.govtPaymentType) document.getElementById('govt-payment-type').value = income.govtPaymentType;
                    if (income.govtPaymentAmount) document.getElementById('govt-payment-amount').value = income.govtPaymentAmount;
                    if (income.govtPaymentTax) document.getElementById('govt-payment-tax').value = income.govtPaymentTax;

                    // Other Income
                    if (income.foreignIncome) document.getElementById('foreign-income').value = income.foreignIncome;
                    if (income.businessIncome) document.getElementById('business-income').value = income.businessIncome;
                    if (income.superIncome) document.getElementById('super-income').value = income.superIncome;
                    if (income.partnershipIncome) document.getElementById('partnership-income').value = income.partnershipIncome;
                }

                // Deductions
                if (taxProfileData.deductions) {
                    const deductions = taxProfileData.deductions;

                    // Car Expenses
                    if (deductions.useCarForWork) {
                        document.getElementById('use-car-for-work').checked = true;
                        toggleCarExpenseDetails();

                        if (deductions.carMake) document.getElementById('car-make').value = deductions.carMake;
                        if (deductions.carRegistration) document.getElementById('car-registration').value = deductions.carRegistration;
                        if (deductions.carMethod) document.getElementById('car-method').value = deductions.carMethod;
                        if (deductions.businessKm) document.getElementById('business-km').value = deductions.businessKm;
                        if (deductions.carExpenses) document.getElementById('car-expenses').value = deductions.carExpenses;
                    }

                    // Other deduction sections would be populated here
                }

                // Other sections (tax offsets, medicare, hecs, additional info) would be populated here

            } catch (error) {
                log('Error loading tax profile data: ' + error.message, 'error');
                showAlert('Failed to load your tax profile data. Please try again.', 'danger');
            }
        }

        // Save the tax profile data
        function saveTaxProfileData() {
            log('Saving tax profile data');
            try {
                // First validate the form
                if (!validateTaxProfileForm()) {
                    return false;
                }

                // Collect data from the form
                const taxProfileData = {
                    personalInfo: {
                        // Basic Identification
                        title: document.getElementById('title').value,
                        familyName: document.getElementById('family-name').value,
                        firstName: document.getElementById('first-given-name').value,
                        otherNames: document.getElementById('other-given-names').value,
                        previousNames: document.getElementById('previous-names').value,
                        dateOfBirth: document.getElementById('date-of-birth').value,
                        tfn: document.getElementById('tfn').value,
                        abn: document.getElementById('abn').value,

                        // Contact Details
                        residentialAddress: document.getElementById('residential-address').value,
                        postalAddress: document.getElementById('postal-address').value,
                        email: document.getElementById('email').value,
                        mobile: document.getElementById('mobile').value,
                        alternativePhone: document.getElementById('alternative-phone').value,

                        // Filing Status
                        residencyStatus: document.querySelector('input[name="residency-status"]:checked')?.value,
                        taxFreeThreshold: document.querySelector('input[name="tax-free-threshold"]:checked')?.value,

                        // Spouse details
                        hasSpouse: document.getElementById('has-spouse').checked,
                        spouseName: document.getElementById('has-spouse').checked ? document.getElementById('spouse-name').value : '',
                        spouseTfn: document.getElementById('has-spouse').checked ? document.getElementById('spouse-tfn').value : '',
                        spouseIncome: document.getElementById('has-spouse').checked ? document.getElementById('spouse-income').value : '',
                        spousePeriod: document.getElementById('has-spouse').checked ? document.querySelector('input[name="spouse-period"]:checked')?.value : '',

                        // Dependent details
                        hasDependents: document.getElementById('has-dependents').checked,
                        dependents: document.getElementById('has-dependents').checked ? collectDependentsData() : [],

                        // Bank account
                        bankBsb: document.getElementById('bank-bsb').value,
                        bankAccount: document.getElementById('bank-account').value,
                        bankName: document.getElementById('bank-name').value
                    },
                    income: {
                        // Employment Income
                        employers: collectEmployersData(),

                        // Investment Income
                        interestIncome: document.getElementById('interest-income').value,
                        dividendIncome: document.getElementById('dividend-income').value,
                        trustIncome: document.getElementById('trust-income').value,
                        rentalIncome: document.getElementById('rental-income').value,
                        capitalGains: document.getElementById('capital-gains').value,

                        // Government Payments
                        govtPaymentType: document.getElementById('govt-payment-type').value,
                        govtPaymentAmount: document.getElementById('govt-payment-amount').value,
                        govtPaymentTax: document.getElementById('govt-payment-tax').value,

                        // Other Income
                        foreignIncome: document.getElementById('foreign-income').value,
                        businessIncome: document.getElementById('business-income').value,
                        superIncome: document.getElementById('super-income').value,
                        partnershipIncome: document.getElementById('partnership-income').value
                    },
                    deductions: {
                        // Car Expenses
                        useCarForWork: document.getElementById('use-car-for-work').checked,
                        carMake: document.getElementById('use-car-for-work').checked ? document.getElementById('car-make').value : '',
                        carRegistration: document.getElementById('use-car-for-work').checked ? document.getElementById('car-registration').value : '',
                        carMethod: document.getElementById('use-car-for-work').checked ? document.getElementById('car-method').value : '',
                        businessKm: document.getElementById('use-car-for-work').checked ? document.getElementById('business-km').value : '',
                        carExpenses: document.getElementById('use-car-for-work').checked ? document.getElementById('car-expenses').value : ''

                        // Other deduction sections would be collected here
                    },
                    taxOffsets: {
                        // Tax offset data would be collected here
                    },
                    medicare: {
                        // Medicare data would be collected here
                    },
                    hecs: {
                        // HECS/HELP data would be collected here
                    },
                    additionalInfo: {
                        // Additional information would be collected here
                    },
                    lastUpdated: new Date().toISOString()
                };

                // Save to local storage
                localStorage.setItem('taxProfileData', JSON.stringify(taxProfileData));

                // Show success message
                showAlert('Your tax profile has been saved successfully.', 'success');

                // Close the modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('tax-profile-modal'));
                if (modal) modal.hide();

                return true;

            } catch (error) {
                log('Error saving tax profile data: ' + error.message, 'error');
                showAlert('Failed to save your tax profile. Please try again.', 'danger');
                return false;
            }
        }

        // Validate the tax profile form
        function validateTaxProfileForm() {
            log('Validating tax profile form');

            // Get the form
            const form = document.getElementById('tax-profile-form');

            // Add bootstrap validation classes
            form.classList.add('was-validated');

            // Check if the form is valid
            if (!form.checkValidity()) {
                // Focus on first invalid field
                const firstInvalidField = form.querySelector(':invalid');
                if (firstInvalidField) {
                    // Activate the tab containing the invalid field
                    const tabPane = firstInvalidField.closest('.tab-pane');
                    if (tabPane) {
                        const tabId = tabPane.id.replace('-content', '-tab');
                        const tab = document.getElementById(tabId);
                        if (tab) {
                            tab.click();
                        }
                    }

                    firstInvalidField.focus();
                }

                showAlert('Please fill in all required fields correctly.', 'warning');
                return false;
            }

            return true;
        }

        // Collect data from dynamic employer fields
        function collectEmployersData() {
            const employersData = [];
            const employerElements = document.querySelectorAll('.employer-item');

            employerElements.forEach(element => {
                const employer = {
                    name: element.querySelector('.employer-name')?.value || '',
                    abn: element.querySelector('.employer-abn')?.value || '',
                    occupation: element.querySelector('.employer-occupation')?.value || '',
                    employmentType: element.querySelector('.employer-type')?.value || '',
                    salary: element.querySelector('.employer-salary')?.value || '',
                    taxWithheld: element.querySelector('.employer-tax')?.value || ''
                };

                employersData.push(employer);
            });

            return employersData;
        }

        // Add employer to form
        function addEmployerToForm(employer = null) {
            const employersContainer = document.getElementById('employers-container');
            const employerCount = employersContainer.querySelectorAll('.employer-item').length + 1;

            const employerDiv = document.createElement('div');
            employerDiv.className = 'employer-item card mb-3';
            employerDiv.innerHTML = `
                <div class="card-header bg-light d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Employer ${employerCount}</h5>
                    <button type="button" class="btn btn-sm btn-outline-danger remove-employer">
                        <i class="fas fa-times"></i> Remove
                    </button>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">Employer Name</label>
                            <input type="text" class="form-control employer-name" value="${employer?.name || ''}" required>
                            <div class="invalid-feedback">Please enter employer name.</div>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">ABN</label>
                            <input type="text" class="form-control employer-abn" value="${employer?.abn || ''}">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Occupation</label>
                            <input type="text" class="form-control employer-occupation" value="${employer?.occupation || ''}" required>
                            <div class="invalid-feedback">Please enter your occupation.</div>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Employment Type</label>
                            <select class="form-select employer-type" required>
                                <option value="" ${!employer?.employmentType ? 'selected' : ''}>Choose...</option>
                                <option value="full-time" ${employer?.employmentType === 'full-time' ? 'selected' : ''}>Full-time</option>
                                <option value="part-time" ${employer?.employmentType === 'part-time' ? 'selected' : ''}>Part-time</option>
                                <option value="casual" ${employer?.employmentType === 'casual' ? 'selected' : ''}>Casual</option>
                            </select>
                            <div class="invalid-feedback">Please select employment type.</div>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">Salary/Wages</label>
                            <input type="number" class="form-control employer-salary" min="0" step="0.01" value="${employer?.salary || ''}" required>
                            <div class="invalid-feedback">Please enter your salary.</div>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">Tax Withheld</label>
                            <input type="number" class="form-control employer-tax" min="0" step="0.01" value="${employer?.taxWithheld || ''}">
                        </div>
                    </div>
                </div>
            `;

            // Add remove handler
            const removeButton = employerDiv.querySelector('.remove-employer');
            removeButton.addEventListener('click', function () {
                employersContainer.removeChild(employerDiv);
            });

            employersContainer.appendChild(employerDiv);
        }

        // Collect data from dynamic dependent fields
        function collectDependentsData() {
            const dependentsData = [];
            const dependentElements = document.querySelectorAll('.dependent-item');

            dependentElements.forEach(element => {
                const dependent = {
                    name: element.querySelector('.dependent-name')?.value || '',
                    dateOfBirth: element.querySelector('.dependent-dob')?.value || '',
                    relationship: element.querySelector('.dependent-relationship')?.value || ''
                };

                dependentsData.push(dependent);
            });

            return dependentsData;
        }

        // Add dependent to form
        function addDependentToForm(dependent = null) {
            const dependentsContainer = document.getElementById('dependents-container');
            const dependentCount = dependentsContainer.querySelectorAll('.dependent-item').length + 1;

            const dependentDiv = document.createElement('div');
            dependentDiv.className = 'dependent-item card mb-3';
            dependentDiv.innerHTML = `
                <div class="card-header bg-light d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Dependent ${dependentCount}</h5>
                    <button type="button" class="btn btn-sm btn-outline-danger remove-dependent">
                        <i class="fas fa-times"></i> Remove
                    </button>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">Full Name</label>
                            <input type="text" class="form-control dependent-name" value="${dependent?.name || ''}" required>
                            <div class="invalid-feedback">Please enter dependent's name.</div>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Date of Birth</label>
                            <input type="date" class="form-control dependent-dob" value="${dependent?.dateOfBirth || ''}" required>
                            <div class="invalid-feedback">Please enter date of birth.</div>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Relationship</label>
                            <select class="form-select dependent-relationship" required>
                                <option value="" ${!dependent?.relationship ? 'selected' : ''}>Choose...</option>
                                <option value="child" ${dependent?.relationship === 'child' ? 'selected' : ''}>Child</option>
                                <option value="stepchild" ${dependent?.relationship === 'stepchild' ? 'selected' : ''}>Stepchild</option>
                                <option value="foster" ${dependent?.relationship === 'foster' ? 'selected' : ''}>Foster child</option>
                                <option value="other" ${dependent?.relationship === 'other' ? 'selected' : ''}>Other</option>
                            </select>
                            <div class="invalid-feedback">Please select relationship.</div>
                        </div>
                    </div>
                </div>
            `;

            // Add remove handler
            const removeButton = dependentDiv.querySelector('.remove-dependent');
            removeButton.addEventListener('click', function () {
                dependentsContainer.removeChild(dependentDiv);
            });

            dependentsContainer.appendChild(dependentDiv);
        }

        // Navigate between tabs
        function goToNextTab(currentTabId, nextTabId) {
            // First validate the current tab if we're going forward
            if (nextTabId !== 'personal-tab' && nextTabId !== 'income-tab' && nextTabId !== 'deductions-tab') {
                const form = document.getElementById('tax-profile-form');
                form.classList.add('was-validated');

                // Get the current tab pane
                const currentTabPane = document.getElementById(currentTabId.replace('-tab', '-content'));

                // Check if there are invalid fields in the current tab
                const invalidFields = currentTabPane.querySelectorAll(':invalid');
                if (invalidFields.length > 0) {
                    invalidFields[0].focus();
                    showAlert('Please fill in all required fields correctly before proceeding.', 'warning');
                    return;
                }
            }

            // Activate the next tab
            const nextTab = document.getElementById(nextTabId);
            if (nextTab) {
                const tab = new bootstrap.Tab(nextTab);
                tab.show();
            }
        }

        // Toggle spouse details visibility
        function toggleSpouseDetails() {
            const hasSpouse = document.getElementById('has-spouse').checked;
            const spouseDetails = document.getElementById('spouse-details');

            if (hasSpouse) {
                spouseDetails.style.display = 'flex';
            } else {
                spouseDetails.style.display = 'none';
            }
        }

        // Toggle dependent details visibility
        function toggleDependentDetails() {
            const hasDependents = document.getElementById('has-dependents').checked;
            const dependentDetails = document.getElementById('dependent-details');

            if (hasDependents) {
                dependentDetails.style.display = 'flex';
            } else {
                dependentDetails.style.display = 'none';
            }
        }

        // Toggle car expense details visibility
        function toggleCarExpenseDetails() {
            const useCarForWork = document.getElementById('use-car-for-work').checked;
            const carExpenseDetails = document.getElementById('car-expense-details');

            if (useCarForWork) {
                carExpenseDetails.style.display = 'flex';
            } else {
                carExpenseDetails.style.display = 'none';
            }
        }

        // Setup event listeners for the tax profile form
        function setupTaxProfileForm() {
            log('Setting up tax profile form event listeners');

            // Spouse checkbox change
            const hasSpouseCheckbox = document.getElementById('has-spouse');
            if (hasSpouseCheckbox) {
                hasSpouseCheckbox.addEventListener('change', toggleSpouseDetails);
            }

            // Dependent checkbox change
            const hasDependentsCheckbox = document.getElementById('has-dependents');
            if (hasDependentsCheckbox) {
                hasDependentsCheckbox.addEventListener('change', toggleDependentDetails);
            }

            // Car expense checkbox change
            const useCarForWorkCheckbox = document.getElementById('use-car-for-work');
            if (useCarForWorkCheckbox) {
                useCarForWorkCheckbox.addEventListener('change', toggleCarExpenseDetails);
            }

            // Add employer button
            const addEmployerButton = document.getElementById('add-employer');
            if (addEmployerButton) {
                addEmployerButton.addEventListener('click', function () {
                    addEmployerToForm();
                });
            }

            // Add dependent button
            const addDependentButton = document.getElementById('add-dependent');
            if (addDependentButton) {
                addDependentButton.addEventListener('click', function () {
                    addDependentToForm();
                });
            }

            // Save tax profile button
            const saveTaxProfileButton = document.getElementById('save-tax-profile');
            if (saveTaxProfileButton) {
                saveTaxProfileButton.addEventListener('click', saveTaxProfileData);
            }
        }

        // Update setupMainNavLinks to include the tax profile handler
        function setupMainNavLinks() {
            log('Setting up main navigation links');

            try {
                // Get all main content sections
                const mainDashboard = document.querySelector('main');
                const dataDashboardSection = document.getElementById('data-dashboard-section');

                // Handle data dashboard navigation
                const dataDashboardLink = document.getElementById('data-dashboard-nav-link');
                if (dataDashboardLink && !dataDashboardLink._hasNavClickHandler) {
                    dataDashboardLink.addEventListener('click', function (e) {
                        e.preventDefault();

                        // Hide main dashboard, show data dashboard section
                        if (mainDashboard) mainDashboard.style.display = 'none';
                        if (dataDashboardSection) {
                            dataDashboardSection.style.display = 'block';
                            loadDataDashboard(); // Load dashboard data when section is shown
                        }

                        // Update active navigation state
                        document.querySelectorAll('.sidebar .nav-link').forEach(link => {
                            link.classList.remove('active');
                        });
                        dataDashboardLink.classList.add('active');
                    });
                    dataDashboardLink._hasNavClickHandler = true;
                    log('Added navigation handler to Data Dashboard link');
                }

                // Handle main dashboard navigation
                const mainDashboardLink = document.querySelector('.sidebar .nav-link.active');
                if (mainDashboardLink && !mainDashboardLink._hasNavClickHandler) {
                    mainDashboardLink.addEventListener('click', function (e) {
                        e.preventDefault();

                        // Show main dashboard, hide data dashboard section
                        if (mainDashboard) mainDashboard.style.display = 'block';
                        if (dataDashboardSection) dataDashboardSection.style.display = 'none';

                        // Update active navigation state
                        document.querySelectorAll('.sidebar .nav-link').forEach(link => {
                            link.classList.remove('active');
                        });
                        mainDashboardLink.classList.add('active');
                    });
                    mainDashboardLink._hasNavClickHandler = true;
                    log('Added navigation handler to main dashboard link');
                }

                // Add Tax Profile handler
                setupTaxProfileHandler();

            } catch (error) {
                log('Error setting up navigation links: ' + error.message, 'error');
            }
        }

        // Add setup for the tax profile form to the document ready function
        document.addEventListener('DOMContentLoaded', function () {
            // ... existing code ...

            // Setup the tax profile form event listeners
            setupTaxProfileForm();

            // ... existing code ...
        });

        // ... existing code ...

        // Function to update tax profile summary on the dashboard
        function updateTaxProfileSummary() {
            log('Updating tax profile summary');

            try {
                const taxProfileData = localStorage.getItem('taxProfileData');
                const noProfileMessage = document.getElementById('no-tax-profile-message');
                const summaryContent = document.getElementById('tax-profile-summary-content');

                if (!taxProfileData) {
                    // No profile data exists
                    if (noProfileMessage) noProfileMessage.style.display = 'block';
                    if (summaryContent) summaryContent.style.display = 'none';
                    return;
                }

                // Profile data exists, parse it
                const profile = JSON.parse(taxProfileData);

                // Hide no profile message and show summary
                if (noProfileMessage) noProfileMessage.style.display = 'none';
                if (summaryContent) summaryContent.style.display = 'block';

                // Update personal information
                if (profile.personalInfo) {
                    const personalInfo = profile.personalInfo;

                    // Name
                    const fullName = `${personalInfo.firstName || ''} ${personalInfo.lastName || ''}`.trim();
                    document.getElementById('summary-full-name').textContent = fullName || '-';

                    // TFN (masked for privacy)
                    if (personalInfo.tfn) {
                        const maskedTfn = personalInfo.tfn.replace(/\d(?=\d{4})/g, '*');
                        document.getElementById('summary-tfn').textContent = maskedTfn;
                    } else {
                        document.getElementById('summary-tfn').textContent = '-';
                    }

                    // Filing Status
                    document.getElementById('summary-filing-status').textContent = personalInfo.filingStatus || '-';

                    // Dependents
                    const dependentsCount = personalInfo.hasDependents ?
                        (personalInfo.dependents ? personalInfo.dependents.length : 0) : 0;
                    document.getElementById('summary-dependents').textContent =
                        dependentsCount > 0 ? `${dependentsCount} dependent(s)` : 'None';
                }

                // Update financial summary

                // Income sources
                if (profile.income) {
                    const income = profile.income;
                    const employersCount = income.employers ? income.employers.length : 0;
                    const otherIncomeSources = [
                        income.interestIncome && 'Interest',
                        income.dividendIncome && 'Dividends',
                        income.trustIncome && 'Trust',
                        income.rentalIncome && 'Rental',
                        income.capitalGains && 'Capital Gains',
                        income.foreignIncome && 'Foreign',
                        income.businessIncome && 'Business',
                        income.superIncome && 'Super',
                        income.partnershipIncome && 'Partnership'
                    ].filter(Boolean);

                    const incomeSourcesText = employersCount > 0 ?
                        `${employersCount} employer(s)` : 'No employment income';

                    const additionalText = otherIncomeSources.length > 0 ?
                        `, plus ${otherIncomeSources.length} other source(s)` : '';

                    document.getElementById('summary-income-sources').textContent =
                        incomeSourcesText + additionalText;
                }

                // Deductions
                if (profile.deductions) {
                    const deductions = profile.deductions;
                    const deductionTypes = [
                        deductions.useCarForWork && 'Car',
                        deductions.workClothing && 'Work clothing',
                        deductions.homeOffice && 'Home office',
                        deductions.selfEducation && 'Self-education',
                        deductions.tools && 'Tools',
                        deductions.donations && 'Donations',
                        deductions.taxAgentFees && 'Tax agent fees'
                    ].filter(Boolean);

                    document.getElementById('summary-deductions').textContent =
                        deductionTypes.length > 0 ?
                            `${deductionTypes.length} type(s)` : 'None claimed';
                }

                // HECS/HELP
                if (profile.hecs) {
                    document.getElementById('summary-hecs').textContent =
                        profile.hecs.hasHecs ? 'Yes' : 'No';
                }

                log('Tax profile summary updated successfully');
            } catch (error) {
                log('Error updating tax profile summary: ' + error.message, 'error');
                // In case of error, just show the no profile message
                const noProfileMessage = document.getElementById('no-tax-profile-message');
                const summaryContent = document.getElementById('tax-profile-summary-content');

                if (noProfileMessage) noProfileMessage.style.display = 'block';
                if (summaryContent) summaryContent.style.display = 'none';
            }
        }

        // Update saveTaxProfileData to update the dashboard summary
        function saveTaxProfileData() {
            log('Saving tax profile data');
            try {
                // First validate the form
                if (!validateTaxProfileForm()) {
                    return false;
                }

                // Collect data from the form
                const taxProfileData = {
                    personalInfo: {
                        // Basic Identification
                        title: document.getElementById('title').value,
                        familyName: document.getElementById('family-name').value,
                        firstName: document.getElementById('first-given-name').value,
                        otherNames: document.getElementById('other-given-names').value,
                        previousNames: document.getElementById('previous-names').value,
                        dateOfBirth: document.getElementById('date-of-birth').value,
                        tfn: document.getElementById('tfn').value,
                        abn: document.getElementById('abn').value,

                        // Contact Details
                        residentialAddress: document.getElementById('residential-address').value,
                        postalAddress: document.getElementById('postal-address').value,
                        email: document.getElementById('email').value,
                        mobile: document.getElementById('mobile').value,
                        alternativePhone: document.getElementById('alternative-phone').value,

                        // Filing Status
                        residencyStatus: document.querySelector('input[name="residency-status"]:checked')?.value,
                        taxFreeThreshold: document.querySelector('input[name="tax-free-threshold"]:checked')?.value,

                        // Spouse details
                        hasSpouse: document.getElementById('has-spouse').checked,
                        spouseName: document.getElementById('has-spouse').checked ? document.getElementById('spouse-name').value : '',
                        spouseTfn: document.getElementById('has-spouse').checked ? document.getElementById('spouse-tfn').value : '',
                        spouseIncome: document.getElementById('has-spouse').checked ? document.getElementById('spouse-income').value : '',
                        spousePeriod: document.getElementById('has-spouse').checked ? document.querySelector('input[name="spouse-period"]:checked')?.value : '',

                        // Dependent details
                        hasDependents: document.getElementById('has-dependents').checked,
                        dependents: document.getElementById('has-dependents').checked ? collectDependentsData() : [],

                        // Bank account
                        bankBsb: document.getElementById('bank-bsb').value,
                        bankAccount: document.getElementById('bank-account').value,
                        bankName: document.getElementById('bank-name').value
                    },
                    income: {
                        // Employment Income
                        employers: collectEmployersData(),

                        // Investment Income
                        interestIncome: document.getElementById('interest-income').value,
                        dividendIncome: document.getElementById('dividend-income').value,
                        trustIncome: document.getElementById('trust-income').value,
                        rentalIncome: document.getElementById('rental-income').value,
                        capitalGains: document.getElementById('capital-gains').value,

                        // Government Payments
                        govtPaymentType: document.getElementById('govt-payment-type').value,
                        govtPaymentAmount: document.getElementById('govt-payment-amount').value,
                        govtPaymentTax: document.getElementById('govt-payment-tax').value,

                        // Other Income
                        foreignIncome: document.getElementById('foreign-income').value,
                        businessIncome: document.getElementById('business-income').value,
                        superIncome: document.getElementById('super-income').value,
                        partnershipIncome: document.getElementById('partnership-income').value
                    },
                    deductions: {
                        // Car Expenses
                        useCarForWork: document.getElementById('use-car-for-work').checked,
                        carMake: document.getElementById('use-car-for-work').checked ? document.getElementById('car-make').value : '',
                        carRegistration: document.getElementById('use-car-for-work').checked ? document.getElementById('car-registration').value : '',
                        carMethod: document.getElementById('use-car-for-work').checked ? document.getElementById('car-method').value : '',
                        businessKm: document.getElementById('use-car-for-work').checked ? document.getElementById('business-km').value : '',
                        carExpenses: document.getElementById('use-car-for-work').checked ? document.getElementById('car-expenses').value : ''

                        // Other deduction sections would be collected here
                    },
                    taxOffsets: {
                        // Tax offset data would be collected here
                    },
                    medicare: {
                        // Medicare data would be collected here
                    },
                    hecs: {
                        // HECS/HELP data would be collected here
                    },
                    additionalInfo: {
                        // Additional information would be collected here
                    },
                    lastUpdated: new Date().toISOString()
                };

                // Save to local storage
                localStorage.setItem('taxProfileData', JSON.stringify(taxProfileData));

                // Update dashboard summary
                updateTaxProfileSummary();

                // Show success message
                showAlert('Your tax profile has been saved successfully!', 'success');

                // Close the modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('tax-profile-modal'));
                if (modal) {
                    modal.hide();
                }

                log('Tax profile data saved successfully');
                return true;

            } catch (error) {
                log('Error saving tax profile data: ' + error.message, 'error');
                showAlert('Failed to save your tax profile. Please try again.', 'danger');
                return false;
            }
        }

        // Initialize application
        document.addEventListener('DOMContentLoaded', function () {
            log('DOM content loaded, initializing application');

            // Setup sidebar toggle
            setupSidebarToggle();

            // Initial clock update
            updateClock();
            setInterval(updateClock, 60000); // Update every minute

            // Initialize default data if needed
            const subsInitialized = initializeDefaultSubscriptions();
            initializeDefaultGoals();

            // Force direct update of the subscriptions value
            if (subsInitialized) {
                log('Forcing immediate update of subscription values');
                const subscriptions = JSON.parse(localStorage.getItem('subscriptions') || '[]');
                let totalAmount = 0;

                // Calculate total monthly cost
                subscriptions.forEach(sub => {
                    let amount = parseFloat(sub.amount || 0);
                    if (isNaN(amount)) amount = 0;

                    // Convert to monthly equivalent
                    switch (sub.frequency) {
                        case 'yearly': amount = amount / 12; break;
                        case 'quarterly': amount = amount / 3; break;
                        case 'weekly': amount = amount * 4.33; break;
                    }

                    totalAmount += amount;
                });

                // Direct update to subscription value
                const totalSubscriptionsElement = document.getElementById('total-subscriptions-value');
                if (totalSubscriptionsElement) {
                    totalSubscriptionsElement.textContent = parseFloat(totalAmount).toFixed(2);
                    log('Directly set subscription value to: ' + parseFloat(totalAmount).toFixed(2));
                }

                // Update subscription count
                const subscriptionCountElement = document.getElementById('subscription-count');
                if (subscriptionCountElement) {
                    subscriptionCountElement.textContent = subscriptions.length;
                }
            }

            // Setup event listeners for navigation
            setupNavigation();

            // Setup transaction filtering
            setupTransactionFilters();

            // Setup modal handlers
            setupModalHandlers();

            // Setup tab navigation in modals
            setupTabNavigation();

            // Setup feature handlers
            setupGoalsHandler();
            setupBankAccountsHandler();
            setupTaxProfileHandler();
            setupReceiptsHandler();

            // Update UI elements with data
            updateGoalsDisplay();
            updateTaxProfileSummary();
            loadSubscriptionsData(); // Load and display subscriptions

            // Get mock data and display
            getMockData();

            // Setup dashboard tiles
            setupDashboardTiles();

            // Ensure subscriptions card has click handler
            const subscriptionsCard = document.getElementById('subscriptions-card');
            if (subscriptionsCard && !subscriptionsCard._hasClickHandler) {
                subscriptionsCard.addEventListener('click', function () {
                    log('Subscriptions card clicked');
                    openSubscriptionsModal();
                });
                subscriptionsCard._hasClickHandler = true;
                log('Added click handler to subscriptions card');
            }

            log('Application initialized successfully');
        });

        // Function to initialize default subscription data if none exists
        function initializeDefaultSubscriptions() {
            log('Initializing default subscriptions data');

            // Check if subscriptions data already exists
            const existingSubscriptions = localStorage.getItem('subscriptions');
            if (existingSubscriptions && JSON.parse(existingSubscriptions).length > 0) {
                log('Existing subscriptions found, skipping default initialization');
                return false; // No changes made
            }

            // Create default subscriptions
            const defaultSubscriptions = [
                {
                    id: generateUniqueId(),
                    name: 'Netflix',
                    amount: '15.99',
                    frequency: 'monthly',
                    category: 'entertainment',
                    nextPayment: new Date(new Date().setDate(new Date().getDate() + 12)).toISOString(),
                    nextPaymentDate: new Date(new Date().setDate(new Date().getDate() + 12)).toISOString(),
                    startDate: new Date(new Date().setDate(new Date().getDate() - 18)).toISOString(),
                    createdAt: new Date().toISOString()
                },
                {
                    id: generateUniqueId(),
                    name: 'Spotify',
                    amount: '9.99',
                    frequency: 'monthly',
                    category: 'entertainment',
                    nextPayment: new Date(new Date().setDate(new Date().getDate() + 8)).toISOString(),
                    nextPaymentDate: new Date(new Date().setDate(new Date().getDate() + 8)).toISOString(),
                    startDate: new Date(new Date().setDate(new Date().getDate() - 22)).toISOString(),
                    createdAt: new Date().toISOString()
                },
                {
                    id: generateUniqueId(),
                    name: 'Gym Membership',
                    amount: '45.00',
                    frequency: 'monthly',
                    category: 'health',
                    nextPayment: new Date(new Date().setDate(new Date().getDate() + 15)).toISOString(),
                    nextPaymentDate: new Date(new Date().setDate(new Date().getDate() + 15)).toISOString(),
                    startDate: new Date(new Date().setDate(new Date().getDate() - 15)).toISOString(),
                    createdAt: new Date().toISOString()
                }
            ];

            // Save to localStorage
            localStorage.setItem('subscriptions', JSON.stringify(defaultSubscriptions));

            log('Default subscriptions initialized');
            return true; // Changes made
        }

        // Setup handlers for clickable dashboard tiles
        function setupDashboardTiles() {
            log('Setting up dashboard tiles');

            // Goals card
            const goalsCard = document.getElementById('goals-card');
            if (goalsCard) {
                goalsCard.addEventListener('click', function () {
                    const goalsModal = new bootstrap.Modal(document.getElementById('goals-modal'));
                    goalsModal.show();
                    loadGoalsContent(document.getElementById('goals-modal'));
                });
                log('Added click handler to goals card');
            }

            // Tax Profile card
            const taxProfileCard = document.getElementById('tax-profile-card');
            if (taxProfileCard) {
                taxProfileCard.addEventListener('click', function () {
                    const taxProfileModal = new bootstrap.Modal(document.getElementById('tax-profile-modal'));
                    taxProfileModal.show();

                    // If no tax profile data exists yet, initialize with empty data
                    if (!localStorage.getItem('taxProfileData')) {
                        initializeEmptyTaxProfile();
                    } else {
                        // Load existing tax profile data
                        loadTaxProfileData();
                    }
                });
                log('Added click handler to tax profile card');
            }

            // Edit tax profile button
            const editTaxProfileBtn = document.getElementById('edit-tax-profile-btn');
            if (editTaxProfileBtn) {
                editTaxProfileBtn.addEventListener('click', function (e) {
                    e.stopPropagation(); // Prevent the card click handler from firing

                    const taxProfileModal = new bootstrap.Modal(document.getElementById('tax-profile-modal'));
                    taxProfileModal.show();

                    // Load existing tax profile data
                    loadTaxProfileData();
                });
                log('Added click handler to edit tax profile button');
            }
        }

        document.addEventListener('DOMContentLoaded', function () {
            const receiptsNavLink = document.getElementById('receipts-nav-link');
            const receiptsSection = document.getElementById('receipts-section');
            const storedStats = JSON.parse(localStorage.getItem('receiptStats'));
            if (storedStats) {
                updateReceiptDashboard(storedStats);
            }
            receiptsNavLink.addEventListener('click', function (e) {
                e.preventDefault();

                // Hide all sections if you have multiple
                document.querySelectorAll('.main-content > .row').forEach(row => {
                    row.style.display = 'none';
                });

                // Show the receipts section
                receiptsSection.style.display = 'block';
            });
        });
        document.addEventListener('DOMContentLoaded', async () => {
            // Firebase + Auth
            initializeApp();
            await checkAuthState();

            // Charts
            initializeCharts();

            const uploadReceiptBtn = document.getElementById('upload-receipt-btn');
            const receiptFileInput = document.getElementById('receipt-file-input');

            if (uploadReceiptBtn && receiptFileInput) {
                uploadReceiptBtn.addEventListener('click', () => {
                    receiptFileInput.click(); // Trigger hidden file input on button click
                });

                receiptFileInput.addEventListener('change', (event) => {
                    const file = event.target.files[0];
                    if (file) {
                        console.log('Receipt file selected:', file.name);
                        handleReceiptUpload(file);
                        receiptFileInput.value = ''; // Reset so re-upload works
                    }
                });
            } else {
                console.error('Could not find #upload-receipt-btn or #receipt-file-input');
            }
            let receiptmodalElement = document.getElementById('receipt-upload-section-btn');
            receiptmodalElement.addEventListener('click', () => {
                let receiptmodalMainElement = document.getElementById('receipt-upload-section');
                // Show the modal
                const modal = new bootstrap.Modal(receiptmodalMainElement);
                modal.show();
            });
            // Fetch data if logged in
            // if (window.currentUser) {
            //     fetchDashboardData();
            //     fetchBankConnections();
            // }

            // setupEventListeners();
        });


        document.addEventListener('DOMContentLoaded', function () {
    const submitReceiptBtn = document.querySelector('#receipt-upload-section button[type="submit"]');
    const receiptFileInput = document.getElementById('receipt-file');
    const receiptUrlInput = document.getElementById('receipt-url');
    const photoCanvas = document.getElementById('photo-canvas');

    if (submitReceiptBtn) {
        submitReceiptBtn.addEventListener('click', async function (e) {
            e.preventDefault();

            const activeTab = document.querySelector('#uploadTab .nav-link.active').id;

            try {
                if (activeTab === 'local-tab') {
                    const file = receiptFileInput.files[0];
                    if (!file) {
                        showToast('Please select a file to upload.', 'primary');
                        return;
                    }
                    await handleReceiptUpload(file);

                } else if (activeTab === 'url-tab') { debugger
                    const url = receiptUrlInput.value.trim();
                    if (!url) {
                        showToast('Please paste a receipt URL.', 'primary');
                        return;
                    }

                    showToast('Fetching image from URL...', 'primary');

                    const response = await fetch(url);
                    const blob = await response.blob();

                    // Infer filename and type
                    const contentType = blob.type || 'image/jpeg';
                    const extension = contentType.split('/')[1] || 'jpg';
                    const file = new File([blob], `url-upload.${extension}`, { type: contentType });

                    await handleReceiptUpload(file);

                } else if (activeTab === 'camera-tab') {
                    photoCanvas.toBlob(async function (blob) {
                        if (!blob) {
                            showToast('No photo captured.', 'primary');
                            return;
                        }

                        const file = new File([blob], 'photo.jpg', { type: 'image/jpeg' });
                        await handleReceiptUpload(file);
                    }, 'image/jpeg');
                }
            } catch (error) {
                showToast(`Upload failed: ${error.message}`, 'danger');
                console.error('Error during upload:', error);
            }
        });
    }
});
        const video = document.getElementById('camera-stream');

        const startCamera = async () => {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: true });
                video.srcObject = stream;
            } catch (err) {
                console.error('Camera access error:', err);

                showToast('Could not access camera.', 'danger');
            }
        };

        const captureBtn = document.getElementById('capture-photo-btn');
        const canvas = document.getElementById('photo-canvas');
        // const photoPreview = document.getElementById('photo-preview');

        captureBtn.addEventListener('click', () => {
            const context = canvas.getContext('2d');
            canvas.style.display = 'block';
            // photoPreview.style.display = 'block';

            // Draw video frame to canvas
            context.drawImage(video, 0, 0, canvas.width, canvas.height);

            // Convert to image preview
            // photoPreview.src = canvas.toDataURL('image/jpeg');
        });




        // Start camera when modal is shown
        const receiptModalEl = document.getElementById('receipt-upload-section');
        receiptModalEl.addEventListener('shown.bs.modal', () => {
            startCamera();
        });

        function showToast(message, type = 'primary') {
            debugger
            const toastEl = document.getElementById('main-toast');
            const toastBody = document.getElementById('toast-body');

            if (!toastEl || !toastBody) {
                console.error('Toast elements not found in DOM.');
                return;
            }

            // Update message and style
            toastBody.textContent = message;
            toastEl.className = `toast align-items-center text-white bg-${type} border-0`;

            // Show toast using Bootstrap
            const bsToast = new bootstrap.Toast(toastEl);
            bsToast.show();
        }


        async function checkAuthState() {
            console.log("Checking Auth State (placeholder)...");
            // Add your auth state checking logic here
            // Set window.currentUser if logged in
            window.currentUser = { uid: "mock-user-123" }; // Example mock user
        }
        function initializeCharts() {
            console.log("Initializing Charts (placeholder)...");
            // Add your chart initialization logic here
        }
        async function handleReceiptUpload(file) {
            if (!file) {
                showToast("No file selected!", 'primary');

                return;
            }

            showToast('Uploading receipt...', 'primary');
            const formData = new FormData();
            formData.append('receipt', file);

            try {
                const response = await fetch('/api/receipts/upload/formx', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (!response.ok || !result.success) {
                    throw new Error(result.error || `HTTP error! status: ${response.status}`);
                }

                showToast('Extraction Successful!', 'success');

                const data = result.data;
                populateFormWithReceiptData(data); //  NEW

                // Show the form
                document.getElementById('receipt-review-form').style.display = 'block';

                // Close the upload modal
                const modalEl = document.getElementById('receipt-upload-section');
                const modalInstance = bootstrap.Modal.getInstance(modalEl);
                modalInstance.hide();

            } catch (error) {
                showToast(`Extraction Failed: ${error.message}`, 'danger');
                console.error('Receipt upload/extraction failed:', error);
            }
        }

        function populateFormWithReceiptData(data) {
            debugger
            const doc = data.documents[0].data;
            document.getElementById('vendor_name').value = doc.merchant_name || '';
            document.getElementById('total_amount').value = doc.total_amount || '';
            document.getElementById('date').value = doc.date || '';

            // Save original data temporarily for later reference
            window.currentReceiptData = data;
        }

        document.getElementById('receiptForm').addEventListener('submit', function (e) {
            e.preventDefault();

            // Get updated values
            const updatedData = {
                vendor_name: document.getElementById('vendor_name').value,
                total_amount: document.getElementById('total_amount').value,
                date: document.getElementById('date').value
            };

            // Update the data in the original response object
            window.currentReceiptData.documents[0].data = {
                ...window.currentReceiptData.documents[0].data,
                ...updatedData
            };

            // Proceed to update localStorage and UI
            updateLocalStorageAndUI(window.currentReceiptData);

            // Optionally hide the form
            document.getElementById('receipt-review-form').style.display = 'none';

            //  Show toast confirmation
            showToast('Receipt data saved successfully!', 'success');
        });
        document.getElementById('cancel-review-btn').addEventListener('click', function () {
            // Just hide the form, no update to localStorage
            document.getElementById('receipt-review-form').style.display = 'none';

            // Optionally show a toast that user cancelled
            showToast('Review cancelled. Receipt not saved.', 'secondary');
        });

        function updateLocalStorageAndUI(newData) {
            debugger
            const currentStats = JSON.parse(localStorage.getItem('receiptStats')) || {
                totalReceipts: 0,
                totalSpent: 0,
                matchedReceipts: 0
            };

            // Increment values
            currentStats.totalReceipts += 1;
            currentStats.totalSpent += parseFloat(newData.documents[0].data.total_amount || 0);
            if (newData.matched) {
                currentStats.matchedReceipts += 1;
            }

            // Store in localStorage
            localStorage.setItem('receiptStats', JSON.stringify(currentStats));

            // Update HTML
            updateReceiptDashboard(currentStats);
        }
        function updateReceiptDashboard(stats) {
            document.getElementById('total-receipts-count').textContent = stats.totalReceipts;
            document.getElementById('total-receipts-amount').textContent = `$${stats.totalSpent.toFixed(2)}`;
            document.getElementById('matched-receipts-count').textContent = stats.matchedReceipts;

            const average = stats.totalReceipts > 0 ? stats.totalSpent / stats.totalReceipts : 0;
            document.getElementById('average-receipt-amount').textContent = `$${average.toFixed(2)}`;
        }
    </script>

    <!-- Tax Profile Modal -->
    <div class="modal fade" id="tax-profile-modal" tabindex="-1" aria-labelledby="tax-profile-modal-label"
        aria-hidden="true">
        <div class="modal-dialog modal-xl modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="tax-profile-modal-label">
                        <i class="fas fa-file-invoice-dollar me-2"></i> Your Tax Profile
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                        aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i> Complete your tax profile to help our AI identify
                        potential tax deductions and optimize your financial planning.
                    </div>

                    <!-- Tax Profile Form -->
                    <form id="tax-profile-form" class="needs-validation" novalidate>
                        <!-- Nav tabs for sections -->
                        <ul class="nav nav-tabs mb-4" id="taxProfileTabs" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="personal-tab" data-bs-toggle="tab"
                                    data-bs-target="#personal-content" type="button" role="tab">Personal
                                    Information</button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="income-tab" data-bs-toggle="tab"
                                    data-bs-target="#income-content" type="button" role="tab">Income</button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="deductions-tab" data-bs-toggle="tab"
                                    data-bs-target="#deductions-content" type="button" role="tab">Deductions</button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="offsets-tab" data-bs-toggle="tab"
                                    data-bs-target="#offsets-content" type="button" role="tab">Tax Offsets</button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="medicare-tab" data-bs-toggle="tab"
                                    data-bs-target="#medicare-content" type="button" role="tab">Medicare</button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="hecs-tab" data-bs-toggle="tab"
                                    data-bs-target="#hecs-content" type="button" role="tab">HELP/HECS</button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="additional-tab" data-bs-toggle="tab"
                                    data-bs-target="#additional-content" type="button" role="tab">Additional
                                    Info</button>
                            </li>
                        </ul>

                        <!-- Tab content -->
                        <div class="tab-content" id="taxProfileTabsContent">
                            <!-- Personal Information Tab -->
                            <div class="tab-pane fade show active" id="personal-content" role="tabpanel">
                                <h4 class="mb-3">Basic Identification</h4>
                                <div class="row g-3">
                                    <div class="col-md-2">
                                        <label for="title" class="form-label">Title</label>
                                        <select class="form-select" id="title" required>
                                            <option value="">Choose...</option>
                                            <option value="Mr">Mr</option>
                                            <option value="Mrs">Mrs</option>
                                            <option value="Miss">Miss</option>
                                            <option value="Ms">Ms</option>
                                            <option value="Dr">Dr</option>
                                        </select>
                                        <div class="invalid-feedback">Please select a title.</div>
                                    </div>
                                    <div class="col-md-4">
                                        <label for="family-name" class="form-label">Family Name/Surname</label>
                                        <input type="text" class="form-control" id="family-name" maxlength="40"
                                            required>
                                        <div class="invalid-feedback">Please enter your family name.</div>
                                    </div>
                                    <div class="col-md-3">
                                        <label for="first-given-name" class="form-label">First Given Name</label>
                                        <input type="text" class="form-control" id="first-given-name" maxlength="40"
                                            required>
                                        <div class="invalid-feedback">Please enter your first name.</div>
                                    </div>
                                    <div class="col-md-3">
                                        <label for="other-given-names" class="form-label">Other Given Names</label>
                                        <input type="text" class="form-control" id="other-given-names" maxlength="40">
                                    </div>
                                    <div class="col-md-6">
                                        <label for="previous-names" class="form-label">Previous Names (if
                                            applicable)</label>
                                        <input type="text" class="form-control" id="previous-names">
                                        <small class="text-muted">Maiden, former married names, etc.</small>
                                    </div>
                                    <div class="col-md-3">
                                        <label for="date-of-birth" class="form-label">Date of Birth</label>
                                        <input type="date" class="form-control" id="date-of-birth" required>
                                        <div class="invalid-feedback">Please enter your date of birth.</div>
                                    </div>
                                    <div class="col-md-3">
                                        <label for="tfn" class="form-label">Tax File Number (TFN)</label>
                                        <input type="text" class="form-control" id="tfn" pattern="[0-9]{9}" required>
                                        <div class="invalid-feedback">Please enter a valid 9-digit TFN.</div>
                                    </div>
                                    <div class="col-md-4">
                                        <label for="abn" class="form-label">ABN (if applicable)</label>
                                        <input type="text" class="form-control" id="abn" pattern="[0-9]{11}">
                                    </div>
                                </div>

                                <h4 class="mb-3 mt-4">Contact Details</h4>
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <label for="residential-address" class="form-label">Residential Address</label>
                                        <input type="text" class="form-control" id="residential-address" required>
                                        <div class="invalid-feedback">Please enter your residential address.</div>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="postal-address" class="form-label">Postal Address</label>
                                        <input type="text" class="form-control" id="postal-address">
                                        <small class="text-muted">If different from residential address</small>
                                    </div>
                                    <div class="col-md-4">
                                        <label for="email" class="form-label">Email Address</label>
                                        <input type="email" class="form-control" id="email" required>
                                        <div class="invalid-feedback">Please enter a valid email address.</div>
                                    </div>
                                    <div class="col-md-4">
                                        <label for="mobile" class="form-label">Mobile Phone Number</label>
                                        <input type="tel" class="form-control" id="mobile" pattern="[0-9]{10}" required>
                                        <div class="invalid-feedback">Please enter a valid 10-digit mobile number.</div>
                                    </div>
                                    <div class="col-md-4">
                                        <label for="alternative-phone" class="form-label">Alternative Phone
                                            Number</label>
                                        <input type="tel" class="form-control" id="alternative-phone">
                                    </div>
                                </div>

                                <h4 class="mb-3 mt-4">Filing Status</h4>
                                <div class="row g-3">
                                    <div class="col-md-4">
                                        <label class="form-label">Australian Resident for Tax Purposes?</label>
                                        <div>
                                            <div class="form-check form-check-inline">
                                                <input class="form-check-input" type="radio" name="residency-status"
                                                    id="resident-yes" value="yes" required>
                                                <label class="form-check-label" for="resident-yes">Yes</label>
                                            </div>
                                            <div class="form-check form-check-inline">
                                                <input class="form-check-input" type="radio" name="residency-status"
                                                    id="resident-no" value="no">
                                                <label class="form-check-label" for="resident-no">No</label>
                                            </div>
                                            <div class="invalid-feedback">Please select your residency status.</div>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label">Claiming Tax-Free Threshold?</label>
                                        <div>
                                            <div class="form-check form-check-inline">
                                                <input class="form-check-input" type="radio" name="tax-free-threshold"
                                                    id="threshold-yes" value="yes" required>
                                                <label class="form-check-label" for="threshold-yes">Yes</label>
                                            </div>
                                            <div class="form-check form-check-inline">
                                                <input class="form-check-input" type="radio" name="tax-free-threshold"
                                                    id="threshold-no" value="no">
                                                <label class="form-check-label" for="threshold-no">No</label>
                                            </div>
                                            <div class="invalid-feedback">Please select your tax-free threshold status.
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="row g-3 mt-2">
                                    <div class="col-md-6">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="has-spouse">
                                            <label class="form-check-label" for="has-spouse">
                                                I have a spouse during this tax year
                                            </label>
                                        </div>
                                    </div>
                                </div>

                                <div id="spouse-details" class="row g-3 mt-2" style="display: none;">
                                    <div class="col-md-4">
                                        <label for="spouse-name" class="form-label">Spouse's Full Name</label>
                                        <input type="text" class="form-control" id="spouse-name">
                                    </div>
                                    <div class="col-md-4">
                                        <label for="spouse-tfn" class="form-label">Spouse's TFN</label>
                                        <input type="text" class="form-control" id="spouse-tfn" pattern="[0-9]{9}">
                                    </div>
                                    <div class="col-md-4">
                                        <label for="spouse-income" class="form-label">Spouse's Taxable Income</label>
                                        <input type="number" class="form-control" id="spouse-income" min="0"
                                            step="0.01">
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">Spouse for Full or Partial Year?</label>
                                        <div>
                                            <div class="form-check form-check-inline">
                                                <input class="form-check-input" type="radio" name="spouse-period"
                                                    id="spouse-full" value="full">
                                                <label class="form-check-label" for="spouse-full">Full Year</label>
                                            </div>
                                            <div class="form-check form-check-inline">
                                                <input class="form-check-input" type="radio" name="spouse-period"
                                                    id="spouse-partial" value="partial">
                                                <label class="form-check-label" for="spouse-partial">Partial
                                                    Year</label>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="row g-3 mt-2">
                                    <div class="col-md-6">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="has-dependents">
                                            <label class="form-check-label" for="has-dependents">
                                                I have dependent children
                                            </label>
                                        </div>
                                    </div>
                                </div>

                                <div id="dependent-details" class="row g-3 mt-2" style="display: none;">
                                    <div class="col-md-12">
                                        <button type="button" class="btn btn-sm btn-outline-primary" id="add-dependent">
                                            <i class="fas fa-plus"></i> Add Dependent
                                        </button>
                                    </div>
                                    <div class="col-md-12" id="dependents-container">
                                        <!-- Dependent children will be added here -->
                                    </div>
                                </div>

                                <h4 class="mb-3 mt-4">Bank Account for Refunds</h4>
                                <div class="row g-3">
                                    <div class="col-md-3">
                                        <label for="bank-bsb" class="form-label">BSB</label>
                                        <input type="text" class="form-control" id="bank-bsb" pattern="[0-9]{6}"
                                            required>
                                        <div class="invalid-feedback">Please enter a valid BSB (6 digits).</div>
                                    </div>
                                    <div class="col-md-5">
                                        <label for="bank-account" class="form-label">Account Number</label>
                                        <input type="text" class="form-control" id="bank-account" pattern="[0-9]+"
                                            required>
                                        <div class="invalid-feedback">Please enter a valid account number.</div>
                                    </div>
                                    <div class="col-md-4">
                                        <label for="bank-name" class="form-label">Account Name</label>
                                        <input type="text" class="form-control" id="bank-name" required>
                                        <div class="invalid-feedback">Please enter the account name.</div>
                                    </div>
                                </div>

                                <div class="d-flex justify-content-between mt-4">
                                    <div></div>
                                    <button type="button" class="btn btn-primary"
                                        onclick="goToNextTab('personal-tab', 'income-tab')">Next: Income <i
                                            class="fas fa-arrow-right ms-2"></i></button>
                                </div>
                            </div>

                            <!-- Income Tab -->
                            <div class="tab-pane fade" id="income-content" role="tabpanel">
                                <h4 class="mb-3">Employment Income</h4>
                                <div class="row g-3 mb-3">
                                    <div class="col-md-12">
                                        <button type="button" class="btn btn-sm btn-outline-primary" id="add-employer">
                                            <i class="fas fa-plus"></i> Add Employer
                                        </button>
                                    </div>
                                    <div class="col-md-12" id="employers-container">
                                        <!-- Employer details will be added here -->
                                    </div>
                                </div>

                                <h4 class="mb-3 mt-4">Investment Income</h4>
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <label for="interest-income" class="form-label">Interest from Bank
                                            Accounts</label>
                                        <input type="number" class="form-control" id="interest-income" min="0"
                                            step="0.01">
                                    </div>
                                    <div class="col-md-6">
                                        <label for="dividend-income" class="form-label">Dividends from
                                            Investments</label>
                                        <input type="number" class="form-control" id="dividend-income" min="0"
                                            step="0.01">
                                    </div>
                                    <div class="col-md-6">
                                        <label for="trust-income" class="form-label">Trust Distributions</label>
                                        <input type="number" class="form-control" id="trust-income" min="0" step="0.01">
                                    </div>
                                    <div class="col-md-6">
                                        <label for="rental-income" class="form-label">Rental Property Income</label>
                                        <input type="number" class="form-control" id="rental-income" min="0"
                                            step="0.01">
                                    </div>
                                    <div class="col-md-6">
                                        <label for="capital-gains" class="form-label">Capital Gains</label>
                                        <input type="number" class="form-control" id="capital-gains" min="0"
                                            step="0.01">
                                        <small class="text-muted">Including cryptocurrency</small>
                                    </div>
                                </div>

                                <h4 class="mb-3 mt-4">Government Payments</h4>
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <label for="govt-payment-type" class="form-label">Types of Pensions or
                                            Benefits</label>
                                        <input type="text" class="form-control" id="govt-payment-type">
                                    </div>
                                    <div class="col-md-3">
                                        <label for="govt-payment-amount" class="form-label">Amount Received</label>
                                        <input type="number" class="form-control" id="govt-payment-amount" min="0"
                                            step="0.01">
                                    </div>
                                    <div class="col-md-3">
                                        <label for="govt-payment-tax" class="form-label">Tax Withheld</label>
                                        <input type="number" class="form-control" id="govt-payment-tax" min="0"
                                            step="0.01">
                                    </div>
                                </div>

                                <h4 class="mb-3 mt-4">Other Income</h4>
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <label for="foreign-income" class="form-label">Foreign Income</label>
                                        <input type="number" class="form-control" id="foreign-income" min="0"
                                            step="0.01">
                                    </div>
                                    <div class="col-md-6">
                                        <label for="business-income" class="form-label">Business Income</label>
                                        <input type="number" class="form-control" id="business-income" min="0"
                                            step="0.01">
                                    </div>
                                    <div class="col-md-6">
                                        <label for="super-income" class="form-label">Superannuation Income</label>
                                        <input type="number" class="form-control" id="super-income" min="0" step="0.01">
                                    </div>
                                    <div class="col-md-6">
                                        <label for="partnership-income" class="form-label">Income from Partnerships and
                                            Trusts</label>
                                        <input type="number" class="form-control" id="partnership-income" min="0"
                                            step="0.01">
                                    </div>
                                </div>

                                <div class="d-flex justify-content-between mt-4">
                                    <button type="button" class="btn btn-outline-secondary"
                                        onclick="goToNextTab('income-tab', 'personal-tab')"><i
                                            class="fas fa-arrow-left me-2"></i> Previous: Personal</button>
                                    <button type="button" class="btn btn-primary"
                                        onclick="goToNextTab('income-tab', 'deductions-tab')">Next: Deductions <i
                                            class="fas fa-arrow-right ms-2"></i></button>
                                </div>
                            </div>

                            <!-- Deductions Tab -->
                            <div class="tab-pane fade" id="deductions-content" role="tabpanel">
                                <h4 class="mb-3">Work-Related Expenses</h4>

                                <!-- Car Expenses -->
                                <div class="card mb-3">
                                    <div class="card-header bg-light">
                                        <h5 class="mb-0">Car Expenses (D1)</h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="row g-3">
                                            <div class="col-md-12">
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox"
                                                        id="use-car-for-work">
                                                    <label class="form-check-label" for="use-car-for-work">
                                                        I use my car for work purposes
                                                    </label>
                                                </div>
                                            </div>
                                        </div>

                                        <div id="car-expense-details" class="row g-3 mt-2" style="display: none;">
                                            <div class="col-md-4">
                                                <label for="car-make" class="form-label">Car Make and Model</label>
                                                <input type="text" class="form-control" id="car-make">
                                            </div>
                                            <div class="col-md-4">
                                                <label for="car-registration" class="form-label">Registration
                                                    Number</label>
                                                <input type="text" class="form-control" id="car-registration">
                                            </div>
                                            <div class="col-md-4">
                                                <label for="car-method" class="form-label">Calculation Method</label>
                                                <select class="form-select" id="car-method">
                                                    <option value="cents">Cents per Kilometer</option>
                                                    <option value="logbook">Logbook Method</option>
                                                </select>
                                            </div>
                                            <div class="col-md-4">
                                                <label for="business-km" class="form-label">Business Kilometers</label>
                                                <input type="number" class="form-control" id="business-km" min="0">
                                            </div>
                                            <div class="col-md-8">
                                                <label for="car-expenses" class="form-label">Total Car Expenses
                                                    Claimed</label>
                                                <input type="number" class="form-control" id="car-expenses" min="0"
                                                    step="0.01">
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Other key deduction sections would go here -->
                                <div class="alert alert-info">
                                    <i class="fas fa-info-circle me-2"></i> Additional deduction sections will include
                                    travel expenses, clothing expenses, self-education, and other work-related expenses.
                                </div>

                                <div class="d-flex justify-content-between mt-4">
                                    <button type="button" class="btn btn-outline-secondary"
                                        onclick="goToNextTab('deductions-tab', 'income-tab')"><i
                                            class="fas fa-arrow-left me-2"></i> Previous: Income</button>
                                    <button type="button" class="btn btn-primary"
                                        onclick="goToNextTab('deductions-tab', 'offsets-tab')">Next: Tax Offsets <i
                                            class="fas fa-arrow-right ms-2"></i></button>
                                </div>
                            </div>

                            <!-- Placeholder for remaining tabs -->
                            <div class="tab-pane fade" id="offsets-content" role="tabpanel">
                                <div class="alert alert-info">
                                    <i class="fas fa-info-circle me-2"></i> This section will contain tax offset fields
                                    including private health insurance details, spouse details for offsets, and other
                                    tax offset information.
                                </div>

                                <div class="d-flex justify-content-between mt-4">
                                    <button type="button" class="btn btn-outline-secondary"
                                        onclick="goToNextTab('offsets-tab', 'deductions-tab')"><i
                                            class="fas fa-arrow-left me-2"></i> Previous: Deductions</button>
                                    <button type="button" class="btn btn-primary"
                                        onclick="goToNextTab('offsets-tab', 'medicare-tab')">Next: Medicare <i
                                            class="fas fa-arrow-right ms-2"></i></button>
                                </div>
                            </div>

                            <div class="tab-pane fade" id="medicare-content" role="tabpanel">
                                <div class="alert alert-info">
                                    <i class="fas fa-info-circle me-2"></i> This section will contain Medicare levy
                                    information and private health insurance details.
                                </div>

                                <div class="d-flex justify-content-between mt-4">
                                    <button type="button" class="btn btn-outline-secondary"
                                        onclick="goToNextTab('medicare-tab', 'offsets-tab')"><i
                                            class="fas fa-arrow-left me-2"></i> Previous: Tax Offsets</button>
                                    <button type="button" class="btn btn-primary"
                                        onclick="goToNextTab('medicare-tab', 'hecs-tab')">Next: HELP/HECS <i
                                            class="fas fa-arrow-right ms-2"></i></button>
                                </div>
                            </div>

                            <div class="tab-pane fade" id="hecs-content" role="tabpanel">
                                <div class="alert alert-info">
                                    <i class="fas fa-info-circle me-2"></i> This section will contain HELP/HECS debt
                                    information and student loan details.
                                </div>

                                <div class="d-flex justify-content-between mt-4">
                                    <button type="button" class="btn btn-outline-secondary"
                                        onclick="goToNextTab('hecs-tab', 'medicare-tab')"><i
                                            class="fas fa-arrow-left me-2"></i> Previous: Medicare</button>
                                    <button type="button" class="btn btn-primary"
                                        onclick="goToNextTab('hecs-tab', 'additional-tab')">Next: Additional Info <i
                                            class="fas fa-arrow-right ms-2"></i></button>
                                </div>
                            </div>

                            <div class="tab-pane fade" id="additional-content" role="tabpanel">
                                <div class="alert alert-info">
                                    <i class="fas fa-info-circle me-2"></i> This section will contain additional tax
                                    information such as foreign entities, family trust details, and other special
                                    circumstances.
                                </div>

                                <div class="d-flex justify-content-between mt-4">
                                    <button type="button" class="btn btn-outline-secondary"
                                        onclick="goToNextTab('additional-tab', 'hecs-tab')"><i
                                            class="fas fa-arrow-left me-2"></i> Previous: HELP/HECS</button>
                                    <button type="button" class="btn btn-primary" id="save-tax-profile">
                                        <i class="fas fa-save me-2"></i> Save Tax Profile
                                    </button>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

</body>

</html>