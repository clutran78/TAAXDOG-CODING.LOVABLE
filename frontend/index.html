<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TAAXDOG - Dashboard</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Custom CSS -->
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f8f9fa;
        }
        .sidebar {
            position: fixed;
            top: 56px; /* Match navbar height to prevent overlap */
            bottom: 0;
            left: 0;
            z-index: 100;
            padding: 0; /* Remove top padding since we're using top: 56px */
            box-shadow: inset -1px 0 0 rgba(0, 0, 0, .1);
            background-color: white;
            color: #333;
            width: 240px; /* Set explicit width to match main-content margin */
        }
        .sidebar-sticky {
            position: relative;
            height: 100%; /* Take full height of sidebar */
            padding-top: 0.5rem;
            overflow-x: hidden;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }
        .sidebar .nav-link {
            font-weight: 500;
            color: #333;
            padding: 0.75rem 1rem;
            margin-bottom: 0.25rem;
        }
        .sidebar .nav-link:hover {
            background-color: rgba(0, 0, 0, 0.05);
        }
        .sidebar .nav-link.active {
            background-color: rgba(0, 0, 0, 0.1);
        }
        .sidebar .nav-link i {
            margin-right: 10px;
        }
        .navbar-brand {
            padding-top: 0.75rem;
            padding-bottom: 0.75rem;
            font-size: 1.5rem;
            font-weight: bold;
            color: #333;
            display: flex;
            align-items: center;
        }
        .navbar-brand i {
            color: #4361ee;
            margin-right: 10px;
        }
        .navbar {
            background-color: white;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            position: fixed; /* Fix navbar to top */
            width: 100%;
            top: 0;
            z-index: 101;
            height: 56px; /* Set explicit height */
        }
        .navbar .navbar-toggler {
            border-color: rgba(0, 0, 0, 0.5);
        }
        .main-content {
            margin-left: 240px;
            padding: 2rem;
        }
        .card {
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            border: none;
        }
        .card-header {
            background-color: transparent;
            border-bottom: 1px solid rgba(0, 0, 0, 0.125);
            font-weight: 600;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .stats-card {
            text-align: left;
            height: 100%;
            display: flex;
            flex-direction: column;
        }
        .stats-card .card-body {
            padding: 1.5rem;
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        .stats-card .stat-value {
            font-size: 1.8rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
        }
        .stats-card .stat-change {
            font-size: 0.8rem;
            padding: 3px 8px;
            border-radius: 20px;
            display: inline-block;
        }
        .stats-card .positive-change {
            background-color: rgba(0, 200, 0, 0.1);
            color: #00b300;
        }
        .stats-card .negative-change {
            background-color: rgba(255, 0, 0, 0.1);
            color: #e60000;
        }
        .stats-card i {
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
        }
        .income-icon {
            color: #4CAF50;
        }
        .expense-icon {
            color: #F44336;
        }
        .balance-icon {
            color: #3F51B5;
        }
        .subscription-icon {
            color: #9C27B0;
        }
        .progress {
            height: 10px;
            margin-top: 5px;
            margin-bottom: 15px;
        }
        .goal-item {
            margin-bottom: 15px;
        }
        .goal-details {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }
        .notification-item {
            padding: 10px 0;
            border-bottom: 1px solid #eee;
        }
        .notification-item:last-child {
            border-bottom: none;
        }
        .notification-date {
            font-size: 0.8rem;
            color: #777;
        }
        .clock-display {
            position: absolute;
            bottom: 15px;
            right: 15px;
            background: #555;
            color: white;
            padding: 5px 15px;
            border-radius: 5px;
            font-size: 1.5rem;
            font-weight: bold;
        }
        .connect-bank-btn {
            background-color: #4361ee;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
        }
        .connect-bank-btn:hover {
            background-color: #3250b2;
        }
        .modal-body iframe {
            width: 100%;
            min-height: 500px;
            border: none;
        }
        .bank-connection-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 15px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 10px;
        }
        .bank-icon {
            width: 40px;
            height: 40px;
            margin-right: 15px;
            border-radius: 4px;
        }
        .bank-info {
            flex-grow: 1;
        }
        .bank-name {
            font-weight: 600;
            margin-bottom: 2px;
        }
        .bank-status {
            font-size: 0.8rem;
            color: #6c757d;
        }
        .bank-status.success {
            color: #28a745;
        }
        .bank-status.error {
            color: #dc3545;
        }
        .bank-status.pending {
            color: #ffc107;
        }
        .bank-actions {
            display: flex;
            gap: 8px;
        }
        .bank-actions button {
            border: none;
            background: none;
            color: #4361ee;
            cursor: pointer;
            padding: 5px;
        }
        .bank-actions button:hover {
            color: #3250b2;
        }
        /* Mobile responsive adjustments */
        @media (max-width: 767.98px) {
            .sidebar {
                position: static;
                height: auto;
                padding: 0;
                width: 100%;
                margin-top: 56px;
            }
            .main-content {
                margin-left: 0;
                margin-top: 56px; /* Add margin for fixed navbar */
                padding: 1rem;
            }
            .navbar {
                position: fixed;
            }
            .navbar-brand {
                font-size: 1.2rem;
            }
        }
        /* Additional styles for tiles */
        .tile-card {
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            height: 100%;
        }
        
        .tile-card:hover {
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
            transform: translateY(-5px);
        }
        
        .tile-card .card-body {
            display: flex;
            flex-direction: column;
            flex: 1;
            overflow: hidden; /* Prevent content from overflowing */
            position: relative; /* For positioning the clock */
        }
        
        .scrollable-content {
            scrollbar-width: thin;
            overflow-y: auto;
            flex: 1;
        }
        
        .scrollable-content::-webkit-scrollbar {
            width: 6px;
        }
        
        .scrollable-content::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        
        .scrollable-content::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 3px;
        }
        
        .scrollable-content::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        
        /* For modal content scrollability */
        #tile-modal-content {
            max-height: 70vh;
            overflow-y: auto;
            padding: 10px;
        }
        
        /* Mobile specific styles */
        @media (max-width: 767.98px) {
            .card-body {
                padding: 0.75rem;
            }
        }
        /* Logout button styling */
        .logout-button {
            margin-top: auto;
            padding: 10px 15px;
            background-color: #f8f9fa;
            border-top: 1px solid #eee;
        }
        
        .logout-button .nav-link {
            color: #dc3545 !important;
            font-weight: bold;
        }
        
        .logout-button .nav-link:hover {
            background-color: #f1f1f1;
        }
    </style>
</head>
<body>
    <!-- Top Navbar -->
    <nav class="navbar navbar-expand-lg navbar-light sticky-top">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">
                <i class="fas fa-wallet"></i> TaaxDog
            </a>
            <div class="d-flex">
                <button class="connect-bank-btn" id="connect-bank-button">
                    Connect Bank
            </button>
            </div>
        </div>
    </nav>

    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <nav id="sidebar" class="col-md-3 col-lg-2 d-md-block sidebar collapse">
                <div class="sidebar-sticky">
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link active" href="#">
                                <i class="fas fa-th-large"></i> Dashboard
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#">
                                <i class="fas fa-arrow-circle-up text-success"></i> Net Income
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#">
                                <i class="fas fa-arrow-circle-down text-danger"></i> Total Expenses
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#">
                                <i class="fas fa-balance-scale text-primary"></i> Net Balance
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#">
                                <i class="fas fa-credit-card text-info"></i> Subscriptions
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#">
                                <i class="fas fa-bullseye text-warning"></i> Goals
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#">
                                <i class="fas fa-user-circle"></i> Your Tax Profile
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#">
                                <i class="fas fa-file-invoice-dollar"></i> Tax Return
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#">
                                <i class="fas fa-bell"></i> Notifications
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#">
                                <i class="fas fa-cog"></i> Settings
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" id="receipts-nav-link">
                                <i class="fas fa-receipt text-success"></i> Receipts
                            </a>
                        </li>
                    </ul>
                    
                    <!-- Logout button at bottom of sidebar -->
                    <div class="logout-button mt-auto">
                        <ul class="nav flex-column">
                            <li class="nav-item">
                                <a class="nav-link d-flex align-items-center" href="#" id="logout-button">
                                    <i class="fas fa-sign-out-alt text-danger me-2"></i>
                                    <span>Log Out</span>
                            </a>
                        </li>
                    </ul>
                    </div>
                </div>
            </nav>

            <!-- Main Content -->
            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4 main-content">
                <div class="row mt-5">
                    <!-- First Row - Stats Cards -->
                    <div class="col-md-3 mb-4">
                        <div class="card stats-card">
                            <div class="card-header">
                                Net Income
                                <i class="fas fa-arrow-circle-up income-icon"></i>
                        </div>
                            <div class="card-body">
                                <div class="stat-value" id="net-income-value">$0.00</div>
                                <div class="stat-change positive-change">
                                    <i class="fas fa-arrow-up"></i> +12.3% from last month
                    </div>
                </div>
                    </div>
                </div>
                    <div class="col-md-3 mb-4">
                        <div class="card stats-card">
                            <div class="card-header">
                                Total Expenses
                                <i class="fas fa-arrow-circle-down expense-icon"></i>
                            </div>
                            <div class="card-body">
                                <div class="stat-value" id="total-expenses-value">$0.00</div>
                                <div class="stat-change negative-change">
                                    <i class="fas fa-arrow-down"></i> -8.1% from last month
                            </div>
                        </div>
                    </div>
                    </div>
                    <div class="col-md-3 mb-4">
                        <div class="card stats-card">
                            <div class="card-header">
                                Net Balance
                                <i class="fas fa-balance-scale balance-icon"></i>
                            </div>
                            <div class="card-body">
                                <div class="stat-value" id="net-balance-value">$0.00</div>
                                <div class="stat-change positive-change">
                                    <i class="fas fa-arrow-up"></i> +15.2% from last month
                            </div>
                        </div>
                    </div>
                    </div>
                    <div class="col-md-3 mb-4">
                        <div class="card stats-card">
                            <div class="card-header">
                                Monthly Subscriptions
                                <i class="fas fa-credit-card subscription-icon"></i>
                            </div>
                            <div class="card-body">
                                <div class="stat-value" id="subscriptions-value">$0.00</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Second Row - Goals, Notifications, and Bank Accounts -->
                <div class="row mt-3">
                    <!-- Left Side - Goals -->
                    <div class="col-md-6">
                        <!-- Goals Card -->
                        <div class="card tile-card h-100" data-tile-type="goals">
                            <div class="card-header">
                                Goals Progress
                                <i class="fas fa-bullseye text-warning"></i>
                            </div>
                            <div class="card-body">
                                <div class="scrollable-content">
                                    <h3>3 Active Goals</h3>
                                    <div class="stat-change positive-change mb-4">
                                        <i class="fas fa-check-circle"></i> 60% Complete from last month
                            </div>
                                    
                                    <!-- Emergency Fund Goal -->
                                    <div class="goal-item">
                                        <div class="goal-details">
                                            <span>Emergency Fund</span>
                                            <span class="text-success">$5000.00</span>
                        </div>
                                        <div class="progress">
                                            <div class="progress-bar bg-success" role="progressbar" style="width: 50%" aria-valuenow="50" aria-valuemin="0" aria-valuemax="100"></div>
                                        </div>
                                        <div class="d-flex justify-content-between">
                                            <small>$5000.00 of $10000.00</small>
                                            <small>Due: 30/06/2024</small>
                    </div>
                </div>

                                    <!-- New Car Goal -->
                                    <div class="goal-item">
                                        <div class="goal-details">
                                            <span>New Car</span>
                                            <span class="text-success">$2500.00</span>
                            </div>
                                        <div class="progress">
                                            <div class="progress-bar bg-success" role="progressbar" style="width: 16.7%" aria-valuenow="16.7" aria-valuemin="0" aria-valuemax="100"></div>
                        </div>
                                        <div class="d-flex justify-content-between">
                                            <small>$2500.00 of $15000.00</small>
                                            <small>Due: 31/12/2024</small>
                    </div>
                            </div>
                                    
                                    <!-- Holiday Goal -->
                                    <div class="goal-item">
                                        <div class="goal-details">
                                            <span>Holiday</span>
                                            <span class="text-success">$1200.00</span>
                        </div>
                                        <div class="progress">
                                            <div class="progress-bar bg-success" role="progressbar" style="width: 40%" aria-valuenow="40" aria-valuemin="0" aria-valuemax="100"></div>
                    </div>
                                        <div class="d-flex justify-content-between">
                                            <small>$1200.00 of $3000.00</small>
                                            <small>Due: 15/09/2024</small>
                            </div>
                        </div>
                    </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Right Side - Bank Accounts and Notifications -->
                    <div class="col-md-6">
                        <!-- Bank Accounts Card -->
                        <div class="card tile-card mb-3" data-tile-type="bank-accounts" style="height: calc(50% - 10px);">
                            <div class="card-header">
                                Bank Accounts
                                <i class="fas fa-university text-primary"></i>
                            </div>
                            <div class="card-body">
                                <div class="scrollable-content">
                                    <div id="bank-connections-container">
                                        <!-- Bank connections will be loaded here -->
                                        <div class="text-center py-4" id="no-connections-message">
                                            <i class="fas fa-university fa-3x mb-3 text-muted"></i>
                                            <p>No bank accounts connected yet. Click the "Connect Bank" button in the top-right corner to get started.</p>
                                        </div>
                                        <div id="connections-list" style="display: none;">
                                            <!-- Bank connections will be loaded here -->
                                        </div>
                            </div>
                        </div>
                    </div>
                </div>

                        <!-- Notifications Card -->
                        <div class="card tile-card" data-tile-type="notifications" style="height: calc(50% - 10px);">
                            <div class="card-header">
                                Notifications
                                <i class="fas fa-bell text-warning"></i>
                            </div>
                            <div class="card-body">
                                <div class="scrollable-content">
                                    <h3>2 New Updates</h3>
                                    
                                    <!-- Notifications List -->
                                    <div class="notification-item">
                                        <h5>Tax Return Due</h5>
                                        <p>Your tax return is due in 2 weeks</p>
                                        <p class="notification-date">15/03/2024</p>
                                    </div>
                                    
                                    <div class="notification-item">
                                        <h5>Goal Milestone</h5>
                                        <p>Emergency Fund reached 75% of target</p>
                                        <p class="notification-date">10/03/2024</p>
                                    </div>
                                </div>
                                
                                <!-- Clock Display -->
                                <div class="clock-display">
                                    <span id="hours">14</span>:<span id="minutes">31</span>
                                    <div class="d-flex justify-content-between">
                                        <small>min</small>
                                        <small>hour</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Third Row - Receipts Section (initially hidden) -->
                <div class="row mt-3" id="receipts-section" style="display: none;">
                    <div class="col-12">
                        <div class="card shadow-sm mb-4">
                            <div class="card-header bg-white d-flex justify-content-between align-items-center py-3">
                                <h5 class="mb-0"><i class="fas fa-receipt text-primary me-2"></i>Receipts</h5>
                                <button class="btn btn-primary" id="upload-receipt-btn">
                                    <i class="fas fa-plus me-1"></i> Upload New Receipt
                                </button>
                            </div>
                            <div class="card-body">
                                <!-- Search and Filter Bar -->
                                <div class="row mb-4">
                                    <div class="col-md-4 mb-2 mb-md-0">
                                        <div class="input-group">
                                            <input type="text" class="form-control border-end-0" id="receipt-search" placeholder="Search merchant, items...">
                                            <button class="btn btn-outline-secondary border-start-0 bg-white" type="button" id="receipt-search-btn">
                                                <i class="fas fa-search text-muted"></i>
                                            </button>
                                        </div>
                                    </div>
                                    <div class="col-md-3 mb-2 mb-md-0">
                                        <select class="form-select" id="receipt-category-filter">
                                            <option value="">All Categories</option>
                                            <option value="groceries">Groceries</option>
                                            <option value="dining">Dining & Restaurants</option>
                                            <option value="entertainment">Entertainment</option>
                                            <option value="transportation">Transportation</option>
                                            <option value="utilities">Utilities</option>
                                            <option value="housing">Housing & Rent</option>
                                            <option value="healthcare">Healthcare</option>
                                            <option value="education">Education</option>
                                            <option value="shopping">Shopping</option>
                                            <option value="travel">Travel</option>
                                            <option value="business">Business Expenses</option>
                                            <option value="other">Other</option>
                                        </select>
                                    </div>
                                    <div class="col-md-3 mb-2 mb-md-0">
                                        <select class="form-select" id="receipt-date-filter">
                                            <option value="all">All Time</option>
                                            <option value="today">Today</option>
                                            <option value="week">This Week</option>
                                            <option value="month">This Month</option>
                                            <option value="quarter">This Quarter</option>
                                            <option value="year">This Year</option>
                                        </select>
                                    </div>
                                    <div class="col-md-2">
                                        <button class="btn btn-outline-secondary w-100" id="reset-filters-btn">
                                            <i class="fas fa-undo me-1"></i> Reset
                                        </button>
                                    </div>
                                </div>
                                
                                <div id="no-receipts-message" style="display: none;" class="text-center p-5">
                                    <div class="mb-4">
                                        <i class="fas fa-receipt fa-4x text-secondary opacity-50"></i>
                                    </div>
                                    <h5 class="text-muted mb-3">No receipts found</h5>
                                    <p class="text-muted mb-4">Upload your first receipt to start tracking your expenses</p>
                                    <button class="btn btn-primary btn-lg" id="upload-first-receipt-btn">
                                        <i class="fas fa-plus me-2"></i> Upload Your First Receipt
                                    </button>
                                </div>
                                
                                <div id="receipts-list" style="display: none;">
                                    <div class="table-responsive rounded">
                                        <table class="table table-hover align-middle">
                                            <thead class="table-light">
                                                <tr>
                                                    <th class="ps-3">Date</th>
                                                    <th>Merchant</th>
                                                    <th>Category</th>
                                                    <th>Amount</th>
                                                    <th>Status</th>
                                                    <th class="text-end pe-3">Actions</th>
                                                </tr>
                                            </thead>
                                            <tbody id="receipts-table-body">
                                                <!-- Receipts will be loaded here -->
                                            </tbody>
                                        </table>
                                    </div>
                                    <div class="d-flex justify-content-between align-items-center mt-3">
                                        <div>
                                            <span class="text-muted">Showing <span id="receipts-count">0</span> receipts</span>
                                        </div>
                                        <nav aria-label="Receipt pagination">
                                            <ul class="pagination pagination-sm" id="receipts-pagination">
                                                <!-- Pagination will be added here -->
                                            </ul>
                                        </nav>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Receipt Statistics Card -->
                        <div class="card shadow-sm mb-4">
                            <div class="card-header bg-white py-3">
                                <h5 class="mb-0"><i class="fas fa-chart-pie text-primary me-2"></i>Receipt Summary</h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-3 mb-3 mb-md-0">
                                        <div class="card border-0 bg-light h-100">
                                            <div class="card-body text-center">
                                                <h6 class="text-muted mb-2">Total Receipts</h6>
                                                <h3 id="total-receipts-count">0</h3>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-3 mb-3 mb-md-0">
                                        <div class="card border-0 bg-light h-100">
                                            <div class="card-body text-center">
                                                <h6 class="text-muted mb-2">Total Spent</h6>
                                                <h3 id="total-receipts-amount">$0.00</h3>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-3 mb-3 mb-md-0">
                                        <div class="card border-0 bg-light h-100">
                                            <div class="card-body text-center">
                                                <h6 class="text-muted mb-2">Matched Receipts</h6>
                                                <h3 id="matched-receipts-count">0</h3>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="card border-0 bg-light h-100">
                                            <div class="card-body text-center">
                                                <h6 class="text-muted mb-2">Average Amount</h6>
                                                <h3 id="average-receipt-amount">$0.00</h3>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Bank Connection Modal -->
    <div class="modal fade" id="bankConnectionModal" tabindex="-1" aria-labelledby="bankConnectionModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="bankConnectionModalLabel">Connect Your Bank Account</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="bank-connect-form" class="p-3">
                        <p class="lead mb-4">Please select your bank and enter your credentials to securely connect your account.</p>
                        
                        <div class="mb-3">
                            <label for="bankSelection" class="form-label">Select Your Bank</label>
                            <select class="form-select" id="bankSelection" required>
                                <option value="" selected disabled>Choose your bank...</option>
                                <option value="au-cba">Commonwealth Bank</option>
                                <option value="au-nab">NAB</option>
                                <option value="au-anz">ANZ</option>
                                <option value="au-westpac">Westpac</option>
                                <option value="au-ing">ING</option>
                                <option value="au-macquarie">Macquarie Bank</option>
                                <option value="au-bankwest">Bankwest</option>
                                <option value="au-stgeorge">St.George</option>
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label for="bankUsername" class="form-label">Bank Username/ID</label>
                            <input type="text" class="form-control" id="bankUsername" placeholder="Your bank login username" required>
                        </div>
                        
                        <div class="mb-3">
                            <label for="bankPassword" class="form-label">Bank Password</label>
                            <input type="password" class="form-control" id="bankPassword" placeholder="Your bank login password" required>
                            <div class="form-text">Your credentials are securely transmitted and never stored on our servers.</div>
                        </div>
                        
                        <div class="form-check mb-4">
                            <input class="form-check-input" type="checkbox" id="termsCheck" required>
                            <label class="form-check-label" for="termsCheck">
                                I agree to the <a href="#" data-bs-toggle="modal" data-bs-target="#termsModal">terms and conditions</a> for bank account connectivity
                            </label>
                        </div>
                        
                        <button type="button" id="connect-bank-submit" class="btn btn-primary">Connect</button>
                    </div>
                    
                    <div id="auth-link-container" class="text-center p-3" style="display: none;">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-3">Establishing secure connection to your bank...</p>
                    </div>
                    <iframe id="auth-link-iframe" style="display: none;" title="Bank Connection"></iframe>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Terms and Conditions Modal -->
    <div class="modal fade" id="termsModal" tabindex="-1" aria-labelledby="termsModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="termsModalLabel">Terms and Conditions</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>By connecting your bank account, you agree to allow TAAXDOG to:</p>
                    <ul>
                        <li>Access your account and transaction data through the Basiq API</li>
                        <li>Use your data to provide financial insights and reports</li>
                        <li>Store necessary information to maintain the connection</li>
                    </ul>
                    <p>Your login credentials are transmitted securely and are not stored by TAAXDOG. All data is handled according to our privacy policy.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" data-bs-dismiss="modal">I Understand</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Tile Content Modal -->
    <div class="modal fade" id="tileContentModal" tabindex="-1" aria-labelledby="tileContentModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="tileContentModalLabel">Tile Content</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="tile-modal-content">
                        <!-- Tile content will be loaded here -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" id="add-goal-button" class="btn btn-primary" style="display: none;">Add New Goal</button>
                    <button type="button" id="add-bank-button" class="btn btn-primary" style="display: none;">Add New Bank Account</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Receipt Upload Modal -->
    <div class="modal fade" id="receipt-upload-modal" tabindex="-1" aria-labelledby="receipt-upload-modal-label" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="receipt-upload-modal-label">Add Receipt</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- Method selection tabs -->
                    <ul class="nav nav-tabs mb-3" id="receipt-method-tabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="manual-tab" data-bs-toggle="tab" data-bs-target="#manual-entry" type="button" role="tab" aria-controls="manual-entry" aria-selected="true">
                                <i class="fas fa-keyboard me-2"></i>Manual Entry
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="upload-tab" data-bs-toggle="tab" data-bs-target="#upload-receipt" type="button" role="tab" aria-controls="upload-receipt" aria-selected="false">
                                <i class="fas fa-upload me-2"></i>Upload Image
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="camera-tab" data-bs-toggle="tab" data-bs-target="#camera-capture" type="button" role="tab" aria-controls="camera-capture" aria-selected="false">
                                <i class="fas fa-camera me-2"></i>Take Photo
                            </button>
                        </li>
                    </ul>
                    
                    <!-- Tab content -->
                    <div class="tab-content" id="receipt-tabs-content">
                        <!-- Manual Entry Tab -->
                        <div class="tab-pane fade show active" id="manual-entry" role="tabpanel" aria-labelledby="manual-tab">
                            <form id="manual-receipt-form">
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="manual-merchant" class="form-label">Merchant/Store</label>
                                        <input type="text" class="form-control" id="manual-merchant" required>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="manual-date" class="form-label">Date</label>
                                        <input type="date" class="form-control" id="manual-date" required>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="manual-total" class="form-label">Total Amount</label>
                                        <div class="input-group">
                                            <span class="input-group-text">$</span>
                                            <input type="number" step="0.01" min="0" class="form-control" id="manual-total" required>
                                        </div>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="manual-tax" class="form-label">Tax Amount (Optional)</label>
                                        <div class="input-group">
                                            <span class="input-group-text">$</span>
                                            <input type="number" step="0.01" min="0" class="form-control" id="manual-tax">
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="manual-category" class="form-label">Category</label>
                                        <select class="form-select" id="manual-category">
                                            <option value="Food and Dining">Food and Dining</option>
                                            <option value="Shopping">Shopping</option>
                                            <option value="Travel">Travel</option>
                                            <option value="Entertainment">Entertainment</option>
                                            <option value="Office">Office</option>
                                            <option value="Groceries">Groceries</option>
                                            <option value="Automotive">Automotive</option>
                                            <option value="Utilities">Utilities</option>
                                            <option value="Healthcare">Healthcare</option>
                                            <option value="Other">Other</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="manual-notes" class="form-label">Notes (Optional)</label>
                                        <textarea class="form-control" id="manual-notes" rows="1"></textarea>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Receipt Items (Optional)</label>
                                    <div id="manual-items-container">
                                        <!-- Items will be added here -->
                                    </div>
                                    <button type="button" id="add-item-btn" class="btn btn-sm btn-outline-secondary mt-2">
                                        <i class="fas fa-plus"></i> Add Item
                                    </button>
                                </div>
                                <div class="d-grid">
                                    <button type="button" id="manual-submit" class="btn btn-primary" onclick="saveManualReceipt()">Save Receipt</button>
                                </div>
                            </form>
                        </div>
                        
                        <!-- Upload Image Tab -->
                        <div class="tab-pane fade" id="upload-receipt" role="tabpanel" aria-labelledby="upload-tab">
                            <form id="receipt-upload-form">
                                <div class="mb-3">
                                    <label for="receipt-image" class="form-label">Receipt Image</label>
                                    <input type="file" class="form-control" id="receipt-image" accept="image/*" required>
                                    <div class="form-text">Upload a clear image of your receipt.</div>
                                </div>
                                <div class="mb-3">
                                    <label for="receipt-ocr-provider" class="form-label">OCR Provider</label>
                                    <select class="form-select" id="receipt-ocr-provider">
                                        <option value="docuclipper" selected>DocuClipper (Standard)</option>
                                        <option value="tabscanner">Tabscanner (Enhanced)</option>
                                    </select>
                                    <div class="form-text">Choose which OCR service to use for processing your receipt.</div>
                                </div>
                                <div class="mb-3">
                                    <label for="receipt-category" class="form-label">Category</label>
                                    <select class="form-select" id="receipt-category">
                                        <option value="Food and Dining">Food and Dining</option>
                                        <option value="Shopping">Shopping</option>
                                        <option value="Travel">Travel</option>
                                        <option value="Entertainment">Entertainment</option>
                                        <option value="Office">Office</option>
                                        <option value="Groceries">Groceries</option>
                                        <option value="Automotive">Automotive</option>
                                        <option value="Utilities">Utilities</option>
                                        <option value="Healthcare">Healthcare</option>
                                        <option value="Other">Other</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label for="receipt-notes" class="form-label">Notes (Optional)</label>
                                    <textarea class="form-control" id="receipt-notes" rows="3"></textarea>
                                </div>
                                <div class="mb-3">
                                    <div id="receipt-preview-container" style="display: none;">
                                        <h6>Preview:</h6>
                                        <img id="receipt-preview" src="" alt="Receipt Preview" style="max-width: 100%; max-height: 300px;">
                                    </div>
                                </div>
                                
                                <div class="alert alert-info" role="alert">
                                    <i class="fas fa-info-circle"></i> Our system will automatically extract information from your receipt image.
                                </div>
                                
                                <div class="d-grid">
                                    <button type="button" id="receipt-upload-submit" class="btn btn-primary" onclick="processReceiptUpload()">Process Receipt</button>
                                </div>
                            </form>
                        </div>
                        
                        <!-- Camera Capture Tab -->
                        <div class="tab-pane fade" id="camera-capture" role="tabpanel" aria-labelledby="camera-tab">
                            <div class="mb-3">
                                <div id="camera-container" class="text-center">
                                    <video id="camera-video" autoplay playsinline style="max-width: 100%; max-height: 300px; display: none;"></video>
                                    <canvas id="camera-canvas" style="display: none;"></canvas>
                                    <img id="camera-preview" style="max-width: 100%; max-height: 300px; display: none;" alt="Captured Receipt">
                                    
                                    <div id="camera-placeholder" class="py-5 border rounded bg-light text-center">
                                        <i class="fas fa-camera fa-3x mb-3 text-muted"></i>
                                        <p>Click the button below to access your camera</p>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="d-grid gap-2 mb-3">
                                <button type="button" id="camera-start-btn" class="btn btn-outline-primary" onclick="startCamera()">
                                    <i class="fas fa-camera me-2"></i>Start Camera
                                </button>
                                <button type="button" id="camera-capture-btn" class="btn btn-primary" style="display: none;">
                                    <i class="fas fa-camera me-2"></i>Capture Receipt
                                </button>
                                <button type="button" id="camera-retake-btn" class="btn btn-outline-secondary" style="display: none;">
                                    <i class="fas fa-redo me-2"></i>Retake Photo
                                </button>
                                <button type="button" id="camera-submit-btn" class="btn btn-success" style="display: none;">
                                    <i class="fas fa-check me-2"></i>Use This Photo
                                </button>
                            </div>
                            
                            <div class="alert alert-info" role="alert">
                                <i class="fas fa-info-circle"></i> Take a clear photo of your receipt in good lighting for best results.
                            </div>
                        </div>
                    </div>
                    
                    <div id="receipt-upload-progress" style="display: none;">
                        <div class="progress mb-3">
                            <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%"></div>
                        </div>
                        <p id="receipt-upload-status">Processing receipt...</p>
                    </div>
                    
                    <div id="receipt-upload-result" style="display: none;">
                        <!-- Result will be shown here -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" id="create-mock-receipt" class="btn btn-outline-secondary">Create Mock Receipt</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-success" id="upload-another-receipt" style="display: none;">Upload Another</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Receipt Detail Modal -->
    <div class="modal fade" id="receipt-detail-modal" tabindex="-1" aria-labelledby="receipt-detail-modal-label" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="receipt-detail-modal-label">Receipt Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card mb-3">
                                <div class="card-header">Receipt Information</div>
                                <div class="card-body">
                                    <div class="row mb-2">
                                        <div class="col-4 text-muted">Merchant:</div>
                                        <div class="col-8" id="detail-merchant"></div>
                                    </div>
                                    <div class="row mb-2">
                                        <div class="col-4 text-muted">Date:</div>
                                        <div class="col-8" id="detail-date"></div>
                                    </div>
                                    <div class="row mb-2">
                                        <div class="col-4 text-muted">Total:</div>
                                        <div class="col-8" id="detail-total"></div>
                                    </div>
                                    <div class="row mb-2">
                                        <div class="col-4 text-muted">Tax:</div>
                                        <div class="col-8" id="detail-tax"></div>
                                    </div>
                                    <div class="row mb-2">
                                        <div class="col-4 text-muted">Category:</div>
                                        <div class="col-8">
                                            <select class="form-select form-select-sm" id="detail-category">
                                                <option value="groceries">Groceries</option>
                                                <option value="dining">Dining & Restaurants</option>
                                                <option value="entertainment">Entertainment</option>
                                                <option value="transportation">Transportation</option>
                                                <option value="utilities">Utilities</option>
                                                <option value="housing">Housing & Rent</option>
                                                <option value="healthcare">Healthcare</option>
                                                <option value="education">Education</option>
                                                <option value="shopping">Shopping</option>
                                                <option value="travel">Travel</option>
                                                <option value="business">Business Expenses</option>
                                                <option value="other">Other</option>
                                            </select>
                                            <button class="btn btn-sm btn-outline-primary mt-1" id="update-category-btn">Update</button>
                                        </div>
                                    </div>
                                    <div class="row mb-2">
                                        <div class="col-4 text-muted">Notes:</div>
                                        <div class="col-8">
                                            <textarea class="form-control form-control-sm" id="detail-notes" rows="2"></textarea>
                                            <button class="btn btn-sm btn-outline-primary mt-1" id="update-notes-btn">Update</button>
                                        </div>
                                    </div>
                                    <div class="row mb-2">
                                        <div class="col-4 text-muted">Receipt ID:</div>
                                        <div class="col-8" id="detail-receipt-id"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card mb-3">
                                <div class="card-header">Transaction Match</div>
                                <div class="card-body">
                                    <div id="no-match-message" style="display: none;">
                                        <p>No transaction matched with this receipt.</p>
                                        <button class="btn btn-sm btn-outline-primary" id="find-match-btn">Find Match</button>
                                    </div>
                                    <div id="match-details" style="display: none;">
                                        <div class="row mb-2">
                                            <div class="col-4 text-muted">Transaction:</div>
                                            <div class="col-8" id="detail-transaction-desc"></div>
                                        </div>
                                        <div class="row mb-2">
                                            <div class="col-4 text-muted">Amount:</div>
                                            <div class="col-8" id="detail-transaction-amount"></div>
                                        </div>
                                        <div class="row mb-2">
                                            <div class="col-4 text-muted">Date:</div>
                                            <div class="col-8" id="detail-transaction-date"></div>
                                        </div>
                                        <div class="row mb-2">
                                            <div class="col-4 text-muted">Confidence:</div>
                                            <div class="col-8" id="detail-match-confidence"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">Receipt Items</div>
                        <div class="card-body">
                            <div id="no-items-message" style="display: none;">
                                <p>No detailed items were extracted from this receipt.</p>
                            </div>
                            <div id="items-table-container" style="display: none;">
                                <div class="table-responsive">
                                    <table class="table table-sm">
                                        <thead>
                                            <tr>
                                                <th>Item</th>
                                                <th>Quantity</th>
                                                <th>Unit Price</th>
                                                <th>Total</th>
                                            </tr>
                                        </thead>
                                        <tbody id="items-table-body">
                                            <!-- Items will be loaded here -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-danger" id="delete-receipt-btn">Delete</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Firebase App (the core Firebase SDK) -->
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-auth-compat.js"></script>
    
    <!-- Add this Firebase config and initialization code -->
    <script src="firebase-config.js"></script>
    <script>
        // Initialize Firebase with imported config
        if (typeof firebaseConfig !== 'undefined') {
            console.log('Initializing Firebase with config');
            firebase.initializeApp(firebaseConfig);
        } else {
            console.error('Firebase config is missing. Create a firebase-config.js file with your Firebase configuration.');
            // Fallback for development/testing only - DO NOT use in production
            firebase.initializeApp({
                apiKey: "demo-key-for-development",
                authDomain: "taaxdog-demo.firebaseapp.com",
                projectId: "taaxdog-demo",
                storageBucket: "taaxdog-demo.appspot.com",
                messagingSenderId: "123456789012",
                appId: "1:123456789012:web:abcdef1234567890abcdef"
            });
        }
        
        // Initialize simulated auth for development if no real auth
        function initSimulatedAuth() {
            console.log('Initializing simulated auth for development');
            // Only simulate if not already logged in
            if (!firebase.auth().currentUser) {
                // Create a simulated user for development
                const simulatedUser = {
                    uid: 'sim-user-' + Date.now(),
                    email: 'demo@example.com',
                    displayName: 'Demo User',
                    getIdToken: () => Promise.resolve('demo-token')
                };
                
                // Override the auth methods to use the simulated user
                const originalCurrentUser = firebase.auth().currentUser;
                const originalGetIdToken = firebase.auth().currentUser?.getIdToken;
                
                // Only override if not already set
                if (!originalCurrentUser) {
                    Object.defineProperty(firebase.auth(), 'currentUser', {
                        get: function() { return simulatedUser; }
                    });
                    
                    firebase.auth().getIdToken = () => Promise.resolve('demo-token');
                }
            }
        }
        
        // Check if we're in development mode and initialize simulated auth
        if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
            console.log('Development environment detected, using simulated auth if needed');
            setTimeout(initSimulatedAuth, 1000); // Give real auth a chance to initialize first
        }
        
        // Add this right at the top of your script section
        console.log('Script loading...');

        // Global variables to track financial data
        let globalStats = {
            netIncome: 0,
            totalExpenses: 0,
            netBalance: 0,
            subscriptions: 0,
            receiptsTotal: 0
        };

        // Format currency helper function
        function formatCurrency(amount) {
            if (amount === undefined || amount === null) {
                return '';
            }
            
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD'
            }).format(amount);
        }

        // Update dashboard stats based on all data
        function updateDashboardStats() {
            console.log('Updating dashboard stats with:', globalStats);
            
            // Update the stats cards
            document.getElementById('net-income-value').textContent = formatCurrency(globalStats.netIncome);
            document.getElementById('total-expenses-value').textContent = formatCurrency(globalStats.totalExpenses);
            document.getElementById('net-balance-value').textContent = formatCurrency(globalStats.netBalance);
            document.getElementById('subscriptions-value').textContent = formatCurrency(globalStats.subscriptions);
        }

        // When page loads, set up receipts functionality immediately
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM fully loaded');
            
            // Setup receipts functionality
            setupReceiptsFunctionality();
            
            // Setup upload receipt button functionality
            setupUploadReceiptFunctionality();
            
            // Setup navigation menu
            setupNavigationMenu();
            
            // Initialize financial data
            initializeFinancialData();
            
            // Setup tiles click behavior
            setupTilesClickBehavior();
            
            // Add event listener for dashboard navigation to refresh stats
            document.querySelector('.sidebar .nav-link:first-child').addEventListener('click', function() {
                console.log('Dashboard link clicked, refreshing stats');
                updateDashboardStats();
            });
            
            // Other existing event handlers...
            // ... existing code ...
        });

        // Initialize the dashboard with sample financial data
        function initializeFinancialData() {
            console.log('Initializing financial data');
            
            // First try to load saved stats
            const statsLoaded = loadFinancialStats();
            
            if (!statsLoaded) {
                console.log('No saved stats found, using sample data');
                
                // For demonstration, we'll use sample data
                // In a real app, this would come from an API call
                
                // Start with bank connections data
                let connectionTotal = 0;
                const bankConnections = getSavedBankConnections();
                
                bankConnections.forEach(connection => {
                    if (connection.balance) {
                        connectionTotal += parseFloat(connection.balance);
                    }
                });
                
                // Simulate some expenses (we'll also add receipts data later)
                globalStats.totalExpenses = 1245.67;
                
                // Simulate some income
                globalStats.netIncome = 3500.00;
                
                // Calculate balance
                globalStats.netBalance = globalStats.netIncome - globalStats.totalExpenses;
                
                // Simulate subscriptions
                globalStats.subscriptions = 86.99;
                
                // Save initial stats
                saveFinancialStats();
            }
            
            // Now load receipts and add their totals
            loadReceiptsForStats();
            
            // Initial dashboard update
            updateDashboardStats();
        }

        // Load receipts specifically to update stats
        function loadReceiptsForStats() {
            console.log('Loading receipts for stats update');
            
            // In development mode with simulated auth
            if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
                // Simulate receipt data for development
                setTimeout(() => {
                    // Add sample receipt totals to expenses
                    const receiptTotal = 78.94; // Example total from receipts
                    globalStats.receiptsTotal += receiptTotal;
                    globalStats.totalExpenses += receiptTotal;
                    globalStats.netBalance = globalStats.netIncome - globalStats.totalExpenses;
                    
                    // Update the dashboard
                    updateDashboardStats();
                    console.log('Updated stats with simulated receipt data');
                }, 500);
                return;
            }
        
        // Check if user is logged in
            if (!firebase.auth().currentUser) {
                console.error('User not logged in, cannot load receipts for stats');
                return;
            }
            
            // Get the Firebase ID token
            firebase.auth().currentUser.getIdToken(true)
                .then(idToken => {
                    console.log('Got Firebase ID token, fetching receipts for stats');
                    // Fetch receipts from API
                    return fetch('/api/receipts', {
                        headers: {
                            'Authorization': idToken
                        }
                    });
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Failed to load receipts. Server returned: ' + response.status);
                    }
                    
                    return response.json();
                })
                .then(data => {
                    if (!data.success) {
                        throw new Error(data.error || 'Failed to load receipts.');
                    }
                    
                    const receipts = data.receipts || [];
                    
                    // Calculate receipt totals
                    let receiptTotal = 0;
                    receipts.forEach(receipt => {
                        if (receipt.total_amount) {
                            receiptTotal += parseFloat(receipt.total_amount);
                        }
                    });
                    
                    // Update global stats
                    globalStats.receiptsTotal = receiptTotal;
                    globalStats.totalExpenses += receiptTotal;
                    globalStats.netBalance = globalStats.netIncome - globalStats.totalExpenses;
                    
                    // Update the dashboard
                    updateDashboardStats();
                })
                .catch(error => {
                    console.error('Error loading receipts for stats:', error);
                });
        }

        // Setup links in the left navigation menu
        function setupNavigationMenu() {
            console.log('Setting up navigation menu links');
            
            // Get all nav links
            const navLinks = document.querySelectorAll('.sidebar .nav-link');
            
            // Get all main content rows
            const mainRows = document.querySelectorAll('main .row:not(#receipts-section)');
            const receiptsSection = document.getElementById('receipts-section');
            
            // Add click event to all nav links
            navLinks.forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    
                    // Only process if not already active
                    if (!this.classList.contains('active')) {
                        console.log('Nav link clicked:', this.textContent.trim());
                        
                        // Remove active class from all links
                        navLinks.forEach(l => l.classList.remove('active'));
                        
                        // Add active class to clicked link
                        this.classList.add('active');
                        
                        // Handle special case for Receipts
                        if (this.id === 'receipts-nav-link') {
                            // Hide all main rows
                            mainRows.forEach(row => row.style.display = 'none');
                            
                            // Show receipts section
                            if (receiptsSection) {
                                receiptsSection.style.display = 'flex';
                                
                                // Load receipts if not already loaded
                                try {
                                    loadReceipts();
                } catch (error) {
                                    console.error('Error loading receipts:', error);
                                }
                            }
                            return;
                        }
                        
                        // For other links, show the main dashboard
                        // Hide receipts section
                        if (receiptsSection) {
                            receiptsSection.style.display = 'none';
                        }
                        
                        // Show all main rows
                        mainRows.forEach(row => row.style.display = '');
                        
                        // Update dashboard stats when returning to dashboard
                        updateDashboardStats();
                        
                        // Scroll to specific section if needed
                        // This maps menu items to their corresponding dashboard sections
                        const sectionMap = {
                            'Dashboard': null, // Just refresh the stats
                            'Net Income': document.querySelector('.stats-card:nth-child(1)'),
                            'Total Expenses': document.querySelector('.stats-card:nth-child(2)'),
                            'Net Balance': document.querySelector('.stats-card:nth-child(3)'),
                            'Subscriptions': document.querySelector('.stats-card:nth-child(4)'),
                            'Goals': document.querySelector('[data-tile-type="goals"]'),
                            'Notifications': document.querySelector('[data-tile-type="notifications"]'),
                            'Your Tax Profile': null, // Will implement when this section exists
                            'Tax Return': null, // Will implement when this section exists
                            'Settings': null, // Will implement when this section exists
                        };
                        
                        // Get the text of the clicked link
                        const linkText = this.textContent.trim();
                        
                        // Find the corresponding section
                        const section = sectionMap[linkText];
                        
                        // If we found a section, scroll to it
                        if (section) {
                            section.scrollIntoView({ behavior: 'smooth' });
                            
                            // Add a subtle highlight effect
                            section.style.transition = 'box-shadow 0.3s ease, transform 0.3s ease';
                            section.style.boxShadow = '0 0 20px rgba(67, 97, 238, 0.6)';
                            section.style.transform = 'scale(1.02)';
                            
                            // Remove highlight after a delay
                            setTimeout(() => {
                                section.style.boxShadow = '';
                                section.style.transform = 'scale(1)';
                            }, 1500);
                        }
                    }
                });
            });
            
            // Set Dashboard as active by default
            const dashboardLink = document.querySelector('.sidebar .nav-link:first-child');
            if (dashboardLink && !dashboardLink.classList.contains('active')) {
                dashboardLink.classList.add('active');
            }
        }

        // Setup click behavior for dashboard tiles
        function setupTilesClickBehavior() {
            console.log('Setting up tiles click behavior');
            
            // Get all tile cards
            const tileCards = document.querySelectorAll('.tile-card');
            
            // Get the modal elements
            const tileModal = new bootstrap.Modal(document.getElementById('tileContentModal'));
            const modalTitle = document.getElementById('tileContentModalLabel');
            const modalContent = document.getElementById('tile-modal-content');
            const addGoalButton = document.getElementById('add-goal-button');
            const addBankButton = document.getElementById('add-bank-button');
            
            // Add click event to all tile cards
            tileCards.forEach(card => {
                card.addEventListener('click', function() {
                    console.log('Tile clicked:', this.dataset.tileType);
                    
                    // Set the modal title based on the tile type
                    const tileType = this.dataset.tileType;
                    
                    // Hide all special buttons
                    addGoalButton.style.display = 'none';
                    addBankButton.style.display = 'none';
                    
                    switch (tileType) {
                        case 'goals':
                            modalTitle.textContent = 'Goals Progress';
                            const goalsContent = this.querySelector('.scrollable-content').cloneNode(true);
                            modalContent.innerHTML = '';
                            modalContent.appendChild(goalsContent);
                            addGoalButton.style.display = 'block';
                            break;
                            
                        case 'bank-accounts':
                            modalTitle.textContent = 'Bank Accounts';
                            const bankContent = this.querySelector('.scrollable-content').cloneNode(true);
                            modalContent.innerHTML = '';
                            modalContent.appendChild(bankContent);
                            addBankButton.style.display = 'block';
                            break;
                            
                        case 'notifications':
                            modalTitle.textContent = 'Notifications';
                            const notifContent = this.querySelector('.scrollable-content').cloneNode(true);
                            modalContent.innerHTML = '';
                            modalContent.appendChild(notifContent);
                            break;
                            
                        default:
                            modalTitle.textContent = 'Tile Content';
                            modalContent.innerHTML = '<p>No content available.</p>';
                    }
                    
                    // Show the modal
                    tileModal.show();
                });
            });
        }

        // Add receipt to the total expenses when uploaded
        function addReceiptToExpenses(receipt) {
            console.log('Adding receipt to expenses:', receipt);
            
            if (receipt && receipt.total_amount) {
                const amount = parseFloat(receipt.total_amount);
                
                // Update global stats
                globalStats.receiptsTotal += amount;
                globalStats.totalExpenses += amount;
                globalStats.netBalance = globalStats.netIncome - globalStats.totalExpenses;
                
                // Update the dashboard
                updateDashboardStats();
                
                // Save the updated stats to localStorage for persistence
                saveFinancialStats();
                
                console.log('Updated expenses with receipt amount:', amount);
            }
        }

        // Add function to save and load financial stats for persistence
        function saveFinancialStats() {
            console.log('Saving financial stats to localStorage');
            localStorage.setItem('taaxdogFinancialStats', JSON.stringify(globalStats));
        }
        
        function loadFinancialStats() {
            console.log('Loading financial stats from localStorage');
            const savedStats = localStorage.getItem('taaxdogFinancialStats');
            if (savedStats) {
                try {
                    const parsedStats = JSON.parse(savedStats);
                    // Merge saved stats with global stats, keeping default values if not in saved
                    globalStats = {...globalStats, ...parsedStats};
                    console.log('Loaded financial stats:', globalStats);
                    return true;
                } catch (error) {
                    console.error('Error parsing saved financial stats:', error);
                }
            }
            return false;
        }

        // Moved receipts functionality into a separate function for clarity
        function setupReceiptsFunctionality() {
            console.log('Setting up receipts functionality');
            
            // Receipts navigation link
            const receiptsNavLink = document.getElementById('receipts-nav-link');
            console.log('Receipts nav link found:', !!receiptsNavLink);
            
            const receiptsSection = document.getElementById('receipts-section');
            console.log('Receipts section found:', !!receiptsSection);

            // ADDED: Setup Upload Receipt Button explicitly
            const uploadReceiptBtn = document.getElementById('upload-receipt-btn');
            if (uploadReceiptBtn) {
                console.log('Upload Receipt Button found, setting up click handler');
                uploadReceiptBtn.addEventListener('click', function() {
                    console.log('Upload Receipt Button clicked!');
                    const receiptUploadModal = new bootstrap.Modal(document.getElementById('receipt-upload-modal'));
                    receiptUploadModal.show();
                });
            } else {
                console.error('Upload Receipt Button not found!');
            }
            
            if (receiptsNavLink && receiptsSection) {
                console.log('Adding click event to receipts nav link');
                
                receiptsNavLink.addEventListener('click', function(e) {
                    console.log('Receipts link clicked!');
            e.preventDefault();
                    
                    // Hide all main content rows except receipts
                    document.querySelectorAll('main .row').forEach(row => {
                        console.log('Processing row:', row.id);
                        if (row.id !== 'receipts-section') {
                            row.style.display = 'none';
                        }
                    });
                    
                    // Show receipts section
                    receiptsSection.style.display = 'flex';
                    console.log('Receipts section displayed');
                    
                    try {
                        // Load receipts data
                        loadReceipts();
                        console.log('loadReceipts called');
                    } catch (error) {
                        console.error('Error loading receipts:', error);
                        alert('Error loading receipts: ' + error.message);
                    }
                });
            } else {
                console.error('Could not find receipts elements:', {
                    'receiptsNavLink': receiptsNavLink,
                    'receiptsSection': receiptsSection
                });
            }
        }

        // Setup upload receipt functionality
        function setupUploadReceiptFunctionality() {
            // Add this at the beginning of the function
            // Connect the upload receipt button to the modal
            const uploadReceiptBtn = document.getElementById('upload-receipt-btn');
            const uploadFirstReceiptBtn = document.getElementById('upload-first-receipt-btn');
            const receiptUploadModal = new bootstrap.Modal(document.getElementById('receipt-upload-modal'));
            
            if (uploadReceiptBtn) {
                uploadReceiptBtn.addEventListener('click', function() {
                    console.log('Upload receipt button clicked');
                    receiptUploadModal.show();
                });
            } else {
                console.error('Upload receipt button not found');
            }
            
            if (uploadFirstReceiptBtn) {
                uploadFirstReceiptBtn.addEventListener('click', function() {
                    console.log('Upload first receipt button clicked');
                    receiptUploadModal.show();
                });
            }
            
            const receiptImage = document.getElementById('receipt-image');
            const receiptPreview = document.getElementById('receipt-preview');
            const previewContainer = document.getElementById('receipt-preview-container');
            const uploadForm = document.getElementById('receipt-upload-form');
            const uploadSubmit = document.getElementById('receipt-upload-submit');
            const uploadProgress = document.getElementById('receipt-upload-progress');
            const uploadResult = document.getElementById('receipt-upload-result');
            const uploadAnother = document.getElementById('upload-another-receipt');
            const ocrProviderSelect = document.getElementById('receipt-ocr-provider');
            
            // Show preview when image is selected
            receiptImage.addEventListener('change', function() {
                const file = this.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        receiptPreview.src = e.target.result;
                        previewContainer.style.display = 'block';
                    }
                    reader.readAsDataURL(file);
                }
            });
            
            // Handle upload button click
            uploadSubmit.addEventListener('click', function() {
                if (!uploadForm.checkValidity()) {
                    uploadForm.reportValidity();
                    return;
                }
                
                // Gather form data
                const fileInput = document.getElementById('receipt-image');
                const category = document.getElementById('receipt-category').value;
                const notes = document.getElementById('receipt-notes').value;
                const ocrProvider = ocrProviderSelect.value;
                
                if (!fileInput.files[0]) {
                    alert('Please select a receipt image to upload');
                    return;
                }
                
                // Show progress
                uploadProgress.style.display = 'block';
                uploadResult.style.display = 'none';
                uploadSubmit.disabled = true;
                
                // Create FormData
                const formData = new FormData();
                formData.append('image', fileInput.files[0]);
                formData.append('category', category);
                formData.append('notes', notes);
                formData.append('use_tabscanner', ocrProvider === 'tabscanner' ? 'true' : 'false');
                
                // Check if we're in development mode
                const isDevelopment = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
                
                if (isDevelopment) {
                    console.log('Development mode: using mock receipt upload');
                    
                    // Create a mock receipt with the uploaded image
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        // Create a mock receipt based on the uploaded image
                        const mockReceipt = {
                            receipt_id: 'mock-receipt-' + Date.now(),
                            merchant: 'Example Store',
                            date: new Date().toISOString().split('T')[0],
                            total_amount: 42.99,
                            tax_amount: 3.87,
                            category: category,
                            notes: notes,
                            image: e.target.result,
                            items: [
                                {name: 'Example Item 1', quantity: 1, unit_price: 19.99, total: 19.99},
                                {name: 'Example Item 2', quantity: 2, unit_price: 9.99, total: 19.98},
                                {name: 'Tax', quantity: 1, unit_price: 3.87, total: 3.87}
                            ],
                            created_at: new Date().toISOString()
                        };
                        
                        // Store in localStorage for development
                        let simulatedReceipts = JSON.parse(localStorage.getItem('simulatedReceipts') || '[]');
                        simulatedReceipts.push(mockReceipt);
                        localStorage.setItem('simulatedReceipts', JSON.stringify(simulatedReceipts));
                        
                        // Show success message
                        uploadProgress.style.display = 'none';
                        uploadResult.innerHTML = '<div class="alert alert-success">Receipt uploaded successfully in development mode!</div>';
                        uploadResult.style.display = 'block';
                        uploadSubmit.disabled = false;
                        
                        // Enable the "Upload Another" button
                        uploadAnother.style.display = 'inline-block';
                        uploadAnother.addEventListener('click', function() {
                            // Reset the form
                            uploadForm.reset();
                            previewContainer.style.display = 'none';
                            uploadResult.style.display = 'none';
                            uploadAnother.style.display = 'none';
                        });
                        
                        // Also update financial stats if needed
                        if (typeof addReceiptToExpenses === 'function') {
                            addReceiptToExpenses(mockReceipt);
                        }
                        
                        // Reload receipts list if we're on that page
                        if (document.getElementById('receipts-section').style.display !== 'none') {
                            loadReceipts();
                        }
                    };
                    
                    reader.readAsDataURL(fileInput.files[0]);
                    return;
                }
                
                // Get the current user's ID token for auth
                firebase.auth().currentUser.getIdToken()
                    .then(idToken => {
                        // Determine the endpoint based on the OCR provider
                        let endpoint = '/api/receipts/upload';
                        if (ocrProvider === 'tabscanner') {
                            console.log('Using Tabscanner OCR for receipt processing');
                            endpoint = '/api/receipts/upload/tabscanner';
                        } else {
                            console.log('Using DocuClipper OCR for receipt processing');
                        }
                        
                        // Upload the receipt
                        return fetch(endpoint, {
                            method: 'POST',
                            headers: {
                                'Authorization': 'Bearer ' + idToken
                            },
                            body: formData
                        });
                    })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Upload failed: ' + response.status);
                        }
                        return response.json();
                    })
                    .then(data => {
                        // Process successful upload
                        console.log('Receipt upload successful:', data);
                        
                        // Hide progress, show result
                        uploadProgress.style.display = 'none';
                        uploadResult.style.display = 'block';
                        uploadSubmit.style.display = 'none';
                        uploadAnother.style.display = 'inline-block';
                        
                        // Fill in the result data
                        const receipt = data.receipt_data || data.receipt;
                        document.getElementById('extracted-merchant').textContent = receipt.merchant || 'Unknown';
                        document.getElementById('extracted-total').textContent = formatCurrency(receipt.total_amount) || '$0.00';
                        document.getElementById('extracted-date').textContent = receipt.date || 'Unknown';
                        document.getElementById('extracted-items-count').textContent = (receipt.items && receipt.items.length) 
                            ? `${receipt.items.length} items` 
                            : 'No items';
                        document.getElementById('extracted-ocr-provider').textContent = 
                            (ocrProvider === 'tabscanner') ? 'Tabscanner (Enhanced)' : 'DocuClipper (Standard)';
                        
                        // Update expenses with this receipt
                        if (receipt.total_amount) {
                            addReceiptToExpenses(receipt);
                        }
                        
                        // Refresh receipts list
                        if (typeof loadUserReceipts === 'function') {
                            loadUserReceipts();
                        } else if (typeof loadReceipts === 'function') {
                            loadReceipts();
                        }
                    })
                    .catch(error => {
                        console.error('Error uploading receipt:', error);
                        uploadProgress.style.display = 'none';
                        uploadSubmit.disabled = false;
                        alert('Failed to upload receipt: ' + error.message);
                    });
            });
            
            // Reset form for another upload
            if (uploadAnother) {
                uploadAnother.addEventListener('click', function() {
                    uploadForm.reset();
                    previewContainer.style.display = 'none';
                    uploadResult.style.display = 'none';
                    uploadSubmit.style.display = 'inline-block';
                    uploadSubmit.disabled = false;
                    uploadAnother.style.display = 'none';
                });
            }
        }

        function createMockReceipt() {
            console.log('Creating mock receipt for testing');
            
            // Get existing receipts from localStorage
            let receipts = JSON.parse(localStorage.getItem('simulatedReceipts') || '[]');
            
            // Generate a unique ID
            const receiptId = 'mock-' + Date.now();
            
            // Generate a random amount between $5 and $150
            const amount = (Math.random() * 145 + 5).toFixed(2);
            const taxAmount = (amount * 0.0825).toFixed(2); // Approx 8.25% tax
            
            // Get current date in YYYY-MM-DD format
            const today = new Date();
            const date = today.toISOString().split('T')[0];
            
            // Pick a random merchant
            const merchants = [
                'Grocery Mart', 'Coffee Shop', 'Office Supplies', 
                'Restaurant', 'Gas Station', 'Hardware Store',
                'Electronics Store', 'Clothing Store', 'Pharmacy'
            ];
            const merchant = merchants[Math.floor(Math.random() * merchants.length)];
            
            // Pick a random category
            const categories = [
                'Food and Dining', 'Shopping', 'Travel', 
                'Entertainment', 'Office', 'Groceries',
                'Automotive', 'Utilities', 'Healthcare'
            ];
            const category = categories[Math.floor(Math.random() * categories.length)];
            
            // Create 1-5 random items
            const itemCount = Math.floor(Math.random() * 5) + 1;
            const items = [];
            
            let itemsTotal = 0;
            for (let i = 0; i < itemCount; i++) {
                const itemName = `Item ${i+1}`;
                const quantity = Math.floor(Math.random() * 3) + 1;
                const unitPrice = (Math.random() * 20 + 5).toFixed(2);
                const total = (quantity * unitPrice).toFixed(2);
                
                items.push({
                    name: itemName,
                    quantity: quantity,
                    unit_price: unitPrice,
                    total: total
                });
                
                itemsTotal += parseFloat(total);
            }
            
            // Create the mock receipt
            const receipt = {
                receipt_id: receiptId,
                date: date,
                merchant: merchant,
                category: category,
                total_amount: amount,
                tax_amount: taxAmount,
                items: items,
                status: 'processed',
                created_at: new Date().toISOString(),
                notes: ''
            };
            
            // Add to the array
            receipts.push(receipt);
            
            // Save to localStorage
            localStorage.setItem('simulatedReceipts', JSON.stringify(receipts));
            
            // Update global stats with the new receipt amount
            if (typeof globalStats !== 'undefined') {
                // Update receipt totals
                globalStats.receiptsTotal = (parseFloat(globalStats.receiptsTotal) || 0) + parseFloat(amount);
                
                // Update expenses
                globalStats.totalExpenses = (parseFloat(globalStats.totalExpenses) || 0) + parseFloat(amount);
                
                // Update balance
                globalStats.netBalance = globalStats.netIncome - globalStats.totalExpenses;
                
                // Save the updated stats
                saveFinancialStats();
                
                // Update the dashboard
                updateDashboardStats();
            }
            
            console.log('Created mock receipt:', receipt);
            
            // Show a success message
            alert('Mock receipt created successfully!');
            
            // Reload the receipts list
            loadReceipts();
            
            return receipt;
        }

        // Add a button to the upload modal to create a mock receipt
        document.addEventListener('DOMContentLoaded', function() {
            // Get the modal footer
            const modalFooter = document.querySelector('#receipt-upload-modal .modal-footer');
            if (!modalFooter) return;
            
            // Create the mock receipt button
            const mockButton = document.createElement('button');
            mockButton.type = 'button';
            mockButton.className = 'btn btn-secondary ms-auto';
            mockButton.textContent = 'Create Mock Receipt (Dev)';
            mockButton.addEventListener('click', function() {
                createMockReceipt();
                // Close the modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('receipt-upload-modal'));
                if (modal) modal.hide();
            });
            
            // Add the button to the modal footer
            modalFooter.prepend(mockButton);
        });

        function getSavedBankConnections() {
            // Try to get from local storage
            const storedConnections = localStorage.getItem('bankConnections');
            return storedConnections ? JSON.parse(storedConnections) : [];
        }
        
        // Implement loadReceipts function to display receipts in the UI
        function loadReceipts() {
            console.log('loadReceipts function called');
            
            // Get receipts container elements
            const noReceiptsMessage = document.getElementById('no-receipts-message');
            const receiptsList = document.getElementById('receipts-list');
            const receiptsTableBody = document.getElementById('receipts-table-body');
            
            if (!noReceiptsMessage || !receiptsList || !receiptsTableBody) {
                console.error('Receipt container elements not found:', {
                    'noReceiptsMessage': !!noReceiptsMessage,
                    'receiptsList': !!receiptsList,
                    'receiptsTableBody': !!receiptsTableBody
                });
                return;
            }
            
            // Show loading state
            noReceiptsMessage.innerHTML = '<i class="fas fa-spinner fa-spin fa-3x mb-3"></i><p>Loading receipts...</p>';
            noReceiptsMessage.style.display = 'block';
            receiptsList.style.display = 'none';
            
            // Check if we're in development mode
            const isDevelopment = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
            
            // In development mode, load receipts from localStorage
            if (isDevelopment) {
                console.log('Development mode detected, loading simulated receipts');
                setTimeout(() => {
                    try {
                        // Get receipts from localStorage
                        const simulatedReceipts = JSON.parse(localStorage.getItem('simulatedReceipts') || '[]');
                        console.log('Found simulated receipts:', simulatedReceipts.length);
                        
                        if (simulatedReceipts.length === 0) {
                            // No receipts yet, show empty state
                            noReceiptsMessage.innerHTML = `
                                <i class="fas fa-receipt fa-3x mb-3 text-muted"></i>
                                <p>You don't have any receipts yet.</p>
                                <button id="upload-first-receipt-btn" class="btn btn-primary mt-3">
                                    <i class="fas fa-upload me-2"></i>Upload Your First Receipt
                                </button>`;
                            noReceiptsMessage.style.display = 'block';
                            receiptsList.style.display = 'none';
                            
                            // Add click handler to the upload button
                            const uploadFirstReceiptBtn = document.getElementById('upload-first-receipt-btn');
                            if (uploadFirstReceiptBtn) {
                                uploadFirstReceiptBtn.addEventListener('click', function() {
                                    const receiptUploadModal = new bootstrap.Modal(document.getElementById('receipt-upload-modal'));
                                    receiptUploadModal.show();
                                });
                            }
                        } else {
                            // Display the receipts
                            displaySimulatedReceipts(simulatedReceipts, receiptsTableBody);
                            noReceiptsMessage.style.display = 'none';
                            receiptsList.style.display = 'block';
                            
                            // Update receipt count
                            const receiptsCount = document.getElementById('receipts-count');
                            if (receiptsCount) {
                                receiptsCount.textContent = simulatedReceipts.length;
                            }
                            
                            // Update receipt statistics
                            updateReceiptStatistics(simulatedReceipts);
                        }
                    } catch (error) {
                        console.error('Error loading simulated receipts:', error);
                        noReceiptsMessage.innerHTML = `
                            <i class="fas fa-exclamation-triangle fa-3x mb-3 text-danger"></i>
                            <p>Error loading receipts: ${error.message}</p>`;
                    }
                }, 500); // Small delay to simulate API call
                return;
            }
            
            // Non-development mode - use Firebase and API
            // Make sure user is logged in
            if (!firebase.auth().currentUser) {
                console.error('User not logged in');
                noReceiptsMessage.innerHTML = '<i class="fas fa-exclamation-triangle fa-3x mb-3 text-danger"></i><p>Please log in to view your receipts.</p>';
                return;
            }
            
            // Use the Firebase ID token to fetch receipts from API
            firebase.auth().currentUser.getIdToken()
                .then(idToken => {
                    return fetch('/api/receipts', {
                        headers: {
                            'Authorization': 'Bearer ' + idToken
                        }
                    });
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Failed to fetch receipts: ' + response.status);
                    }
                    return response.json();
                })
                .then(data => {
                    if (!data.success) {
                        throw new Error(data.error || 'Failed to load receipts.');
                    }
                    
                    const receipts = data.receipts || [];
                    
                    if (receipts.length === 0) {
                        // No receipts yet, show empty state
                        noReceiptsMessage.innerHTML = `
                            <i class="fas fa-receipt fa-3x mb-3 text-muted"></i>
                            <p>You don't have any receipts yet.</p>
                            <button id="upload-first-receipt-btn" class="btn btn-primary mt-3">
                                <i class="fas fa-upload me-2"></i>Upload Your First Receipt
                            </button>`;
                        noReceiptsMessage.style.display = 'block';
                        receiptsList.style.display = 'none';
                        
                        // Add click handler to the upload button
                        const uploadFirstReceiptBtn = document.getElementById('upload-first-receipt-btn');
                        if (uploadFirstReceiptBtn) {
                            uploadFirstReceiptBtn.addEventListener('click', function() {
                                const receiptUploadModal = new bootstrap.Modal(document.getElementById('receipt-upload-modal'));
                                receiptUploadModal.show();
                            });
                        }
                    } else {
                        // Display the receipts
                        displayReceipts(receipts, receiptsTableBody);
                        noReceiptsMessage.style.display = 'none';
                        receiptsList.style.display = 'block';
                    }
                })
                .catch(error => {
                    console.error('Error loading receipts:', error);
                    noReceiptsMessage.innerHTML = `
                        <i class="fas fa-exclamation-triangle fa-3x mb-3 text-danger"></i>
                        <p>Error loading receipts: ${error.message}</p>
                        <button id="try-simulated-receipts" class="btn btn-outline-primary mt-3">
                            Try Simulated Receipts
                        </button>`;
                    
                    // Add event listener to the "Try Simulated Receipts" button
                    const trySimulatedBtn = document.getElementById('try-simulated-receipts');
                    if (trySimulatedBtn) {
                        trySimulatedBtn.addEventListener('click', function() {
                            localStorage.setItem('useSimulatedReceipts', 'true');
                            loadReceipts();
                        });
                    }
                });
        }

        // Helper function to display receipts in the table
        function displaySimulatedReceipts(receipts, tableBody) {
            // Clear existing content
            tableBody.innerHTML = '';
            
            // Add each receipt to the table
            receipts.forEach((receipt, index) => {
                const row = document.createElement('tr');
                
                // Format date
                let displayDate = receipt.date;
                try {
                    if (typeof displayDate === 'string' && displayDate.includes('-')) {
                        const date = new Date(displayDate);
                        displayDate = date.toLocaleDateString();
                    }
                } catch (e) {
                    console.warn('Error formatting date:', e);
                }
                
                // Create row content
                row.innerHTML = `
                    <td class="ps-3">${displayDate}</td>
                    <td>${receipt.merchant || 'Unknown'}</td>
                    <td>${receipt.category || 'Uncategorized'}</td>
                    <td>${formatCurrency(receipt.total_amount) || '$0.00'}</td>
                    <td><span class="badge bg-success">Processed</span></td>
                    <td class="text-end pe-3">
                        <button class="btn btn-sm btn-outline-primary view-receipt-btn" data-receipt-id="${receipt.receipt_id}">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger delete-receipt-btn" data-receipt-id="${receipt.receipt_id}">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                
                // Add row to table
                tableBody.appendChild(row);
            });
            
            // Add event listeners to view buttons
            document.querySelectorAll('.view-receipt-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const receiptId = this.getAttribute('data-receipt-id');
                    viewReceiptDetails(receiptId);
                });
            });
            
            // Add event listeners to delete buttons
            document.querySelectorAll('.delete-receipt-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const receiptId = this.getAttribute('data-receipt-id');
                    if (confirm('Are you sure you want to delete this receipt?')) {
                        deleteSimulatedReceipt(receiptId);
                    }
                });
            });
        }

        // Update receipt statistics in the UI
        function updateReceiptStatistics(receipts) {
            const totalReceiptsCount = document.getElementById('total-receipts-count');
            const totalReceiptsAmount = document.getElementById('total-receipts-amount');
            const matchedReceiptsCount = document.getElementById('matched-receipts-count');
            const averageReceiptAmount = document.getElementById('average-receipt-amount');
            
            if (receipts && receipts.length > 0) {
                // Calculate statistics
                const totalAmount = receipts.reduce((sum, receipt) => sum + parseFloat(receipt.total_amount || 0), 0);
                const matchedCount = receipts.filter(receipt => receipt.matched_transaction_id).length;
                const avgAmount = totalAmount / receipts.length;
                
                // Update UI
                if (totalReceiptsCount) totalReceiptsCount.textContent = receipts.length;
                if (totalReceiptsAmount) totalReceiptsAmount.textContent = formatCurrency(totalAmount);
                if (matchedReceiptsCount) matchedReceiptsCount.textContent = matchedCount;
                if (averageReceiptAmount) averageReceiptAmount.textContent = formatCurrency(avgAmount);
            } else {
                // No receipts, set zeros
                if (totalReceiptsCount) totalReceiptsCount.textContent = '0';
                if (totalReceiptsAmount) totalReceiptsAmount.textContent = '$0.00';
                if (matchedReceiptsCount) matchedReceiptsCount.textContent = '0';
                if (averageReceiptAmount) averageReceiptAmount.textContent = '$0.00';
            }
        }

        // Delete a simulated receipt
        function deleteSimulatedReceipt(receiptId) {
            console.log('Deleting simulated receipt:', receiptId);
            
            // Get current receipts
            let receipts = JSON.parse(localStorage.getItem('simulatedReceipts') || '[]');
            
            // Find the receipt to delete
            const receiptIndex = receipts.findIndex(r => r.receipt_id === receiptId);
            if (receiptIndex === -1) {
                console.error('Receipt not found:', receiptId);
                return;
            }
            
            // Get the receipt before we delete it
            const receipt = receipts[receiptIndex];
            
            // Remove the receipt from the array
            receipts.splice(receiptIndex, 1);
            
            // Save the updated array
            localStorage.setItem('simulatedReceipts', JSON.stringify(receipts));
            
            // If the receipt had a total amount, update the expenses
            if (receipt.total_amount) {
                const amount = parseFloat(receipt.total_amount);
                
                // Update global stats
                globalStats.receiptsTotal -= amount;
                globalStats.totalExpenses -= amount;
                globalStats.netBalance = globalStats.netIncome - globalStats.totalExpenses;
                
                // Update the dashboard
                updateDashboardStats();
                
                // Save the updated stats
                saveFinancialStats();
            }
            
            // Reload the receipts list
            loadReceipts();
        }

        // View receipt details
        function viewReceiptDetails(receiptId) {
            console.log('Viewing receipt details:', receiptId);
            
            // Check if we're in development mode
            const isDevelopment = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
            
            if (isDevelopment) {
                // Load receipt from localStorage
                const receipts = JSON.parse(localStorage.getItem('simulatedReceipts') || '[]');
                const receipt = receipts.find(r => r.receipt_id === receiptId);
                
                if (!receipt) {
                    console.error('Receipt not found:', receiptId);
                    alert('Receipt not found');
                    return;
                }
                
                // Show the receipt details modal
                const modal = new bootstrap.Modal(document.getElementById('receipt-detail-modal'));
                
                // Fill in the details
                document.getElementById('detail-merchant').textContent = receipt.merchant || 'Unknown';
                document.getElementById('detail-date').textContent = receipt.date || 'Unknown';
                document.getElementById('detail-total').textContent = formatCurrency(receipt.total_amount) || '$0.00';
                document.getElementById('detail-tax').textContent = formatCurrency(receipt.tax_amount) || 'N/A';
                document.getElementById('detail-receipt-id').textContent = receipt.receipt_id;
                
                // Set category if present
                const categorySelect = document.getElementById('detail-category');
                if (categorySelect && receipt.category) {
                    for (let i = 0; i < categorySelect.options.length; i++) {
                        if (categorySelect.options[i].value === receipt.category) {
                            categorySelect.selectedIndex = i;
                            break;
                        }
                    }
                }
                
                // Set notes if present
                const notesTextarea = document.getElementById('detail-notes');
                if (notesTextarea) {
                    notesTextarea.value = receipt.notes || '';
                }
                
                // Show transaction match status
                const noMatchMessage = document.getElementById('no-match-message');
                const matchDetails = document.getElementById('match-details');
                
                if (noMatchMessage) noMatchMessage.style.display = 'block';
                if (matchDetails) matchDetails.style.display = 'none';
                
                // Show receipt items
                const noItemsMessage = document.getElementById('no-items-message');
                const itemsTableContainer = document.getElementById('items-table-container');
                const itemsTableBody = document.getElementById('items-table-body');
                
                if (receipt.items && receipt.items.length > 0) {
                    // We have items to display
                    if (itemsTableBody) {
                        itemsTableBody.innerHTML = '';
                        receipt.items.forEach(item => {
                            const row = document.createElement('tr');
                            row.innerHTML = `
                                <td>${item.name || 'Unknown Item'}</td>
                                <td>${item.quantity || '1'}</td>
                                <td>${formatCurrency(item.unit_price) || '$0.00'}</td>
                                <td>${formatCurrency(item.total) || '$0.00'}</td>
                            `;
                            itemsTableBody.appendChild(row);
                        });
                    }
                    
                    if (noItemsMessage) noItemsMessage.style.display = 'none';
                    if (itemsTableContainer) itemsTableContainer.style.display = 'block';
                } else {
                    // No items to display
                    if (noItemsMessage) noItemsMessage.style.display = 'block';
                    if (itemsTableContainer) itemsTableContainer.style.display = 'none';
                }
                
                // Setup delete button
                const deleteButton = document.getElementById('delete-receipt-btn');
                if (deleteButton) {
                    // Remove existing event listeners
                    const newDeleteButton = deleteButton.cloneNode(true);
                    deleteButton.parentNode.replaceChild(newDeleteButton, deleteButton);
                    
                    // Add new event listener
                    newDeleteButton.addEventListener('click', function() {
                        deleteSimulatedReceipt(receiptId);
                        modal.hide();
                    });
                }
                
                // Show the modal
                modal.show();
            } else {
                // For non-development mode, use the Firebase/API version
                // ... API-based receipt details viewing code would go here ...
                alert('Receipt details view not implemented for API mode yet');
            }
        }
    </script>
    
    <!-- Development mode receipt upload handler -->
    <script src="frontend/fix_upload.js"></script>
    
    <!-- Direct fix for receipt buttons -->
    <script>
        // Simple button handlers
        function saveManualReceipt() {
            console.log('saveManualReceipt called directly');
            
            // Get form values
            const merchant = document.getElementById('manual-merchant').value;
            const date = document.getElementById('manual-date').value;
            const total = document.getElementById('manual-total').value;
            const tax = document.getElementById('manual-tax').value || '0';
            const category = document.getElementById('manual-category').value;
            const notes = document.getElementById('manual-notes').value;
            
            // Validate required fields
            if (!merchant || !date || !total) {
                alert('Please fill in all required fields (Merchant, Date, Total Amount)');
                return;
            }
            
            // Create receipt object
            const receipt = {
                receipt_id: 'manual-' + Date.now(),
                merchant: merchant,
                date: date,
                total_amount: parseFloat(total).toFixed(2),
                tax_amount: tax ? parseFloat(tax).toFixed(2) : '0.00',
                category: category || 'Uncategorized',
                notes: notes || '',
                items: [],
                status: 'processed',
                created_at: new Date().toISOString()
            };
            
            alert('Saving receipt for: ' + merchant + ' - $' + total);
            
            // Save to localStorage
            let receipts = JSON.parse(localStorage.getItem('simulatedReceipts') || '[]');
            receipts.push(receipt);
            localStorage.setItem('simulatedReceipts', JSON.stringify(receipts));
            console.log('Receipt saved to localStorage:', receipt);
            
            // Update UI with success message
            const manualForm = document.getElementById('manual-receipt-form');
            if (manualForm) {
                manualForm.innerHTML = `
                    <div class="alert alert-success">
                        <h5><i class="fas fa-check-circle me-2"></i>Receipt saved successfully!</h5>
                        <p class="mb-1">Merchant: ${receipt.merchant}</p>
                        <p class="mb-1">Date: ${receipt.date}</p>
                        <p class="mb-1">Total: $${parseFloat(receipt.total_amount).toFixed(2)}</p>
                        <p class="mb-0">Category: ${receipt.category}</p>
                    </div>
                    <div class="text-center mt-3">
                        <button type="button" class="btn btn-outline-primary" data-bs-dismiss="modal">Close</button>
                    </div>
                `;
            }
            
            // Refresh receipts if on that page
            if (typeof loadReceipts === 'function') {
                try {
                    loadReceipts();
                } catch(e) {
                    console.error('Error reloading receipts:', e);
                }
            }
            
            // Update stats if possible
            if (typeof globalStats !== 'undefined') {
                try {
                    const amount = parseFloat(receipt.total_amount);
                    globalStats.receiptsTotal = (parseFloat(globalStats.receiptsTotal) || 0) + amount;
                    globalStats.totalExpenses = (parseFloat(globalStats.totalExpenses) || 0) + amount;
                    globalStats.netBalance = globalStats.netIncome - globalStats.totalExpenses;
                    
                    if (typeof saveFinancialStats === 'function') {
                        saveFinancialStats();
                    }
                    
                    if (typeof updateDashboardStats === 'function') {
                        updateDashboardStats();
                    }
                } catch(e) {
                    console.error('Error updating stats:', e);
                }
            }
        }
        
        function processReceiptUpload() {
            console.log('processReceiptUpload called directly');
            
            // Get file input
            const fileInput = document.getElementById('receipt-image');
            if (!fileInput || !fileInput.files || !fileInput.files[0]) {
                alert('Please select a receipt image to upload');
                return;
            }
            
            // Get other form values
            const category = document.getElementById('receipt-category').value;
            const notes = document.getElementById('receipt-notes').value;
            
            // Show processing
            const uploadContainer = document.getElementById('upload-receipt');
            if (uploadContainer) {
                uploadContainer.innerHTML = `
                    <div class="text-center py-4">
                        <div class="spinner-border text-primary mb-3" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <h5>Processing receipt image...</h5>
                        <p class="text-muted">This may take a few seconds</p>
                    </div>
                `;
            }
            
            // Process the image (simulated in development mode)
            const reader = new FileReader();
            reader.onload = function(e) {
                setTimeout(() => {
                    // Generate a mock receipt with simulated OCR data
                    const randomAmount = (Math.random() * 100 + 10).toFixed(2);
                    const taxAmount = (randomAmount * 0.08).toFixed(2);
                    
                    const receipt = {
                        receipt_id: 'upload-' + Date.now(),
                        merchant: 'Coffee Shop',
                        date: new Date().toISOString().split('T')[0],
                        total_amount: randomAmount,
                        tax_amount: taxAmount,
                        category: category || 'Food and Dining',
                        notes: notes || '',
                        image: e.target.result,
                        status: 'processed',
                        created_at: new Date().toISOString()
                    };
                    
                    // Save to localStorage immediately
                    let receipts = JSON.parse(localStorage.getItem('simulatedReceipts') || '[]');
                    receipts.push(receipt);
                    localStorage.setItem('simulatedReceipts', JSON.stringify(receipts));
                    console.log('Receipt saved to localStorage immediately after processing:', receipt);
                    
                    // Update financial stats
                    if (typeof globalStats !== 'undefined') {
                        try {
                            const amount = parseFloat(receipt.total_amount);
                            globalStats.receiptsTotal = (parseFloat(globalStats.receiptsTotal) || 0) + amount;
                            globalStats.totalExpenses = (parseFloat(globalStats.totalExpenses) || 0) + amount;
                            globalStats.netBalance = globalStats.netIncome - globalStats.totalExpenses;
                            
                            if (typeof saveFinancialStats === 'function') {
                                saveFinancialStats();
                            }
                            
                            if (typeof updateDashboardStats === 'function') {
                                updateDashboardStats();
                            }
                        } catch(e) {
                            console.error('Error updating stats:', e);
                        }
                    }
                    
                    // Show success message
                    if (uploadContainer) {
                        uploadContainer.innerHTML = `
                            <div class="alert alert-success">
                                <h5><i class="fas fa-check-circle me-2"></i>Receipt saved successfully!</h5>
                                <p class="mb-1">Merchant: ${receipt.merchant}</p>
                                <p class="mb-1">Date: ${receipt.date}</p>
                                <p class="mb-1">Total: $${parseFloat(receipt.total_amount).toFixed(2)}</p>
                                <p class="mb-0">Category: ${receipt.category}</p>
                            </div>
                            <div class="text-center mt-3">
                                <button type="button" class="btn btn-outline-primary" data-bs-dismiss="modal">Close</button>
                            </div>
                        `;
                    }
                    
                    // Refresh receipts if on that page
                    if (typeof loadReceipts === 'function') {
                        try {
                            loadReceipts();
                        } catch(e) {
                            console.error('Error reloading receipts:', e);
                        }
                    }
                    
                }, 2000); // Simulated processing time
            };
            reader.readAsDataURL(fileInput.files[0]);
        }
        
        function startCamera() {
            console.log('startCamera called directly');
            
            // Get camera elements
            const cameraVideo = document.getElementById('camera-video');
            const cameraPlaceholder = document.getElementById('camera-placeholder');
            const cameraCaptureBtn = document.getElementById('camera-capture-btn');
            const cameraStartBtn = document.getElementById('camera-start-btn');
            const cameraContainer = document.getElementById('camera-capture'); // Tab pane container
            
            // Request camera access
            if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } })
                    .then(function(stream) {
                        if (cameraVideo) {
                            cameraVideo.srcObject = stream;
                            cameraVideo.style.display = 'block';
                            cameraVideo.play();
                        }
                        if (cameraPlaceholder) {
                            cameraPlaceholder.style.display = 'none';
                        }
                        if (cameraCaptureBtn) {
                            cameraCaptureBtn.style.display = 'block';
                            
                            // Add capture functionality
                            cameraCaptureBtn.onclick = function() {
                                console.log('Camera capture button clicked');
                                
                                // Show processing
                                if (cameraContainer) {
                                    cameraContainer.innerHTML = `
                                        <div class="text-center py-4">
                                            <div class="spinner-border text-primary mb-3" role="status">
                                                <span class="visually-hidden">Loading...</span>
                                            </div>
                                            <h5>Processing receipt image...</h5>
                                            <p class="text-muted">This may take a few seconds</p>
                                        </div>
                                    `;
                                }
                                
                                // Stop the camera stream
                                if (stream) {
                                    stream.getTracks().forEach(track => track.stop());
                                }
                                
                                // Create a canvas to capture the image
                                const canvas = document.createElement('canvas');
                                canvas.width = cameraVideo.videoWidth;
                                canvas.height = cameraVideo.videoHeight;
                                const context = canvas.getContext('2d');
                                context.drawImage(cameraVideo, 0, 0, canvas.width, canvas.height);
                                const imageData = canvas.toDataURL('image/jpeg');
                                
                                // Simulate processing time
                                setTimeout(() => {
                                    // Generate a mock receipt with simulated OCR data
                                    const randomAmount = (Math.random() * 100 + 10).toFixed(2);
                                    const taxAmount = (randomAmount * 0.08).toFixed(2);
                                    
                                    const receipt = {
                                        receipt_id: 'camera-' + Date.now(),
                                        merchant: 'Local Restaurant',
                                        date: new Date().toISOString().split('T')[0],
                                        total_amount: randomAmount,
                                        tax_amount: taxAmount,
                                        category: 'Food and Dining',
                                        notes: 'Captured via camera',
                                        image: imageData,
                                        status: 'processed',
                                        created_at: new Date().toISOString()
                                    };
                                    
                                    // Save to localStorage immediately
                                    let receipts = JSON.parse(localStorage.getItem('simulatedReceipts') || '[]');
                                    receipts.push(receipt);
                                    localStorage.setItem('simulatedReceipts', JSON.stringify(receipts));
                                    console.log('Camera receipt saved to localStorage:', receipt);
                                    
                                    // Update financial stats
                                    if (typeof globalStats !== 'undefined') {
                                        try {
                                            const amount = parseFloat(receipt.total_amount);
                                            globalStats.receiptsTotal = (parseFloat(globalStats.receiptsTotal) || 0) + amount;
                                            globalStats.totalExpenses = (parseFloat(globalStats.totalExpenses) || 0) + amount;
                                            globalStats.netBalance = globalStats.netIncome - globalStats.totalExpenses;
                                            
                                            if (typeof saveFinancialStats === 'function') {
                                                saveFinancialStats();
                                            }
                                            
                                            if (typeof updateDashboardStats === 'function') {
                                                updateDashboardStats();
                                            }
                                        } catch(e) {
                                            console.error('Error updating stats:', e);
                                        }
                                    }
                                    
                                    // Show success message
                                    if (cameraContainer) {
                                        cameraContainer.innerHTML = `
                                            <div class="alert alert-success">
                                                <h5><i class="fas fa-check-circle me-2"></i>Receipt saved successfully!</h5>
                                                <p class="mb-1">Merchant: ${receipt.merchant}</p>
                                                <p class="mb-1">Date: ${receipt.date}</p>
                                                <p class="mb-1">Total: $${parseFloat(receipt.total_amount).toFixed(2)}</p>
                                                <p class="mb-0">Category: ${receipt.category}</p>
                                            </div>
                                            <div class="text-center mt-3">
                                                <button type="button" class="btn btn-outline-primary" data-bs-dismiss="modal">Close</button>
                                            </div>
                                        `;
                                    }
                                    
                                    // Refresh receipts if on that page
                                    if (typeof loadReceipts === 'function') {
                                        try {
                                            loadReceipts();
                                        } catch(e) {
                                            console.error('Error reloading receipts:', e);
                                        }
                                    }
                                    
                                }, 2000); // Simulated processing time
                            };
                        }
                        if (cameraStartBtn) {
                            cameraStartBtn.style.display = 'none';
                        }
                    })
                    .catch(function(err) {
                        console.error('Error accessing camera:', err);
                        alert('Could not access camera. Please check permissions.');
                    });
            } else {
                alert('Your browser does not support camera access.');
            }
        }
    </script>
</body>
</html> 