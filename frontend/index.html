<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TAAXDOG - Dashboard</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Custom CSS -->
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f8f9fa;
        }
        .sidebar {
            position: fixed;
            top: 56px; /* Match navbar height to prevent overlap */
            bottom: 0;
            left: 0;
            z-index: 100;
            padding: 0; /* Remove top padding since we're using top: 56px */
            box-shadow: inset -1px 0 0 rgba(0, 0, 0, .1);
            background-color: white;
            color: #333;
            width: 240px; /* Set explicit width to match main-content margin */
        }
        .sidebar-sticky {
            position: relative;
            height: 100%; /* Take full height of sidebar */
            padding-top: 0.5rem;
            overflow-x: hidden;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }
        .sidebar .nav-link {
            font-weight: 500;
            color: #333;
            padding: 0.75rem 1rem;
            margin-bottom: 0.25rem;
        }
        .sidebar .nav-link:hover {
            background-color: rgba(0, 0, 0, 0.05);
        }
        .sidebar .nav-link.active {
            background-color: rgba(0, 0, 0, 0.1);
        }
        .sidebar .nav-link i {
            margin-right: 10px;
        }
        .navbar-brand {
            padding-top: 0.75rem;
            padding-bottom: 0.75rem;
            font-size: 1.5rem;
            font-weight: bold;
            color: #333;
            display: flex;
            align-items: center;
        }
        .navbar-brand i {
            color: #4361ee;
            margin-right: 10px;
        }
        .navbar {
            background-color: white;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            position: fixed; /* Fix navbar to top */
            width: 100%;
            top: 0;
            z-index: 101;
            height: 56px; /* Set explicit height */
        }
        .navbar .navbar-toggler {
            border-color: rgba(0, 0, 0, 0.5);
        }
        .main-content {
            margin-left: 240px; /* Match sidebar width */
            padding: 2rem 1.5rem;
        }
        .card {
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            border: none;
        }
        .card-header {
            background-color: transparent;
            border-bottom: 1px solid rgba(0, 0, 0, 0.125);
            font-weight: 600;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .stats-card {
            text-align: left;
            height: 100%;
            display: flex;
            flex-direction: column;
        }
        .stats-card .card-body {
            padding: 1.5rem;
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        .stats-card .stat-value {
            font-size: 1.8rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
        }
        .stats-card .stat-change {
            font-size: 0.8rem;
            padding: 3px 8px;
            border-radius: 20px;
            display: inline-block;
        }
        .stats-card .positive-change {
            background-color: rgba(0, 200, 0, 0.1);
            color: #00b300;
        }
        .stats-card .negative-change {
            background-color: rgba(255, 0, 0, 0.1);
            color: #e60000;
        }
        .stats-card i {
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
        }
        .income-icon {
            color: #4CAF50;
        }
        .expense-icon {
            color: #F44336;
        }
        .balance-icon {
            color: #3F51B5;
        }
        .subscription-icon {
            color: #9C27B0;
        }
        .progress {
            height: 10px;
            margin-top: 5px;
            margin-bottom: 15px;
        }
        .goal-item {
            margin-bottom: 15px;
        }
        .goal-details {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }
        .notification-item {
            padding: 10px 0;
            border-bottom: 1px solid #eee;
        }
        .notification-item:last-child {
            border-bottom: none;
        }
        .notification-date {
            font-size: 0.8rem;
            color: #777;
        }
        .clock-display {
            position: absolute;
            bottom: 15px;
            right: 15px;
            background: #555;
            color: white;
            padding: 5px 15px;
            border-radius: 5px;
            font-size: 1.5rem;
            font-weight: bold;
        }
        .connect-bank-btn {
            background-color: #4361ee;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
        }
        .connect-bank-btn:hover {
            background-color: #3250b2;
        }
        .modal-body iframe {
            width: 100%;
            min-height: 500px;
            border: none;
        }
        .bank-connection-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 15px;
            border-bottom: 1px solid #eee;
            margin-bottom: 10px;
        }
        .bank-logo {
            max-width: 40px;
            margin-right: 15px;
        }
        .bank-info {
            flex-grow: 1;
        }
        .bank-name {
            font-weight: 600;
            margin-bottom: 2px;
        }
        .bank-status {
            font-size: 0.8rem;
            color: #6c757d;
        }
        .bank-status.success {
            color: #28a745;
        }
        .bank-status.error {
            color: #dc3545;
        }
        .bank-status.pending {
            color: #ffc107;
        }
        .bank-actions {
            display: flex;
            gap: 8px;
        }
        .bank-actions button {
            border: none;
            background: none;
            color: #4361ee;
            cursor: pointer;
            padding: 5px;
        }
        .bank-actions button:hover {
            color: #3250b2;
        }
        /* Mobile responsive adjustments */
        @media (max-width: 767.98px) {
            .sidebar {
                position: static;
                height: auto;
                padding: 0;
                width: 100%;
                margin-top: 56px;
            }
            .main-content {
                margin-left: 0;
                margin-top: 56px; /* Add margin for fixed navbar */
                padding: 1rem;
            }
            .navbar {
                position: fixed;
            }
            .navbar-brand {
                font-size: 1.2rem;
            }
        }
        /* Additional styles for tiles */
        .tile-card {
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            height: 100%;
        }
        
        .tile-card:hover {
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
            transform: translateY(-5px);
        }
        
        .tile-card .card-body {
            display: flex;
            flex-direction: column;
            flex: 1;
            overflow: hidden; /* Prevent content from overflowing */
            position: relative; /* For positioning the clock */
        }
        
        .scrollable-content {
            scrollbar-width: thin;
            overflow-y: auto;
            flex: 1;
        }
        
        .scrollable-content::-webkit-scrollbar {
            width: 6px;
        }
        
        .scrollable-content::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        
        .scrollable-content::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 3px;
        }
        
        .scrollable-content::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        
        /* For modal content scrollability */
        #tile-modal-content {
            max-height: 70vh;
            overflow-y: auto;
            padding: 10px;
        }
        
        /* Mobile specific styles */
        @media (max-width: 767.98px) {
            .card-body {
                padding: 0.75rem;
            }
        }
        /* Logout button styling */
        .logout-button {
            margin-top: auto;
            padding: 10px 15px;
            background-color: #f8f9fa;
            border-top: 1px solid #eee;
        }
        
        .logout-button .nav-link {
            color: #dc3545 !important;
            font-weight: bold;
        }
        
        .logout-button .nav-link:hover {
            background-color: #f1f1f1;
        }
        
        .stats-card {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .stats-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        }
        .tile {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            min-height: 200px;
            cursor: pointer;
        }
        .tile:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        }
        .chart-container {
            height: 300px;
        }
        
        /* Dashboard-specific styles */
        #data-dashboard-section .card {
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            border: none;
            border-radius: 8px;
            overflow: hidden;
            margin-bottom: 20px;
        }
        
        #data-dashboard-section .card-header {
            padding: 12px 16px;
            font-weight: 500;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        }
        
        #data-dashboard-section .card-body {
            padding: 20px;
        }
        
        /* Make the canvas container fill its parent */
        #data-dashboard-section canvas {
            width: 100% !important;
            height: 100% !important;
            max-height: 100%;
            max-width: 100%;
            display: block;
        }
        
        /* Center the chart in its container */
        #categoryChart {
            margin: 0 auto;
        }
        
        #data-dashboard-section .table-card-body {
            height: auto;
            max-height: 350px;
            padding: 0;
        }
        
        #transactionsTable {
            font-size: 0.9rem;
            margin-bottom: 0;
        }
        
        #transactionsTable th {
            font-weight: 600;
            background-color: #f8f9fa;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        #transactionsTable td {
            vertical-align: middle;
            padding: 0.5rem;
        }
        
        /* Responsive layout for dashboard */
        @media (max-width: 991.98px) {
            #data-dashboard-section .row {
                margin-bottom: 1rem !important;
            }
            
            #data-dashboard-section .col-lg-6 {
                margin-bottom: 1rem;
            }
            
            #data-dashboard-section .card .card-body {
                height: 350px;
            }
        }
        
        .bank-connection-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 15px;
            border-bottom: 1px solid #eee;
            margin-bottom: 10px;
        }
        .bank-logo {
            max-width: 40px;
            margin-right: 15px;
        }
    </style>
    
    <!-- Chart.js for Data Visualization -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
</head>
<body>
    <!-- Top Navbar -->
    <nav class="navbar navbar-expand-lg navbar-light sticky-top">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">
                <i class="fas fa-wallet"></i> TaaxDog
            </a>
            <div class="d-flex">
                <button class="connect-bank-btn" id="connect-bank-button">
                    Connect Bank
            </button>
            </div>
        </div>
    </nav>

    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <nav id="sidebar" class="col-md-3 col-lg-2 d-md-block sidebar collapse">
                <div class="sidebar-sticky">
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link active" href="#">
                                <i class="fas fa-tachometer-alt"></i> Dashboard
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" id="data-dashboard-nav-link">
                                <i class="fas fa-chart-bar text-primary"></i> Data Dashboard
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#">
                                <i class="fas fa-money-bill-wave text-success"></i> Net Income
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#">
                                <i class="fas fa-arrow-circle-down text-danger"></i> Total Expenses
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#">
                                <i class="fas fa-balance-scale text-primary"></i> Net Balance
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#">
                                <i class="fas fa-credit-card text-info"></i> Subscriptions
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#">
                                <i class="fas fa-bullseye text-warning"></i> Goals
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#">
                                <i class="fas fa-user-circle"></i> Your Tax Profile
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#">
                                <i class="fas fa-file-invoice-dollar"></i> Tax Return
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#">
                                <i class="fas fa-bell"></i> Notifications
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#">
                                <i class="fas fa-cog"></i> Settings
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" id="receipts-nav-link">
                                <i class="fas fa-receipt text-success"></i> Receipts
                            </a>
                        </li>
                    </ul>
                    
                    <!-- Logout button at bottom of sidebar -->
                    <div class="logout-button mt-auto">
                        <ul class="nav flex-column">
                            <li class="nav-item">
                                <a class="nav-link d-flex align-items-center" href="#" id="logout-button">
                                    <i class="fas fa-sign-out-alt text-danger me-2"></i>
                                    <span>Log Out</span>
                            </a>
                        </li>
                    </ul>
                    </div>
                </div>
            </nav>

            <!-- Main Content -->
            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4 main-content">
                <div class="row mt-5">
                    <!-- First Row - Stats Cards -->
                    <div class="col-md-3 mb-4">
                        <div class="card stats-card">
                            <div class="card-header">
                                Net Income
                                <i class="fas fa-arrow-circle-up income-icon"></i>
                        </div>
                            <div class="card-body">
                                <div class="stat-value" id="net-income-value">$0.00</div>
                                <div class="stat-change positive-change">
                                    <i class="fas fa-arrow-up"></i> +12.3% from last month
                    </div>
                </div>
                    </div>
                </div>
                    <div class="col-md-3 mb-4">
                        <div class="card stats-card">
                            <div class="card-header">
                                Total Expenses
                                <i class="fas fa-arrow-circle-down expense-icon"></i>
                            </div>
                            <div class="card-body">
                                <div class="stat-value" id="total-expenses-value">$0.00</div>
                                <div class="stat-change negative-change">
                                    <i class="fas fa-arrow-down"></i> -8.1% from last month
                            </div>
                        </div>
                    </div>
                    </div>
                    <div class="col-md-3 mb-4">
                        <div class="card stats-card">
                            <div class="card-header">
                                Net Balance
                                <i class="fas fa-balance-scale balance-icon"></i>
                            </div>
                            <div class="card-body">
                                <div class="stat-value" id="net-balance-value">$0.00</div>
                                <div class="stat-change positive-change">
                                    <i class="fas fa-arrow-up"></i> +15.2% from last month
                            </div>
                        </div>
                    </div>
                    </div>
                    <div class="col-md-3 mb-4">
                        <div class="card stats-card">
                            <div class="card-header">
                                Monthly Subscriptions
                                <i class="fas fa-credit-card subscription-icon"></i>
                            </div>
                            <div class="card-body">
                                <div class="stat-value" id="subscriptions-value">$0.00</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Second Row - Goals, Notifications, and Bank Accounts -->
                <div class="row mt-3">
                    <!-- Left Side - Goals -->
                    <div class="col-md-6">
                        <!-- Goals Card -->
                        <div class="card tile-card h-100" data-tile-type="goals">
                            <div class="card-header">
                                Goals Progress
                                <i class="fas fa-bullseye text-warning"></i>
                            </div>
                            <div class="card-body">
                                <div class="scrollable-content">
                                    <h3>3 Active Goals</h3>
                                    <div class="stat-change positive-change mb-4">
                                        <i class="fas fa-check-circle"></i> 60% Complete from last month
                            </div>
                                    
                                    <!-- Emergency Fund Goal -->
                                    <div class="goal-item">
                                        <div class="goal-details">
                                            <span>Emergency Fund</span>
                                            <span class="text-success">$5000.00</span>
                        </div>
                                        <div class="progress">
                                            <div class="progress-bar bg-success" role="progressbar" style="width: 50%" aria-valuenow="50" aria-valuemin="0" aria-valuemax="100"></div>
                                        </div>
                                        <div class="d-flex justify-content-between">
                                            <small>$5000.00 of $10000.00</small>
                                            <small>Due: 30/06/2024</small>
                    </div>
                </div>

                                    <!-- New Car Goal -->
                                    <div class="goal-item">
                                        <div class="goal-details">
                                            <span>New Car</span>
                                            <span class="text-success">$2500.00</span>
                            </div>
                                        <div class="progress">
                                            <div class="progress-bar bg-success" role="progressbar" style="width: 16.7%" aria-valuenow="16.7" aria-valuemin="0" aria-valuemax="100"></div>
                        </div>
                                        <div class="d-flex justify-content-between">
                                            <small>$2500.00 of $15000.00</small>
                                            <small>Due: 31/12/2024</small>
                    </div>
                            </div>
                                    
                                    <!-- Holiday Goal -->
                                    <div class="goal-item">
                                        <div class="goal-details">
                                            <span>Holiday</span>
                                            <span class="text-success">$1200.00</span>
                        </div>
                                        <div class="progress">
                                            <div class="progress-bar bg-success" role="progressbar" style="width: 40%" aria-valuenow="40" aria-valuemin="0" aria-valuemax="100"></div>
                    </div>
                                        <div class="d-flex justify-content-between">
                                            <small>$1200.00 of $3000.00</small>
                                            <small>Due: 15/09/2024</small>
                            </div>
                        </div>
                    </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Right Side - Bank Accounts and Notifications -->
                    <div class="col-md-6">
                        <!-- Bank Accounts Card -->
                        <div class="card tile-card mb-3" data-tile-type="bank-accounts" style="height: calc(50% - 10px);">
                            <div class="card-header">
                                Bank Accounts
                                <i class="fas fa-university text-primary"></i>
                            </div>
                            <div class="card-body">
                                <div class="scrollable-content">
                                    <div id="bank-connections-container">
                                        <!-- Bank connections will be loaded here -->
                                        <div class="text-center py-4" id="no-connections-message">
                                            <i class="fas fa-university fa-3x mb-3 text-muted"></i>
                                            <p>No bank accounts connected yet. Click the "Connect Bank" button in the top-right corner to get started.</p>
                                        </div>
                                        <div id="connections-list" style="display: none;">
                                            <!-- Bank connections will be loaded here -->
                                        </div>
                            </div>
                        </div>
                    </div>
                </div>

                        <!-- Notifications Card -->
                        <div class="card tile-card" data-tile-type="notifications" style="height: calc(50% - 10px);">
                            <div class="card-header">
                                Notifications
                                <i class="fas fa-bell text-warning"></i>
                            </div>
                            <div class="card-body">
                                <div class="scrollable-content">
                                    <h3>2 New Updates</h3>
                                    
                                    <!-- Notifications List -->
                                    <div class="notification-item">
                                        <h5>Tax Return Due</h5>
                                        <p>Your tax return is due in 2 weeks</p>
                                        <p class="notification-date">15/03/2024</p>
                                    </div>
                                    
                                    <div class="notification-item">
                                        <h5>Goal Milestone</h5>
                                        <p>Emergency Fund reached 75% of target</p>
                                        <p class="notification-date">10/03/2024</p>
                                    </div>
                                </div>
                                
                                <!-- Clock Display -->
                                <div class="clock-display">
                                    <span id="hours">14</span>:<span id="minutes">31</span>
                                    <div class="d-flex justify-content-between">
                                        <small>min</small>
                                        <small>hour</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Third Row - Receipts Section (initially hidden) -->
                <div class="row mt-3" id="receipts-section" style="display: none;">
                    <div class="col-12">
                        <div class="card shadow-sm mb-4">
                            <div class="card-header bg-white d-flex justify-content-between align-items-center py-3">
                                <h5 class="mb-0"><i class="fas fa-receipt text-primary me-2"></i>Receipts</h5>
                                <button class="btn btn-primary" id="upload-receipt-btn">
                                    <i class="fas fa-plus me-1"></i> Upload New Receipt
                                </button>
                            </div>
                            <div class="card-body">
                                <!-- Search and Filter Bar -->
                                <div class="row mb-4">
                                    <div class="col-md-4 mb-2 mb-md-0">
                                        <div class="input-group">
                                            <input type="text" class="form-control border-end-0" id="receipt-search" placeholder="Search merchant, items...">
                                            <button class="btn btn-outline-secondary border-start-0 bg-white" type="button" id="receipt-search-btn">
                                                <i class="fas fa-search text-muted"></i>
                                            </button>
                                        </div>
                                    </div>
                                    <div class="col-md-3 mb-2 mb-md-0">
                                        <select class="form-select" id="receipt-category-filter">
                                            <option value="">All Categories</option>
                                            <option value="groceries">Groceries</option>
                                            <option value="dining">Dining & Restaurants</option>
                                            <option value="entertainment">Entertainment</option>
                                            <option value="transportation">Transportation</option>
                                            <option value="utilities">Utilities</option>
                                            <option value="housing">Housing & Rent</option>
                                            <option value="healthcare">Healthcare</option>
                                            <option value="education">Education</option>
                                            <option value="shopping">Shopping</option>
                                            <option value="travel">Travel</option>
                                            <option value="business">Business Expenses</option>
                                            <option value="other">Other</option>
                                        </select>
                                    </div>
                                    <div class="col-md-3 mb-2 mb-md-0">
                                        <select class="form-select" id="receipt-date-filter">
                                            <option value="all">All Time</option>
                                            <option value="today">Today</option>
                                            <option value="week">This Week</option>
                                            <option value="month">This Month</option>
                                            <option value="quarter">This Quarter</option>
                                            <option value="year">This Year</option>
                                        </select>
                                    </div>
                                    <div class="col-md-2">
                                        <button class="btn btn-outline-secondary w-100" id="reset-filters-btn">
                                            <i class="fas fa-undo me-1"></i> Reset
                                        </button>
                                    </div>
                                </div>
                                
                                <div id="no-receipts-message" style="display: none;" class="text-center p-5">
                                    <div class="mb-4">
                                        <i class="fas fa-receipt fa-4x text-secondary opacity-50"></i>
                                    </div>
                                    <h5 class="text-muted mb-3">No receipts found</h5>
                                    <p class="text-muted mb-4">Upload your first receipt to start tracking your expenses</p>
                                    <button class="btn btn-primary btn-lg" id="upload-first-receipt-btn">
                                        <i class="fas fa-plus me-2"></i> Upload Your First Receipt
                                    </button>
                                </div>
                                
                                <div id="receipts-list" style="display: none;">
                                    <div class="table-responsive rounded">
                                        <table class="table table-hover align-middle">
                                            <thead class="table-light">
                                                <tr>
                                                    <th class="ps-3">Date</th>
                                                    <th>Merchant</th>
                                                    <th>Category</th>
                                                    <th>Amount</th>
                                                    <th>Status</th>
                                                    <th class="text-end pe-3">Actions</th>
                                                </tr>
                                            </thead>
                                            <tbody id="receipts-table-body">
                                                <!-- Receipts will be loaded here -->
                                            </tbody>
                                        </table>
                                    </div>
                                    <div class="d-flex justify-content-between align-items-center mt-3">
                                        <div>
                                            <span class="text-muted">Showing <span id="receipts-count">0</span> receipts</span>
                                        </div>
                                        <nav aria-label="Receipt pagination">
                                            <ul class="pagination pagination-sm" id="receipts-pagination">
                                                <!-- Pagination will be added here -->
                                            </ul>
                                        </nav>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Receipt Statistics Card -->
                        <div class="card shadow-sm mb-4">
                            <div class="card-header bg-white py-3">
                                <h5 class="mb-0"><i class="fas fa-chart-pie text-primary me-2"></i>Receipt Summary</h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-3 mb-3 mb-md-0">
                                        <div class="card border-0 bg-light h-100">
                                            <div class="card-body text-center">
                                                <h6 class="text-muted mb-2">Total Receipts</h6>
                                                <h3 id="total-receipts-count">0</h3>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-3 mb-3 mb-md-0">
                                        <div class="card border-0 bg-light h-100">
                                            <div class="card-body text-center">
                                                <h6 class="text-muted mb-2">Total Spent</h6>
                                                <h3 id="total-receipts-amount">$0.00</h3>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-3 mb-3 mb-md-0">
                                        <div class="card border-0 bg-light h-100">
                                            <div class="card-body text-center">
                                                <h6 class="text-muted mb-2">Matched Receipts</h6>
                                                <h3 id="matched-receipts-count">0</h3>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="card border-0 bg-light h-100">
                                            <div class="card-body text-center">
                                                <h6 class="text-muted mb-2">Average Amount</h6>
                                                <h3 id="average-receipt-amount">$0.00</h3>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Data Dashboard Section -->
    <div class="row mt-3" id="data-dashboard-section" style="display: none;">
        <div class="col-12">
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-white d-flex justify-content-between align-items-center py-3">
                    <h5 class="mb-0"><i class="fas fa-chart-bar text-primary me-2"></i>Data Dashboard</h5>
                </div>
                <div class="card-body p-4">
                    <!-- Category chart in full width with controlled width -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <div class="card shadow-sm">
                                <div class="card-header bg-white">
                                    <h6 class="mb-0">Expenses by Category</h6>
                                </div>
                                <div class="card-body" style="height: 450px;">
                                    <div style="position: relative; height: 100%; max-width: 900px; margin: 0 auto;">
                                        <canvas id="categoryChart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Time chart in full width -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <div class="card shadow-sm">
                                <div class="card-header bg-white">
                                    <h6 class="mb-0">Expenses Over Time</h6>
                                </div>
                                <div class="card-body" style="height: 350px;">
                                    <canvas id="timeChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Transactions table -->
                    <div class="row">
                        <div class="col-12">
                            <div class="card shadow-sm">
                                <div class="card-header bg-white">
                                    <h6 class="mb-0">Transactions Analysis</h6>
                                </div>
                                <div class="card-body table-card-body">
                                    <div class="table-responsive" style="max-height: 300px; overflow-y: auto;">
                                        <table class="table table-hover table-sm" id="transactionsTable">
                                            <thead class="sticky-top bg-white">
                                                <tr>
                                                    <th>Date</th>
                                                    <th>Merchant</th>
                                                    <th>Category</th>
                                                    <th>Amount</th>
                                                    <th>Type</th>
                                                </tr>
                                            </thead>
                                            <tbody id="transactionsTableBody">
                                                <!-- Transactions will be loaded here -->
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bank Connection Modal -->
    <div class="modal fade" id="bankConnectionModal" tabindex="-1" aria-labelledby="bankConnectionModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="bankConnectionModalLabel">Connect Your Bank Account</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="bank-connect-form" class="p-3">
                        <p class="lead mb-4">Please select your bank and enter your credentials to securely connect your account.</p>
                        
                        <div class="mb-3">
                            <label for="bankSelection" class="form-label">Select Your Bank</label>
                            <select class="form-select" id="bankSelection" required>
                                <option value="" selected disabled>Choose your bank...</option>
                                <option value="au-cba">Commonwealth Bank</option>
                                <option value="au-nab">NAB</option>
                                <option value="au-anz">ANZ</option>
                                <option value="au-westpac">Westpac</option>
                                <option value="au-ing">ING</option>
                                <option value="au-macquarie">Macquarie Bank</option>
                                <option value="au-bankwest">Bankwest</option>
                                <option value="au-stgeorge">St.George</option>
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label for="bankUsername" class="form-label">Bank Username/ID</label>
                            <input type="text" class="form-control" id="bankUsername" placeholder="Your bank login username" required>
                        </div>
                        
                        <div class="mb-3">
                            <label for="bankPassword" class="form-label">Bank Password</label>
                            <input type="password" class="form-control" id="bankPassword" placeholder="Your bank login password" required>
                            <div class="form-text">Your credentials are securely transmitted and never stored on our servers.</div>
                        </div>
                        
                        <div class="form-check mb-4">
                            <input class="form-check-input" type="checkbox" id="termsCheck" required>
                            <label class="form-check-label" for="termsCheck">
                                I agree to the <a href="#" data-bs-toggle="modal" data-bs-target="#termsModal">terms and conditions</a> for bank account connectivity
                            </label>
                        </div>
                        
                        <button type="button" id="connect-bank-submit" class="btn btn-primary">Connect</button>
                    </div>
                    
                    <div id="auth-link-container" class="text-center p-3" style="display: none;">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-3">Establishing secure connection to your bank...</p>
                    </div>
                    <iframe id="auth-link-iframe" style="display: none;" title="Bank Connection"></iframe>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Terms and Conditions Modal -->
    <div class="modal fade" id="termsModal" tabindex="-1" aria-labelledby="termsModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="termsModalLabel">Terms and Conditions</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>By connecting your bank account, you agree to allow TAAXDOG to:</p>
                    <ul>
                        <li>Access your account and transaction data through the Basiq API</li>
                        <li>Use your data to provide financial insights and reports</li>
                        <li>Store necessary information to maintain the connection</li>
                    </ul>
                    <p>Your login credentials are transmitted securely and are not stored by TAAXDOG. All data is handled according to our privacy policy.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" data-bs-dismiss="modal">I Understand</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Tile Content Modal -->
    <div class="modal fade" id="tileContentModal" tabindex="-1" aria-labelledby="tileContentModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="tileContentModalLabel">Tile Content</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="tile-modal-content">
                        <!-- Tile content will be loaded here -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" id="add-goal-button" class="btn btn-primary" style="display: none;">Add New Goal</button>
                    <button type="button" id="add-bank-button" class="btn btn-primary" style="display: none;">Add New Bank Account</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Receipt Upload Modal -->
    <div class="modal fade" id="receipt-upload-modal" tabindex="-1" aria-labelledby="receipt-upload-modal-label" aria-hidden="true" data-bs-backdrop="static">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="receipt-upload-modal-label">Add Receipt</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" id="receipt-modal-close"></button>
                </div>
                <div class="modal-body">
                    <!-- Method selection tabs -->
                    <ul class="nav nav-tabs mb-3" id="receipt-method-tabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="manual-tab" data-bs-toggle="tab" data-bs-target="#manual-entry" type="button" role="tab" aria-controls="manual-entry" aria-selected="true">
                                <i class="fas fa-keyboard me-2"></i>Manual Entry
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="upload-tab" data-bs-toggle="tab" data-bs-target="#upload-receipt" type="button" role="tab" aria-controls="upload-receipt" aria-selected="false">
                                <i class="fas fa-upload me-2"></i>Upload Image
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="camera-tab" data-bs-toggle="tab" data-bs-target="#camera-capture" type="button" role="tab" aria-controls="camera-capture" aria-selected="false">
                                <i class="fas fa-camera me-2"></i>Take Photo
                            </button>
                        </li>
                    </ul>
                    
                    <!-- Tab content -->
                    <div class="tab-content" id="receipt-method-content">
                        <!-- Tab: Manual Entry -->
                        <div class="tab-pane fade" id="manual-entry" role="tabpanel" aria-labelledby="manual-tab">
                            <form id="manual-receipt-form">
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="manual-merchant" class="form-label">Merchant/Store</label>
                                        <input type="text" class="form-control" id="manual-merchant" required>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="manual-date" class="form-label">Date</label>
                                        <input type="date" class="form-control" id="manual-date" required>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="manual-total" class="form-label">Total Amount</label>
                                        <div class="input-group">
                                            <span class="input-group-text">$</span>
                                            <input type="number" step="0.01" min="0" class="form-control" id="manual-total" required>
                                        </div>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="manual-tax" class="form-label">Tax Amount (Optional)</label>
                                        <div class="input-group">
                                            <span class="input-group-text">$</span>
                                            <input type="number" step="0.01" min="0" class="form-control" id="manual-tax">
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="manual-category" class="form-label">Category</label>
                                        <select class="form-select" id="manual-category">
                                            <option value="Food and Dining">Food and Dining</option>
                                            <option value="Shopping">Shopping</option>
                                            <option value="Travel">Travel</option>
                                            <option value="Entertainment">Entertainment</option>
                                            <option value="Office">Office</option>
                                            <option value="Groceries">Groceries</option>
                                            <option value="Automotive">Automotive</option>
                                            <option value="Utilities">Utilities</option>
                                            <option value="Healthcare">Healthcare</option>
                                            <option value="Other">Other</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="manual-notes" class="form-label">Notes (Optional)</label>
                                        <textarea class="form-control" id="manual-notes" rows="1"></textarea>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Receipt Items (Optional)</label>
                                    <div id="manual-items-container">
                                        <!-- Items will be added here -->
                                    </div>
                                    <button type="button" id="add-item-btn" class="btn btn-sm btn-outline-secondary mt-2">
                                        <i class="fas fa-plus"></i> Add Item
                                    </button>
                                </div>
                                <div class="d-grid">
                                    <button type="button" id="manual-submit" class="btn btn-primary" onclick="saveManualReceipt()">Save Receipt</button>
                                </div>
                            </form>
                        </div>
                        
                        <!-- Tab: Upload Receipt -->
                        <div class="tab-pane fade" id="upload-receipt" role="tabpanel" aria-labelledby="upload-tab">
                            <form id="receipt-upload-form" class="needs-validation" novalidate>
                                <div class="mb-3">
                                    <label for="receipt-image" class="form-label">Receipt Image</label>
                                    <input type="file" class="form-control" id="receipt-image" accept="image/*" required>
                                    <div class="invalid-feedback">Please select a receipt image.</div>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="receipt-ocr-provider" class="form-label">OCR Provider</label>
                                    <select class="form-select" id="receipt-ocr-provider">
                                        <option value="tabscanner">Tabscanner (Recommended)</option>
                                        <option value="docuclipper">DocuClipper</option>
                                    </select>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="receipt-category" class="form-label">Category</label>
                                    <select class="form-select" id="receipt-category" required>
                                        <option value="">Select a category</option>
                                        <option value="Groceries">Groceries</option>
                                        <option value="Dining">Dining</option>
                                        <option value="Transportation">Transportation</option>
                                        <option value="Entertainment">Entertainment</option>
                                        <option value="Healthcare">Healthcare</option>
                                        <option value="Shopping">Shopping</option>
                                        <option value="Utilities">Utilities</option>
                                        <option value="Housing">Housing</option>
                                        <option value="Travel">Travel</option>
                                        <option value="Education">Education</option>
                                        <option value="Business">Business</option>
                                        <option value="Uncategorized">Uncategorized</option>
                                    </select>
                                    <div class="invalid-feedback">Please select a category.</div>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="receipt-notes" class="form-label">Notes (Optional)</label>
                                    <textarea class="form-control" id="receipt-notes" rows="3"></textarea>
                                </div>
                                <div class="mb-3">
                                    <div id="receipt-preview-container" style="display: none;">
                                        <h6>Preview:</h6>
                                        <img id="receipt-preview" src="" alt="Receipt Preview" style="max-width: 100%; max-height: 300px;" class="border rounded">
                                    </div>
                                </div>
                                
                                <!-- Progress bar and results -->
                                <div id="receipt-upload-progress" style="display: none;" class="mb-3">
                                    <div class="progress">
                                        <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 100%" aria-valuenow="100" aria-valuemin="0" aria-valuemax="100"></div>
                                    </div>
                                    <p class="text-center mt-2"><small>Processing receipt - this may take a few moments...</small></p>
                                </div>
                                
                                <div id="receipt-upload-result" style="display: none;" class="mb-3 alert"></div>
                                
                                <!-- Buttons -->
                                <div class="d-grid gap-2">
                                    <button type="button" class="btn btn-primary" id="receipt-upload-submit">Process Receipt</button>
                                    <button type="button" class="btn btn-success" id="upload-another-receipt" style="display: none;">Upload Another Receipt</button>
                                </div>
                            </form>
                        </div>
                        
                        <!-- Tab: Camera Capture -->
                        <div class="tab-pane fade" id="camera-capture" role="tabpanel" aria-labelledby="camera-tab">
                            <div class="mb-3">
                                <div id="camera-container" class="text-center">
                                    <video id="camera-video" autoplay playsinline style="max-width: 100%; max-height: 300px; display: none;"></video>
                                    <canvas id="camera-canvas" style="display: none;"></canvas>
                                    <img id="camera-preview" style="max-width: 100%; max-height: 300px; display: none;" alt="Captured Receipt">
                                    
                                    <div id="camera-placeholder" class="py-5 border rounded bg-light text-center">
                                        <i class="fas fa-camera fa-3x mb-3 text-muted"></i>
                                        <p>Click the button below to access your camera</p>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="d-grid gap-2 mb-3">
                                <button type="button" id="camera-start-btn" class="btn btn-outline-primary" onclick="startCamera()">
                                    <i class="fas fa-camera me-2"></i>Start Camera
                                </button>
                                <button type="button" id="camera-capture-btn" class="btn btn-primary" style="display: none;">
                                    <i class="fas fa-camera me-2"></i>Capture Receipt
                                </button>
                                <button type="button" id="camera-retake-btn" class="btn btn-outline-secondary" style="display: none;">
                                    <i class="fas fa-redo me-2"></i>Retake Photo
                                </button>
                                <button type="button" id="camera-submit-btn" class="btn btn-success" style="display: none;">
                                    <i class="fas fa-check me-2"></i>Use This Photo
                                </button>
                            </div>
                            
                            <div class="alert alert-info" role="alert">
                                <i class="fas fa-info-circle"></i> Take a clear photo of your receipt in good lighting for best results.
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Receipt Detail Modal -->
    <div class="modal fade" id="receipt-detail-modal" tabindex="-1" aria-labelledby="receipt-detail-modal-label" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="receipt-detail-modal-label">Receipt Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card mb-3">
                                <div class="card-header">Receipt Information</div>
                                <div class="card-body">
                                    <div class="row mb-2">
                                        <div class="col-4 text-muted">Merchant:</div>
                                        <div class="col-8" id="detail-merchant"></div>
                                    </div>
                                    <div class="row mb-2">
                                        <div class="col-4 text-muted">Date:</div>
                                        <div class="col-8" id="detail-date"></div>
                                    </div>
                                    <div class="row mb-2">
                                        <div class="col-4 text-muted">Total:</div>
                                        <div class="col-8" id="detail-total"></div>
                                    </div>
                                    <div class="row mb-2">
                                        <div class="col-4 text-muted">Tax:</div>
                                        <div class="col-8" id="detail-tax"></div>
                                    </div>
                                    <div class="row mb-2">
                                        <div class="col-4 text-muted">Category:</div>
                                        <div class="col-8">
                                            <select class="form-select form-select-sm" id="detail-category">
                                                <option value="groceries">Groceries</option>
                                                <option value="dining">Dining & Restaurants</option>
                                                <option value="entertainment">Entertainment</option>
                                                <option value="transportation">Transportation</option>
                                                <option value="utilities">Utilities</option>
                                                <option value="housing">Housing & Rent</option>
                                                <option value="healthcare">Healthcare</option>
                                                <option value="education">Education</option>
                                                <option value="shopping">Shopping</option>
                                                <option value="travel">Travel</option>
                                                <option value="business">Business Expenses</option>
                                                <option value="other">Other</option>
                                            </select>
                                            <button class="btn btn-sm btn-outline-primary mt-1" id="update-category-btn">Update</button>
                                        </div>
                                    </div>
                                    <div class="row mb-2">
                                        <div class="col-4 text-muted">Notes:</div>
                                        <div class="col-8">
                                            <textarea class="form-control form-control-sm" id="detail-notes" rows="2"></textarea>
                                            <button class="btn btn-sm btn-outline-primary mt-1" id="update-notes-btn">Update</button>
                                        </div>
                                    </div>
                                    <div class="row mb-2">
                                        <div class="col-4 text-muted">Receipt ID:</div>
                                        <div class="col-8" id="detail-receipt-id"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card mb-3">
                                <div class="card-header">Transaction Match</div>
                                <div class="card-body">
                                    <div id="no-match-message" style="display: none;">
                                        <p>No transaction matched with this receipt.</p>
                                        <button class="btn btn-sm btn-outline-primary" id="find-match-btn">Find Match</button>
                                    </div>
                                    <div id="match-details" style="display: none;">
                                        <div class="row mb-2">
                                            <div class="col-4 text-muted">Transaction:</div>
                                            <div class="col-8" id="detail-transaction-desc"></div>
                                        </div>
                                        <div class="row mb-2">
                                            <div class="col-4 text-muted">Amount:</div>
                                            <div class="col-8" id="detail-transaction-amount"></div>
                                        </div>
                                        <div class="row mb-2">
                                            <div class="col-4 text-muted">Date:</div>
                                            <div class="col-8" id="detail-transaction-date"></div>
                                        </div>
                                        <div class="row mb-2">
                                            <div class="col-4 text-muted">Confidence:</div>
                                            <div class="col-8" id="detail-match-confidence"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">Receipt Items</div>
                        <div class="card-body">
                            <div id="no-items-message" style="display: none;">
                                <p>No detailed items were extracted from this receipt.</p>
                            </div>
                            <div id="items-table-container" style="display: none;">
                                <div class="table-responsive">
                                    <table class="table table-sm">
                                        <thead>
                                            <tr>
                                                <th>Item</th>
                                                <th>Quantity</th>
                                                <th>Unit Price</th>
                                                <th>Total</th>
                                            </tr>
                                        </thead>
                                        <tbody id="items-table-body">
                                            <!-- Items will be loaded here -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-danger" id="delete-receipt-btn">Delete</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Firebase App (the core Firebase SDK) -->
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-auth-compat.js"></script>
    
    <!-- Add this Firebase config and initialization code -->
    <script src="firebase-config.js"></script>
    <script>
        // Initialize Firebase with imported config
        if (typeof firebaseConfig !== 'undefined') {
            console.log('Initializing Firebase with config');
            firebase.initializeApp(firebaseConfig);
        } else {
            console.error('Firebase config is missing. Create a firebase-config.js file with your Firebase configuration.');
            // Fallback for development/testing only - DO NOT use in production
            firebase.initializeApp({
                apiKey: "demo-key-for-development",
                authDomain: "taaxdog-demo.firebaseapp.com",
                projectId: "taaxdog-demo",
                storageBucket: "taaxdog-demo.appspot.com",
                messagingSenderId: "123456789012",
                appId: "1:123456789012:web:abcdef1234567890abcdef"
            });
        }
        
        // Initialize simulated auth for development if no real auth
        function initSimulatedAuth() {
            console.log('Initializing simulated auth for development');
            // Only simulate if not already logged in
            if (!firebase.auth().currentUser) {
                // Create a simulated user for development
                const simulatedUser = {
                    uid: 'sim-user-' + Date.now(),
                    email: 'demo@example.com',
                    displayName: 'Demo User',
                    getIdToken: () => Promise.resolve('demo-token')
                };
                
                // Override the auth methods to use the simulated user
                const originalCurrentUser = firebase.auth().currentUser;
                const originalGetIdToken = firebase.auth().currentUser?.getIdToken;
                
                // Only override if not already set
                if (!originalCurrentUser) {
                    Object.defineProperty(firebase.auth(), 'currentUser', {
                        get: function() { return simulatedUser; }
                    });
                    
                    firebase.auth().getIdToken = () => Promise.resolve('demo-token');
                }
            }
        }
        
        // Check if we're in development mode and initialize simulated auth
        if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
            console.log('Development environment detected, using simulated auth if needed');
            setTimeout(initSimulatedAuth, 1000); // Give real auth a chance to initialize first
        }
        
        // Add this right at the top of your script section
        console.log('Script loading...');

        // Global variables to track financial data
        let globalStats = {
            netIncome: 0,
            totalExpenses: 0,
            netBalance: 0,
            subscriptions: 0,
            receiptsTotal: 0
        };

        // Format currency helper function
        function formatCurrency(amount) {
            if (amount === undefined || amount === null) {
                return '';
            }
            
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD'
            }).format(amount);
        }

        // Update dashboard stats based on all data
        function updateDashboardStats() {
            console.log('Updating dashboard stats with:', globalStats);
            
            // Update the stats cards
            document.getElementById('net-income-value').textContent = formatCurrency(globalStats.netIncome);
            document.getElementById('total-expenses-value').textContent = formatCurrency(globalStats.totalExpenses);
            document.getElementById('net-balance-value').textContent = formatCurrency(globalStats.netBalance);
            document.getElementById('subscriptions-value').textContent = formatCurrency(globalStats.subscriptions);
        }

        // When page loads, set up receipts functionality immediately
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM fully loaded');
            
            // Setup receipts functionality
            setupReceiptsFunctionality();
            
            // Setup upload receipt button functionality
            setupUploadReceiptFunctionality();
            
            // Setup navigation menu
            setupNavigationMenu();
            
            // Initialize financial data
            initializeFinancialData();
            
            // Setup tiles click behavior
            setupTilesClickBehavior();
            
            // Add event listener for dashboard navigation to refresh stats
            document.querySelector('.sidebar .nav-link:first-child').addEventListener('click', function() {
                console.log('Dashboard link clicked, refreshing stats');
                updateDashboardStats();
            });
            
            // Generate simulated transaction data for development and testing
            generateSimulatedTransactions();
            
            // Other existing event handlers...
            // ... existing code ...
        });
        
        // Generate simulated transaction data for testing in development
        function generateSimulatedTransactions() {
            // Only run in development mode
            const isDevelopment = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
            if (!isDevelopment) return;
            
            // Use a setTimeout to defer execution to avoid blocking the UI
            setTimeout(() => {
                try {
                    console.log('Generating simulated transactions for development testing');
                    
                    // Check if we already have simulated transactions
                    const existingTransactions = localStorage.getItem('simulatedTransactions');
                    if (existingTransactions) {
                        try {
                            const transactions = JSON.parse(existingTransactions);
                            if (Array.isArray(transactions) && transactions.length > 0) {
                                console.log('Using existing simulated transactions:', transactions.length);
                                return; // Use existing transactions
                            }
                        } catch (e) {
                            console.error('Error parsing existing transactions:', e);
                        }
                    }
                    
                    // Generate random transactions for the last 30 days
                    const simulatedTransactions = [];
                    const today = new Date();
                    const merchants = [
                        'Grocery Store', 'Supermarket', 'Coffee Shop', 'Gas Station', 
                        'Restaurant', 'Department Store', 'Pharmacy', 'Hardware Store',
                        'Online Store', 'Electronics Shop', 'Clothing Store', 'Bookstore'
                    ];
                    
                    // Create transactions in batches to avoid freezing the UI
                    const batchSize = 10;
                    const totalTransactions = 50;
                    
                    function generateBatch(startIndex) {
                        const endIndex = Math.min(startIndex + batchSize, totalTransactions);
                        console.log(`Generating transactions batch ${startIndex} to ${endIndex}`);
                        
                        for (let i = startIndex; i < endIndex; i++) {
                            try {
                                // Random date within last 30 days
                                const daysAgo = Math.floor(Math.random() * 30);
                                const transactionDate = new Date(today);
                                transactionDate.setDate(today.getDate() - daysAgo);
                                
                                // Random merchant
                                const merchant = merchants[Math.floor(Math.random() * merchants.length)];
                                
                                // Random amount between $1 and $200
                                const amount = -(Math.random() * 199 + 1).toFixed(2);
                                
                                // Create transaction
                                simulatedTransactions.push({
                                    id: 'txn-' + Date.now() + '-' + i,
                                    date: transactionDate.toISOString().split('T')[0],
                                    postDate: transactionDate.toISOString(),
                                    amount: parseFloat(amount),
                                    description: merchant,
                                    merchant: merchant,
                                    status: 'posted',
                                    account: 'acct_' + Math.floor(Math.random() * 3 + 1)
                                });
                            } catch (err) {
                                console.error('Error generating transaction:', err);
                            }
                        }
                        
                        // If we've generated all transactions, save to localStorage
                        if (endIndex >= totalTransactions) {
                            localStorage.setItem('simulatedTransactions', JSON.stringify(simulatedTransactions));
                            console.log('Generated simulated transactions:', simulatedTransactions.length);
                        } else {
                            // Otherwise, schedule the next batch
                            setTimeout(() => generateBatch(endIndex), 0);
                        }
                    }
                    
                    // Start generating transactions in batches
                    generateBatch(0);
                    
                } catch (error) {
                    console.error('Error generating simulated transactions:', error);
                }
            }, 100);
        }

        // Initialize the dashboard with sample financial data
        function initializeFinancialData() {
            console.log('Initializing financial data');
            
            // First try to load saved stats
            const statsLoaded = loadFinancialStats();
            
            if (!statsLoaded) {
                console.log('No saved stats found, using sample data');
                
                // For demonstration, we'll use sample data
                // In a real app, this would come from an API call
                
                // Start with bank connections data
                let connectionTotal = 0;
                const bankConnections = getSavedBankConnections();
                
                bankConnections.forEach(connection => {
                    if (connection.balance) {
                        connectionTotal += parseFloat(connection.balance);
                    }
                });
                
                // Simulate some expenses (we'll also add receipts data later)
                globalStats.totalExpenses = 1245.67;
                
                // Simulate some income
                globalStats.netIncome = 3500.00;
                
                // Calculate balance
                globalStats.netBalance = globalStats.netIncome - globalStats.totalExpenses;
                
                // Simulate subscriptions
                globalStats.subscriptions = 86.99;
                
                // Save initial stats
                saveFinancialStats();
            }
            
            // Now load receipts and add their totals
            loadReceiptsForStats();
            
            // Initial dashboard update
            updateDashboardStats();
        }

        // Load receipts specifically to update stats
        function loadReceiptsForStats() {
            console.log('Loading receipts for stats update');
            
            // In development mode with simulated auth
            if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
                // Simulate receipt data for development
                setTimeout(() => {
                    // Add sample receipt totals to expenses
                    const receiptTotal = 78.94; // Example total from receipts
                    globalStats.receiptsTotal += receiptTotal;
                    globalStats.totalExpenses += receiptTotal;
                    globalStats.netBalance = globalStats.netIncome - globalStats.totalExpenses;
                    
                    // Update the dashboard
                    updateDashboardStats();
                    console.log('Updated stats with simulated receipt data');
                }, 500);
                return;
            }
        
        // Check if user is logged in
            if (!firebase.auth().currentUser) {
                console.error('User not logged in, cannot load receipts for stats');
                return;
            }
            
            // Get the Firebase ID token
            firebase.auth().currentUser.getIdToken(true)
                .then(idToken => {
                    console.log('Got Firebase ID token, fetching receipts for stats');
                    // Fetch receipts from API
                    return fetch('/api/receipts', {
                        headers: {
                            'Authorization': idToken
                        }
                    });
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Failed to load receipts. Server returned: ' + response.status);
                    }
                    
                    return response.json();
                })
                .then(data => {
                    if (!data.success) {
                        throw new Error(data.error || 'Failed to load receipts.');
                    }
                    
                    const receipts = data.receipts || [];
                    
                    // Calculate receipt totals
                    let receiptTotal = 0;
                    receipts.forEach(receipt => {
                        if (receipt.total_amount) {
                            receiptTotal += parseFloat(receipt.total_amount);
                        }
                    });
                    
                    // Update global stats
                    globalStats.receiptsTotal = receiptTotal;
                    globalStats.totalExpenses += receiptTotal;
                    globalStats.netBalance = globalStats.netIncome - globalStats.totalExpenses;
                    
                    // Update the dashboard
                    updateDashboardStats();
                })
                .catch(error => {
                    console.error('Error loading receipts for stats:', error);
                });
        }

        // Setup links in the left navigation menu
        function setupNavigationMenu() {
            console.log('Setting up navigation menu links');
            
            // Get all nav links
            const navLinks = document.querySelectorAll('.sidebar .nav-link');
            
            // Get all main content rows
            const mainRows = document.querySelectorAll('main .row:not(#receipts-section)');
            const receiptsSection = document.getElementById('receipts-section');
            
            // Add click event to all nav links
            navLinks.forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    
                    // Only process if not already active
                    if (!this.classList.contains('active')) {
                        console.log('Nav link clicked:', this.textContent.trim());
                        
                        // Remove active class from all links
                        navLinks.forEach(l => l.classList.remove('active'));
                        
                        // Add active class to clicked link
                        this.classList.add('active');
                        
                        // Handle special case for Receipts
                        if (this.id === 'receipts-nav-link') {
                            // Hide all main rows
                            mainRows.forEach(row => row.style.display = 'none');
                            
                            // Show receipts section
                            if (receiptsSection) {
                                receiptsSection.style.display = 'flex';
                                
                                // Load receipts if not already loaded
                                try {
                                    loadReceipts();
                                } catch (error) {
                                    console.error('Error loading receipts:', error);
                                }
                            }
                            return;
                        }
                        
                        // Handle special case for Data Dashboard
                        if (this.id === 'data-dashboard-nav-link') {
                            // Hide all main rows
                            mainRows.forEach(row => row.style.display = 'none');
                            
                            // Hide receipts section
                            if (receiptsSection) {
                                receiptsSection.style.display = 'none';
                            }
                            
                            // Show data dashboard section
                            const dataDashboardSection = document.getElementById('data-dashboard-section');
                            if (dataDashboardSection) {
                                dataDashboardSection.style.display = 'flex';
                                
                                // Initialize dashboard if not already initialized
                                try {
                                    initializeDataDashboard();
                                } catch (error) {
                                    console.error('Error initializing data dashboard:', error);
                                    alert('Error initializing data dashboard: ' + error.message);
                                }
                            }
                            return;
                        }
                        
                        // For other links, show the main dashboard
                        // Hide receipts section
                        if (receiptsSection) {
                            receiptsSection.style.display = 'none';
                        }
                        
                        // Show all main rows
                        mainRows.forEach(row => row.style.display = '');
                        
                        // Update dashboard stats when returning to dashboard
                        updateDashboardStats();
                        
                        // Scroll to specific section if needed
                        // This maps menu items to their corresponding dashboard sections
                        const sectionMap = {
                            'Dashboard': null, // Just refresh the stats
                            'Net Income': document.querySelector('.stats-card:nth-child(1)'),
                            'Total Expenses': document.querySelector('.stats-card:nth-child(2)'),
                            'Net Balance': document.querySelector('.stats-card:nth-child(3)'),
                            'Subscriptions': document.querySelector('.stats-card:nth-child(4)'),
                            'Goals': document.querySelector('[data-tile-type="goals"]'),
                            'Notifications': document.querySelector('[data-tile-type="notifications"]'),
                            'Your Tax Profile': null, // Will implement when this section exists
                            'Tax Return': null, // Will implement when this section exists
                            'Settings': null, // Will implement when this section exists
                        };
                        
                        // Get the text of the clicked link
                        const linkText = this.textContent.trim();
                        
                        // Find the corresponding section
                        const section = sectionMap[linkText];
                        
                        // If we found a section, scroll to it
                        if (section) {
                            section.scrollIntoView({ behavior: 'smooth' });
                            
                            // Add a subtle highlight effect
                            section.style.transition = 'box-shadow 0.3s ease, transform 0.3s ease';
                            section.style.boxShadow = '0 0 20px rgba(67, 97, 238, 0.6)';
                            section.style.transform = 'scale(1.02)';
                            
                            // Remove highlight after a delay
                            setTimeout(() => {
                                section.style.boxShadow = '';
                                section.style.transform = 'scale(1)';
                            }, 1500);
                        }
                    }
                });
            });
            
            // Set Dashboard as active by default
            const dashboardLink = document.querySelector('.sidebar .nav-link:first-child');
            if (dashboardLink && !dashboardLink.classList.contains('active')) {
                dashboardLink.classList.add('active');
            }
        }

        // Setup click behavior for dashboard tiles
        function setupTilesClickBehavior() {
            console.log('Setting up tiles click behavior');
            
            // Get all tile cards
            const tileCards = document.querySelectorAll('.tile-card');
            
            // Get the modal elements
            const tileModal = new bootstrap.Modal(document.getElementById('tileContentModal'));
            const modalTitle = document.getElementById('tileContentModalLabel');
            const modalContent = document.getElementById('tile-modal-content');
            const addGoalButton = document.getElementById('add-goal-button');
            const addBankButton = document.getElementById('add-bank-button');
            
            // Add click event to all tile cards
            tileCards.forEach(card => {
                card.addEventListener('click', function() {
                    console.log('Tile clicked:', this.dataset.tileType);
                    
                    // Set the modal title based on the tile type
                    const tileType = this.dataset.tileType;
                    
                    // Hide all special buttons
                    addGoalButton.style.display = 'none';
                    addBankButton.style.display = 'none';
                    
                    switch (tileType) {
                        case 'goals':
                            modalTitle.textContent = 'Goals Progress';
                            const goalsContent = this.querySelector('.scrollable-content').cloneNode(true);
                            modalContent.innerHTML = '';
                            modalContent.appendChild(goalsContent);
                            addGoalButton.style.display = 'block';
                            break;
                            
                        case 'bank-accounts':
                            modalTitle.textContent = 'Bank Accounts';
                            const bankContent = this.querySelector('.scrollable-content').cloneNode(true);
                            modalContent.innerHTML = '';
                            modalContent.appendChild(bankContent);
                            addBankButton.style.display = 'block';
                            break;
                            
                        case 'notifications':
                            modalTitle.textContent = 'Notifications';
                            const notifContent = this.querySelector('.scrollable-content').cloneNode(true);
                            modalContent.innerHTML = '';
                            modalContent.appendChild(notifContent);
                            break;
                            
                        default:
                            modalTitle.textContent = 'Tile Content';
                            modalContent.innerHTML = '<p>No content available.</p>';
                    }
                    
                    // Show the modal
                    tileModal.show();
                });
            });
        }

        // Add receipt to the total expenses when uploaded
        function addReceiptToExpenses(receipt) {
            console.log('Adding receipt to expenses:', receipt);
            
            if (receipt && receipt.total_amount) {
                const amount = parseFloat(receipt.total_amount);
                
                // Update global stats
                globalStats.receiptsTotal += amount;
                globalStats.totalExpenses += amount;
                globalStats.netBalance = globalStats.netIncome - globalStats.totalExpenses;
                
                // Update the dashboard
                updateDashboardStats();
                
                // Save the updated stats to localStorage for persistence
                saveFinancialStats();
                
                console.log('Updated expenses with receipt amount:', amount);
            }
        }

        // Add function to save and load financial stats for persistence
        function saveFinancialStats() {
            console.log('Saving financial stats to localStorage');
            localStorage.setItem('taaxdogFinancialStats', JSON.stringify(globalStats));
        }
        
        function loadFinancialStats() {
            console.log('Loading financial stats from localStorage');
            const savedStats = localStorage.getItem('taaxdogFinancialStats');
            if (savedStats) {
                try {
                    const parsedStats = JSON.parse(savedStats);
                    // Merge saved stats with global stats, keeping default values if not in saved
                    globalStats = {...globalStats, ...parsedStats};
                    console.log('Loaded financial stats:', globalStats);
                    return true;
                } catch (error) {
                    console.error('Error parsing saved financial stats:', error);
                }
            }
            return false;
        }

        // Moved receipts functionality into a separate function for clarity
        function setupReceiptsFunctionality() {
            console.log('Setting up receipts functionality');
            
            // Receipts navigation link
            const receiptsNavLink = document.getElementById('receipts-nav-link');
            console.log('Receipts nav link found:', !!receiptsNavLink);
            
            const receiptsSection = document.getElementById('receipts-section');
            console.log('Receipts section found:', !!receiptsSection);

            // ADDED: Setup Upload Receipt Button explicitly
            const uploadReceiptBtn = document.getElementById('upload-receipt-btn');
            if (uploadReceiptBtn) {
                console.log('Upload Receipt Button found, setting up click handler');
                uploadReceiptBtn.addEventListener('click', function() {
                    console.log('Upload Receipt Button clicked!');
                    const receiptUploadModal = new bootstrap.Modal(document.getElementById('receipt-upload-modal'));
                    receiptUploadModal.show();
                });
            } else {
                console.error('Upload Receipt Button not found!');
            }
            
            if (receiptsNavLink && receiptsSection) {
                console.log('Adding click event to receipts nav link');
                
                receiptsNavLink.addEventListener('click', function(e) {
                    console.log('Receipts link clicked!');
            e.preventDefault();
                    
                    // Hide all main content rows except receipts
                    document.querySelectorAll('main .row').forEach(row => {
                        console.log('Processing row:', row.id);
                        if (row.id !== 'receipts-section') {
                            row.style.display = 'none';
                        }
                    });
                    
                    // Show receipts section
                    receiptsSection.style.display = 'flex';
                    console.log('Receipts section displayed');
                    
                    try {
                        // Load receipts data
                        loadReceipts();
                        console.log('loadReceipts called');
                    } catch (error) {
                        console.error('Error loading receipts:', error);
                        alert('Error loading receipts: ' + error.message);
                    }
                });
            } else {
                console.error('Could not find receipts elements:', {
                    'receiptsNavLink': receiptsNavLink,
                    'receiptsSection': receiptsSection
                });
            }
        }

        // Setup upload receipt functionality
        function setupUploadReceiptFunctionality() {
            // Add this at the beginning of the function
            // Connect the upload receipt button to the modal
            const uploadReceiptBtn = document.getElementById('upload-receipt-btn');
            const uploadFirstReceiptBtn = document.getElementById('upload-first-receipt-btn');
            const receiptUploadModal = new bootstrap.Modal(document.getElementById('receipt-upload-modal'));
            
            if (uploadReceiptBtn) {
                uploadReceiptBtn.addEventListener('click', function() {
                    console.log('Upload receipt button clicked');
                    receiptUploadModal.show();
                });
            } else {
                console.error('Upload receipt button not found');
            }
            
            if (uploadFirstReceiptBtn) {
                uploadFirstReceiptBtn.addEventListener('click', function() {
                    console.log('Upload first receipt button clicked');
                    receiptUploadModal.show();
                });
            }
            
            const receiptImage = document.getElementById('receipt-image');
            const receiptPreview = document.getElementById('receipt-preview');
            const previewContainer = document.getElementById('receipt-preview-container');
            const uploadForm = document.getElementById('receipt-upload-form');
            const uploadSubmit = document.getElementById('receipt-upload-submit');
            const uploadProgress = document.getElementById('receipt-upload-progress');
            const uploadResult = document.getElementById('receipt-upload-result');
            const uploadAnother = document.getElementById('upload-another-receipt');
            const ocrProviderSelect = document.getElementById('receipt-ocr-provider');
            
            // Show preview when image is selected
            receiptImage.addEventListener('change', function() {
                const file = this.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        receiptPreview.src = e.target.result;
                        previewContainer.style.display = 'block';
                    }
                    reader.readAsDataURL(file);
                }
            });
            
            // Handle upload button click
            uploadSubmit.addEventListener('click', function() {
                if (!uploadForm.checkValidity()) {
                    uploadForm.reportValidity();
                    return;
                }
                
                // Gather form data
                const fileInput = document.getElementById('receipt-image');
                const category = document.getElementById('receipt-category').value;
                const notes = document.getElementById('receipt-notes').value;
                const ocrProvider = ocrProviderSelect.value;
                
                if (!fileInput.files[0]) {
                    alert('Please select a receipt image to upload');
                    return;
                }
                
                // Show progress
                uploadProgress.style.display = 'block';
                uploadResult.style.display = 'none';
                uploadSubmit.disabled = true;
                
                // Create FormData
                const formData = new FormData();
                formData.append('image', fileInput.files[0]);
                formData.append('category', category);
                formData.append('notes', notes);
                formData.append('use_tabscanner', ocrProvider === 'tabscanner' ? 'true' : 'false');
                
                // Check if we're in development mode
                const isDevelopment = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
                
                if (isDevelopment) {
                    console.log('Development mode: using mock receipt upload and OCR data extraction');
                    
                    // Simulate OCR processing delay with a shorter timeout
                    setTimeout(() => {
                        try {
                            // Create a mock receipt directly without complex modal interactions
                            const mockReceiptData = {
                                receipt_id: 'mock-receipt-' + Date.now(),
                                merchant: 'Grocery Store',
                                date: new Date().toISOString().split('T')[0],
                                total_amount: 42.99,
                                tax_amount: 3.87,
                                subtotal: 39.12,
                                category: category,
                                notes: notes,
                                image: URL.createObjectURL(fileInput.files[0]), // Create a blob URL instead of base64
                                items: [
                                    {name: 'Milk', quantity: 1, unit_price: 3.99, total: 3.99},
                                    {name: 'Bread', quantity: 2, unit_price: 2.99, total: 5.98},
                                    {name: 'Eggs', quantity: 1, unit_price: 4.29, total: 4.29}
                                ],
                                confidence: 0.85,
                                ocr_provider: ocrProvider,
                                created_at: new Date().toISOString()
                            };
                            
                            // Store receipt data in a way that won't freeze UI
                            setTimeout(() => {
                                try {
                                    // Get existing receipts (if any)
                                    let simulatedReceipts = [];
                                    try {
                                        const storedReceipts = localStorage.getItem('simulatedReceipts');
                                        if (storedReceipts) {
                                            simulatedReceipts = JSON.parse(storedReceipts);
                                            if (!Array.isArray(simulatedReceipts)) {
                                                simulatedReceipts = [];
                                            }
                                        }
                                    } catch (e) {
                                        console.error('Error parsing stored receipts, resetting:', e);
                                        simulatedReceipts = [];
                                    }
                                    
                                    // Add new receipt
                                    simulatedReceipts.push(mockReceiptData);
                                    localStorage.setItem('simulatedReceipts', JSON.stringify(simulatedReceipts));
                                    console.log('Receipt saved successfully, total receipts:', simulatedReceipts.length);
                                } catch (storageError) {
                                    console.error('Error saving receipt:', storageError);
                                }
                            }, 0);
                            
                            // Show success message
                            uploadProgress.style.display = 'none';
                            uploadResult.innerHTML = '<div class="alert alert-success">' +
                                '<strong>Success!</strong> Receipt saved successfully.' +
                                '<br>Merchant: ' + mockReceiptData.merchant + 
                                '<br>Total: $' + mockReceiptData.total_amount +
                                '<br>Date: ' + mockReceiptData.date +
                                '</div>';
                            uploadResult.style.display = 'block';
                            uploadSubmit.disabled = false;
                            
                            // Enable the "Upload Another" button
                            uploadAnother.style.display = 'inline-block';
                            uploadSubmit.style.display = 'none';
                            
                            // Update UI as needed - using a separate setTimeout to prevent UI freezing
                            setTimeout(() => {
                                try {
                                    // Update expenses
                                    if (typeof addReceiptToExpenses === 'function') {
                                        addReceiptToExpenses(mockReceiptData);
                                    }
                                    
                                    // Reload receipts list if we're on that page in a deferred way
                                    if (document.getElementById('receipts-section') && 
                                        document.getElementById('receipts-section').style.display !== 'none') {
                                        // Restore loadReceipts but call it in a way that won't freeze UI
                                        setTimeout(() => loadReceipts(), 100);
                                    }
                                    
                                    // Update receipts count display
                                    const receiptsCount = document.getElementById('receipts-count');
                                    if (receiptsCount) {
                                        let count = 0;
                                        try {
                                            const stored = localStorage.getItem('simulatedReceipts');
                                            if (stored) {
                                                const parsed = JSON.parse(stored);
                                                if (Array.isArray(parsed)) {
                                                    count = parsed.length;
                                                }
                                            }
                                        } catch (e) {
                                            console.error('Error getting receipt count:', e);
                                        }
                                        receiptsCount.textContent = count.toString();
                                    }
                                } catch (innerError) {
                                    console.error('Error updating UI after receipt save:', innerError);
                                }
                            }, 100);
                            
                        } catch (error) {
                            console.error('Error in receipt processing:', error);
                            uploadProgress.style.display = 'none';
                            uploadResult.innerHTML = '<div class="alert alert-danger">' +
                                '<strong>Error!</strong> Failed to process receipt: ' + error.message +
                                '</div>';
                            uploadResult.style.display = 'block';
                            uploadSubmit.disabled = false;
                        }
                    }, 500); // Reduced delay for better responsiveness
                    
                    return;
                }
                
                // Get the current user's ID token for auth
                firebase.auth().currentUser.getIdToken()
                    .then(idToken => {
                        // Determine which endpoint to use based on OCR provider selection
                        let endpoint = '/api/receipts/upload';
                        if (ocrProvider === 'tabscanner') {
                            endpoint = '/api/receipts/upload/tabscanner';
                        }
                        
                        console.log(`Using ${ocrProvider} for receipt processing via ${endpoint}`);
                        
                        // Upload the receipt
                        return fetch(endpoint, {
                            method: 'POST',
                            headers: {
                                'Authorization': 'Bearer ' + idToken
                            },
                            body: formData
                        });
                    })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Upload failed: ' + response.status);
                        }
                        return response.json();
                    })
                    .then(data => {
                        // Process successful upload
                        console.log('Receipt processing successful:', data);
                        
                        // Hide progress
                        uploadProgress.style.display = 'none';
                        
                        if (data.success) {
                            const receipt = data.receipt_data || data.receipt;
                            
                            // Show the extracted data for confirmation/editing
                            showExtractedReceiptData(receipt, (confirmedData) => {
                                // Show success message after confirmation
                                uploadResult.innerHTML = '<div class="alert alert-success">' +
                                    '<strong>Success!</strong> Receipt data extracted and saved successfully.' +
                                    '<br>Merchant: ' + confirmedData.merchant + 
                                    '<br>Total: $' + confirmedData.total_amount +
                                    '<br>Date: ' + confirmedData.date +
                                    '</div>';
                                uploadResult.style.display = 'block';
                                uploadSubmit.style.display = 'none';
                                uploadAnother.style.display = 'inline-block';
                                
                                // Match with possible transactions
                                if (data.matched_transaction) {
                                    showTransactionMatch(data.matched_transaction, confirmedData);
                                } else {
                                    matchReceiptWithTransactions(confirmedData);
                                }
                                
                                // Reload receipts list if we're on that page
                                if (document.getElementById('receipts-section').style.display !== 'none') {
                                    loadReceipts();
                                }
                            });
                        } else {
                            // Show error
                            uploadResult.innerHTML = '<div class="alert alert-danger">' +
                                '<strong>Error!</strong> ' + (data.error || 'Failed to process receipt.') +
                                '</div>';
                            uploadResult.style.display = 'block';
                            uploadSubmit.disabled = false;
                        }
                    })
                    .catch(error => {
                        console.error('Error uploading receipt:', error);
                        
                        // Hide progress, show error
                        uploadProgress.style.display = 'none';
                        uploadResult.innerHTML = '<div class="alert alert-danger">' +
                            '<strong>Error!</strong> ' + error.message +
                            '</div>';
                        uploadResult.style.display = 'block';
                        uploadSubmit.disabled = false;
                    });
            });
            
            // Handle "Upload Another" button
            uploadAnother.addEventListener('click', function() {
                // Reset the form
                uploadForm.reset();
                previewContainer.style.display = 'none';
                uploadResult.style.display = 'none';
                uploadAnother.style.display = 'none';
                uploadSubmit.style.display = 'inline-block';
                uploadSubmit.disabled = false;
            });
        }

        function createMockReceipt() {
            console.log('Creating mock receipt for testing');
            
            // Get existing receipts from localStorage
            let receipts = JSON.parse(localStorage.getItem('simulatedReceipts') || '[]');
            
            // Generate a unique ID
            const receiptId = 'mock-' + Date.now();
            
            // Generate a random amount between $5 and $150
            const amount = (Math.random() * 145 + 5).toFixed(2);
            const taxAmount = (amount * 0.0825).toFixed(2); // Approx 8.25% tax
            
            // Get current date in YYYY-MM-DD format
            const today = new Date();
            const date = today.toISOString().split('T')[0];
            
            // Pick a random merchant
            const merchants = [
                'Grocery Mart', 'Coffee Shop', 'Office Supplies', 
                'Restaurant', 'Gas Station', 'Hardware Store',
                'Electronics Store', 'Clothing Store', 'Pharmacy'
            ];
            const merchant = merchants[Math.floor(Math.random() * merchants.length)];
            
            // Pick a random category
            const categories = [
                'Food and Dining', 'Shopping', 'Travel', 
                'Entertainment', 'Office', 'Groceries',
                'Automotive', 'Utilities', 'Healthcare'
            ];
            const category = categories[Math.floor(Math.random() * categories.length)];
            
            // Create 1-5 random items
            const itemCount = Math.floor(Math.random() * 5) + 1;
            const items = [];
            
            let itemsTotal = 0;
            for (let i = 0; i < itemCount; i++) {
                const itemName = `Item ${i+1}`;
                const quantity = Math.floor(Math.random() * 3) + 1;
                const unitPrice = (Math.random() * 20 + 5).toFixed(2);
                const total = (quantity * unitPrice).toFixed(2);
                
                items.push({
                    name: itemName,
                    quantity: quantity,
                    unit_price: unitPrice,
                    total: total
                });
                
                itemsTotal += parseFloat(total);
            }
            
            // Create the mock receipt
            const receipt = {
                receipt_id: receiptId,
                date: date,
                merchant: merchant,
                category: category,
                total_amount: amount,
                tax_amount: taxAmount,
                items: items,
                status: 'processed',
                created_at: new Date().toISOString(),
                notes: ''
            };
            
            // Add to the array
            receipts.push(receipt);
            
            // Save to localStorage
            localStorage.setItem('simulatedReceipts', JSON.stringify(receipts));
            
            // Update global stats with the new receipt amount
            if (typeof globalStats !== 'undefined') {
                // Update receipt totals
                globalStats.receiptsTotal = (parseFloat(globalStats.receiptsTotal) || 0) + parseFloat(amount);
                
                // Update expenses
                globalStats.totalExpenses = (parseFloat(globalStats.totalExpenses) || 0) + parseFloat(amount);
                
                // Update balance
                globalStats.netBalance = globalStats.netIncome - globalStats.totalExpenses;
                
                // Save the updated stats
                saveFinancialStats();
                
                // Update the dashboard
                updateDashboardStats();
            }
            
            console.log('Created mock receipt:', receipt);
            
            // Show a success message
            alert('Mock receipt created successfully!');
            
            // Reload the receipts list
            loadReceipts();
            
            return receipt;
        }

        // Add a button to the upload modal to create a mock receipt
        document.addEventListener('DOMContentLoaded', function() {
            // Get the modal footer
            const modalFooter = document.querySelector('#receipt-upload-modal .modal-footer');
            if (!modalFooter) return;
            
            // Create the mock receipt button
            const mockButton = document.createElement('button');
            mockButton.type = 'button';
            mockButton.className = 'btn btn-secondary ms-auto';
            mockButton.textContent = 'Create Mock Receipt (Dev)';
            mockButton.addEventListener('click', function() {
                createMockReceipt();
                // Close the modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('receipt-upload-modal'));
                if (modal) modal.hide();
            });
            
            // Add the button to the modal footer
            modalFooter.prepend(mockButton);
        });

        function getSavedBankConnections() {
            // Try to get from local storage
            const storedConnections = localStorage.getItem('bankConnections');
            return storedConnections ? JSON.parse(storedConnections) : [];
        }
        
        // Implement loadReceipts function to display receipts in the UI
        function loadReceipts() {
            console.log('loadReceipts function called');
            
            // Get receipts container elements
            const noReceiptsMessage = document.getElementById('no-receipts-message');
            const receiptsList = document.getElementById('receipts-list');
            const receiptsTableBody = document.getElementById('receipts-table-body');
            
            if (!noReceiptsMessage || !receiptsList || !receiptsTableBody) {
                console.error('Receipt container elements not found:', {
                    'noReceiptsMessage': !!noReceiptsMessage,
                    'receiptsList': !!receiptsList,
                    'receiptsTableBody': !!receiptsTableBody
                });
                return;
            }
            
            // Show loading state
            noReceiptsMessage.innerHTML = '<i class="fas fa-spinner fa-spin fa-3x mb-3"></i><p>Loading receipts...</p>';
            noReceiptsMessage.style.display = 'block';
            receiptsList.style.display = 'none';
            
            // Check if we're in development mode
            const isDevelopment = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
            
            // In development mode, load receipts from localStorage
            if (isDevelopment) {
                console.log('Development mode detected, loading simulated receipts');
                
                // Use setTimeout to prevent UI freezing
                setTimeout(() => {
                    try {
                        // Get receipts from localStorage with error handling
                        let simulatedReceipts = [];
                        try {
                            const storedReceipts = localStorage.getItem('simulatedReceipts');
                            if (storedReceipts) {
                                simulatedReceipts = JSON.parse(storedReceipts);
                                if (!Array.isArray(simulatedReceipts)) {
                                    console.error('simulatedReceipts is not an array, resetting');
                                    simulatedReceipts = [];
                                }
                            }
                        } catch (e) {
                            console.error('Error parsing stored receipts:', e);
                            simulatedReceipts = []; // Reset to empty array on error
                        }
                        
                        console.log('Found simulated receipts:', simulatedReceipts.length);
                        
                        if (simulatedReceipts.length === 0) {
                            // No receipts yet, show empty state
                            noReceiptsMessage.innerHTML = `
                                <i class="fas fa-receipt fa-3x mb-3 text-muted"></i>
                                <p>You don't have any receipts yet.</p>
                                <button id="upload-first-receipt-btn" class="btn btn-primary mt-3">
                                    <i class="fas fa-upload me-2"></i>Upload Your First Receipt
                                </button>`;
                            noReceiptsMessage.style.display = 'block';
                            receiptsList.style.display = 'none';
                            
                            // Update count display
                            const receiptsCount = document.getElementById('receipts-count');
                            if (receiptsCount) receiptsCount.textContent = '0';
                            
                            // Add click handler to the upload button
                            const uploadFirstReceiptBtn = document.getElementById('upload-first-receipt-btn');
                            if (uploadFirstReceiptBtn) {
                                uploadFirstReceiptBtn.addEventListener('click', function() {
                                    const receiptModal = document.getElementById('receipt-upload-modal');
                                    if (receiptModal) {
                                        const bsModal = new bootstrap.Modal(receiptModal);
                                        bsModal.show();
                                    }
                                });
                            }
                            
                            // Also update receipt summary stats
                            if (typeof updateReceiptSummaryStats === 'function') {
                                updateReceiptSummaryStats(simulatedReceipts);
                            }
                            return;
                        }
                        
                        // Sort receipts by date (newest first)
                        simulatedReceipts.sort((a, b) => {
                            try {
                                const dateA = new Date(a.date || '');
                                const dateB = new Date(b.date || '');
                                return dateB - dateA;
                            } catch (e) {
                                console.error('Error sorting by date:', e);
                                return 0;
                            }
                        });
                        
                        // Clear existing rows
                        receiptsTableBody.innerHTML = '';
                        
                        // Process receipts in batches to avoid UI freezing
                        const batchSize = 10;
                        const batches = Math.ceil(simulatedReceipts.length / batchSize);
                        
                        function processBatch(batchIndex) {
                            if (batchIndex >= batches) {
                                // All batches processed
                                // Show the receipts list
                                noReceiptsMessage.style.display = 'none';
                                receiptsList.style.display = 'block';
                                
                                // Update receipt count
                                const receiptsCount = document.getElementById('receipts-count');
                                if (receiptsCount) receiptsCount.textContent = simulatedReceipts.length.toString();
                                
                                // Add event handlers to view and delete buttons
                                addReceiptEventHandlers();
                                
                                // Also update receipt summary stats
                                if (typeof updateReceiptSummaryStats === 'function') {
                                    updateReceiptSummaryStats(simulatedReceipts);
                                }
                                return;
                            }
                            
                            const start = batchIndex * batchSize;
                            const end = Math.min(start + batchSize, simulatedReceipts.length);
                            const batchReceipts = simulatedReceipts.slice(start, end);
                            
                            batchReceipts.forEach(receipt => {
                                try {
                                    if (!receipt || typeof receipt !== 'object') {
                                        console.warn('Invalid receipt object', receipt);
                                        return;
                                    }
                                    
                                    const row = document.createElement('tr');
                                    row.className = 'receipt-row';
                                    row.dataset.receiptId = receipt.receipt_id || '';
                                    
                                    // Format date safely
                                    let formattedDate = 'Unknown';
                                    try {
                                        if (receipt.date) {
                                            const receiptDate = new Date(receipt.date);
                                            formattedDate = receiptDate.toLocaleDateString();
                                        }
                                    } catch (e) {
                                        console.warn('Error formatting date for receipt:', e);
                                    }
                                    
                                    // Format amount safely
                                    let formattedAmount = '$0.00';
                                    try {
                                        if (receipt.total_amount) {
                                            formattedAmount = typeof formatCurrency === 'function'
                                                ? formatCurrency(receipt.total_amount)
                                                : '$' + parseFloat(receipt.total_amount).toFixed(2);
                                        }
                                    } catch (e) {
                                        console.warn('Error formatting amount for receipt:', e);
                                    }
                                    
                                    // Check if receipt is matched with a transaction
                                    const isMatched = receipt.matched_transaction_id || receipt.manually_matched;
                                    const matchBadge = isMatched 
                                        ? '<span class="badge bg-success">Matched</span>' 
                                        : '<span class="badge bg-secondary">Unmatched</span>';
                                    
                                    row.innerHTML = `
                                        <td>${formattedDate}</td>
                                        <td>${receipt.merchant || 'Unknown'}</td>
                                        <td>${receipt.category || 'Uncategorized'}</td>
                                        <td>${formattedAmount}</td>
                                        <td>${matchBadge}</td>
                                        <td>
                                            <button class="btn btn-sm btn-outline-primary view-receipt-btn" title="View Details">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                            <button class="btn btn-sm btn-outline-danger delete-receipt-btn" title="Delete Receipt">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </td>
                                    `;
                                    
                                    receiptsTableBody.appendChild(row);
                                } catch (e) {
                                    console.error('Error adding receipt row:', e, receipt);
                                }
                            });
                            
                            // Process next batch on the next event loop
                            setTimeout(() => processBatch(batchIndex + 1), 0);
                        }
                        
                        // Start processing batches
                        processBatch(0);
                        
                    } catch (error) {
                        console.error('Error loading receipts:', error);
                        noReceiptsMessage.innerHTML = `
                            <div class="alert alert-danger">
                                <i class="fas fa-exclamation-triangle me-2"></i>
                                Error loading receipts: ${error.message}
                            </div>`;
                        noReceiptsMessage.style.display = 'block';
                        receiptsList.style.display = 'none';
                    }
                }, 0);
                
                return;
            }
            
            // For production mode (with Firebase)
            // ... existing code ...
        }

        // Add this simplified function to view receipt details without freezing
        function showSimplifiedReceiptDetails(receipt) {
            try {
                // Create a simple modal to show the receipt without complex UI
                const detailsContent = `
                    <div class="modal-header">
                        <h5 class="modal-title">Receipt from ${receipt.merchant}</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="card">
                            <div class="card-body">
                                <h5 class="card-title">${receipt.merchant}</h5>
                                <h6 class="card-subtitle mb-2 text-muted">Date: ${new Date(receipt.date).toLocaleDateString()}</h6>
                                <p class="card-text">
                                    <strong>Total:</strong> $${(receipt.total_amount || 0).toFixed(2)}<br>
                                    <strong>Tax:</strong> $${(receipt.tax_amount || 0).toFixed(2)}<br>
                                    <strong>Category:</strong> ${receipt.category || 'None'}<br>
                                    <strong>Notes:</strong> ${receipt.notes || 'None'}
                                </p>
                            </div>
                        </div>
                        <div class="mt-3">
                            <button class="btn btn-primary" id="close-receipt-details">Close</button>
                        </div>
                    </div>
                `;
                
                // Find the modal element or create it if it doesn't exist
                let detailsModal = document.getElementById('receipt-details-modal');
                if (!detailsModal) {
                    detailsModal = document.createElement('div');
                    detailsModal.id = 'receipt-details-modal';
                    detailsModal.className = 'modal fade';
                    detailsModal.setAttribute('tabindex', '-1');
                    detailsModal.innerHTML = `
                        <div class="modal-dialog">
                            <div class="modal-content" id="receipt-details-content">
                            </div>
                        </div>
                    `;
                    document.body.appendChild(detailsModal);
                }
                
                // Update content and show modal
                const modalContent = document.getElementById('receipt-details-content');
                if (modalContent) {
                    modalContent.innerHTML = detailsContent;
                }
                
                // Initialize and show the modal
                const bsModal = new bootstrap.Modal(detailsModal);
                bsModal.show();
                
                // Set up close button
                const closeBtn = document.getElementById('close-receipt-details');
                if (closeBtn) {
                    closeBtn.addEventListener('click', () => bsModal.hide());
                }
                
            } catch (error) {
                console.error('Error showing receipt details:', error);
                alert('Error showing receipt details: ' + error.message);
            }
        }

        // Helper function to load more receipts
        function loadMoreReceipts(allReceipts, currentlyDisplayed) {
            try {
                const receiptsList = document.getElementById('receipts-list');
                const loadMoreSection = document.querySelector('.list-group-item:last-child');
                if (!loadMoreSection) return;
                
                // Remove the load more button section
                loadMoreSection.remove();
                
                // Calculate how many more to display (up to 10 more)
                const moreToDisplay = Math.min(10, allReceipts.length - currentlyDisplayed);
                const nextBatch = allReceipts.slice(currentlyDisplayed, currentlyDisplayed + moreToDisplay);
                
                // Create HTML for the next batch
                let newContent = '';
                nextBatch.forEach(receipt => {
                    const id = receipt.receipt_id;
                    const date = new Date(receipt.date).toLocaleDateString();
                    const merchant = receipt.merchant || 'Unknown Merchant';
                    const amount = (receipt.total_amount || 0).toFixed(2);
                    
                    newContent += `
                        <a href="#" class="list-group-item list-group-item-action" data-receipt-id="${id}">
                            <div class="d-flex w-100 justify-content-between">
                                <h5 class="mb-1">${merchant}</h5>
                                <small>$${amount}</small>
                            </div>
                            <p class="mb-1">Date: ${date}</p>
                            <small>${receipt.category || 'No Category'}</small>
                        </a>
                    `;
                });
                
                // Add load more button if there are still more receipts
                const newTotal = currentlyDisplayed + moreToDisplay;
                if (newTotal < allReceipts.length) {
                    newContent += `
                        <div class="list-group-item text-center">
                            <button id="load-more-receipts" class="btn btn-outline-primary btn-sm">
                                Load ${Math.min(10, allReceipts.length - newTotal)} more (${newTotal} of ${allReceipts.length})
                            </button>
                        </div>
                    `;
                }
                
                // Append to the list group
                const listGroup = receiptsList.querySelector('.list-group');
                if (listGroup) {
                    // Create a temporary container
                    const temp = document.createElement('div');
                    temp.innerHTML = newContent;
                    
                    // Append each child
                    while (temp.firstChild) {
                        listGroup.appendChild(temp.firstChild);
                    }
                    
                    // Set up load more button again if added
                    const loadMoreBtn = document.getElementById('load-more-receipts');
                    if (loadMoreBtn) {
                        loadMoreBtn.addEventListener('click', () => {
                            loadMoreReceipts(allReceipts, newTotal);
                        });
                    }
                }
            } catch (error) {
                console.error('Error loading more receipts:', error);
            }
        }

        // Helper function to update receipt summary stats
        function updateReceiptSummaryStats(receipts) {
            try {
                console.log('Updating receipt summary stats');
                
                // Calculate totals
                const totalReceiptsCount = receipts.length;
                let totalAmount = 0;
                let matchedCount = 0;
                
                receipts.forEach(receipt => {
                    totalAmount += parseFloat(receipt.total_amount) || 0;
                    if (receipt.matched_transaction_id) matchedCount++;
                });
                
                const averageAmount = totalReceiptsCount > 0 ? totalAmount / totalReceiptsCount : 0;
                
                // Update UI elements
                const elements = {
                    totalReceipts: document.getElementById('total-receipts-count'),
                    totalAmount: document.getElementById('total-receipts-amount'),
                    matchedReceipts: document.getElementById('matched-receipts-count'),
                    averageAmount: document.getElementById('average-receipt-amount')
                };
                
                if (elements.totalReceipts) elements.totalReceipts.textContent = totalReceiptsCount;
                
                if (elements.totalAmount) {
                    elements.totalAmount.textContent = typeof formatCurrency === 'function' 
                        ? formatCurrency(totalAmount) 
                        : '$' + totalAmount.toFixed(2);
                }
                
                if (elements.matchedReceipts) elements.matchedReceipts.textContent = matchedCount;
                
                if (elements.averageAmount) {
                    elements.averageAmount.textContent = typeof formatCurrency === 'function' 
                        ? formatCurrency(averageAmount) 
                        : '$' + averageAmount.toFixed(2);
                }
                
                console.log('Receipt summary updated successfully');
            } catch (error) {
                console.error('Error updating receipt summary stats:', error);
            }
        }

        // ... existing code ...

        // Function to show receipt details in a modal
        function showReceiptDetails(receiptId) {
            try {
                console.log('Showing receipt details for:', receiptId);
                
                if (!receiptId) {
                    console.error('No receipt ID provided');
                    return;
                }
                
                // Find receipt modal elements
                const receiptModal = document.getElementById('receipt-details-modal');
                const receiptTitle = document.getElementById('receipt-details-title');
                const receiptDate = document.getElementById('receipt-details-date');
                const receiptMerchant = document.getElementById('receipt-details-merchant');
                const receiptTotal = document.getElementById('receipt-details-total');
                const receiptCategory = document.getElementById('receipt-details-category');
                const receiptTax = document.getElementById('receipt-details-tax');
                const receiptSubtotal = document.getElementById('receipt-details-subtotal');
                const receiptNotes = document.getElementById('receipt-details-notes');
                const receiptImage = document.getElementById('receipt-details-image');
                const receiptItemsTable = document.getElementById('receipt-items-table');
                const receiptItemsTableBody = document.getElementById('receipt-items-tbody');
                const receiptMatchStatus = document.getElementById('receipt-match-status');
                const findMatchBtn = document.getElementById('find-receipt-match-btn');
                const transactionMatchDetails = document.getElementById('transaction-match-details');
                
                // Check if all elements exist
                if (!receiptModal || !receiptTitle || !receiptDate || !receiptMerchant || 
                    !receiptTotal || !receiptCategory || !receiptNotes || !receiptItemsTable || 
                    !receiptItemsTableBody) {
                    console.error('Receipt modal elements not found');
                    return;
                }
                
                // Determine if we're in development mode
                const isDevelopment = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
                
                // In development mode, get receipt from localStorage
                if (isDevelopment) {
                    console.log('Development mode, getting receipt from localStorage');
                    
                    // Show loading state
                    receiptTitle.textContent = 'Loading...';
                    receiptItemsTableBody.innerHTML = `
                        <tr>
                            <td colspan="4" class="text-center">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                            </td>
                        </tr>`;
                    
                    // Display the modal right away with loading state
                    const bsModal = new bootstrap.Modal(receiptModal);
                    bsModal.show();
                    
                    // Load receipt data in the background to avoid UI freezing
                    setTimeout(() => {
                        try {
                            // Get receipt from localStorage
                            let receipt = null;
                            let simulatedReceipts = [];
                            
                            try {
                                const storedReceipts = localStorage.getItem('simulatedReceipts');
                                if (storedReceipts) {
                                    simulatedReceipts = JSON.parse(storedReceipts);
                                    receipt = simulatedReceipts.find(r => r.receipt_id === receiptId);
                                }
                            } catch (e) {
                                console.error('Error getting receipt from localStorage:', e);
                            }
                            
                            if (!receipt) {
                                receiptTitle.textContent = 'Receipt Not Found';
                                receiptItemsTableBody.innerHTML = `
                                    <tr>
                                        <td colspan="4" class="text-center text-danger">
                                            <i class="fas fa-exclamation-triangle me-2"></i>
                                            Receipt not found
                                        </td>
                                    </tr>`;
                                return;
                            }
                            
                            // Update modal title and basic info
                            receiptTitle.textContent = `Receipt: ${receipt.merchant || 'Unknown'}`;
                            receiptMerchant.textContent = receipt.merchant || 'Unknown';
                            
                            // Format and set date
                            try {
                                if (receipt.date) {
                                    const receiptDate = new Date(receipt.date);
                                    receiptDate.textContent = receiptDate.toLocaleDateString();
                                } else {
                                    receiptDate.textContent = 'Unknown';
                                }
                            } catch (e) {
                                console.warn('Error formatting date:', e);
                                receiptDate.textContent = 'Error';
                            }
                            
                            // Set amount fields with safe checks
                            try {
                                if (receipt.total_amount) {
                                    receiptTotal.textContent = typeof formatCurrency === 'function'
                                        ? formatCurrency(receipt.total_amount)
                                        : '$' + parseFloat(receipt.total_amount).toFixed(2);
                                } else {
                                    receiptTotal.textContent = '$0.00';
                                }
                            } catch (e) {
                                console.warn('Error formatting total amount:', e);
                                receiptTotal.textContent = 'Error';
                            }
                            
                            // Set tax and subtotal if available
                            if (receiptTax) {
                                try {
                                    if (receipt.tax_amount) {
                                        receiptTax.textContent = typeof formatCurrency === 'function'
                                            ? formatCurrency(receipt.tax_amount)
                                            : '$' + parseFloat(receipt.tax_amount).toFixed(2);
                                    } else {
                                        receiptTax.textContent = 'N/A';
                                    }
                                } catch (e) {
                                    console.warn('Error formatting tax amount:', e);
                                    receiptTax.textContent = 'Error';
                                }
                            }
                            
                            if (receiptSubtotal) {
                                try {
                                    if (receipt.subtotal) {
                                        receiptSubtotal.textContent = typeof formatCurrency === 'function'
                                            ? formatCurrency(receipt.subtotal)
                                            : '$' + parseFloat(receipt.subtotal).toFixed(2);
                                    } else {
                                        receiptSubtotal.textContent = 'N/A';
                                    }
                                } catch (e) {
                                    console.warn('Error formatting subtotal:', e);
                                    receiptSubtotal.textContent = 'Error';
                                }
                            }
                            
                            // Set category and notes
                            receiptCategory.textContent = receipt.category || 'Uncategorized';
                            receiptNotes.textContent = receipt.notes || 'No notes';
                            
                            // Set receipt image if available
                            if (receiptImage && receipt.image) {
                                receiptImage.src = receipt.image;
                                receiptImage.style.display = 'block';
                            } else if (receiptImage) {
                                receiptImage.style.display = 'none';
                            }
                            
                            // Setup match status and buttons - will be processed in a separate batch
                            // to keep UI responsive
                            setTimeout(() => {
                                try {
                                    if (receiptMatchStatus && findMatchBtn) {
                                        // Check if receipt is already matched
                                        if (receipt.matched_transaction_id || receipt.manually_matched) {
                                            receiptMatchStatus.innerHTML = '<span class="badge bg-success">Matched</span>';
                                            findMatchBtn.style.display = 'none';
                                            
                                            // If transaction match details element exists, show matched transaction info
                                            if (transactionMatchDetails) {
                                                const matchedId = receipt.matched_transaction_id;
                                                if (matchedId) {
                                                    // Show loading state
                                                    transactionMatchDetails.innerHTML = `
                                                        <div class="mt-3 p-3 border rounded">
                                                            <h6>Matched Transaction</h6>
                                                            <div class="text-center">
                                                                <div class="spinner-border spinner-border-sm" role="status">
                                                                    <span class="visually-hidden">Loading...</span>
                                                                </div>
                                                                <p class="mb-0">Loading transaction details...</p>
                                                            </div>
                                                        </div>`;
                                                    transactionMatchDetails.style.display = 'block';
                                                    
                                                    // Load transaction details in yet another background task
                                                    setTimeout(() => {
                                                        try {
                                                            // In development mode, get transactions from localStorage
                                                            let matchedTransaction = null;
                                                            try {
                                                                const storedTransactions = localStorage.getItem('simulatedTransactions');
                                                                if (storedTransactions) {
                                                                    const transactions = JSON.parse(storedTransactions);
                                                                    matchedTransaction = transactions.find(t => t.id === matchedId);
                                                                }
                                                            } catch (e) {
                                                                console.error('Error getting matched transaction:', e);
                                                            }
                                                            
                                                            if (matchedTransaction) {
                                                                const txDate = new Date(matchedTransaction.date).toLocaleDateString();
                                                                const txAmount = typeof formatCurrency === 'function'
                                                                    ? formatCurrency(matchedTransaction.amount)
                                                                    : '$' + Math.abs(parseFloat(matchedTransaction.amount)).toFixed(2);
                                                                
                                                                transactionMatchDetails.innerHTML = `
                                                                    <div class="mt-3 p-3 border rounded bg-light">
                                                                        <h6 class="mb-3">Matched Transaction</h6>
                                                                        <div class="row">
                                                                            <div class="col-md-6">
                                                                                <p class="mb-1"><strong>Date:</strong> ${txDate}</p>
                                                                                <p class="mb-1"><strong>Description:</strong> ${matchedTransaction.description}</p>
                                                                            </div>
                                                                            <div class="col-md-6">
                                                                                <p class="mb-1"><strong>Amount:</strong> ${txAmount}</p>
                                                                                <p class="mb-1"><strong>Category:</strong> ${matchedTransaction.category || 'Uncategorized'}</p>
                                                                            </div>
                                                                        </div>
                                                                    </div>`;
                                                            } else {
                                                                transactionMatchDetails.innerHTML = `
                                                                    <div class="mt-3 p-3 border rounded">
                                                                        <h6>Matched Transaction</h6>
                                                                        <p class="text-muted mb-0">Transaction details not found (ID: ${matchedId})</p>
                                                                    </div>`;
                                                            }
                                                        } catch (e) {
                                                            console.error('Error loading matched transaction:', e);
                                                            transactionMatchDetails.innerHTML = `
                                                                <div class="mt-3 p-3 border rounded">
                                                                    <h6>Matched Transaction</h6>
                                                                    <p class="text-danger mb-0">Error loading transaction details</p>
                                                                </div>`;
                                                        }
                                                    }, 50);
                                                }
                                            }
                                        } else {
                                            receiptMatchStatus.innerHTML = '<span class="badge bg-secondary">Unmatched</span>';
                                            findMatchBtn.style.display = 'inline-block';
                                            
                                            // Add click handler to find match button
                                            findMatchBtn.onclick = function() {
                                                matchReceiptWithTransactions(receipt);
                                            };
                                        }
                                    }
                                } catch (e) {
                                    console.error('Error setting up match UI:', e);
                                }
                            }, 50);
                            
                            // Process receipt items in batches if available
                            setTimeout(() => {
                                receiptItemsTableBody.innerHTML = ''; // Clear loading state
                                
                                if (receipt.items && Array.isArray(receipt.items) && receipt.items.length > 0) {
                                    // Only display up to 20 items to prevent UI slowness
                                    const displayItems = receipt.items.slice(0, 20);
                                    
                                    displayItems.forEach(item => {
                                        try {
                                            if (!item || typeof item !== 'object') return;
                                            
                                            const row = document.createElement('tr');
                                            
                                            // Format values with safe checks
                                            const name = item.name || 'Unknown item';
                                            const quantity = item.quantity || 1;
                                            const unitPrice = typeof formatCurrency === 'function'
                                                ? formatCurrency(item.unit_price || 0)
                                                : '$' + parseFloat(item.unit_price || 0).toFixed(2);
                                            const total = typeof formatCurrency === 'function'
                                                ? formatCurrency(item.total || 0)
                                                : '$' + parseFloat(item.total || 0).toFixed(2);
                                            
                                            row.innerHTML = `
                                                <td>${name}</td>
                                                <td>${quantity}</td>
                                                <td>${unitPrice}</td>
                                                <td>${total}</td>
                                            `;
                                            
                                            receiptItemsTableBody.appendChild(row);
                                        } catch (e) {
                                            console.error('Error adding item row:', e);
                                        }
                                    });
                                    
                                    // If we limited the items, add a note
                                    if (receipt.items.length > 20) {
                                        const row = document.createElement('tr');
                                        row.innerHTML = `
                                            <td colspan="4" class="text-center text-muted">
                                                <small>Note: Only showing first 20 items out of ${receipt.items.length}</small>
                                            </td>
                                        `;
                                        receiptItemsTableBody.appendChild(row);
                                    }
                                    
                                    receiptItemsTable.style.display = 'table';
                                } else {
                                    // No items or invalid items array
                                    receiptItemsTableBody.innerHTML = `
                                        <tr>
                                            <td colspan="4" class="text-center">
                                                <p class="text-muted mb-0">No item details available</p>
                                            </td>
                                        </tr>`;
                                    receiptItemsTable.style.display = 'table';
                                }
                            }, 100);
                            
                        } catch (error) {
                            console.error('Error loading receipt details:', error);
                            receiptTitle.textContent = 'Error';
                            receiptItemsTableBody.innerHTML = `
                                <tr>
                                    <td colspan="4" class="text-center text-danger">
                                        <i class="fas fa-exclamation-triangle me-2"></i>
                                        Error loading receipt: ${error.message}
                                    </td>
                                </tr>`;
                        }
                    }, 50); // Short delay to allow modal to show before loading data
                    
                    return;
                }
                
                // For production mode (with Firebase)
                // ... existing code ...
            } catch (error) {
                console.error('Fatal error in showReceiptDetails:', error);
                alert('Error showing receipt details: ' + error.message);
            }
        }

        // Add event handlers to receipt buttons
        function addReceiptEventHandlers() {
            // Add click handlers for viewing receipt details
            document.querySelectorAll('.view-receipt-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const row = this.closest('tr');
                    const receiptId = row.dataset.receiptId;
                    
                    if (!receiptId) {
                        console.error('No receipt ID found for this row');
                        return;
                    }
                    
                    // Find the receipt in localStorage
                    try {
                        const simulatedReceipts = JSON.parse(localStorage.getItem('simulatedReceipts') || '[]');
                        const receipt = simulatedReceipts.find(r => r.receipt_id === receiptId);
                        
                        if (receipt) {
                            showReceiptDetails(receipt);
                        } else {
                            console.error('Receipt not found:', receiptId);
                            alert('Receipt details not found.');
                        }
                    } catch (e) {
                        console.error('Error retrieving receipt details:', e);
                        alert('Error loading receipt details.');
                    }
                });
            });
            
            // Add click handlers for deleting receipts
            document.querySelectorAll('.delete-receipt-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const row = this.closest('tr');
                    const receiptId = row.dataset.receiptId;
                    
                    if (!receiptId) {
                        console.error('No receipt ID found for this row');
                        return;
                    }
                    
                    try {
                        const simulatedReceipts = JSON.parse(localStorage.getItem('simulatedReceipts') || '[]');
                        const receiptIndex = simulatedReceipts.findIndex(r => r.receipt_id === receiptId);
                        
                        if (receiptIndex === -1) {
                            console.error('Receipt not found for deletion:', receiptId);
                            return;
                        }
                        
                        const receipt = simulatedReceipts[receiptIndex];
                        
                        if (confirm(`Are you sure you want to delete this receipt from ${receipt.merchant || 'Unknown'}?`)) {
                            // Get the receipt amount for stats update
                            const amount = parseFloat(receipt.total_amount) || 0;
                            
                            // Remove from array
                            simulatedReceipts.splice(receiptIndex, 1);
                            
                            // Save to localStorage
                            localStorage.setItem('simulatedReceipts', JSON.stringify(simulatedReceipts));
                            
                            // Update financial stats
                            if (typeof globalStats !== 'undefined') {
                                // Update receipt totals
                                globalStats.receiptsTotal = (parseFloat(globalStats.receiptsTotal) || 0) - amount;
                                
                                // Update expenses
                                globalStats.totalExpenses = (parseFloat(globalStats.totalExpenses) || 0) - amount;
                                
                                // Update balance
                                globalStats.netBalance = globalStats.netIncome - globalStats.totalExpenses;
                                
                                // Save the updated stats
                                if (typeof saveFinancialStats === 'function') {
                                    saveFinancialStats();
                                }
                                
                                // Update the dashboard
                                if (typeof updateDashboardStats === 'function') {
                                    updateDashboardStats();
                                }
                            }
                            
                            // Reload the receipts
                            loadReceipts();
                        }
                    } catch (e) {
                        console.error('Error deleting receipt:', e);
                        alert('Error deleting receipt.');
                    }
                });
            });
        }

        // Function to match a receipt with banking transactions
        function matchReceiptWithTransactions(receipt) {
            console.log('Matching receipt with transactions:', receipt);
            
            // Check if we have essential receipt data for matching
            if (!receipt || !receipt.total_amount || !receipt.date) {
                console.error('Invalid receipt data for matching');
                alert('Receipt is missing essential data (amount or date) needed for matching.');
                return;
            }
            
            // Show a loading indicator
            const matchStatus = document.getElementById('receipt-match-status');
            const findMatchBtn = document.getElementById('find-receipt-match-btn');
            const transactionMatchDetails = document.getElementById('transaction-match-details');
            
            if (matchStatus) {
                matchStatus.innerHTML = '<span class="badge bg-info">Searching...</span>';
            }
            
            if (findMatchBtn) {
                findMatchBtn.disabled = true;
            }
            
            if (transactionMatchDetails) {
                transactionMatchDetails.innerHTML = `
                    <div class="mt-3 p-3 border rounded">
                        <div class="text-center">
                            <div class="spinner-border spinner-border-sm text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="mb-0 mt-2">Searching for matching transactions...</p>
                        </div>
                    </div>`;
                transactionMatchDetails.style.display = 'block';
            }
            
            // Determine if we're in development mode
            const isDevelopment = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
            
            if (isDevelopment) {
                // In development mode, get transactions from localStorage
                setTimeout(() => {
                    findReceiptMatch(receipt);
                }, 500); // Simulate API delay
            } else {
                // In production mode, call the API
                findReceiptMatchAPI(receipt);
            }
        }
        
        // Helper function to find a receipt match using simulated data in development mode
        function findReceiptMatch(receipt) {
            try {
                // Get transactions from localStorage
                let transactions = [];
                try {
                    const storedTransactions = localStorage.getItem('simulatedTransactions');
                    if (storedTransactions) {
                        transactions = JSON.parse(storedTransactions);
                        if (!Array.isArray(transactions)) {
                            console.error('Stored transactions is not an array');
                            transactions = [];
                        }
                    }
                } catch (e) {
                    console.error('Error parsing stored transactions:', e);
                }
                
                console.log(`Looking for matches among ${transactions.length} transactions`);
                
                if (transactions.length === 0) {
                    showNoMatchFound();
                    return;
                }
                
                // Extract receipt data for matching
                const receiptAmount = parseFloat(receipt.total_amount);
                const receiptDate = receipt.date;
                const receiptMerchant = (receipt.merchant || '').toLowerCase();
                
                // Find possible matches
                const matches = [];
                
                for (const transaction of transactions) {
                    // Check amount (convert to absolute for comparing expenses which may be negative)
                    const txAmount = Math.abs(parseFloat(transaction.amount || 0));
                    const amountDiff = Math.abs(txAmount - receiptAmount);
                    
                    // Check date
                    const txDate = transaction.date;
                    
                    // Check merchant in description
                    const txDescription = (transaction.description || '').toLowerCase();
                    
                    // Matching conditions
                    const amountMatch = amountDiff < 0.10; // Within 10 cents
                    const dateMatch = txDate === receiptDate;
                    const merchantMatch = receiptMerchant && (
                        txDescription.includes(receiptMerchant) || 
                        receiptMerchant.split(' ').some(word => word.length > 3 && txDescription.includes(word))
                    );
                    
                    // Calculate match score
                    let score = 0;
                    if (amountMatch) score += 5;
                    if (dateMatch) score += 3;
                    if (merchantMatch) score += 2;
                    
                    // Consider it a match if we have at least amount and date matching
                    if (amountMatch && dateMatch) {
                        let confidence = 0.7;
                        if (merchantMatch) confidence = 0.95;
                        
                        matches.push({
                            transaction: transaction,
                            confidence: confidence,
                            score: score
                        });
                    }
                }
                
                // Sort matches by score
                matches.sort((a, b) => b.score - a.score);
                
                if (matches.length > 0) {
                    const bestMatch = matches[0];
                    
                    // Update the receipt with the match info
                    updateReceiptWithMatch(receipt, bestMatch.transaction, bestMatch.confidence);
                    
                    // Show the match to the user
                    showTransactionMatch(bestMatch.transaction, receipt, bestMatch.confidence);
                } else {
                    showNoMatchFound();
                }
                
            } catch (error) {
                console.error('Error finding receipt match:', error);
                showNoMatchFound();
            }
        }
        
        // Helper function to find a receipt match via API in production mode
        function findReceiptMatchAPI(receipt) {
            // Make API call to backend for matching
            fetch('/api/receipts/match', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    receipt: receipt
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success && data.match) {
                    // Update the receipt with match info
                    updateReceiptWithMatch(receipt, data.match.transaction, data.match.confidence);
                    
                    // Show the match to the user
                    showTransactionMatch(data.match.transaction, receipt, data.match.confidence);
                } else {
                    showNoMatchFound();
                }
            })
            .catch(error => {
                console.error('Error calling match API:', error);
                showNoMatchFound();
            });
        }
        
        // Helper function to update receipt with match information
        function updateReceiptWithMatch(receipt, transaction, confidence) {
            // In development mode, update the receipt in localStorage
            if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
                try {
                    // Get all receipts
                    const storedReceipts = localStorage.getItem('simulatedReceipts');
                    if (storedReceipts) {
                        const receipts = JSON.parse(storedReceipts);
                        
                        // Find and update the receipt
                        const receiptIndex = receipts.findIndex(r => r.receipt_id === receipt.receipt_id);
                        if (receiptIndex >= 0) {
                            receipts[receiptIndex].matched_transaction_id = transaction.id;
                            receipts[receiptIndex].match_confidence = confidence;
                            
                            // Save updated receipts
                            localStorage.setItem('simulatedReceipts', JSON.stringify(receipts));
                            console.log('Updated receipt with match info in localStorage');
                        }
                    }
                } catch (e) {
                    console.error('Error updating receipt match in localStorage:', e);
                }
            } else {
                // In production, call API to update the receipt
                if (receipt.receipt_id) {
                    fetch(`/api/receipts/${receipt.receipt_id}/match`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            transaction_id: transaction.id,
                            confidence: confidence
                        })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            console.log('Receipt updated with match info via API');
                        } else {
                            console.error('Failed to update receipt match via API:', data.error);
                        }
                    })
                    .catch(error => {
                        console.error('Error calling receipt match update API:', error);
                    });
                }
            }
            
            // Update the receipt object we have in memory
            receipt.matched_transaction_id = transaction.id;
            receipt.match_confidence = confidence;
        }
        
        // Helper function to show 'no match found' message
        function showNoMatchFound() {
            const matchStatus = document.getElementById('receipt-match-status');
            const findMatchBtn = document.getElementById('find-receipt-match-btn');
            const transactionMatchDetails = document.getElementById('transaction-match-details');
            
            if (matchStatus) {
                matchStatus.innerHTML = '<span class="badge bg-secondary">Unmatched</span>';
            }
            
            if (findMatchBtn) {
                findMatchBtn.disabled = false;
            }
            
            if (transactionMatchDetails) {
                transactionMatchDetails.innerHTML = `
                    <div class="mt-3 p-3 border rounded">
                        <div class="text-center">
                            <p class="mb-0"><i class="fas fa-search me-2"></i>No matching transaction found</p>
                            <small class="text-muted">Try adjusting the receipt details or check your transactions</small>
                        </div>
                    </div>`;
                transactionMatchDetails.style.display = 'block';
            }
        }
        
        // Function to show transaction match to the user
        function showTransactionMatch(transaction, receipt, confidence) {
            console.log('Showing transaction match:', transaction);
            
            // Get UI elements
            const matchStatus = document.getElementById('receipt-match-status');
            const findMatchBtn = document.getElementById('find-receipt-match-btn');
            const transactionMatchDetails = document.getElementById('transaction-match-details');
            
            // Format values for display
            const txDate = transaction.date ? new Date(transaction.date).toLocaleDateString() : 'Unknown';
            const txAmount = typeof formatCurrency === 'function'
                ? formatCurrency(Math.abs(transaction.amount))
                : '$' + Math.abs(parseFloat(transaction.amount || 0)).toFixed(2);
            
            // Determine confidence level text
            let confidenceText = 'Low';
            let confidenceClass = 'text-warning';
            
            if (confidence >= 0.9) {
                confidenceText = 'High';
                confidenceClass = 'text-success';
            } else if (confidence >= 0.7) {
                confidenceText = 'Medium';
                confidenceClass = 'text-primary';
            }
            
            // Update the UI with match info
            if (matchStatus) {
                matchStatus.innerHTML = '<span class="badge bg-success">Matched</span>';
            }
            
            if (findMatchBtn) {
                findMatchBtn.style.display = 'none';
            }
            
            if (transactionMatchDetails) {
                transactionMatchDetails.innerHTML = `
                    <div class="mt-3 p-3 border rounded bg-light">
                        <h6 class="mb-3">Matched Transaction <span class="float-end ${confidenceClass} small">${confidenceText} Confidence</span></h6>
                        <div class="row">
                            <div class="col-md-6">
                                <p class="mb-1"><strong>Date:</strong> ${txDate}</p>
                                <p class="mb-1"><strong>Description:</strong> ${transaction.description || 'Unknown'}</p>
                            </div>
                            <div class="col-md-6">
                                <p class="mb-1"><strong>Amount:</strong> ${txAmount}</p>
                                <p class="mb-1"><strong>Account:</strong> ${transaction.account || 'Unknown'}</p>
                            </div>
                        </div>
                        <div class="mt-3 text-center">
                            <button id="confirm-match-btn" class="btn btn-sm btn-success me-2">
                                <i class="fas fa-check me-1"></i>Confirm Match
                            </button>
                            <button id="reject-match-btn" class="btn btn-sm btn-outline-danger">
                                <i class="fas fa-times me-1"></i>Reject Match
                            </button>
                        </div>
                    </div>`;
                transactionMatchDetails.style.display = 'block';
                
                // Add event listeners for confirm/reject buttons
                const confirmMatchBtn = document.getElementById('confirm-match-btn');
                const rejectMatchBtn = document.getElementById('reject-match-btn');
                
                if (confirmMatchBtn) {
                    confirmMatchBtn.addEventListener('click', () => {
                        // Update the receipt with confirmation
                        receipt.manually_matched = true;
                        updateReceiptWithMatch(receipt, transaction, 1.0); // 1.0 = 100% confidence (manually confirmed)
                        
                        // Update UI to reflect confirmation
                        transactionMatchDetails.innerHTML = `
                            <div class="mt-3 p-3 border rounded bg-light">
                                <h6 class="mb-3">Matched Transaction <span class="float-end text-success small">Confirmed</span></h6>
                                <div class="row">
                                    <div class="col-md-6">
                                        <p class="mb-1"><strong>Date:</strong> ${txDate}</p>
                                        <p class="mb-1"><strong>Description:</strong> ${transaction.description || 'Unknown'}</p>
                                    </div>
                                    <div class="col-md-6">
                                        <p class="mb-1"><strong>Amount:</strong> ${txAmount}</p>
                                        <p class="mb-1"><strong>Account:</strong> ${transaction.account || 'Unknown'}</p>
                                    </div>
                                </div>
                                <div class="alert alert-success mt-2 mb-0">
                                    <i class="fas fa-check-circle me-2"></i>Match confirmed
                                </div>
                            </div>`;
                    });
                }
                
                if (rejectMatchBtn) {
                    rejectMatchBtn.addEventListener('click', () => {
                        // Remove the match from the receipt
                        delete receipt.matched_transaction_id;
                        delete receipt.match_confidence;
                        
                        // Also update in localStorage
                        if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
                            try {
                                const storedReceipts = localStorage.getItem('simulatedReceipts');
                                if (storedReceipts) {
                                    const receipts = JSON.parse(storedReceipts);
                                    const receiptIndex = receipts.findIndex(r => r.receipt_id === receipt.receipt_id);
                                    if (receiptIndex >= 0) {
                                        delete receipts[receiptIndex].matched_transaction_id;
                                        delete receipts[receiptIndex].match_confidence;
                                        delete receipts[receiptIndex].manually_matched;
                                        localStorage.setItem('simulatedReceipts', JSON.stringify(receipts));
                                    }
                                }
                            } catch (e) {
                                console.error('Error removing match from localStorage:', e);
                            }
                        }
                        
                        // Reset UI to unmatched state
                        if (matchStatus) {
                            matchStatus.innerHTML = '<span class="badge bg-secondary">Unmatched</span>';
                        }
                        
                        if (findMatchBtn) {
                            findMatchBtn.style.display = 'inline-block';
                            findMatchBtn.disabled = false;
                        }
                        
                        // Show message about rejected match
                        transactionMatchDetails.innerHTML = `
                            <div class="mt-3 p-3 border rounded">
                                <div class="text-center">
                                    <p class="mb-0"><i class="fas fa-info-circle me-2"></i>Match rejected</p>
                                    <small class="text-muted">Click 'Find Match' to try again</small>
                                </div>
                            </div>`;
                    });
                }
            }
        }

        // Function to show extracted receipt data for confirmation
        function showExtractedReceiptData(receipt, callback) {
            console.log('Showing extracted receipt data for confirmation:', receipt);
            
            // Create or get the modal element for confirming receipt data
            let receiptConfirmModal = document.getElementById('receipt-confirm-modal');
            
            // If modal doesn't exist, create it
            if (!receiptConfirmModal) {
                receiptConfirmModal = document.createElement('div');
                receiptConfirmModal.id = 'receipt-confirm-modal';
                receiptConfirmModal.className = 'modal fade';
                receiptConfirmModal.setAttribute('tabindex', '-1');
                receiptConfirmModal.setAttribute('aria-labelledby', 'receipt-confirm-modal-label');
                receiptConfirmModal.setAttribute('aria-hidden', 'true');
                
                receiptConfirmModal.innerHTML = `
                    <div class="modal-dialog modal-dialog-centered">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="receipt-confirm-modal-label">Confirm Receipt Details</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <form id="receipt-confirm-form">
                                    <div class="mb-3">
                                        <label for="confirm-merchant" class="form-label">Merchant</label>
                                        <input type="text" class="form-control" id="confirm-merchant" required>
                                    </div>
                                    <div class="mb-3">
                                        <label for="confirm-date" class="form-label">Date</label>
                                        <input type="date" class="form-control" id="confirm-date" required>
                                    </div>
                                    <div class="mb-3">
                                        <label for="confirm-total" class="form-label">Total Amount</label>
                                        <input type="number" step="0.01" class="form-control" id="confirm-total" required>
                                    </div>
                                    <div class="mb-3">
                                        <label for="confirm-tax" class="form-label">Tax Amount</label>
                                        <input type="number" step="0.01" class="form-control" id="confirm-tax">
                                    </div>
                                    <div class="mb-3">
                                        <label for="confirm-category" class="form-label">Category</label>
                                        <select class="form-select" id="confirm-category">
                                            <option value="">Select a category</option>
                                            <option value="Food and Dining">Food and Dining</option>
                                            <option value="Groceries">Groceries</option>
                                            <option value="Shopping">Shopping</option>
                                            <option value="Transportation">Transportation</option>
                                            <option value="Utilities">Utilities</option>
                                            <option value="Healthcare">Healthcare</option>
                                            <option value="Entertainment">Entertainment</option>
                                            <option value="Travel">Travel</option>
                                            <option value="Business">Business</option>
                                            <option value="Other">Other</option>
                                        </select>
                                    </div>
                                    <div class="mb-3">
                                        <label for="confirm-notes" class="form-label">Notes</label>
                                        <textarea class="form-control" id="confirm-notes" rows="2"></textarea>
                                    </div>
                                </form>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                <button type="button" class="btn btn-primary" id="confirm-receipt-btn">Confirm & Save</button>
                            </div>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(receiptConfirmModal);
            }
            
            // Fill form with receipt data
            const merchantInput = document.getElementById('confirm-merchant');
            const dateInput = document.getElementById('confirm-date');
            const totalInput = document.getElementById('confirm-total');
            const taxInput = document.getElementById('confirm-tax');
            const categorySelect = document.getElementById('confirm-category');
            const notesTextarea = document.getElementById('confirm-notes');
            
            // Populate form fields
            if (merchantInput) merchantInput.value = receipt.merchant || '';
            if (dateInput) dateInput.value = receipt.date || '';
            if (totalInput) totalInput.value = receipt.total_amount || '';
            if (taxInput) taxInput.value = receipt.tax_amount || '';
            if (categorySelect) categorySelect.value = receipt.category || '';
            if (notesTextarea) notesTextarea.value = receipt.notes || '';
            
            // Initialize the modal
            const bsModal = new bootstrap.Modal(receiptConfirmModal);
            bsModal.show();
            
            // Handle form submission
            const confirmBtn = document.getElementById('confirm-receipt-btn');
            
            // Remove any existing event listeners by cloning and replacing the button
            if (confirmBtn) {
                const newConfirmBtn = confirmBtn.cloneNode(true);
                confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
                
                // Add event listener to the new button
                newConfirmBtn.addEventListener('click', () => {
                    const form = document.getElementById('receipt-confirm-form');
                    
                    // Basic form validation
                    const merchant = merchantInput.value.trim();
                    const date = dateInput.value;
                    const total = parseFloat(totalInput.value);
                    
                    if (!merchant || !date || isNaN(total)) {
                        alert('Please fill in all required fields: Merchant, Date, and Total Amount');
                        return;
                    }
                    
                    // Update receipt with confirmed values
                    const confirmedReceipt = {
                        ...receipt,
                        merchant: merchant,
                        date: date,
                        total_amount: total,
                        tax_amount: taxInput.value ? parseFloat(taxInput.value) : receipt.tax_amount,
                        category: categorySelect.value || receipt.category,
                        notes: notesTextarea.value || receipt.notes
                    };
                    
                    // Close the modal
                    bsModal.hide();
                    
                    // Call the callback with the confirmed receipt data
                    if (typeof callback === 'function') {
                        callback(confirmedReceipt);
                    }
                });
            }
        }

        // Helper function to format currency
        function formatCurrency(amount) {
            if (amount === undefined || amount === null) return '$0.00';
            
            // Format as currency
            return '$' + parseFloat(amount).toFixed(2);
        }

        // Function to initialize and load the data visualization dashboard
        let dashboardInitialized = false;
        function initializeDataDashboard() {
            if (dashboardInitialized) {
                console.log('Dashboard already initialized');
                return;
            }
            
            console.log('Initializing data visualization dashboard');
            
            // Get data for the dashboard
            const dashboardData = getFinancialDataForDashboard();
            
            // Process data for charts
            const { categoryData, timeData, tableData } = processDataForCharts(dashboardData.transactions);
            
            // Create category chart
            createCategoryChart(categoryData);
            
            // Create time chart
            createTimeChart(timeData);
            
            // Populate transactions table
            populateTransactionsTable(tableData);
            
            dashboardInitialized = true;
        }
        
        // Process data for charts
        function processDataForCharts(transactions) {
            // Process data for category chart
            const categoryMap = new Map();
            transactions.forEach(transaction => {
                if (transaction.category) {
                    const category = transaction.category;
                    const amount = parseFloat(transaction.amount) || 0;
                    if (categoryMap.has(category)) {
                        categoryMap.set(category, categoryMap.get(category) + amount);
                    } else {
                        categoryMap.set(category, amount);
                    }
                }
            });
            
            // Sort categories by amount (descending) and limit to top 7 for better visibility
            const sortedCategories = [...categoryMap.entries()]
                .sort((a, b) => b[1] - a[1]);
            
            // Take top 6 categories and group the rest as "Other"
            const topCategories = sortedCategories.slice(0, 6);
            let otherTotal = 0;
            
            if (sortedCategories.length > 6) {
                sortedCategories.slice(6).forEach(([_, amount]) => {
                    otherTotal += amount;
                });
            }
            
            const finalCategories = new Map(topCategories);
            if (otherTotal > 0) {
                finalCategories.set('Other', otherTotal);
            }
            
            const categoryData = {
                labels: Array.from(finalCategories.keys()),
                datasets: [{
                    label: 'Amount',
                    data: Array.from(finalCategories.values()),
                    backgroundColor: [
                        'rgba(255, 99, 132, 0.7)',
                        'rgba(54, 162, 235, 0.7)',
                        'rgba(255, 206, 86, 0.7)',
                        'rgba(75, 192, 192, 0.7)',
                        'rgba(153, 102, 255, 0.7)',
                        'rgba(255, 159, 64, 0.7)',
                        'rgba(199, 199, 199, 0.7)',
                    ],
                    borderWidth: 1
                }]
            };
            
            // Process data for time chart
            const timeMap = new Map();
            transactions.forEach(transaction => {
                if (transaction.date) {
                    // Convert to month-year format
                    const date = new Date(transaction.date);
                    const monthYear = `${date.toLocaleString('default', { month: 'short' })} ${date.getFullYear()}`;
                    const amount = parseFloat(transaction.amount) || 0;
                    
                    if (timeMap.has(monthYear)) {
                        timeMap.set(monthYear, timeMap.get(monthYear) + amount);
                    } else {
                        timeMap.set(monthYear, amount);
                    }
                }
            });
            
            // Sort by date
            const sortedTimeMap = new Map([...timeMap.entries()].sort((a, b) => {
                const dateA = new Date(a[0]);
                const dateB = new Date(b[0]);
                return dateA - dateB;
            }));
            
            const timeData = {
                labels: Array.from(sortedTimeMap.keys()),
                datasets: [{
                    label: 'Total Expenses',
                    data: Array.from(sortedTimeMap.values()),
                    borderColor: 'rgba(75, 192, 192, 1)',
                    backgroundColor: 'rgba(75, 192, 192, 0.2)',
                    tension: 0.1,
                    fill: true
                }]
            };
            
            // Sort transactions by date (newest first)
            const sortedTransactions = [...transactions].sort((a, b) => {
                const dateA = new Date(a.date);
                const dateB = new Date(b.date);
                return dateB - dateA;
            });
            
            // Limit to 50 most recent transactions
            const tableData = sortedTransactions.slice(0, 50);
            
            return { categoryData, timeData, tableData };
        }
        
        // Create category chart
        function createCategoryChart(data) {
            const ctx = document.getElementById('categoryChart').getContext('2d');
            new Chart(ctx, {
                type: 'doughnut',
                data: data,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    layout: {
                        padding: 20
                    },
                    radius: '70%',
                    cutout: '50%',
                    plugins: {
                        legend: {
                            position: 'right',
                            align: 'center',
                            labels: {
                                boxWidth: 15,
                                padding: 15,
                                font: {
                                    size: 14
                                }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.raw || 0;
                                    return `${label}: ${formatCurrency(value)}`;
                                }
                            }
                        }
                    }
                }
            });
        }
        
        // Create time chart
        function createTimeChart(data) {
            const ctx = document.getElementById('timeChart').getContext('2d');
            new Chart(ctx, {
                type: 'line',
                data: data,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '$' + value.toFixed(2);
                                },
                                font: {
                                    size: 11
                                }
                            }
                        },
                        x: {
                            ticks: {
                                font: {
                                    size: 11
                                },
                                maxRotation: 0,
                                minRotation: 0
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                boxWidth: 15,
                                font: {
                                    size: 12
                                }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.dataset.label || '';
                                    const value = context.raw || 0;
                                    return `${label}: ${formatCurrency(value)}`;
                                }
                            }
                        }
                    }
                }
            });
        }
        
        // Populate transactions table
        function populateTransactionsTable(transactions) {
            const tableBody = document.getElementById('transactionsTableBody');
            if (!tableBody) return;
            
            tableBody.innerHTML = '';
            
            transactions.forEach(transaction => {
                const row = document.createElement('tr');
                
                // Format the date
                let formattedDate = 'Unknown';
                if (transaction.date) {
                    const date = new Date(transaction.date);
                    formattedDate = date.toLocaleDateString();
                }
                
                // Create table row
                row.innerHTML = `
                    <td>${formattedDate}</td>
                    <td>${transaction.merchant || 'Unknown'}</td>
                    <td>${transaction.category || 'Uncategorized'}</td>
                    <td>${formatCurrency(transaction.amount)}</td>
                    <td><span class="badge ${transaction.type === 'income' ? 'bg-success' : 'bg-danger'}">${transaction.type === 'income' ? 'Income' : 'Expense'}</span></td>
                `;
                
                tableBody.appendChild(row);
            });
        }
        
        // Function to get financial data for the dashboard
        function getFinancialDataForDashboard() {
            // Get transactions from localStorage
            let transactions = [];
            try {
                const storedTransactions = localStorage.getItem('transactions');
                if (storedTransactions) {
                    transactions = JSON.parse(storedTransactions);
                }
            } catch (error) {
                console.error('Error loading transactions for dashboard:', error);
            }
            
            // Get receipts from localStorage
            let receipts = [];
            try {
                const storedReceipts = localStorage.getItem('receipts');
                if (storedReceipts) {
                    receipts = JSON.parse(storedReceipts);
                }
            } catch (error) {
                console.error('Error loading receipts for dashboard:', error);
            }
            
            // If no data, generate sample data
            if (transactions.length === 0) {
                transactions = generateSampleTransactionData();
            }
            
            // Return data for dashboard
            return {
                transactions: transactions,
                receipts: receipts
            };
        }
        
        // Function to generate sample transaction data for the dashboard
        function generateSampleTransactionData() {
            const sampleData = [];
            const categories = ['Groceries', 'Dining', 'Transportation', 'Entertainment', 'Shopping', 'Utilities', 'Healthcare', 'Housing'];
            const merchants = ['Woolworths', 'Coles', 'IGA', 'Aldi', 'Bunnings', 'JB Hi-Fi', 'Kmart', 'Target', 'Big W', 'Myer', 'David Jones'];
            
            // Generate sample transactions for the last 6 months
            const today = new Date();
            for (let i = 0; i < 100; i++) {
                const daysAgo = Math.floor(Math.random() * 180);
                const date = new Date(today);
                date.setDate(date.getDate() - daysAgo);
                
                const category = categories[Math.floor(Math.random() * categories.length)];
                const merchant = merchants[Math.floor(Math.random() * merchants.length)];
                const amount = Math.round(Math.random() * 200 * 100) / 100;
                
                sampleData.push({
                    id: 'sample-' + i,
                    date: date.toISOString(),
                    category: category,
                    merchant: merchant,
                    amount: amount,
                    description: `Sample ${category} transaction at ${merchant}`,
                    type: Math.random() > 0.2 ? 'expense' : 'income'
                });
            }
            
            return sampleData;
        }
        
        // Helper function to format currency
        function formatCurrency(amount) {
            if (amount === undefined || amount === null) return '$0.00';
            
            // Format as currency
            return '$' + parseFloat(amount).toFixed(2);
        }
    </script>
    
</body>
</html> 